{"version":2,"ops":[{"type":2,"author":{"id":"7eea5bdd45d6b031d3bf16a241db06db985fb528"},"timestamp":1689609824,"metadata":{"github-id":"RTE_lADODBZtRc5rxVNDzwAAAAJKfPFO"},"title":"[Feature] Support upload of Zarr-backend NWB files","was":"[Feature] Support upload of Zarr-backend NWB files"},{"type":3,"author":{"id":"7eea5bdd45d6b031d3bf16a241db06db985fb528"},"timestamp":1689613122,"metadata":{"github-id":"IC_kwDODBZtRc5hqeWf","github-url":"https://github.com/dandi/dandi-cli/issues/1310#issuecomment-1638524319"},"message":"Some work may also be needed with representation of NWB assets for Zarr back-end - no 'i' info button appears on the asset, and the API also fails to recognize the file as an asset, but rather every individual item blob is its own asset (this I had initially expected given the underlying structures of the Zarr store - but on Slack Roni had indicated that each Zarr chunk was not supposed to be a separate AssetBlob, which is what we are seeing below)\n\n```python\nfrom dandi.dandiapi import DandiAPIClient\n\nclient = DandiAPIClient(api_url=\"https://api-staging.dandiarchive.org/api\")\ndandiset = client.get_dandiset(dandiset_id=\"204919\")\n\ndandiset.get_asset_by_path(path=\"test_read_nwbfile/test_hdf5.nwb\") \n```\n\nworks as expected, but \n\n```python\ndandiset.get_asset_by_path(path=\"test_read_nwbfile/test_zarr.nwb\")\n```\n\ngives\n\n```python\nValueError                                Traceback (most recent call last)\nFile /opt/conda/lib/python3.10/site-packages/dandi/dandiapi.py:1155, in RemoteDandiset.get_asset_by_path(self, path)\n   1152 try:\n   1153     # Weed out any assets that happen to have the given path as a\n   1154     # proper prefix:\n-\u003e 1155     (asset,) = (\n   1156         a for a in self.get_assets_with_path_prefix(path) if a.path == path\n   1157     )\n   1158 except ValueError:\n\nValueError: not enough values to unpack (expected 1, got 0)\n\nDuring handling of the above exception, another exception occurred:\n\nNotFoundError                             Traceback (most recent call last)\nCell In[21], line 1\n----\u003e 1 dandiset.get_asset_by_path(path=\"test_read_nwbfile/test_zarr.nwb\")\n\nFile /opt/conda/lib/python3.10/site-packages/dandi/dandiapi.py:1159, in RemoteDandiset.get_asset_by_path(self, path)\n   1155     (asset,) = (\n   1156         a for a in self.get_assets_with_path_prefix(path) if a.path == path\n   1157     )\n   1158 except ValueError:\n-\u003e 1159     raise NotFoundError(f\"No asset at path {path!r}\")\n   1160 else:\n   1161     return asset\n\nNotFoundError: No asset at path 'test_read_nwbfile/test_zarr.nwb'\n```\n\nand if I do\n\n```python\nlist(dandiset.get_assets())\n```\n\nI see\n\n```python\n[RemoteBlobAsset(client=\u003cdandi.dandiapi.DandiAPIClient object at 0x7fc5162c4400\u003e, identifier='fd8e3782-b0c7-4bd5-89fe-e2acc0263744', path='test_read_nwbfile/test_hdf5.nwb', size=197512, created=datetime.datetime(2023, 7, 17, 15, 31, 55, 641893, tzinfo=datetime.timezone.utc), modified=datetime.datetime(2023, 7, 17, 15, 58, 44, 778333, tzinfo=datetime.timezone.utc), blob='6a61bab5-0662-49e5-be46-0b9ee9a27297', dandiset_id='204919', version_id='0.230717.1558'),\n RemoteBlobAsset(client=\u003cdandi.dandiapi.DandiAPIClient object at 0x7fc5162c4400\u003e, identifier='a78dfc02-9cd5-402a-83c8-5006fb18d5e8', path='test_read_nwbfile/test_zarr.nwb/acquisition/ElectricalSeries/data/0.0', size=46, created=datetime.datetime(2023, 7, 17, 15, 57, 45, 173503, tzinfo=datetime.timezone.utc), modified=datetime.datetime(2023, 7, 17, 15, 58, 44, 787050, tzinfo=datetime.timezone.utc), blob='1419744b-36f6-4c28-a850-71d381fc90e5', dandiset_id='204919', version_id='0.230717.1558'),\n RemoteBlobAsset(client=\u003cdandi.dandiapi.DandiAPIClient object at 0x7fc5162c4400\u003e, identifier='cd9faf76-cb4e-4849-b9eb-c838958676d1', path='test_read_nwbfile/test_zarr.nwb/acquisition/ElectricalSeries/electrodes/0', size=56, created=datetime.datetime(2023, 7, 17, 15, 57, 45, 215932, tzinfo=datetime.timezone.utc), modified=datetime.datetime(2023, 7, 17, 15, 58, 44, 795464, tzinfo=datetime.timezone.utc), blob='e8131c7e-095d-4242-ab4c-1658c8c3f5c5', dandiset_id='204919', version_id='0.230717.1558'),\n RemoteBlobAsset(client=\u003cdandi.dandiapi.DandiAPIClient object at 0x7fc5162c4400\u003e, identifier='383ece04-8db0-4207-843a-86109259a5cd', path='test_read_nwbfile/test_zarr.nwb/acquisition/ElectricalSeries/starting_time/0', size=24, created=datetime.datetime(2023, 7, 17, 15, 57, 45, 222857, tzinfo=datetime.timezone.utc), modified=datetime.datetime(2023, 7, 17, 15, 58, 44, 909428, tzinfo=datetime.timezone.utc), blob='a1f46f4a-d8ec-4183-bd8c-8ed530e963e4', dandiset_id='204919', version_id='0.230717.1558'),\n RemoteBlobAsset(client=\u003cdandi.dandiapi.DandiAPIClient object at 0x7fc5162c4400\u003e, identifier='871186e8-ac63-4c5e-b914-8b9246f7326a', path='test_read_nwbfile/test_zarr.nwb/file_create_date/0', size=56, created=datetime.datetime(2023, 7, 17, 15, 57, 45, 253174, tzinfo=datetime.timezone.utc), modified=datetime.datetime(2023, 7, 17, 15, 58, 44, 806273, tzinfo=datetime.timezone.utc), blob='9d7115fb-3133-437d-9168-7058e8fd84b6', dandiset_id='204919', version_id='0.230717.1558'),\n\n....\n```\n\nand so on (the entire NWB file content listed out as separate blobs)","files":null},{"type":3,"author":{"id":"7eea5bdd45d6b031d3bf16a241db06db985fb528"},"timestamp":1689613264,"metadata":{"github-id":"IC_kwDODBZtRc5hqfJg","github-url":"https://github.com/dandi/dandi-cli/issues/1310#issuecomment-1638527584"},"message":"The context the asset ID part is that I want to be able to stream the content using `fsspec` just like with HDF5 files\n\nPyNWB can easily do this given the S3 asset of the HDF5, so I had thought that it would be just as easy if I had the asset ID of the Zarr folder (the 'test_zarr.nwb' file)","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1689613651,"metadata":{"github-id":"IC_kwDODBZtRc5hqh_5","github-url":"https://github.com/dandi/dandi-cli/issues/1310#issuecomment-1638539257"},"message":"@CodyCBakerPhD - i'm pretty positive what's happening here is the non-recognition of zarr on the CLI side and hence it's simply using the non-zarr route, which then the server interprets as individual blobs. so a fix on the CLI side that treats it as zarr would fix it. can you simply try adding the `.zarr` extension to test?","files":null},{"type":3,"author":{"id":"7eea5bdd45d6b031d3bf16a241db06db985fb528"},"timestamp":1689615516,"metadata":{"github-id":"IC_kwDODBZtRc5hqtdQ","github-url":"https://github.com/dandi/dandi-cli/issues/1310#issuecomment-1638586192"},"message":"Well, that is interesting...\n\nMaking a copy of the file with the name `test_zarr.nwb.zarr` (also confirmed same behavior with `test_zarr.zarr`) allows for `dandi upload` to _appear_ as expected\n\n![image](https://github.com/dandi/dandi-cli/assets/51133164/9ea7668e-714a-4b52-b0f2-fbfce30191da)\n\nhowever, nothing new appears on the dandiset view: https://gui-staging.dandiarchive.org/dandiset/204919/0.230717.1558/files?location=test_read_nwbfile%2F\n\nor the API requests.\n\nI also confirmed the asset made it to the bucket by attempting re-upload, to which it responds by saying the file already exists and so does not re-upload it","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1689617642,"metadata":{"github-id":"IC_kwDODBZtRc5hq6Ez","github-url":"https://github.com/dandi/dandi-cli/issues/1310#issuecomment-1638637875"},"message":"@CodyCBakerPhD - you have stumped me. perhaps @AlmightyYakob has an answer to why that asset doesn't show up.","files":null},{"type":3,"author":{"id":"a9e2633aeb6d7e2366a97d09712312c2442c6054"},"timestamp":1689621166,"metadata":{"github-id":"IC_kwDODBZtRc5hrPMt","github-url":"https://github.com/dandi/dandi-cli/issues/1310#issuecomment-1638724397"},"message":"The file is present, the link you provided points to a previously published version, and so won't show any files uploaded to the draft verison. You can see the file here: https://gui-staging.dandiarchive.org/dandiset/204919/draft/files?location=test_read_nwbfile","files":null},{"type":3,"author":{"id":"7eea5bdd45d6b031d3bf16a241db06db985fb528"},"timestamp":1689621425,"metadata":{"github-id":"IC_kwDODBZtRc5hrQkr","github-url":"https://github.com/dandi/dandi-cli/issues/1310#issuecomment-1638730027"},"message":"@AlmightyYakob Aha, yes that was it! Thank you for the sanity check\n\nWould this workflow perhaps 'simply work' if I just naively add \".nwb\" to the list of accepted Zarr entities? I'll try that out locally and see","files":null},{"type":5,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1721326113,"metadata":{"github-id":"LE_lADODBZtRc5rxVNDzwAAAAMoRdk5"},"added":["zarr"],"removed":[]}]}