{"version":2,"ops":[{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680727917,"metadata":{"github-id":"IC_kwDODBZtRc5ZS8BA","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1498136640"},"message":"It looks like nwbinspector is not catching the validation issue?","files":null},{"type":3,"author":{"id":"7eea5bdd45d6b031d3bf16a241db06db985fb528"},"timestamp":1680731307,"metadata":{"github-id":"IC_kwDODBZtRc5ZTL2A","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1498201472"},"message":"Can you try `dandi validate --ignore DANDI.NO_DANDISET_FOUND \u003csource_folder\u003e` before `dandi organize`?\n\nThey've been adding more content beyond the Inspector lately; also could you share the log file `/Users/jerome.lecoq/Library/Logs/dandi-cli/20230405205110Z-75206.log`? Maybe it has a clue as to 'what' metadata that might be","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680734272,"metadata":{"github-id":"IC_kwDODBZtRc5ZTWS3","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1498244279"},"message":"I am not sure that works as intended \n(nwb) jerome.lecoq@OSXLTCYGQCV upload % cd 000459 \n(nwb) jerome.lecoq@OSXLTCYGQCV 000459 % dandi validate --ignore DANDI.NO_DANDISET_FOUND ../to_upload \n2023-04-05 15:32:25,088 [    INFO] NumExpr defaulting to 8 threads.\n2023-04-05 15:32:28,767 [    INFO] Logs saved in /Users/jerome.lecoq/Library/Logs/dandi-cli/20230405223222Z-76404.log\nError: Path '../to_upload' is not inside Dandiset path '/Users/jerome.lecoq/Documents/Work documents/Allen Institute/Projects/DendriticColumns/dandiset/upload/000459'\n(nwb) jerome.lecoq@OSXLTCYGQCV 000459 % dandi organize ../to_upload                                 \n2023-04-05 15:35:12,506 [    INFO] NumExpr defaulting to 8 threads.\n2023-04-05 15:35:13,308 [    INFO] Loading metadata from 1 files\n[Parallel(n_jobs=-1)]: Using backend LokyBackend with 8 concurrent workers.\n[Parallel(n_jobs=-1)]: Done   1 tasks      | elapsed:    2.6s\n[Parallel(n_jobs=-1)]: Done   1 out of   1 | elapsed:    2.6s finished\n2023-04-05 15:35:15,898 [ WARNING] Completely empty record for ../to_upload/Rorb-IRES2-Cre_590168381_590168385.nwb\n2023-04-05 15:35:15,899 [    INFO] Logs saved in /Users/jerome.lecoq/Library/Logs/dandi-cli/20230405223511Z-76664.log\nError: 1 out of 1 files were found not containing all necessary metadata: ../to_upload/Rorb-IRES2-Cre_590168381_590168385.nwb\n(nwb) jerome.lecoq@OSXLTCYGQCV 000459 % dandi validate --ignore DANDI.NO_DANDISET_FOUND ../to_upload\n2023-04-05 15:35:22,661 [    INFO] NumExpr defaulting to 8 threads.\n2023-04-05 15:35:23,445 [    INFO] Logs saved in /Users/jerome.lecoq/Library/Logs/dandi-cli/20230405223521Z-76685.log\nError: Path '../to_upload' is not inside Dandiset path '/Users/jerome.lecoq/Documents/Work documents/Allen Institute/Projects/DendriticColumns/dandiset/upload/000459'","files":null},{"type":6,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680734381,"metadata":{"github-id":"UCE_lALODBZtRc5ZTWS3zi-Xr6E"},"target":"c736207e181385f6f1775191e62c81a6c5ae518ea6997264494e37ff703d4d2f","message":"I am not sure that works as intended \n```\n(nwb) jerome.lecoq@OSXLTCYGQCV upload % cd 000459 \n(nwb) jerome.lecoq@OSXLTCYGQCV 000459 % dandi validate --ignore DANDI.NO_DANDISET_FOUND ../to_upload \n2023-04-05 15:32:25,088 [    INFO] NumExpr defaulting to 8 threads.\n2023-04-05 15:32:28,767 [    INFO] Logs saved in /Users/jerome.lecoq/Library/Logs/dandi-cli/20230405223222Z-76404.log\nError: Path '../to_upload' is not inside Dandiset path '/Users/jerome.lecoq/Documents/Work documents/Allen Institute/Projects/DendriticColumns/dandiset/upload/000459'\n(nwb) jerome.lecoq@OSXLTCYGQCV 000459 % dandi organize ../to_upload                                 \n2023-04-05 15:35:12,506 [    INFO] NumExpr defaulting to 8 threads.\n2023-04-05 15:35:13,308 [    INFO] Loading metadata from 1 files\n[Parallel(n_jobs=-1)]: Using backend LokyBackend with 8 concurrent workers.\n[Parallel(n_jobs=-1)]: Done   1 tasks      | elapsed:    2.6s\n[Parallel(n_jobs=-1)]: Done   1 out of   1 | elapsed:    2.6s finished\n2023-04-05 15:35:15,898 [ WARNING] Completely empty record for ../to_upload/Rorb-IRES2-Cre_590168381_590168385.nwb\n2023-04-05 15:35:15,899 [    INFO] Logs saved in /Users/jerome.lecoq/Library/Logs/dandi-cli/20230405223511Z-76664.log\nError: 1 out of 1 files were found not containing all necessary metadata: ../to_upload/Rorb-IRES2-Cre_590168381_590168385.nwb\n(nwb) jerome.lecoq@OSXLTCYGQCV 000459 % dandi validate --ignore DANDI.NO_DANDISET_FOUND ../to_upload\n2023-04-05 15:35:22,661 [    INFO] NumExpr defaulting to 8 threads.\n2023-04-05 15:35:23,445 [    INFO] Logs saved in /Users/jerome.lecoq/Library/Logs/dandi-cli/20230405223521Z-76685.log\nError: Path '../to_upload' is not inside Dandiset path '/Users/jerome.lecoq/Documents/Work documents/Allen Institute/Projects/DendriticColumns/dandiset/upload/000459'\n```","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680734364,"metadata":{"github-id":"IC_kwDODBZtRc5ZTWkL","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1498245387"},"message":"Here is the content of the log: \n\n```\n2023-04-05T13:51:10-0700 [INFO    ] dandi 75206:4308206976 dandi v0.51.0, hdmf v3.5.2, pynwb v2.3.1, h5py v3.7.0\n2023-04-05T13:51:10-0700 [INFO    ] dandi 75206:4308206976 sys.argv = ['/Users/jerome.lecoq/opt/miniconda3/envs/nwb/bin/dandi', 'organize', '../to_upload']\n2023-04-05T13:51:10-0700 [INFO    ] dandi 75206:4308206976 os.getcwd() = /Users/jerome.lecoq/Documents/Work documents/Allen Institute/Projects/DendriticColumns/dandiset/upload/000459\n2023-04-05T13:51:10-0700 [DEBUG   ] urllib3.connectionpool 75206:4308206976 Starting new HTTPS connection (1): rig.mit.edu:443\n2023-04-05T13:51:11-0700 [DEBUG   ] urllib3.connectionpool 75206:4308206976 https://rig.mit.edu:443 \"GET /et/projects/dandi/dandi-cli HTTP/1.1\" 200 579\n2023-04-05T13:51:11-0700 [WARNING ] dandi 75206:4308206976 A newer version (0.52.0) of dandi/dandi-cli is available. You are using 0.51.0\n2023-04-05T13:51:11-0700 [DEBUG   ] h5py._conv 75206:4308206976 Creating converter from 7 to 5\n2023-04-05T13:51:11-0700 [DEBUG   ] h5py._conv 75206:4308206976 Creating converter from 5 to 7\n2023-04-05T13:51:11-0700 [DEBUG   ] h5py._conv 75206:4308206976 Creating converter from 7 to 5\n2023-04-05T13:51:11-0700 [DEBUG   ] h5py._conv 75206:4308206976 Creating converter from 5 to 7\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'zlib'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'gzip'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'bz2'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'lzma'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'blosc'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'zstd'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'lz4'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'astype'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'delta'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'quantize'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'fixedscaleoffset'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'packbits'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'categorize'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'pickle'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'base64'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'shuffle'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'bitround'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'msgpack2'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'crc32'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'adler32'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'json2'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'vlen-utf8'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'vlen-bytes'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'vlen-array'\n2023-04-05T13:51:11-0700 [DEBUG   ] numcodecs 75206:4308206976 Registering codec 'n5_wrapper'\n2023-04-05T13:51:11-0700 [INFO    ] numexpr.utils 75206:4308206976 NumExpr defaulting to 8 threads.\n2023-04-05T13:51:12-0700 [INFO    ] dandi 75206:4308206976 Loading metadata from 1 files\n2023-04-05T13:51:14-0700 [WARNING ] dandi 75206:4308206976 Completely empty record for ../to_upload/Rorb-IRES2-Cre_590168381_590168385.nwb\n2023-04-05T13:51:14-0700 [DEBUG   ] dandi 75206:4308206976 Caught exception 1 out of 1 files were found not containing all necessary metadata: ../to_upload/Rorb-IRES2-Cre_590168381_590168385.nwb\n2023-04-05T13:51:14-0700 [INFO    ] dandi 75206:4308206976 Logs saved in /Users/jerome.lecoq/Library/Logs/dandi-cli/20230405205110Z-75206.log\n```","files":null},{"type":3,"author":{"id":"7eea5bdd45d6b031d3bf16a241db06db985fb528"},"timestamp":1680737409,"metadata":{"github-id":"IC_kwDODBZtRc5ZTfK-","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1498280638"},"message":"Last idea of mine: `2023-04-05T13:51:11-0700 [WARNING ] dandi 75206:4308206976 A newer version (0.52.0) of dandi/dandi-cli is available. You are using 0.51.0`\n\nTry upgrading with `pip install -U dandi` and retrying?\n\nOtherwise I defer to @yarikoptic on what looks to be bugs on the DANDI CLI side of things","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680738095,"metadata":{"github-id":"IC_kwDODBZtRc5ZThEw","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1498288432"},"message":"Ah yes, I upgraded after that run\nsame","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1680747153,"metadata":{"github-id":"IC_kwDODBZtRc5ZT7ik","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1498396836"},"message":"so the heart of the problem is the message(s) from `dandi organize`\n```\n2023-04-05 13:51:14,851 [ WARNING] Completely empty record for ../to_upload/Rorb-IRES2-Cre_590168381_590168385.nwb\n2023-04-05 13:51:14,851 [ INFO] Logs saved in /Users/jerome.lecoq/Library/Logs/dandi-cli/20230405205110Z-75206.log\nError: 1 out of 1 files were found not containing all necessary metadata: ../to_upload/Rorb-IRES2-Cre_590168381_590168385.nwb\n```\ncorrect?  I guess we might improve the message there. What it means that the file contains no fields of interest for `organize`, not even the `object_id`.  There was a recent issue filed for that https://github.com/dandi/dandi-cli/issues/1266 -- may be situation described there rings a bell?\n\nyou could use `dandi ls` on those files to see all metadata we load, and something like this\n\n```\nfind pynwb -iname *.nwb | while read p; do echo $p; python -c 'import sys,yaml; from dandi.pynwb_utils import get_object_id; print(get_object_id(sys.argv[1]));' $p; done\n```\nto go through your .nwb files and print their `object_id`s (we might want to add printing object_id by `dandi ls`).\n\nThen you can see which metadata fields are used by `organize` to construct filenames here https://github.com/dandi/dandi-cli/blob/HEAD/dandi/consts.py#L177 .  Current explanation is that among those fields there were no information to name that file.  What did you expect it to get named like?","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680800638,"metadata":{"github-id":"IC_kwDODBZtRc5ZXoBm","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499365478"},"message":"I ran the script you suggested : \n\n```\n(nwb) jerome.lecoq@OSXLTCYGQCV to_upload % find . -iname *.nwb | while read p; do echo $p; python -c 'import sys,yaml; from dandi.pynwb_utils import get_object_id; print(get_object_id(sys.argv[1]));' $p; done\n./Rorb-IRES2-Cre_590168381_590168385.nwb\n86fb9251-666e-4ac6-b246-ed7e2747c238\n```","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680800781,"metadata":{"github-id":"IC_kwDODBZtRc5ZXoxE","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499368516"},"message":"To note, these are NWB files that I created by merging the output of suite2p+NeuroConv with data from Allen Institute Visual coding NWB 1.0 files. It looks like maybe some metadata needs to moved around.","files":null},{"type":6,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680800811,"metadata":{"github-id":"UCE_lALODBZtRc5ZXoxEzi-hu98"},"target":"eefb1a403fb21624b6168b3e0c6e67ca39167e39f97c9287c4fbb07bd04ff7d0","message":"To note, these are NWB files that I created by merging the output of suite2p+NeuroConv with data from Allen Institute Visual coding NWB 1.0 files. It looks like maybe some metadata needs to move around.","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680806230,"metadata":{"github-id":"IC_kwDODBZtRc5ZYA8E","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499467524"},"message":"I am not entirely sure what is missing. \n\nHere is output of pynwb on this file : \n\n\u003e\u003e\u003e input_nwb\nroot pynwb.file.NWBFile at 0x5050990496\nFields:\n  devices: {\n    2-photon microscope \u003cclass 'pynwb.device.Device'\u003e,\n    Microscope \u003cclass 'pynwb.device.Device'\u003e,\n    display monitor \u003cclass 'pynwb.device.Device'\u003e,\n    eye-tracking camera \u003cclass 'pynwb.device.Device'\u003e\n  }\n  file_create_date: [datetime.datetime(2023, 3, 18, 16, 18, 27, 551472, tzinfo=tzutc())]\n  identifier: 64ae8bcc-92ea-4b0c-a207-130dd959045b_test_IDs\n  imaging_planes: {\n    ImagingPlane \u003cclass 'pynwb.ophys.ImagingPlane'\u003e\n  }\n  institution: Allen Institute for Brain Science\n  intervals: {\n    trials \u003cclass 'pynwb.epoch.TimeIntervals'\u003e\n  }\n  processing: {\n    behavior \u003cclass 'pynwb.base.ProcessingModule'\u003e,\n    ophys \u003cclass 'pynwb.base.ProcessingModule'\u003e\n  }\n  session_description: no description\n  session_id: 590168385\n  session_start_time: 2020-01-01 12:30:00-08:00\n  stimulus: {\n    natural_movie_one_stimulus \u003cclass 'pynwb.image.IndexSeries'\u003e,\n    natural_movie_one_stimulus_frame_duration \u003cclass 'pynwb.image.ImageSeries'\u003e,\n    natural_movie_three_stimulus \u003cclass 'pynwb.image.IndexSeries'\u003e,\n    natural_movie_three_stimulus_frame_duration \u003cclass 'pynwb.image.ImageSeries'\u003e,\n    spontaneous_stimulus \u003cclass 'pynwb.misc.IntervalSeries'\u003e\n  }\n  stimulus_template: {\n    natural_movie_one_image_stack \u003cclass 'pynwb.image.OpticalSeries'\u003e,\n    natural_movie_three_image_stack \u003cclass 'pynwb.image.OpticalSeries'\u003e\n  }\n  subject: subject pynwb.file.Subject at 0x5050983488\nFields:\n  age: P113D\n  age__reference: birth\n  description: Mus musculus in vivo\n  genotype: Rorb-IRES2-Cre/wt;Camk2a-tTA/wt;Ai93(TITL-GCaMP6f)/wt\n  sex: M\n  species: Mus musculus\n  subject_id: 575296278\n\n  timestamps_reference_time: 2020-01-01 12:30:00-08:00\n  trials: trials \u003cclass 'pynwb.epoch.TimeIntervals'\u003e","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680810490,"metadata":{"github-id":"IC_kwDODBZtRc5ZYR1N","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499536717"},"message":"We are not sure which metadata is missing. Ahad and I were wondering if something else was crashing organize. \n\nSee here for an example of these files : https://www.dropbox.com/s/qwv4i2zh0un4v9d/Rorb-IRES2-Cre_590168381_590168385.nwb?dl=0","files":null},{"type":3,"author":{"id":"7eea5bdd45d6b031d3bf16a241db06db985fb528"},"timestamp":1680816106,"metadata":{"github-id":"IC_kwDODBZtRc5ZYsRB","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499644993"},"message":"\u003e We are not sure which metadata is missing. \n\nFrom the printout of your NWB file, it looks like you ought to have everything DANDI currently requires (at least to my knowledge). Thanks for including that\n\n\u003e Ahad and I were wondering if something else was crashing organize.\n\nThat is my best guess now as well","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680816542,"metadata":{"github-id":"IC_kwDODBZtRc5ZYtxO","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499651150"},"message":"If that is helpful, I am comparing the content of this NWB files with another file that dandi organize actually like and is already on Dandi. \n\nWORKS: \n```\nFields:\n  devices: {\n    2p_microscope \u003cclass 'pynwb.device.Device'\u003e\n  }\n  file_create_date: [datetime.datetime(2022, 9, 25, 4, 53, 2, 714938, tzinfo=tzoffset(None, -25200))]\n  identifier: 758519303\n  imaging_planes: {\n    ImagingPlane \u003cclass 'pynwb.ophys.ImagingPlane'\u003e\n  }\n  institution: Allen Institute for Brain Science\n  intervals: {\n    trials \u003cclass 'pynwb.epoch.TimeIntervals'\u003e\n  }\n  processing: {\n    behavior \u003cclass 'pynwb.base.ProcessingModule'\u003e,\n    ophys \u003cclass 'pynwb.base.ProcessingModule'\u003e\n  }\n  session_description: Allen Institute OpenScope dataset\n  session_id: 758519303\n  session_start_time: 2018-09-26 17:29:17.502000-07:00\n  subject: subject pynwb.file.Subject at 0x5192267424\nFields:\n  age: P95D\n  genotype: Cux2-CreERT2;Camk2a-tTA;Ai93\n  sex: M\n  species: Mus musculus\n  subject_id: 408021\n\n  timestamps_reference_time: 2018-09-26 17:29:17.502000-07:00\n  trials: trials \u003cclass 'pynwb.epoch.TimeIntervals'\u003e\n```\n\nDOES NOT WORK\n```\nFields:\n  devices: {\n    2-photon microscope \u003cclass 'pynwb.device.Device'\u003e,\n    Microscope \u003cclass 'pynwb.device.Device'\u003e,\n    display monitor \u003cclass 'pynwb.device.Device'\u003e,\n    eye-tracking camera \u003cclass 'pynwb.device.Device'\u003e\n  }\n  file_create_date: [datetime.datetime(2023, 3, 18, 16, 18, 27, 551472, tzinfo=tzutc())]\n  identifier: 64ae8bcc-92ea-4b0c-a207-130dd959045b_test_IDs\n  imaging_planes: {\n    ImagingPlane \u003cclass 'pynwb.ophys.ImagingPlane'\u003e\n  }\n  institution: Allen Institute for Brain Science\n  intervals: {\n    trials \u003cclass 'pynwb.epoch.TimeIntervals'\u003e\n  }\n  processing: {\n    behavior \u003cclass 'pynwb.base.ProcessingModule'\u003e,\n    ophys \u003cclass 'pynwb.base.ProcessingModule'\u003e\n  }\n  session_description: no description\n  session_id: 590168385\n  session_start_time: 2020-01-01 12:30:00-08:00\n  stimulus: {\n    natural_movie_one_stimulus \u003cclass 'pynwb.image.IndexSeries'\u003e,\n    natural_movie_one_stimulus_frame_duration \u003cclass 'pynwb.image.ImageSeries'\u003e,\n    natural_movie_three_stimulus \u003cclass 'pynwb.image.IndexSeries'\u003e,\n    natural_movie_three_stimulus_frame_duration \u003cclass 'pynwb.image.ImageSeries'\u003e,\n    spontaneous_stimulus \u003cclass 'pynwb.misc.IntervalSeries'\u003e\n  }\n  stimulus_template: {\n    natural_movie_one_image_stack \u003cclass 'pynwb.image.OpticalSeries'\u003e,\n    natural_movie_three_image_stack \u003cclass 'pynwb.image.OpticalSeries'\u003e\n  }\n  subject: subject pynwb.file.Subject at 0x5194424160\nFields:\n  age: P113D\n  age__reference: birth\n  description: Mus musculus in vivo\n  genotype: Rorb-IRES2-Cre/wt;Camk2a-tTA/wt;Ai93(TITL-GCaMP6f)/wt\n  sex: M\n  species: Mus musculus\n  subject_id: 575296278\n\n  timestamps_reference_time: 2020-01-01 12:30:00-08:00\n  trials: trials \u003cclass 'pynwb.epoch.TimeIntervals'\u003e\n```","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680816600,"metadata":{"github-id":"IC_kwDODBZtRc5ZYt93","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499651959"},"message":"Could it be fields that should NOT be there?","files":null},{"type":3,"author":{"id":"7eea5bdd45d6b031d3bf16a241db06db985fb528"},"timestamp":1680816816,"metadata":{"github-id":"IC_kwDODBZtRc5ZYuof","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499654687"},"message":"\u003e Could it be fields that should NOT be there?\n\nDoubtful, when it comes to metadata the more information than can be included the better, so as such I don't believe there are any 'forbidden' contents\n\nSomething I did just notice is the underscores in the `identifier='64ae8bcc-92ea-4b0c-a207-130dd959045b_test_IDs'`  @yarikoptic would that cause a problem do you think?","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680817647,"metadata":{"github-id":"IC_kwDODBZtRc5ZYxVP","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499665743"},"message":"I just remove most of the identifier:\n\n\u003e \u003e\u003e\u003e path = 'Rorb-IRES2-Cre_590168381_590168385.nwb'\n\u003e \u003e\u003e\u003e import h5py\n\u003e \u003e\u003e\u003e X = h5py.File(path, 'r+')\n\u003e \u003e\u003e\u003e X.keys()\n\u003e \u003cKeysViewHDF5 ['acquisition', 'analysis', 'file_create_date', 'general', 'identifier', 'intervals', 'processing', 'session_description', 'session_start_time', 'specifications', 'stimulus', 'timestamps_reference_time']\u003e\n\u003e \u003e\u003e\u003e X['identifier']\n\u003e \u003cHDF5 dataset \"identifier\": shape (), type \"|O\"\u003e\n\u003e \u003e\u003e\u003e X['identifier']\n\u003e \u003cHDF5 dataset \"identifier\": shape (), type \"|O\"\u003e\n\u003e \u003e\u003e\u003e X['identifier'][()]\n\u003e b'64ae8bcc-92ea-4b0c-a207-130dd959045b_test_IDs'\n\u003e \u003e\u003e\u003e local_data = X['identifier'][()]\n\u003e \u003e\u003e\u003e local_data[0:8]\n\u003e b'64ae8bcc'\n\u003e \u003e\u003e\u003e X['identifier'][()] = local_data[0:8]\n\u003e \u003e\u003e\u003e X['identifier'][()]\n\u003e b'64ae8bcc'\n\u003e \u003e\u003e\u003e X.close()","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680817657,"metadata":{"github-id":"IC_kwDODBZtRc5ZYxXA","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499665856"},"message":"same error","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1680821656,"metadata":{"github-id":"IC_kwDODBZtRc5ZY_q_","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499724479"},"message":"@jwodder and @yarikoptic - this section of the reader is resulting in an error - perhaps that results in the issue @jeromelecoq  is seeing:\n\nusing `_get_pynwb_metadata(\"/Users/satra/Downloads/Rorb-IRES2-Cre_590168381_590168385.nwb\")` in pynwb_utils\n\n```\nFile ~/software/dandi/dandi-cli/dandi/pynwb_utils.py:210, in _get_pynwb_metadata(path)\n    206 out = {}\n    207 with open_readable(path) as fp, h5py.File(fp) as h5, NWBHDF5IO(\n    208     file=h5, load_namespaces=True\n    209 ) as io:\n--\u003e 210     nwb = io.read()\n    211     for key in metadata_nwb_file_fields:\n    212         value = getattr(nwb, key)\n```\n\nresults in:\n\n```\nConstructError: (root/stimulus/presentation/natural_movie_one_stimulus GroupBuilder {'attributes': {'comments': 'The data stored here is a precursor for what was displayed. Please see http://help.brain-map.org/download/attachments/10616846/VisualCoding_VisualStimuli.pdf for instructions for how to convert this to actual stimulus data', 'description': 'natural_movie_one_stimulus', 'namespace': 'core', 'neurodata_type': 'IndexSeries', 'object_id': '42360a35-1bd0-4f36-b9cc-0dc461ad4438'}, 'groups': {}, 'datasets': {'data': root/stimulus/presentation/natural_movie_one_stimulus/data DatasetBuilder {'attributes': {'conversion': 1.0, 'offset': 0.0, 'resolution': -1.0, 'unit': 'N/A'}, 'data': \u003cClosed HDF5 dataset\u003e}, 'timestamps': root/stimulus/presentation/natural_movie_one_stimulus/timestamps DatasetBuilder {'attributes': {'interval': 1, 'unit': 'seconds'}, 'data': \u003cClosed HDF5 dataset\u003e}}, 'links': {}}, 'Could not construct IndexSeries object due to: Either indexed_timeseries or indexed_images must be provided when creating an IndexSeries.')\n```\n\nwhere as this works just fine:\n\n```\nIn [17]: with NWBHDF5IO(\"path_to_file.nwb\", load_namespaces=True) as io\n    ...: :\n    ...:     nwb = io.read()\n    ...: \n\n```","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680822288,"metadata":{"github-id":"IC_kwDODBZtRc5ZZBVP","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499731279"},"message":"Ah that seems like it. Yes. I tested the io.read() but not the thing above. We just need to find the key it crashes on?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1680822651,"metadata":{"github-id":"IC_kwDODBZtRc5ZZCMo","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499734824"},"message":"Thanks for digging!\n\nhm, I have tried to reproduce while incrementally building up how I open it\n\n```\n$\u003e cat Rorb-IRES2-Cre_590168381_590168385.py\nfrom pynwb import NWBHDF5IO\nimport h5py\nfrom dandi.pynwb_utils import open_readable\n\nfname = \"Rorb-IRES2-Cre_590168381_590168385.nwb\"\n\nwith NWBHDF5IO(fname, load_namespaces=True) as io:\n      nwb = io.read()\nprint(\"way 1 worked\")\n\nwith open(fname, 'rb') as fp, h5py.File(fp) as h5, NWBHDF5IO(file=h5, load_namespaces=True) as io:\n      nwb = io.read()\nprint(\"way 2 worked\")\n\nwith open_readable(fname) as fp, h5py.File(fp) as h5, NWBHDF5IO(file=h5, load_namespaces=True) as io:\n      nwb = io.read()\nprint(\"way 3 worked\")\n```\n\nand they all worked out\n\n```\n$\u003e python Rorb-IRES2-Cre_590168381_590168385.py\nway 1 worked\nway 2 worked\nway 3 worked\n```","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680822781,"metadata":{"github-id":"IC_kwDODBZtRc5ZZCfk","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499736036"},"message":"So I used a variant of this code https://github.com/rly/aibs-nwb1-to-nwb2/blob/038aff3ff09d5093d5acbffad496600a4adc607a/append_suite2p.py#L138\n\nTo port visual stimuli object in an NWB 2 files to a newly created NWB 2.0 files. \n\nWhat exactly is the sub-object that crashes?","files":null},{"type":6,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680822794,"metadata":{"github-id":"UCE_lALODBZtRc5ZZCfkzi-luX0"},"target":"073cddb3ba13146f7caea14131a0d2232d79a8019f008d5f33a519175b94cfff","message":"So I used a variant of this code https://github.com/rly/aibs-nwb1-to-nwb2/blob/038aff3ff09d5093d5acbffad496600a4adc607a/append_suite2p.py#L138\n\nTo port visual stimuli object in an NWB 1 files to a newly created NWB 2.0 files. \n\nWhat exactly is the sub-object that crashes?","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680822976,"metadata":{"github-id":"IC_kwDODBZtRc5ZZC68","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499737788"},"message":"I think those index_timeseries were provided here : https://github.com/rly/aibs-nwb1-to-nwb2/blob/038aff3ff09d5093d5acbffad496600a4adc607a/append_suite2p.py#L184","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1680823477,"metadata":{"github-id":"IC_kwDODBZtRc5ZZF-U","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499750292"},"message":"- I can't reproduce above crash, but can reproduce organize misbehaving\n- running `$\u003e DANDI_CACHE=ignore DANDI_DEVEL=1 dandi -l 1 organize --devel-debug ../Rorb-IRES2-Cre_590168381_590168385.nwb` gives me more as\n\n```\n2023-04-06 19:18:32,451 [    INFO] Loading metadata from 1 files\n2023-04-06 19:18:32,579 [   DEBUG] Failed to get metadata for ../Rorb-IRES2-Cre_590168381_590168385.nwb: NWB files with external \nlinks are not supported: /home/yoh/proj/dandi/nwb-files/Rorb-IRES2-Cre_590168381_590168385.nwb\n2023-04-06 19:18:32,580 [ WARNING] Failed to load metadata for 1 out of 1 files\n```\nwhich is due to https://github.com/dandi/dandi-cli/blob/HEAD/dandi/metadata.py#L110 which was added in https://github.com/dandi/dandi-cli/pull/843 to \"address\" https://github.com/dandi/dandi-cli/issues/840 .\n\nIf my analysis is right, the \"solution\" here might be\n- improve error reporting in dandi-cli to give a clear reason why organize failed -- external links\n- prepare nwb and referenced external files properly named in dandi convention to start with and just copy instead of using `dandi organize`.","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680823763,"metadata":{"github-id":"IC_kwDODBZtRc5ZZHA7","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499754555"},"message":"Can you clarify how I can address the error? Should I remove external links?","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1680823765,"metadata":{"github-id":"IC_kwDODBZtRc5ZZHBY","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499754584"},"message":"@yarikoptic - perhaps its a version thing. in a fresh mamba environment on my m1 tin can:\n\n```\nmamba create -n testnwb ipython pip python=3.10\nmamba activate testnwb \npip install dandi\n```\n\nand then \n\n```python\nfrom dandi.metadata import _get_pynwb_metadata\n_get_pynwb_metadata(\"Rorb-IRES2-Cre_590168381_590168385.nwb\")\n```\n\nthe error (which points to the links as well i think):\n\n\u003e ConstructError: (root/stimulus/presentation/natural_movie_one_stimulus GroupBuilder {'attributes': {'comments': 'The data stored here is a precursor for what was displayed. Please see http://help.brain-map.org/download/attachments/10616846/VisualCoding_VisualStimuli.pdf for instructions for how to convert this to actual stimulus data', 'description': 'natural_movie_one_stimulus', 'namespace': 'core', 'neurodata_type': 'IndexSeries', 'object_id': '42360a35-1bd0-4f36-b9cc-0dc461ad4438'}, 'groups': {}, 'datasets': {'data': root/stimulus/presentation/natural_movie_one_stimulus/data DatasetBuilder {'attributes': {'conversion': 1.0, 'offset': 0.0, 'resolution': -1.0, 'unit': 'N/A'}, 'data': \u003cClosed HDF5 dataset\u003e}, 'timestamps': root/stimulus/presentation/natural_movie_one_stimulus/timestamps DatasetBuilder {'attributes': {'interval': 1, 'unit': 'seconds'}, 'data': \u003cClosed HDF5 dataset\u003e}}, 'links': {}}, 'Could not construct IndexSeries object due to: Either indexed_timeseries or indexed_images must be provided when creating an IndexSeries.')\n\nsome relevant bits:\n\n```\ndandi                     0.52.0                   pypi_0    pypi\nh5py                      3.8.0                    pypi_0    pypi\nhdmf                      3.5.2                    pypi_0    pypi\npynwb                     2.3.1                    pypi_0    pypi\n```","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1680824173,"metadata":{"github-id":"IC_kwDODBZtRc5ZZH57","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499758203"},"message":"@jeromelecoq - this may help: https://www.dandiarchive.org/2022/03/03/external-links-organize.html (perhaps @CodyCBakerPhD could say if its still up to date)","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680824932,"metadata":{"github-id":"IC_kwDODBZtRc5ZZJ-6","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499766714"},"message":"I am not sure why there are external links with the movies. I can access the raw data directly. It looks like the raw movie is in the template.","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680828763,"metadata":{"github-id":"IC_kwDODBZtRc5ZZSDB","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499799745"},"message":"I can't seem to replicate \n```\n\u003e\u003e\u003e from dandi.metadata import _get_pynwb_metadata\n\u003e\u003e\u003e path\n'Rorb-IRES2-Cre_590168381_590168385.nwb'\n\u003e\u003e\u003e _get_pynwb_metadata(path)\n{'experiment_description': None, 'experimenter': None, 'identifier': '64ae8bcc', 'institution': 'Allen Institute for Brain Science', 'keywords': None, 'lab': None, 'related_publications': None, 'session_description': 'no description', 'session_id': '590168385', 'session_start_time': datetime.datetime(2020, 1, 1, 12, 30, tzinfo=tzoffset(None, -28800)), 'age': 'P113D', 'date_of_birth': None, 'genotype': 'Rorb-IRES2-Cre/wt;Camk2a-tTA/wt;Ai93(TITL-GCaMP6f)/wt', 'sex': 'M', 'species': 'Mus musculus', 'subject_id': '575296278', 'number_of_electrodes': 0, 'number_of_units': 0, 'external_file_objects': []}\n```","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680828847,"metadata":{"github-id":"IC_kwDODBZtRc5ZZSLO","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499800270"},"message":"\u003e\u003e\u003e pynwb.__version__\n'2.3.1'\n\u003e\u003e\u003e dandi.__version__\n'0.52.0'\n\u003e\u003e\u003e hdmf.__version__\n'3.5.2'\n\u003e\u003e\u003e pynwb.__version__\n'2.3.1'","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680828886,"metadata":{"github-id":"IC_kwDODBZtRc5ZZSPG","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499800518"},"message":"jerome.lecoq@OSXLTCYGQCV to_upload % python\nPython 3.10.8","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680830593,"metadata":{"github-id":"IC_kwDODBZtRc5ZZW46","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499819578"},"message":"So I am not sure how it happened so far but I have an external link to dataset in the same file ...\n\n\u003e X.get('/stimulus/presentation/natural_movie_one_stimulus/indexed_timeseries', getlink=True)\n\u003cExternalLink to \"/stimulus/templates/natural_movie_one_image_stack\" in file \"Rorb-IRES2-Cre_590168381_590168385.nwb\"\n\n\u003e X.get('/stimulus/templates/natural_movie_one_image_stack', getlink=True)\n\u003ch5py._hl.group.HardLink at 0x114e22350\u003e","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1680830997,"metadata":{"github-id":"IC_kwDODBZtRc5ZZXyq","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499823274"},"message":"thanks @jeromelecoq - suggests something else on my machine. still trying to get clean read.","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680831253,"metadata":{"github-id":"IC_kwDODBZtRc5ZZYhI","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499826248"},"message":"It does seem that this is related to ExternalLinks. \n\nThis link is between datasets in the same file. this link was created by this code line : https://github.com/rly/aibs-nwb1-to-nwb2/blob/038aff3ff09d5093d5acbffad496600a4adc607a/append_suite2p.py#L184\n\nTo connect a template with a presentation. \n\nIs that the wrong way to do this?","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680843064,"metadata":{"github-id":"IC_kwDODBZtRc5ZZySP","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1499931791"},"message":"Is it possible that the error is because the template is stored as an OpticalSeries?\nhttps://github.com/rly/aibs-nwb1-to-nwb2/blob/038aff3ff09d5093d5acbffad496600a4adc607a/append_suite2p.py#L163\n\nRyan discuss it in the comment above : \nhttps://github.com/rly/aibs-nwb1-to-nwb2/blob/038aff3ff09d5093d5acbffad496600a4adc607a/append_suite2p.py#L142\n\n@yarikoptic @satra ?","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1680870841,"metadata":{"github-id":"IC_kwDODBZtRc5Za_7s","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1500249836"},"message":"@jeromelecoq - when did ryan make that suggestion? perhaps the pynwb bug is fixed now and you can go to addressing the best practice violation suggested in your original post?\n\n@yarikoptic and @jeromelecoq - i can't reproduce the contexterror on a separate linux machine, but i can on my m1 mac both natively and using a docker container. and it's interesting that the error points to the same relevant section of code. all coincidence perhaps.","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680888448,"metadata":{"github-id":"IC_kwDODBZtRc5Zb6Bn","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1500487783"},"message":"\u003e @jeromelecoq - when did ryan make that suggestion? perhaps the pynwb bug is fixed now and you can go to addressing the best practice violation suggested in your original post?\n\u003e \n\u003e @yarikoptic and @jeromelecoq - i can't reproduce the contexterror on a separate linux machine, but i can on my m1 mac both natively and using a docker container. and it's interesting that the error points to the same relevant section of code. all coincidence perhaps.\n\nI completely changed the way the natural_movie template is added and used Images object, per Satra suggestion. The same error occurs. So this is ruled out. Here is the newer file. \nhttps://www.dropbox.com/s/i708rcvel1r5lwb/Rorb-IRES2-Cre_590168381_590168385-2.nwb?dl=0\n\nHere is copy of cmd:\n```\n(nwb) jerome.lecoq@OSXLTCYGQCV 000459 % DANDI_CACHE=ignore DANDI_DEVEL=1 dandi -l 1 organize --devel-debug ../to_upload/Rorb-IRES2-Cre_590168381_590168385-2.nwb\n2023-04-07 10:26:12,116 [   DEBUG] Starting new HTTPS connection (1): rig.mit.edu:443\n2023-04-07 10:26:12,671 [   DEBUG] https://rig.mit.edu:443 \"GET /et/projects/dandi/dandi-cli HTTP/1.1\" 200 579\n2023-04-07 10:26:12,673 [   DEBUG] No newer (than 0.52.0) version of dandi/dandi-cli found available\n2023-04-07 10:26:12,940 [   DEBUG] Creating converter from 7 to 5\n2023-04-07 10:26:12,940 [   DEBUG] Creating converter from 5 to 7\n2023-04-07 10:26:12,940 [   DEBUG] Creating converter from 7 to 5\n2023-04-07 10:26:12,940 [   DEBUG] Creating converter from 5 to 7\n2023-04-07 10:26:12,986 [   DEBUG] Registering codec 'zlib'\n2023-04-07 10:26:12,987 [   DEBUG] Registering codec 'gzip'\n2023-04-07 10:26:12,988 [   DEBUG] Registering codec 'bz2'\n2023-04-07 10:26:12,988 [   DEBUG] Registering codec 'lzma'\n2023-04-07 10:26:12,993 [   DEBUG] Registering codec 'blosc'\n2023-04-07 10:26:12,996 [   DEBUG] Registering codec 'zstd'\n2023-04-07 10:26:12,997 [   DEBUG] Registering codec 'lz4'\n2023-04-07 10:26:12,997 [   DEBUG] Registering codec 'astype'\n2023-04-07 10:26:12,998 [   DEBUG] Registering codec 'delta'\n2023-04-07 10:26:12,998 [   DEBUG] Registering codec 'quantize'\n2023-04-07 10:26:12,998 [   DEBUG] Registering codec 'fixedscaleoffset'\n2023-04-07 10:26:12,999 [   DEBUG] Registering codec 'packbits'\n2023-04-07 10:26:12,999 [   DEBUG] Registering codec 'categorize'\n2023-04-07 10:26:12,999 [   DEBUG] Registering codec 'pickle'\n2023-04-07 10:26:13,000 [   DEBUG] Registering codec 'base64'\n2023-04-07 10:26:13,001 [   DEBUG] Registering codec 'shuffle'\n2023-04-07 10:26:13,001 [   DEBUG] Registering codec 'bitround'\n2023-04-07 10:26:13,004 [   DEBUG] Registering codec 'msgpack2'\n2023-04-07 10:26:13,004 [   DEBUG] Registering codec 'crc32'\n2023-04-07 10:26:13,004 [   DEBUG] Registering codec 'adler32'\n2023-04-07 10:26:13,004 [   DEBUG] Registering codec 'json2'\n2023-04-07 10:26:13,006 [   DEBUG] Registering codec 'vlen-utf8'\n2023-04-07 10:26:13,006 [   DEBUG] Registering codec 'vlen-bytes'\n2023-04-07 10:26:13,006 [   DEBUG] Registering codec 'vlen-array'\n2023-04-07 10:26:13,030 [   DEBUG] Registering codec 'n5_wrapper'\n2023-04-07 10:26:13,115 [    INFO] NumExpr defaulting to 8 threads.\n2023-04-07 10:26:13,873 [    INFO] Loading metadata from 1 files\n2023-04-07 10:26:14,008 [   DEBUG] Failed to get metadata for ../to_upload/Rorb-IRES2-Cre_590168381_590168385-2.nwb: NWB files with external links are not supported: /Users/jerome.lecoq/Documents/Work documents/Allen Institute/Projects/DendriticColumns/dandiset/upload/to_upload/Rorb-IRES2-Cre_590168381_590168385-2.nwb\n2023-04-07 10:26:14,008 [ WARNING] Failed to load metadata for 1 out of 1 files\n2023-04-07 10:26:14,008 [ WARNING] Completely empty record for ../to_upload/Rorb-IRES2-Cre_590168381_590168385-2.nwb\n2023-04-07 10:26:14,008 [   DEBUG] Caught exception 1 out of 1 files were found not containing all necessary metadata: ../to_upload/Rorb-IRES2-Cre_590168381_590168385-2.nwb\n2023-04-07 10:26:14,008 [    INFO] Logs saved in /Users/jerome.lecoq/Library/Logs/dandi-cli/20230407172611Z-96788.log\nTraceback (most recent call last):\n  File \"/Users/jerome.lecoq/opt/miniconda3/envs/nwb/bin/dandi\", line 8, in \u003cmodule\u003e\n    sys.exit(main())\n  File \"/Users/jerome.lecoq/opt/miniconda3/envs/nwb/lib/python3.10/site-packages/click/core.py\", line 1130, in __call__\n    return self.main(*args, **kwargs)\n  File \"/Users/jerome.lecoq/opt/miniconda3/envs/nwb/lib/python3.10/site-packages/click/core.py\", line 1055, in main\n    rv = self.invoke(ctx)\n  File \"/Users/jerome.lecoq/opt/miniconda3/envs/nwb/lib/python3.10/site-packages/click/core.py\", line 1657, in invoke\n    return _process_result(sub_ctx.command.invoke(sub_ctx))\n  File \"/Users/jerome.lecoq/opt/miniconda3/envs/nwb/lib/python3.10/site-packages/click/core.py\", line 1404, in invoke\n    return ctx.invoke(self.callback, **ctx.params)\n  File \"/Users/jerome.lecoq/opt/miniconda3/envs/nwb/lib/python3.10/site-packages/click/core.py\", line 760, in invoke\n    return __callback(*args, **kwargs)\n  File \"/Users/jerome.lecoq/opt/miniconda3/envs/nwb/lib/python3.10/site-packages/click/decorators.py\", line 38, in new_func\n    return f(get_current_context().obj, *args, **kwargs)\n  File \"/Users/jerome.lecoq/opt/miniconda3/envs/nwb/lib/python3.10/site-packages/dandi/cli/base.py\", line 102, in wrapper\n    return f(*args, **kwargs)\n  File \"/Users/jerome.lecoq/opt/miniconda3/envs/nwb/lib/python3.10/site-packages/dandi/cli/cmd_organize.py\", line 109, in organize\n    organize(\n  File \"/Users/jerome.lecoq/opt/miniconda3/envs/nwb/lib/python3.10/site-packages/dandi/organize.py\", line 842, in organize\n    raise ValueError(msg)\nValueError: 1 out of 1 files were found not containing all necessary metadata: ../to_upload/Rorb-IRES2-Cre_590168381_590168385-2.nwb\n```\nI am a very unclear as to what is going on. Should we loop in Ryan here?","files":null},{"type":3,"author":{"id":"c1abeb1a926bde7ac233bf2db2c21afb27ff77d4"},"timestamp":1680889098,"metadata":{"github-id":"IC_kwDODBZtRc5Zb795","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1500495737"},"message":"Hi all, I am having the same type of error as jerome `Completely empty record for /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/1193675750raw_data.nwb` with different nwb files. These files are recgenerations of files that were already on dandi and have passed dandi validation in the past, with the only difference being that the subject_id in the subject field has changed. \nOne important element to note is that I upgraded from dandi version 0.48.1 to the latest version before attempting these uploads.\nI have attached a copy of the file here: https://drive.google.com/file/d/1WCzmOd-V3KtAiy1uN4LB-_ShT1yeoxcD/view?usp=sharing","files":null},{"type":6,"author":{"id":"c1abeb1a926bde7ac233bf2db2c21afb27ff77d4"},"timestamp":1680889136,"metadata":{"github-id":"UCE_lALODBZtRc5Zb795zi-syP0"},"target":"2c2900e4d5391b552e72c5321ea251ac1022b66c241ee2c85fb4a37d8b50d0a1","message":"Hi all, I am having the same type of error as jerome `Completely empty record for /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/1193675750raw_data.nwb\nCompletely empty record for /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336/sub-621602/sub-621602_ophys.nwb\nTraceback (most recent call last):\n  File \"dandi_uploads.py\", line 117, in \u003cmodule\u003e\n    automatic_dandi_upload(nwb_folder_path = r'/allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb', dandiset_id = '000336', session_id=r'1193555033', experiment_id = '1193675753', subject_id='621602')\n  File \"dandi_uploads.py\", line 89, in automatic_dandi_upload\n    dandi_organize(paths=str(directory_path), dandiset_path=str(dandi_path_set))\n  File \"/allen/programs/mindscope/workgroups/openscope/ahad/Conda_env/long_nwb/lib/python3.8/site-packages/dandi/organize.py\", line 842, in organize\n    raise ValueError(msg)\nValueError: 2 out of 2 files were found not containing all necessary metadata: /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/1193675750raw_data.nwb, /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336/sub-621602/sub-621602_ophys.nwb\n(/allen/programs/mindscope/workgroups/openscope/ahad/Conda_env/long_nwb) [ahad.bawany@ibs-ahadb-vm1 scripts]$ python dandi_uploads.py \nPATHS:  /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033 /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033 /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336\n[Parallel(n_jobs=-1)]: Using backend LokyBackend with 4 concurrent workers.\n[Parallel(n_jobs=-1)]: Done   2 out of   2 | elapsed:    7.7s remaining:    0.0s\n[Parallel(n_jobs=-1)]: Done   2 out of   2 | elapsed:    7.7s finished\nCompletely empty record for /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/1193675750raw_data.nwb\nCompletely empty record for /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336/sub-621602/sub-621602_ophys.nwb\nTraceback (most recent call last):\n  File \"dandi_uploads.py\", line 117, in \u003cmodule\u003e\n    automatic_dandi_upload(nwb_folder_path = r'/allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb', dandiset_id = '000336', session_id=r'1193555033', experiment_id = '1193675753', subject_id='621602')\n  File \"dandi_uploads.py\", line 89, in automatic_dandi_upload\n    dandi_organize(paths=str(directory_path), dandiset_path=str(dandi_path_set))\n  File \"/allen/programs/mindscope/workgroups/openscope/ahad/Conda_env/long_nwb/lib/python3.8/site-packages/dandi/organize.py\", line 842, in organize\n    raise ValueError(msg)\nValueError: 2 out of 2 files were found not containing all necessary metadata: /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/1193675750raw_data.nwb, /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336/sub-621602/sub-621602_ophys.nwb` with different nwb files. These files are recgenerations of files that were already on dandi and have passed dandi validation in the past, with the only difference being that the subject_id in the subject field has changed. \nOne important element to note is that I upgraded from dandi version 0.48.1 to the latest version before attempting these uploads.\nI have attached a copy of the file here: https://drive.google.com/file/d/1WCzmOd-V3KtAiy1uN4LB-_ShT1yeoxcD/view?usp=sharing","files":null},{"type":6,"author":{"id":"c1abeb1a926bde7ac233bf2db2c21afb27ff77d4"},"timestamp":1680889164,"metadata":{"github-id":"UCE_lALODBZtRc5Zb795zi-syeQ"},"target":"2c2900e4d5391b552e72c5321ea251ac1022b66c241ee2c85fb4a37d8b50d0a1","message":"Hi all, I am having the same type of error as jerome \n`Completely empty record for /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/1193675750raw_data.nwb\nCompletely empty record for /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336/sub-621602/sub-621602_ophys.nwb\nTraceback (most recent call last):\n  File \"dandi_uploads.py\", line 117, in \u003cmodule\u003e\n    automatic_dandi_upload(nwb_folder_path = r'/allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb', dandiset_id = '000336', session_id=r'1193555033', experiment_id = '1193675753', subject_id='621602')\n  File \"dandi_uploads.py\", line 89, in automatic_dandi_upload\n    dandi_organize(paths=str(directory_path), dandiset_path=str(dandi_path_set))\n  File \"/allen/programs/mindscope/workgroups/openscope/ahad/Conda_env/long_nwb/lib/python3.8/site-packages/dandi/organize.py\", line 842, in organize\n    raise ValueError(msg)\nValueError: 2 out of 2 files were found not containing all necessary metadata: /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/1193675750raw_data.nwb, /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336/sub-621602/sub-621602_ophys.nwb\n(/allen/programs/mindscope/workgroups/openscope/ahad/Conda_env/long_nwb) [ahad.bawany@ibs-ahadb-vm1 scripts]$ python dandi_uploads.py \nPATHS:  /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033 /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033 /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336\n[Parallel(n_jobs=-1)]: Using backend LokyBackend with 4 concurrent workers.\n[Parallel(n_jobs=-1)]: Done   2 out of   2 | elapsed:    7.7s remaining:    0.0s\n[Parallel(n_jobs=-1)]: Done   2 out of   2 | elapsed:    7.7s finished\nCompletely empty record for /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/1193675750raw_data.nwb\nCompletely empty record for /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336/sub-621602/sub-621602_ophys.nwb\nTraceback (most recent call last):\n  File \"dandi_uploads.py\", line 117, in \u003cmodule\u003e\n    automatic_dandi_upload(nwb_folder_path = r'/allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb', dandiset_id = '000336', session_id=r'1193555033', experiment_id = '1193675753', subject_id='621602')\n  File \"dandi_uploads.py\", line 89, in automatic_dandi_upload\n    dandi_organize(paths=str(directory_path), dandiset_path=str(dandi_path_set))\n  File \"/allen/programs/mindscope/workgroups/openscope/ahad/Conda_env/long_nwb/lib/python3.8/site-packages/dandi/organize.py\", line 842, in organize\n    raise ValueError(msg)\nValueError: 2 out of 2 files were found not containing all necessary metadata: /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/1193675750raw_data.nwb, /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336/sub-621602/sub-621602_ophys.nwb` \nwith different nwb files. These files are recgenerations of files that were already on dandi and have passed dandi validation in the past, with the only difference being that the subject_id in the subject field has changed. \nOne important element to note is that I upgraded from dandi version 0.48.1 to the latest version before attempting these uploads.\nI have attached a copy of the file here: https://drive.google.com/file/d/1WCzmOd-V3KtAiy1uN4LB-_ShT1yeoxcD/view?usp=sharing","files":null},{"type":6,"author":{"id":"c1abeb1a926bde7ac233bf2db2c21afb27ff77d4"},"timestamp":1680889205,"metadata":{"github-id":"UCE_lALODBZtRc5Zb795zi-syyM"},"target":"2c2900e4d5391b552e72c5321ea251ac1022b66c241ee2c85fb4a37d8b50d0a1","message":"Hi all, I am having the same type of error as jerome \n```Completely empty record for /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/1193675750raw_data.nwb\nCompletely empty record for /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336/sub-621602/sub-621602_ophys.nwb\nTraceback (most recent call last):\n  File \"dandi_uploads.py\", line 117, in \u003cmodule\u003e\n    automatic_dandi_upload(nwb_folder_path = r'/allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb', dandiset_id = '000336', session_id=r'1193555033', experiment_id = '1193675753', subject_id='621602')\n  File \"dandi_uploads.py\", line 89, in automatic_dandi_upload\n    dandi_organize(paths=str(directory_path), dandiset_path=str(dandi_path_set))\n  File \"/allen/programs/mindscope/workgroups/openscope/ahad/Conda_env/long_nwb/lib/python3.8/site-packages/dandi/organize.py\", line 842, in organize\n    raise ValueError(msg)\nValueError: 2 out of 2 files were found not containing all necessary metadata: /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/1193675750raw_data.nwb, /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336/sub-621602/sub-621602_ophys.nwb\n(/allen/programs/mindscope/workgroups/openscope/ahad/Conda_env/long_nwb) [ahad.bawany@ibs-ahadb-vm1 scripts]$ python dandi_uploads.py \nPATHS:  /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033 /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033 /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336\n[Parallel(n_jobs=-1)]: Using backend LokyBackend with 4 concurrent workers.\n[Parallel(n_jobs=-1)]: Done   2 out of   2 | elapsed:    7.7s remaining:    0.0s\n[Parallel(n_jobs=-1)]: Done   2 out of   2 | elapsed:    7.7s finished\nCompletely empty record for /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/1193675750raw_data.nwb\nCompletely empty record for /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336/sub-621602/sub-621602_ophys.nwb\nTraceback (most recent call last):\n  File \"dandi_uploads.py\", line 117, in \u003cmodule\u003e\n    automatic_dandi_upload(nwb_folder_path = r'/allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb', dandiset_id = '000336', session_id=r'1193555033', experiment_id = '1193675753', subject_id='621602')\n  File \"dandi_uploads.py\", line 89, in automatic_dandi_upload\n    dandi_organize(paths=str(directory_path), dandiset_path=str(dandi_path_set))\n  File \"/allen/programs/mindscope/workgroups/openscope/ahad/Conda_env/long_nwb/lib/python3.8/site-packages/dandi/organize.py\", line 842, in organize\n    raise ValueError(msg)\nValueError: 2 out of 2 files were found not containing all necessary metadata: /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/1193675750raw_data.nwb, /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336/sub-621602/sub-621602_ophys.nwb```\nwith different nwb files. These files are recgenerations of files that were already on dandi and have passed dandi validation in the past, with the only difference being that the subject_id in the subject field has changed. \nOne important element to note is that I upgraded from dandi version 0.48.1 to the latest version before attempting these uploads.\nI have attached a copy of the file here: https://drive.google.com/file/d/1WCzmOd-V3KtAiy1uN4LB-_ShT1yeoxcD/view?usp=sharing","files":null},{"type":6,"author":{"id":"c1abeb1a926bde7ac233bf2db2c21afb27ff77d4"},"timestamp":1680889294,"metadata":{"github-id":"UCE_lALODBZtRc5Zb795zi-szh0"},"target":"2c2900e4d5391b552e72c5321ea251ac1022b66c241ee2c85fb4a37d8b50d0a1","message":"Hi all, I am having the same type of error as jerome \n```Completely empty record for /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/1193675750raw_data.nwb\nCompletely empty record for /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336/sub-621602/sub-621602_ophys.nwb\nTraceback (most recent call last):\n  File \"dandi_uploads.py\", line 117, in \u003cmodule\u003e\n    automatic_dandi_upload(nwb_folder_path = r'/allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb', dandiset_id = '000336', session_id=r'1193555033', experiment_id = '1193675753', subject_id='621602')\n  File \"dandi_uploads.py\", line 89, in automatic_dandi_upload\n    dandi_organize(paths=str(directory_path), dandiset_path=str(dandi_path_set))\n  File \"/allen/programs/mindscope/workgroups/openscope/ahad/Conda_env/long_nwb/lib/python3.8/site-packages/dandi/organize.py\", line 842, in organize\n    raise ValueError(msg)\nValueError: 2 out of 2 files were found not containing all necessary metadata: /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/1193675750raw_data.nwb, /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336/sub-621602/sub-621602_ophys.nwb\n(/allen/programs/mindscope/workgroups/openscope/ahad/Conda_env/long_nwb) [ahad.bawany@ibs-ahadb-vm1 scripts]$ python dandi_uploads.py \nPATHS:  /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033 /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033 /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336\n[Parallel(n_jobs=-1)]: Using backend LokyBackend with 4 concurrent workers.\n[Parallel(n_jobs=-1)]: Done   2 out of   2 | elapsed:    7.7s remaining:    0.0s\n[Parallel(n_jobs=-1)]: Done   2 out of   2 | elapsed:    7.7s finished\nCompletely empty record for /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/1193675750raw_data.nwb\nCompletely empty record for /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336/sub-621602/sub-621602_ophys.nwb\nTraceback (most recent call last):\n  File \"dandi_uploads.py\", line 117, in \u003cmodule\u003e\n    automatic_dandi_upload(nwb_folder_path = r'/allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb', dandiset_id = '000336', session_id=r'1193555033', experiment_id = '1193675753', subject_id='621602')\n  File \"dandi_uploads.py\", line 89, in automatic_dandi_upload\n    dandi_organize(paths=str(directory_path), dandiset_path=str(dandi_path_set))\n  File \"/allen/programs/mindscope/workgroups/openscope/ahad/Conda_env/long_nwb/lib/python3.8/site-packages/dandi/organize.py\", line 842, in organize\n    raise ValueError(msg)\nValueError: 2 out of 2 files were found not containing all necessary metadata: /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/1193675750raw_data.nwb, /allen/programs/mindscope/workgroups/openscope/ahad/ophys_no_behavior_nwb/1193555033/000336/sub-621602/sub-621602_ophys.nwb\n ```\nwith different nwb files. These files are recgenerations of files that were already on dandi and have passed dandi validation in the past, with the only difference being that the subject_id in the subject field has changed. \nOne important element to note is that I upgraded from dandi version 0.48.1 to the latest version before attempting these uploads.\nI have attached a copy of the file here: https://drive.google.com/file/d/1WCzmOd-V3KtAiy1uN4LB-_ShT1yeoxcD/view?usp=sharing","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1680896554,"metadata":{"github-id":"IC_kwDODBZtRc5ZcR_3","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1500585975"},"message":"@Ahad-Allen following above discussion -- do you know if files include external links?  you can possibly get to the original exception and warnings (which might warn about external links) via running it as `DANDI_CACHE=ignore DANDI_DEVEL=1 dandi -l 1 organize --devel-debug  ...`.","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1680897319,"metadata":{"github-id":"UCE_lALODBZtRc5ZcR_3zi-uAYU"},"target":"12759e0a575e855714da378d2196c20253e2715803d340b228214f962b525883","message":"@Ahad-Allen following above discussion -- do you know if files include external links? \n\nedit: ignore -- as I showed below, it does not\n\n you can possibly get to the original exception and warnings (which might warn about external links) via running it as `DANDI_CACHE=ignore DANDI_DEVEL=1 dandi -l 1 organize --devel-debug  ...`.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1680897287,"metadata":{"github-id":"IC_kwDODBZtRc5ZcT-V","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1500594069"},"message":"\u003e some relevant bits:\n\u003e \n\u003e ```\n\u003e dandi                     0.52.0                   pypi_0    pypi\n\u003e h5py                      3.8.0                    pypi_0    pypi\n\u003e hdmf                      3.5.2                    pypi_0    pypi\n\u003e pynwb                     2.3.1                    pypi_0    pypi\n\u003e ```\n\n\n\u003cdetails\u003e\n\u003csummary\u003eusing this script -- those modules versions seems to be the same\u003c/summary\u003e \n\n```python\nfrom pynwb import NWBHDF5IO\nfrom dandi.consts import metadata_nwb_file_fields\nfrom dandi.pynwb_utils import open_readable\nfrom dandi.pynwb_utils import nwb_has_external_links\n\nimport sys\n\n\ndef load(io):\n    nwb = io.read()\n    for key in metadata_nwb_file_fields:\n        value = getattr(nwb, key)\n\nimport pkg_resources\nimport dandi, h5py, hdmf, pynwb\nfor m in dandi, h5py, hdmf, pynwb:\n    print(pkg_resources.get_distribution(m.__name__))\n\n\nfor fname in sys.argv[1:]:\n    print(f\"{fname} has links: {nwb_has_external_links(fname)}\")\n    with NWBHDF5IO(fname, load_namespaces=True) as io:\n          load(io)\n    print(\"way 1 worked\")\n\n    with open(fname, 'rb') as fp, h5py.File(fp) as h5, NWBHDF5IO(file=h5, load_namespaces=True) as io:\n          load(io)\n    print(\"way 2 worked\")\n\n    with open_readable(fname) as fp, h5py.File(fp) as h5, NWBHDF5IO(file=h5, load_namespaces=True) as io:\n          load(io)\n    print(\"way 3 worked\")\n\n    from dandi.metadata import _get_pynwb_metadata\n    print(_get_pynwb_metadata(fname))\n```\n\u003c/details\u003e\n\n```\n$\u003e DANDI_CACHE=ignore python test_on_nwb.py Rorb-IRES2-Cre_590168381_590168385.nwb\ndandi 0.52.0\nh5py 3.8.0\nhdmf 3.5.2\npynwb 2.3.1\nRorb-IRES2-Cre_590168381_590168385.nwb has links: True\nway 1 worked\nway 2 worked\nway 3 worked\n{'experiment_description': None, 'experimenter': None, 'identifier': '64ae8bcc-92ea-4b0c-a207-130dd959045b_test_IDs', 'institution': 'Allen Institute for Brain Science', 'keywords': None, 'lab': None, 'related_publications': None, 'session_description': 'no description', 'session_id': '590168385', 'session_start_time': datetime.datetime(2020, 1, 1, 12, 30, tzinfo=tzoffset(None, -28800)), 'age': 'P113D', 'date_of_birth': None, 'genotype': 'Rorb-IRES2-Cre/wt;Camk2a-tTA/wt;Ai93(TITL-GCaMP6f)/wt', 'sex': 'M', 'species': 'Mus musculus', 'subject_id': '575296278', 'number_of_electrodes': 0, 'number_of_units': 0, 'external_file_objects': []}\n```\n\nand on file from @Ahad-Allen \n\n```\n$\u003e DANDI_CACHE=ignore python test_on_nwb.py 1193675750raw_data.nwb                \ndandi 0.52.0\nh5py 3.8.0\nhdmf 3.5.2\npynwb 2.3.1\n1193675750raw_data.nwb has links: False\n/home/yoh/proj/dandi/dandi-cli/venvs/dev3/lib/python3.9/site-packages/hdmf/spec/namespace.py:531: UserWarning: Ignoring cached namespace 'hdmf-common' version 1.5.0 because version 1.5.1 is already loaded.\n  warn(\"Ignoring cached namespace '%s' version %s because version %s is already loaded.\"\n/home/yoh/proj/dandi/dandi-cli/venvs/dev3/lib/python3.9/site-packages/hdmf/spec/namespace.py:531: UserWarning: Ignoring cached namespace 'core' version 2.3.0 because version 2.6.0-alpha is already loaded.\n  warn(\"Ignoring cached namespace '%s' version %s because version %s is already loaded.\"\n/home/yoh/proj/dandi/dandi-cli/venvs/dev3/lib/python3.9/site-packages/hdmf/spec/namespace.py:531: UserWarning: Ignoring cached namespace 'hdmf-experimental' version 0.1.0 because version 0.2.0 is already loaded.\n  warn(\"Ignoring cached namespace '%s' version %s because version %s is already loaded.\"\nway 1 worked\nway 2 worked\nway 3 worked\n{'experiment_description': 'ophys session', 'experimenter': None, 'identifier': '1193675750', 'institution': 'Allen Institute for Brain Science', 'keywords': ['2-photon', 'calcium imaging', 'visual cortex', 'behavior', 'task'], 'lab': None, 'related_publications': None, 'session_description': 'Ophys Session', 'session_id': None, 'session_start_time': datetime.datetime(2022, 7, 22, 12, 7, 33, 412000, tzinfo=tzutc()), 'age': 'P161.0D', 'date_of_birth': None, 'genotype': 'Rbp4-Cre_KL100/wt;Camk2a-tTA/wt;Ai93(TITL-GCaMP6f)/wt', 'sex': 'F', 'species': 'Mus musculus', 'subject_id': '621602', 'number_of_electrodes': 0, 'number_of_units': 0, 'external_file_objects': []}\nDANDI_CACHE=ignore python test_on_nwb.py 1193675750raw_data.nwb  37.75s user 0.88s system 103% cpu 37.303 total\n```\n\nso also works -- I guess difference in some other version detail.","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1680897496,"metadata":{"github-id":"UCE_lALODBZtRc5ZcT-Vzi-uCBM"},"target":"36c89de3c6c0e672f9eb0f3dbf066d28d4f000e3eaf3c39785a15ee4da6f4a54","message":"\u003e some relevant bits:\n\u003e \n\u003e ```\n\u003e dandi                     0.52.0                   pypi_0    pypi\n\u003e h5py                      3.8.0                    pypi_0    pypi\n\u003e hdmf                      3.5.2                    pypi_0    pypi\n\u003e pynwb                     2.3.1                    pypi_0    pypi\n\u003e ```\n\n\n\u003cdetails\u003e\n\u003csummary\u003eusing this script -- those modules versions seems to be the same\u003c/summary\u003e \n\n```python\nfrom pynwb import NWBHDF5IO\nfrom dandi.consts import metadata_nwb_file_fields\nfrom dandi.pynwb_utils import open_readable\nfrom dandi.pynwb_utils import nwb_has_external_links\n\nimport sys\n\n\ndef load(io):\n    nwb = io.read()\n    for key in metadata_nwb_file_fields:\n        value = getattr(nwb, key)\n\nimport pkg_resources\nimport dandi, h5py, hdmf, pynwb\nfor m in dandi, h5py, hdmf, pynwb:\n    print(pkg_resources.get_distribution(m.__name__))\n\n\nfor fname in sys.argv[1:]:\n    print(f\"{fname} has links: {nwb_has_external_links(fname)}\")\n    with NWBHDF5IO(fname, load_namespaces=True) as io:\n          load(io)\n    print(\"way 1 worked\")\n\n    with open(fname, 'rb') as fp, h5py.File(fp) as h5, NWBHDF5IO(file=h5, load_namespaces=True) as io:\n          load(io)\n    print(\"way 2 worked\")\n\n    with open_readable(fname) as fp, h5py.File(fp) as h5, NWBHDF5IO(file=h5, load_namespaces=True) as io:\n          load(io)\n    print(\"way 3 worked\")\n\n    from dandi.metadata import _get_pynwb_metadata\n    print(_get_pynwb_metadata(fname))\n```\n\u003c/details\u003e\n\n```\n$\u003e DANDI_CACHE=ignore python test_on_nwb.py Rorb-IRES2-Cre_590168381_590168385.nwb\ndandi 0.52.0\nh5py 3.8.0\nhdmf 3.5.2\npynwb 2.3.1\nRorb-IRES2-Cre_590168381_590168385.nwb has links: True\nway 1 worked\nway 2 worked\nway 3 worked\n{'experiment_description': None, 'experimenter': None, 'identifier': '64ae8bcc-92ea-4b0c-a207-130dd959045b_test_IDs', 'institution': 'Allen Institute for Brain Science', 'keywords': None, 'lab': None, 'related_publications': None, 'session_description': 'no description', 'session_id': '590168385', 'session_start_time': datetime.datetime(2020, 1, 1, 12, 30, tzinfo=tzoffset(None, -28800)), 'age': 'P113D', 'date_of_birth': None, 'genotype': 'Rorb-IRES2-Cre/wt;Camk2a-tTA/wt;Ai93(TITL-GCaMP6f)/wt', 'sex': 'M', 'species': 'Mus musculus', 'subject_id': '575296278', 'number_of_electrodes': 0, 'number_of_units': 0, 'external_file_objects': []}\n```\n\nand on file from @Ahad-Allen \n\n```\n$\u003e DANDI_CACHE=ignore python test_on_nwb.py 1193675750raw_data.nwb                \ndandi 0.52.0\nh5py 3.8.0\nhdmf 3.5.2\npynwb 2.3.1\n1193675750raw_data.nwb has links: False\n/home/yoh/proj/dandi/dandi-cli/venvs/dev3/lib/python3.9/site-packages/hdmf/spec/namespace.py:531: UserWarning: Ignoring cached namespace 'hdmf-common' version 1.5.0 because version 1.5.1 is already loaded.\n  warn(\"Ignoring cached namespace '%s' version %s because version %s is already loaded.\"\n/home/yoh/proj/dandi/dandi-cli/venvs/dev3/lib/python3.9/site-packages/hdmf/spec/namespace.py:531: UserWarning: Ignoring cached namespace 'core' version 2.3.0 because version 2.6.0-alpha is already loaded.\n  warn(\"Ignoring cached namespace '%s' version %s because version %s is already loaded.\"\n/home/yoh/proj/dandi/dandi-cli/venvs/dev3/lib/python3.9/site-packages/hdmf/spec/namespace.py:531: UserWarning: Ignoring cached namespace 'hdmf-experimental' version 0.1.0 because version 0.2.0 is already loaded.\n  warn(\"Ignoring cached namespace '%s' version %s because version %s is already loaded.\"\nway 1 worked\nway 2 worked\nway 3 worked\n{'experiment_description': 'ophys session', 'experimenter': None, 'identifier': '1193675750', 'institution': 'Allen Institute for Brain Science', 'keywords': ['2-photon', 'calcium imaging', 'visual cortex', 'behavior', 'task'], 'lab': None, 'related_publications': None, 'session_description': 'Ophys Session', 'session_id': None, 'session_start_time': datetime.datetime(2022, 7, 22, 12, 7, 33, 412000, tzinfo=tzutc()), 'age': 'P161.0D', 'date_of_birth': None, 'genotype': 'Rbp4-Cre_KL100/wt;Camk2a-tTA/wt;Ai93(TITL-GCaMP6f)/wt', 'sex': 'F', 'species': 'Mus musculus', 'subject_id': '621602', 'number_of_electrodes': 0, 'number_of_units': 0, 'external_file_objects': []}\nDANDI_CACHE=ignore python test_on_nwb.py 1193675750raw_data.nwb  37.75s user 0.88s system 103% cpu 37.303 total\n```\n\nso also works -- I guess difference in some other version detail.\n\nedit: on that box I use simple virtualenv with system wide python 3.9","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1680897853,"metadata":{"github-id":"IC_kwDODBZtRc5ZcVtz","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1500601203"},"message":"\u003cdetails\u003e\n\u003csummary\u003eand running organize on the file from @Ahad-Allen worked for me\u003c/summary\u003e \n\n```shell\nsmaug:~/proj/dandi/nwb-files/000027\n$\u003e DANDI_CACHE=ignore DANDI_DEVEL=1 dandi -l 1 organize --devel-debug ../1193675750raw_data.nwb \n...\n2023-04-07 15:55:45,114 [    INFO] Symlink support autodetected; setting files_mode='symlink'\n2023-04-07 15:55:45,118 [   DEBUG] Assigned 1 session_id's based on the date\n2023-04-07 15:55:45,119 [    INFO] Organized 1 paths. Visit /home/yoh/proj/dandi/nwb-files/000027/\n2023-04-07 15:55:45,119 [    INFO] Logs saved in /home/yoh/.cache/dandi-cli/log/20230407195534Z-3648741.log\nDANDI_CACHE=ignore DANDI_DEVEL=1 dandi -l 1 organize --devel-debug   11.94s user 0.83s system 108% cpu 11.736 total\n(dev3) 1 10233.....................................:Fri 07 Apr 2023 03:55:45 PM EDT:.\nsmaug:~/proj/dandi/nwb-files/000027\n$\u003e ls -l /home/yoh/proj/dandi/nwb-files/000027/sub-621602/sub-621602_ophys.nwb \nlrwxrwxrwx 1 yoh yoh 53 Apr  7 15:55 /home/yoh/proj/dandi/nwb-files/000027/sub-621602/sub-621602_ophys.nwb -\u003e /home/yoh/proj/dandi/nwb-files/1193675750raw_data.nwb\n\n```\n\u003c/details\u003e","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1680900480,"metadata":{"github-id":"IC_kwDODBZtRc5Zcc_E","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1500630980"},"message":"It looks like these files were created with non-standard means. Without more detailed reported from dandi-cli, it's going to be difficult to know how to resolve.","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1680908895,"metadata":{"github-id":"IC_kwDODBZtRc5ZcxIk","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1500713508"},"message":"Hi @bendichter, well, I am not entirely sure to what extent this is out of a normal workflow. \n\n1/ I used suite2p to segment a movie.\n2/ I used NeuroConv to make the first NWB from suite2p output. \n3/ I loaded NWB 1.0 files from the Allen\n4/ I added objects to the NeuroConv NWB 2.0 output, by copying values from the NWB 1.0 file.","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1681024298,"metadata":{"github-id":"IC_kwDODBZtRc5ZeFtj","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1501059939"},"message":"I was able to nailed down the issue further. The problem is the IndexSeries object when it receives a index_timeseries as parameter to register the associated template. This end-up creating an NWB file with external file link. \nPerhaps the problem is in pynwb upon creating. If I convert to a TimeSeries, removing the link to the template. It all works.","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1681024426,"metadata":{"github-id":"IC_kwDODBZtRc5ZeFx6","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1501060218"},"message":"I believe this code here : https://pynwb.readthedocs.io/en/stable/tutorials/domain/brain_observatory.html\n\nWould not work as a result. \nIn particular this part : \n```\nfor stimulus in stimulus_list:\n    visual_stimulus_images = ImageSeries(\n        name=stimulus,\n        data=dataset.get_stimulus_template(stimulus),\n        unit='NA',\n        format='raw',\n        timestamps=[0.0])\n    image_index = IndexSeries(\n        name=stimulus,\n        data=dataset.get_stimulus_table(stimulus).frame.values,\n        unit='NA',\n        indexed_timeseries=visual_stimulus_images,\n        timestamps=timestamps[dataset.get_stimulus_table(stimulus).start.values])\n    nwbfile.add_stimulus_template(visual_stimulus_images)\n    nwbfile.add_stimulus(image_index)\n```\n\nThe problem is that indexed_timeseries link which causes dandi to have issues.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1681075982,"metadata":{"github-id":"IC_kwDODBZtRc5ZesY1","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1501218357"},"message":"i'm going to bring @rly into this conversation. the summary of this issue is that certain operations lead to external links being created, which are not external links (as in don't point to files outside we think) and that's triggering dandi cli to complain. \n\n@jeromelecoq - just a random thought, is it possible that some part of the step is still pointing to data/data array in the nwb 1 file?  i.e. still maintains a reference hence treated as an external link?","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1681078811,"metadata":{"github-id":"IC_kwDODBZtRc5ZeuIM","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1501225484"},"message":"Yes\nI think a link is created causing the issue.\nI played around with the dataset properties and it seems like the link is\nto current file itself like self referenced link\nI can explore more tonight\n\nOn Sun, Apr 9, 2023 at 2:33 PM Satrajit Ghosh ***@***.***\u003e\nwrote:\n\n\u003e i'm going to bring @rly \u003chttps://github.com/rly\u003e into this conversation.\n\u003e the summary of this issue is that certain operations lead to external links\n\u003e being created, which are not external links (as in don't point to files\n\u003e outside we think) and that's triggering dandi cli to complain.\n\u003e\n\u003e @jeromelecoq \u003chttps://github.com/jeromelecoq\u003e - just a random thought, is\n\u003e it possible that some part of the step is still pointing to data/data array\n\u003e in the nwb 1 file? i.e. still maintains a reference hence treated as an\n\u003e external link?\n\u003e\n\u003e \n\u003e Reply to this email directly, view it on GitHub\n\u003e \u003chttps://github.com/dandi/dandi-cli/issues/1270#issuecomment-1501218357\u003e,\n\u003e or unsubscribe\n\u003e \u003chttps://github.com/notifications/unsubscribe-auth/AATAHTYGZW7OVGJLGNH4JGLXAMTJTANCNFSM6AAAAAAWUR6H2A\u003e\n\u003e .\n\u003e You are receiving this because you were mentioned.Message ID:\n\u003e ***@***.***\u003e\n\u003e\n-- \n*Jrme*","files":null},{"type":3,"author":{"id":"3217666bda2431aa8fe32869bbe258730f97360c"},"timestamp":1681148635,"metadata":{"github-id":"IC_kwDODBZtRc5ZiEzY","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1502104792"},"message":"Using TimeSeries allowed me to move forward and upload a draft of Visual Coding NWB 2.0 to Dandi. This supports the issue is related to links. I am still working on it little things here and there but I will go back to this later on. Obviously my files do not have the template images, just the underlying stimulus structure.","files":null},{"type":3,"author":{"id":"24891a1a9a6057dee135acf783d3b5f6d886008e"},"timestamp":1681261464,"metadata":{"github-id":"IC_kwDODBZtRc5ZqsfH","github-url":"https://github.com/dandi/dandi-cli/issues/1270#issuecomment-1504364487"},"message":"@jeromelecoq please try installing this branch of HDMF referenced in https://github.com/hdmf-dev/hdmf/pull/847:\n```\npip uninstall hdmf --yes\npip install git+https://github.com/hdmf-dev/hdmf.git@fix/export_links\n```\nAnd let me know if that resolves the error.","files":null}]}