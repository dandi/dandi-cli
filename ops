{"version":2,"ops":[{"type":1,"author":{"id":"21bbe6f5e3272d3fe8aa9b85bbd29a984d2b0505"},"timestamp":1630546643,"metadata":{"github-id":"MDU6SXNzdWU5ODY3MDE3MTA=","github-url":"https://github.com/dandi/dandi-cli/issues/764","origin":"github"},"title":"\"File etag changed\" error when reuploading existing nwb files","message":"### Bug description\nNot sure if this is a bug or if I'm doing something wrong?\n\nI've made some changes to a nwb files for a dandiset I created last year (https://gui.dandiarchive.org/#/dandiset/000039). I'm trying to reupload the updated nwb files using the dandi cli, but when I try `dandi upload` command 10 of the 100 nwb files produce an ERROR message with  \" File etag changed\". The other 90 nwb files indicate the uploading was completed but I don't see anything changes on the repo.\n\n### How to reproduce\nI first use pynwb to generate 100 nwb session files for ophys data we have, and save them in dir __output_contrast_090121/__. The nwb generation is not producing any issues and I'm able to open/read the files as expected. Then to reupload them I do the following:\n\n```\n$ dandi validate output_contrast_090121/  # Summary: No validation errors among 100 file(s)\n$ dandi download https://dandiarchive.org/dandiset/000039/draft\n$ cd 000039/\n$ find . -type l -exec unlink {} \\; # if I don't do this the next step give a 100 paths already exists warning\n$ dandi organize ../output_contrast_090121/ -f dry\n$ dandi organize ../output_contrast_090121/  # Organized 100 paths.\n$ dandi upload\n```\nThe upload runs for ~20 minutes and most of the nwb files have a \"100% done\" with \"exists (older) - reuploading\" message. But 10 produce an \"ERROR\" status (can't read the message in the cli). However none of the files are being re-uploaded.\n\n\n### Your personal set up\nI'm using a new anaconda environment, pynwb and dandi were last installed using pip on sept 01, 2021.\n\n - OS: Ubuntu 18.04\n \u003c!-- [e.g. ubuntu 20.04, macOS 11.0] --\u003e\n - Version(s): dandi 0.27.0, Python 3.7.11\n \u003c!-- e.g. dandi --version, python --version ---\u003e\n\n- \u003cdetails\u003e\u003csummary\u003eFull environment\u003c/summary\u003e\n\u003c!-- For reproduction, it's useful to have the full environment. For example, the output of `pip freeze` or `conda list` ---\u003e\n\n```\n_libgcc_mutex             0.1                        main  \nappdirs                   1.4.4                     \u003cpip\u003e\nattrs                     21.2.0                    \u003cpip\u003e\nblas                      1.0                         mkl  \nblessings                 1.7                       \u003cpip\u003e\nca-certificates           2021.7.5             h06a4308_1  \ncached-property           1.5.2                     \u003cpip\u003e\ncertifi                   2021.5.30        py37h06a4308_0  \ncffi                      1.14.6                    \u003cpip\u003e\ncharset-normalizer        2.0.4                     \u003cpip\u003e\nci-info                   0.2.0                     \u003cpip\u003e\nclick                     8.0.1                     \u003cpip\u003e\nclick-didyoumean          0.0.3                     \u003cpip\u003e\ncryptography              3.4.8                     \u003cpip\u003e\ncycler                    0.10.0                   py37_0  \ndandi                     0.27.0                    \u003cpip\u003e\ndandischema               0.3.2                     \u003cpip\u003e\ndbus                      1.13.18              hb2f20db_0  \ndnspython                 2.1.0                     \u003cpip\u003e\nemail-validator           1.1.3                     \u003cpip\u003e\netelemetry                0.2.2                     \u003cpip\u003e\nexpat                     2.4.1                h2531618_2  \nfasteners                 0.16.3                    \u003cpip\u003e\nfontconfig                2.13.1               h6c09931_0  \nfreetype                  2.10.4               h5ab3b9f_0  \nfscacher                  0.1.4                     \u003cpip\u003e\ngiflib                    5.2.1                h7b6447c_0  \nglib                      2.69.1               h5202010_0  \ngst-plugins-base          1.14.0               h8213a91_2  \ngstreamer                 1.14.0               h28cd5cc_2  \nh5py                      3.4.0                     \u003cpip\u003e\nhdmf                      3.1.1                     \u003cpip\u003e\nhumanize                  3.11.0                    \u003cpip\u003e\nicu                       58.2                 he6710b0_3  \nidna                      3.2                       \u003cpip\u003e\nimportlib-metadata        4.8.1                     \u003cpip\u003e\nintel-openmp              2021.3.0          h06a4308_3350  \njeepney                   0.7.1                     \u003cpip\u003e\njoblib                    1.0.1                     \u003cpip\u003e\njpeg                      9b                   h024ee3a_2  \njsonschema                3.2.0                     \u003cpip\u003e\nkeyring                   23.1.0                    \u003cpip\u003e\nkeyrings.alt              4.1.0                     \u003cpip\u003e\nkiwisolver                1.3.1            py37h2531618_0  \nkrb5                      1.19.2               hac12032_0  \nlcms2                     2.12                 h3be6417_0  \nld_impl_linux-64          2.35.1               h7274673_9  \nlibedit                   3.1.20210714         h7f8727e_0  \nlibffi                    3.3                  he6710b0_2  \nlibgcc-ng                 9.1.0                hdf63c60_0  \nlibpng                    1.6.37               hbc83047_0  \nlibpq                     12.2                 h553bfba_1  \nlibstdcxx-ng              9.1.0                hdf63c60_0  \nlibtiff                   4.2.0                h85742a9_0  \nlibuuid                   1.0.3                h1bed415_2  \nlibwebp                   1.2.0                h89dd481_0  \nlibwebp-base              1.2.0                h27cfd23_0  \nlibxcb                    1.14                 h7b6447c_0  \nlibxml2                   2.9.10               hb55368b_3  \nlz4-c                     1.9.3                h295c915_1  \nmatplotlib                3.3.4            py37h06a4308_0  \nmatplotlib-base           3.3.4            py37h62a2d02_0  \nmkl                       2021.3.0           h06a4308_520  \nmkl-service               2.4.0            py37h7f8727e_0  \nmkl_fft                   1.3.0            py37h42c9631_2  \nmkl_random                1.2.2            py37h51133e4_0  \nncurses                   6.2                  he6710b0_1  \nnumexpr                   2.7.3                     \u003cpip\u003e\nnumpy                     1.21.2                    \u003cpip\u003e\nnumpy                     1.20.3           py37hf144106_0  \nnumpy-base                1.20.3           py37h74d4b33_0  \nolefile                   0.46                       py_0  \nopenssl                   1.1.1k               h27cfd23_0  \npackaging                 21.0                      \u003cpip\u003e\npandas                    1.3.2                     \u003cpip\u003e\npcre                      8.45                 h295c915_0  \npillow                    8.3.1            py37h5aabda8_0  \npip                       21.2.2           py37h06a4308_0  \npsycopg2                  2.8.6            py37h3c74f83_1  \npycparser                 2.20                      \u003cpip\u003e\npycryptodomex             3.10.1                    \u003cpip\u003e\npydantic                  1.8.2                     \u003cpip\u003e\npynwb                     2.0.0                     \u003cpip\u003e\npyout                     0.7.1                     \u003cpip\u003e\npyparsing                 2.4.7              pyhd3eb1b0_0  \npyqt                      5.9.2            py37h05f1152_2  \npyrsistent                0.18.0                    \u003cpip\u003e\npython                    3.7.11               h12debd9_0  \npython-dateutil           2.8.2              pyhd3eb1b0_0  \npytz                      2021.1                    \u003cpip\u003e\nqt                        5.9.7                h5867ecd_1  \nreadline                  8.1                  h27cfd23_0  \nrequests                  2.26.0                    \u003cpip\u003e\nruamel.yaml               0.17.16                   \u003cpip\u003e\nruamel.yaml.clib          0.2.6                     \u003cpip\u003e\nscipy                     1.7.1                     \u003cpip\u003e\nSecretStorage             3.3.1                     \u003cpip\u003e\nsemantic-version          2.8.5                     \u003cpip\u003e\nsetuptools                52.0.0           py37h06a4308_0  \nsip                       4.19.8           py37hf484d3e_0  \nsix                       1.16.0             pyhd3eb1b0_0  \nsqlite                    3.36.0               hc218d9a_0  \ntables                    3.6.1                     \u003cpip\u003e\ntenacity                  8.0.1                     \u003cpip\u003e\ntk                        8.6.10               hbc83047_0  \ntornado                   6.1              py37h27cfd23_0  \ntqdm                      4.62.2                    \u003cpip\u003e\ntyping-extensions         3.10.0.2                  \u003cpip\u003e\nurllib3                   1.26.6                    \u003cpip\u003e\nwheel                     0.37.0             pyhd3eb1b0_0  \nxz                        5.2.5                h7b6447c_0  \nzipp                      3.5.0                     \u003cpip\u003e\nzlib                      1.2.11               h7b6447c_3  \nzstd                      1.4.9                haebb681_0  \n```\n\u003c/details\u003e\n\n- \u003cdetails\u003e\u003csummary\u003eLogs\u003c/summary\u003e\nI get the ERROR multiple times in the log, here is one example.\n\n```\n2021-09-01T17:24:03-0700 [INFO    ] dandi 3287:140014276904704 sub-754469470/sub-754469470_ses-769811903_behavior+ophys.nwb: Asset successfully uploaded\n2021-09-01T17:24:17-0700 [INFO    ] dandi 3287:140014012835584 sub-666839638/sub-666839638_ses-695464266_behavior+ophys.nwb: Asset successfully uploaded\n2021-09-01T17:24:18-0700 [WARNING ] dandi 3287:140013450815232 Failed to extract NWB metadata from /allen/programs/braintv/workgroups/neuralcoding/kaeld/targetedconstrast_nwb/000039/sub-710318403/sub-710318403_ses-731095575_behavior+ophys.nwb: ValueError: not able to parse the age: 19 weeksD, no rules to convert: D\n2021-09-01T17:24:18-0700 [ERROR   ] dandi 3287:140013450815232 Error uploading sub-710318403/sub-710318403_ses-731095575_behavior+ophys.nwb:\nTraceback (most recent call last):\n  File \"/allen/programs/braintv/workgroups/modelingsdk/local/miniconda3/envs/dandi/lib/python3.7/site-packages/dandi/upload.py\", line 262, in process_path\n    path, metadata, jobs=jobs_per_file, replace_asset=extant\n  File \"/allen/programs/braintv/workgroups/modelingsdk/local/miniconda3/envs/dandi/lib/python3.7/site-packages/dandi/dandiapi.py\", line 772, in iter_upload_raw_asset\n    f\"{filepath}: File etag changed; was originally\"\nRuntimeError: /allen/programs/braintv/workgroups/neuralcoding/kaeld/targetedconstrast_nwb/000039/sub-710318403/sub-710318403_ses-731095575_behavior+ophys.nwb: File etag changed; was originally ddce42382c7fc662e05e32509582296d-2 but is now 483786afda20b801e0ab35d8631b08a9-2\n\n```\n\u003c/details\u003e","files":null}]}