{"version":2,"ops":[{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1647281851,"metadata":{"github-id":"IC_kwDODBZtRc4_m0YS","github-url":"https://github.com/dandi/dandi-cli/issues/937#issuecomment-1067140626"},"message":"@AlmightyYakob What exactly are the changes to the Zarr uploading procedure from the client's perspective?  I'm assuming that, once all data is uploaded, a request (what method, path, and payload?) is made to the \"ingest\" endpoint, and then the client should periodically query `/zarr/{zarr_id}/` (?) until the \"status\" field acquires ... what value?  Also, is it still necessary to include the file digests in the `/zarr/{zarr_id}/upload/` requests, or is that a separate issue?","files":null},{"type":3,"author":{"id":"a9e2633aeb6d7e2366a97d09712312c2442c6054"},"timestamp":1647284255,"metadata":{"github-id":"IC_kwDODBZtRc4_m9D2","github-url":"https://github.com/dandi/dandi-cli/issues/937#issuecomment-1067176182"},"message":"\u003e I'm assuming that, once all data is uploaded, a request (what method, path, and payload?) is made to the \"ingest\" endpoint\n\nYep, it's `POST /zarr/{zarr_id}/ingest/`\n\n\u003e and then the client should periodically query `/zarr/{zarr_id}/` (?) until the \"status\" field acquires ... what value?\n\nYep, the client should query until the `status` field is `Valid`. The status options are listed [here](https://github.com/dandi/dandi-archive/blob/17ef1ef19b7f693c13cd474beba0d7db8e26961b/dandiapi/api/models/zarr.py#L170-L173).\n\n\u003e Also, is it still necessary to include the file digests in the `/zarr/{zarr_id}/upload/` requests, or is that a separate issue?\n\nI believe so, as the `zarr/upload/complete/` endpoint still verifies etags before returning. @dchiquito Is that correct, or should etag verification be removed from that endpoint as well?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1647284496,"metadata":{"github-id":"IC_kwDODBZtRc4_m95O","github-url":"https://github.com/dandi/dandi-cli/issues/937#issuecomment-1067179598"},"message":"@AlmightyYakob Question: Sometimes, after uploading to a Zarr that already exists, the client may delete files from the Zarr that no longer exist on the local end.  Should this deletion happen before or after POSTing to the \"ingest\" endpoint?","files":null},{"type":3,"author":{"id":"a9e2633aeb6d7e2366a97d09712312c2442c6054"},"timestamp":1647286216,"metadata":{"github-id":"IC_kwDODBZtRc4_nEVY","github-url":"https://github.com/dandi/dandi-cli/issues/937#issuecomment-1067205976"},"message":"\u003e @AlmightyYakob Question: Sometimes, after uploading to a Zarr that already exists, the client may delete files from the Zarr that no longer exist on the local end. Should this deletion happen before or after POSTing to the \"ingest\" endpoint?\n\nGood question. The delete should happen before calling `ingest`, with a following call to `ingest` to recompute size, checksums, etc. An important note is that while an ingest is taking place, the zarr is \"locked\", meaning no files can be uploaded to or deleted from it. Similarly, if an upload of files is currently taking place, the zarr can't be ingested until those uploads are completed via the `POST /zarr/{zarr_id}/upload/complete` endpoint","files":null},{"type":6,"author":{"id":"a9e2633aeb6d7e2366a97d09712312c2442c6054"},"timestamp":1647286222,"metadata":{"github-id":"UCE_lALODBZtRc4_nEVYziGiayI"},"target":"a95ea9125cf9412512a7a849ff58fbcb99038cce5c4e771310b4490181048464","message":"\u003e @AlmightyYakob Question: Sometimes, after uploading to a Zarr that already exists, the client may delete files from the Zarr that no longer exist on the local end. Should this deletion happen before or after POSTing to the \"ingest\" endpoint?\n\nGood question. The delete should happen before calling `ingest`, with a following call to `ingest` to recompute size, checksums, etc. An important note is that while an ingest is taking place, the zarr is \"locked\", meaning no files can be uploaded to or deleted from it. Similarly, if an upload of files is currently taking place, the zarr can't be ingested until those uploads are completed via the `POST /zarr/{zarr_id}/upload/complete` endpoint.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1647286495,"metadata":{"github-id":"IC_kwDODBZtRc4_nFW3","github-url":"https://github.com/dandi/dandi-cli/issues/937#issuecomment-1067210167"},"message":"@AlmightyYakob \n\n\u003e The delete should happen before calling ingest, with a following call to ingest to recompute size, checksums, etc.\n\nYour wording almost implies that \"ingest\" should be called twice; should it?  I'm also now wondering if deletions that occur outside of uploads should be followed by an \"ingest\".","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1647288183,"metadata":{"github-id":"IC_kwDODBZtRc4_nKyT","github-url":"https://github.com/dandi/dandi-cli/issues/937#issuecomment-1067232403"},"message":"\u003e Also, is it still necessary to include the file digests in the /zarr/{zarr_id}/upload/ requests, or is that a separate issue?\n\nThat is still necessary as an integrity check for the individual files being uploaded. I didn't think we were ever going to not do that.","files":null},{"type":3,"author":{"id":"a9e2633aeb6d7e2366a97d09712312c2442c6054"},"timestamp":1647288268,"metadata":{"github-id":"IC_kwDODBZtRc4_nLHY","github-url":"https://github.com/dandi/dandi-cli/issues/937#issuecomment-1067233752"},"message":"\u003e Your wording almost implies that \"ingest\" should be called twice; should it? I'm also now wondering if deletions that occur outside of uploads should be followed by an \"ingest\".\n\nSorry, maybe I misunderstood your question. If deleting existing files from a zarr archive, the ingest endpoint should be called after the deletion endpoint, as that endpoint sets the zarr's status to `Pending` (invalid). If you're cancelling a batch of uploads (files that `complete` was never called on), ingest doesn't need to be called, as a zarr's status is only marked as `Pending` after the `complete` endpoint is called.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1647288480,"metadata":{"github-id":"IC_kwDODBZtRc4_nMBh","github-url":"https://github.com/dandi/dandi-cli/issues/937#issuecomment-1067237473"},"message":"@AlmightyYakob But if I delete files after a series of `/zarr/{zarr_id}/upload/` ... `/zarr/{zarr_id}/upload/complete/` calls, do I need to make one \"ingest\" call immediately after the uploads and another after the deletions, or can I do upload then delete then ingest?","files":null},{"type":3,"author":{"id":"a9e2633aeb6d7e2366a97d09712312c2442c6054"},"timestamp":1647289406,"metadata":{"github-id":"IC_kwDODBZtRc4_nPlg","github-url":"https://github.com/dandi/dandi-cli/issues/937#issuecomment-1067252064"},"message":"\u003e @AlmightyYakob But if I delete files after a series of `/zarr/{zarr_id}/upload/` ... `/zarr/{zarr_id}/upload/complete/` calls, do I need to make one \"ingest\" call immediately after the uploads and another after the deletions, or can I do upload then delete then ingest?\n\nYou can call ingest last, after all of the upload completions and deletions. Ingest isn't _required_ as part of the upload/deletion process, it's just required if you want to know the correct and up to date zarr checksum, size, and file count (if you want the zarr archive to be \"valid\" in dandi).","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1647895441,"metadata":{"github-id":"CE_lADODBZtRc5FqOCGzwAAAAF2PeyG"},"status":2}]}