{"version":2,"ops":[{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1624639657,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2ODY5NjEyMg==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-868696122"},"message":"@yarikoptic The tests are failing on calls to the publish endpoint with the error message \"Dandiset metadata or asset metadata is not valid\".  I believe I've gotten both metadata types to be as valid as I can (aside from the fields that should be set by the server), but the error persists.\n\n@bendichter Is there a way to see exactly what's failing validation?  Could validation errors be reported in the failed publish response?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1624640383,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2ODcwMzM4OA==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-868703388"},"message":"On closer inspection, I've found the following validation errors in the metadata returned by the server instance after creating the Dandiset \u0026 assets:\n\n* Because the server is running locally in Docker, the `contentUrl`s of assets contain URLs of the form `http://localhost:9000/dandi-dandisets/blobs/7ad/90b/7ad90bc7-9ec8-41f0-832a-9502cd6a6baa`, which fail validation due to lacking a TLD.\n* Despite setting the Dandiset contributor name to `\"Wodder, John\"` when creating the Dandiset, the server returns it as a string containing nothing but a single space, which fails validation.\n* Despite setting the Dandiset contributor role to `\"dcite:ContactPerson\"`, the server returns it as `\"dandi:ContactPerson\"`, which fails validation (at least using dandischema 0.2.8).\n\nAlso, I included a role of `\"dcite:Author\"` in the Dandiset contributor field, but it's not present in the metadata returned by the API.\n\ncc: @bendichter @satra","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1624641209,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2ODcxMjI2OQ==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-868712269"},"message":"the TLD issue requires an environment setting for dandischema: `DANDI_ALLOW_LOCALHOST_URLS`\n\nthe other two are likely because the non-staging version of the API is being used? we are at schema 0.4.4 and dandischema 0.2.9 in staging. (this is perhaps something to consider in CLI that staging and production may be running two different versions of schema/dandischema. so the docker containers should allow cli testing using different environments if that is not happening already.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1624644665,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2ODc0NTI0Mw==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-868745243"},"message":"@satra \n\n\u003e the other two are likely because the non-staging version of the API is being used?\n\nI'm testing against a Docker image built from the latest version of the \"staging\" branch of dandi/dandi-api (commit 9325bba).","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1624647496,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2ODc3MDI5MA==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-868770290"},"message":"does the image have the env variable set? or being sent when started?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1624647949,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2ODc3NDQ4MA==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-868774480"},"message":"@satra It does now, but that's not enough to solve the validation errors.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1624650026,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2ODc5MjQzMw==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-868792433"},"message":"@jwodder - can you try pushing a file to the staging server to demonstrate this issue? or does this only happen with the docker server?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1624650804,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2ODc5OTMwNQ==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-868799305"},"message":"@satra It also happens on the staging server.  The following code reproduces the error (Be sure to set `DANDI_API_KEY`):\n\n```python\nfrom pathlib import Path\nimport tempfile\nfrom dandi.consts import dandiset_metadata_file, known_instances\nfrom dandi.dandiapi import DandiAPIClient\nfrom dandi.upload import upload\n\nwith DandiAPIClient(known_instances[\"dandi-staging\"].api) as client:\n    client.dandi_authenticate()\n    d = client.create_dandiset(\n        \"Test Dandiset\",\n        {\n            \"schemaKey\": \"Dandiset\",\n            \"name\": \"Test Dandiset\",\n            \"description\": \"A test Dandiset\",\n            \"contributor\": [\n                {\n                    \"schemaKey\": \"Person\",\n                    \"name\": \"Wodder, John\",\n                    \"roleName\": [\"dcite:Author\", \"dcite:ContactPerson\"],\n                }\n            ],\n            \"license\": [\"spdx:CC0-1.0\"],\n            \"manifestLocation\": [\"https://github.com/dandi/dandi-cli\"],\n        },\n    )\n    dandiset_id = d.identifier\n    print(\"*** Created Dandiset\", dandiset_id)\n    with tempfile.TemporaryDirectory() as tmpdir:\n        dspath = Path(tmpdir)\n        (dspath / dandiset_metadata_file).write_text(f\"identifier: '{dandiset_id}'\\n\")\n        (dspath / \"file.txt\").write_text(\"This is test text.\\n\")\n        upload(\n            paths=[],\n            dandiset_path=dspath,\n            dandi_instance=\"dandi-staging\",\n            allow_any_path=True,\n            validation=\"skip\",\n        )\n    d.publish()\n```","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1624650904,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2ODgwMDE3Mg==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-868800172"},"message":"@satra Actually, nevermind, I can't reproduce it on the staging server, because when I try to publish, I get the error \"Must be an admin to publish\".","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1624651329,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2ODgwMzc4NA==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-868803784"},"message":"@satra It appears that the server ignores whatever's set in the contributor field when creating a Dandiset and instead uses information based on the user account.\n\n@bendichter How do I set the display name for the superuser when running `manage.py createsuperuser`?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1624651656,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2ODgwNjU3MQ==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-868806571"},"message":"@satra Now that I am admin on staging, I can confirm that the above script reproduces the error.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1624652125,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2ODgxMDMyOA==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-868810328"},"message":"API's `/info` returns schema_version:\n```shell\n$\u003e curl --silent https://api.dandiarchive.org/api/info/ | jq .\n{\n  \"schema_version\": \"0.3.1\",\n  \"schema_url\": \"https://raw.githubusercontent.com/dandi/schema/master/releases/0.3.1/dandiset.json\",\n  \"version\": \"0+unknown\"\n}\n```\nmay be dandi-cli should just error out whenever the schema_version it supports differs?  test then should be skipped.","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1624652231,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2ODgxMTI0NQ==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-868811245"},"message":"We added some code to inject the currently logged in user when creating a new dandiset. It is probably overriding the metadata you set. I will adjust so that provided metadata takes precedence.","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1624653923,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2ODgyMzk3MQ==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-868823971"},"message":"@jwodder Can you try again?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1624654092,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2ODgyNTI5NQ==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-868825295"},"message":"@dchiquito I get the same error when trying to publish, yet when I locally validate the Dandiset and asset metadata as retrieved from the server, they pass.","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1624655499,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2ODgzNTY5OQ==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-868835699"},"message":"@jwodder You can see the server side validation error by going to [the dandiset page](https://gui-staging.dandiarchive.org/#/dandiset/000024) and mousing over the greyed-out Publish button.\nCurrently dandiset 000024 is failing to validate because the `schemaVersion` is not specified in the metadata. I thought that the CLI would include that in the metadata used to initialize the dandiset, but I think it's also reasonable for the API to inject the current `schemaVersion` if it isn't specified.","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1624658108,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2ODg1Mjc1Mg==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-868852752"},"message":"@jwodder The dandiset metadata is now validating, but it still isn't publishable because the asset is being uploaded with schema version `0.4.3` instead of `0.4.4`. I suspect that as soon as that's resolved it will work.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1624885822,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2OTY3MDk4Mg==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-869670982"},"message":"@dchiquito The schema version depends on the version of dandischema in use.  Even with dandischema 0.2.9 and schemaVersion 0.4.4, I'm still getting a \"Dandiset metadata or asset metadata is not valid\" error from both the Dockerized server (updated to commit 1afe8be) and staging.  Both the Dandiset and asset metadata as returned by the Dockerized server pass validation once I set `DANDI_ALLOW_LOCALHOST_URLS`, which is also set on the Docker containers.  Publishing seems to work fine via the staging GUI.\n\nDo you think you could at least make the publish error message more informative so that users can see what they're doing wrong?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1624908195,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2OTk2MDAzNg==","github-url":"https://github.com/dandi/dandi-cli/issues/682#issuecomment-869960036"},"message":"With @dchiquito's help, I've gotten the code in #683 to pass against the staging branch of dandi-api.","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1624912335,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50NDk0OTcyMjI0MQ=="},"status":2}]}