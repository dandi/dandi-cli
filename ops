{"version":2,"ops":[{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1662130236,"metadata":{"github-id":"IC_kwDODBZtRc5JpbHX","github-url":"https://github.com/dandi/dandi-cli/issues/1085#issuecomment-1235595735"},"message":"First, see https://github.com/dandi/dandi-archive/issues/1200 for discussion on a potential alternative to `/server-info`.\n\n\u003e if instance cannot be deduced from URL, get that URLs top `/server-info`\n\nAre you sure `/server-info` will always be at the top?  What if someone deploys a DANDI Archive GUI at `https://www.example.com/dandi/`?\n\n---\n\nAs far as I can tell at the moment, this feature would require changing the following:\n\n* The URL-parsing code would have to handle GUI URLs by determining their `/server-info` path, making a request to it, and combining the Dandiset ID etc. from the original URL with the API URL\n* The `--dandi-instance` option would have to accept both known instance names and URLs\n* Something somewhere would have to determine whether a user-supplied instance was an instance name or a URL and return either an appropriate `dandi.consts.DandiInstance` instance or just a final API URL\n\n* We would have to do something about most or all uses of `known_instances` and `known_instances_rev` in the code, including:\n    * [This spot](https://github.com/dandi/dandi-cli/blob/e74c5ac88d4a3af917c0ac9d773325058c09a185/dandi/dandiapi.py#L434-L435) in `DandiAPIClient.for_dandi_instance()`\n    * [`DandiAPIClient._instance_id`](https://github.com/dandi/dandi-cli/blob/e74c5ac88d4a3af917c0ac9d773325058c09a185/dandi/dandiapi.py#L497-L503) (used in stringifying resource objects)\n    * [This spot](https://github.com/dandi/dandi-cli/blob/e74c5ac88d4a3af917c0ac9d773325058c09a185/dandi/cli/cmd_download.py#L125) in the `dandi download` command\n    * We would likely have to finally do something about [this TODO item](https://github.com/dandi/dandi-cli/blob/e74c5ac88d4a3af917c0ac9d773325058c09a185/dandi/dandiapi.py#L473)\n    * Something would have to change in [`get_instance()`](https://github.com/dandi/dandi-cli/blob/e74c5ac88d4a3af917c0ac9d773325058c09a185/dandi/utils.py#L557)","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1662130645,"metadata":{"github-id":"IC_kwDODBZtRc5JpczA","github-url":"https://github.com/dandi/dandi-cli/issues/1085#issuecomment-1235602624"},"message":"\u003e Are you sure `/server-info` will always be at the top? What if someone deploys a DANDI Archive GUI at `https://www.example.com/dandi/`?\n\nI would say that for now (or forever) we can rely on that.  If there would be some strong use case, then we would just need to introduce \"sensing\" for /server-info (like we do for `.git` folder or `dandiset.yaml` locally) down the URL to figure \"the top\". But I really wouldn't worry about that to be needed ATM.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1677638221,"metadata":{"github-id":"IC_kwDODBZtRc5WYbPb","github-url":"https://github.com/dandi/dandi-cli/issues/1085#issuecomment-1449243611"},"message":"\u003e * We would likely have to finally do something about [this TODO item](https://github.com/dandi/dandi-cli/blob/e74c5ac88d4a3af917c0ac9d773325058c09a185/dandi/dandiapi.py#L473)\n\n```python\n        if self.api_url in known_instances_rev:\n            client_name = known_instances_rev[self.api_url]\n        else:\n            raise NotImplementedError(\"TODO client name derivation for keyring\")\n```\nwhich is pretty much like \"what is the realm\" or \"id\" of that instance. I don't think that we would come up with those any time soon.  I think in general we can use `domain:port` as the client_name since unlikely we would have multiple under different sub-paths (i.e. not at the top, assumption above), but could have multiple on different ports (e.g. like during testing/development).","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1678794139,"metadata":{"github-id":"IC_kwDODBZtRc5Xfw4R","github-url":"https://github.com/dandi/dandi-cli/issues/1085#issuecomment-1467944465"},"message":"please let me know if any other clarification is needed.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1684504604,"metadata":{"github-id":"IC_kwDODBZtRc5cqYcZ","github-url":"https://github.com/dandi/dandi-cli/issues/1085#issuecomment-1554614041"},"message":"@yarikoptic Should there be any attempt at handling arbitrary API URLs provided as instance URLs?  How would they be identified or distinguished from GUI URLs?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1684527799,"metadata":{"github-id":"IC_kwDODBZtRc5csmfH","github-url":"https://github.com/dandi/dandi-cli/issues/1085#issuecomment-1555195847"},"message":"https://dandiarchive.org/server-info is pretty much a redirect to `/api/info`. If `/server-info` is 404, and `/api-info` provides json record with expected field(s) -- let's use that one.","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1684527809,"metadata":{"github-id":"UCE_lALODBZtRc5csmfHzjGW3dM"},"target":"f96dc0019cf6623b337d17572a2fcaf0010fc4c7de0da024361ce3797f0dc584","message":"https://dandiarchive.org/server-info is pretty much a redirect to `/api/info`. If `/server-info` is 404, and `/api/info` provides json record with expected field(s) -- let's use that one.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1684758977,"metadata":{"github-id":"IC_kwDODBZtRc5c0COb","github-url":"https://github.com/dandi/dandi-cli/issues/1085#issuecomment-1557144475"},"message":"@yarikoptic Do we still need the \"redirector\" element of `DandiInstance`?  It's only used [here](https://github.com/dandi/dandi-cli/blob/7a86c283ab926f4c53b791d4afc32f797f08e189/dandi/utils.py#L589) in `get_instance()` as the root of the `/server-info` request, but as https://gui.dandiarchive.org/server-info now exists, it seems redundant.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1684769716,"metadata":{"github-id":"IC_kwDODBZtRc5c1KLY","github-url":"https://github.com/dandi/dandi-cli/issues/1085#issuecomment-1557439192"},"message":"right, we no longer use redirector, so I archived https://github.com/dandi/redirector .  For consistency I would just make it `None` while keeping the element  - no need to break ABI (happen some code for some reason uses it downstream) IMHO.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1684846242,"metadata":{"github-id":"IC_kwDODBZtRc5c8FXa","github-url":"https://github.com/dandi/dandi-cli/issues/1085#issuecomment-1559254490"},"message":"@yarikoptic Are we still using a Dandi instance at https://gui-beta-dandiarchive-org.netlify.app?  It's the only instance in `known_instances` that doesn't have an API URL, and I'd like to get rid of it.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1684849130,"metadata":{"github-id":"IC_kwDODBZtRc5c8lro","github-url":"https://github.com/dandi/dandi-cli/issues/1085#issuecomment-1559386856"},"message":"@yarikoptic Also, what fields of the `/server-info`/`/api/info` response am I allowed to assume exist?  The Swagger docs state that all fields are required, yet the current client code for working with the response allows for some of them to be absent.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1684859617,"metadata":{"github-id":"IC_kwDODBZtRc5c-JCp","github-url":"https://github.com/dandi/dandi-cli/issues/1085#issuecomment-1559793833"},"message":"\u003e @yarikoptic Are we still using a Dandi instance at https://gui-beta-dandiarchive-org.netlify.app? It's the only instance in `known_instances` that doesn't have an API URL, and I'd like to get rid of it.\n\nyeah -- I think we can kill it - seems to be NA etc.\n\n\u003e @yarikoptic Also, what fields of the `/server-info`/`/api/info` response am I allowed to assume exist? The Swagger docs state that all fields are required, yet the current client code for working with the response allows for some of them to be absent.\n\nFor detection of the record I would assume it needing to have \"version\" and \"services\". I would code robustly for \"services\" keys and do not assume any present, but if `\"api\"` is not present/empty -- error out.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1684933509,"metadata":{"github-id":"IC_kwDODBZtRc5dDKt-","github-url":"https://github.com/dandi/dandi-cli/issues/1085#issuecomment-1561111422"},"message":"@yarikoptic Question: Resolution of arbitrary instance URLs uses `get_instance()`, which always (even if a known instance is specified) makes a request to `/server-info` to check allowed CLI versions and get the final API \u0026 GUI URLs.  Do we want to keep doing this when parsing Dandi URLs for arbitrary instances?  Doing so would slow things down and make testing without a network tricky.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1684941099,"metadata":{"github-id":"IC_kwDODBZtRc5dEDtk","github-url":"https://github.com/dandi/dandi-cli/issues/1085#issuecomment-1561344868"},"message":"Overall: we definitely want to warrant \"allowed CLI versions\" and I think we should move away from relying on hardcoded records for  instances/services, and thus cannot avoid fetching `/server-info`.\nFor testing without network -- I would assume that we would still have connection to docker instance and thus as long as that one works - everything we test would still work.  Or is there tests you know which would be affected if we start (if we don't do atm) querying `/server-info` for every `get_instance()`?\n\nI looked around the code (not tests) where we use `get_instance`: it seems that part of the slow down could be that we do not cache result of `get_instance` which gets invoked in `_dandi_url_parser.parse`  for every url -- so if we are to queries for multiple URLs - ATM we would rerun `get_instance` over and over again for the same instance. We would want to cache it.  I didn't analyze if we would be getting only top level sanitized (e.g. no trailing `/` and query options) URLs into it (thus a simple `@lru_cache` might suffice) or we would need to sanitize first. With that interactions should probably remain as fast as before if not faster for multiple URLs, or am I missing some specific code paths/use cases?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1684941274,"metadata":{"github-id":"IC_kwDODBZtRc5dEE6Q","github-url":"https://github.com/dandi/dandi-cli/issues/1085#issuecomment-1561349776"},"message":"@yarikoptic \n\n\u003e Or is there tests you know which would be affected if we start (if we don't do atm) querying `/server-info` for every `get_instance()`?\n\nThe tests for parsing production Dandi URLs are going to be affected by #1298, in which the URL parsing code now always calls `get_instance()`.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1684941671,"metadata":{"github-id":"IC_kwDODBZtRc5dEHnd","github-url":"https://github.com/dandi/dandi-cli/issues/1085#issuecomment-1561360861"},"message":"is the instances used by the tests are the same, then with caching of the `get_instance` we at least would keep it efficient right?  Then the concern would remain only testing without network, right?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1684941756,"metadata":{"github-id":"IC_kwDODBZtRc5dEIKb","github-url":"https://github.com/dandi/dandi-cli/issues/1085#issuecomment-1561363099"},"message":"@yarikoptic Correct.","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1686177826,"metadata":{"github-id":"CE_lADODBZtRc5OmoozzwAAAAI0KEf2"},"status":2},{"type":3,"author":{"id":"7a8552494914d3e4116f4b434eb4812a914ca405"},"timestamp":1691777181,"metadata":{"github-id":"IC_kwDODBZtRc5j2S4g","github-url":"https://github.com/dandi/dandi-cli/issues/1085#issuecomment-1675177504"},"message":"\u003c!-- GITHUB_RELEASE COMMENT: released --\u003e\n:rocket: Issue was released in [`0.56.0`](https://github.com/dandi/dandi-cli/releases/tag/0.56.0) :rocket:","files":null},{"type":5,"author":{"id":"7a8552494914d3e4116f4b434eb4812a914ca405"},"timestamp":1691777182,"metadata":{"github-id":"LE_lADODBZtRc5OmoozzwAAAAJYXv0v"},"added":["released"],"removed":[]}]}