{"version":2,"ops":[{"type":1,"author":{"id":"b47d70447f48e9670debced52b0983080ea7199d"},"timestamp":1679945324,"metadata":{"github-id":"I_kwDODBZtRc5h6XKn","github-url":"https://github.com/dandi/dandi-cli/issues/1257","origin":"github"},"title":"Errors while uploading","message":"Dear all,\n\nI am seeing errors while uploading some Zarr files:\n```\nPATH                                                                                        SIZE     ERRORS    UPLOAD STATUS      MESSAGE                                                                                                    \nsub-I45/ses-SPIM/micr/sub-I45_ses-SPIM_sample-BrocaAreaS03_stain-NeuN_SPIM.ome.zarr         28.2 GB    0         100% done                                                                                                                   \nsub-I45/ses-SPIM/micr/sub-I45_ses-SPIM_sample-BrocaAreaS03_stain-Somatostatin_SPIM.ome.zarr 27.0 GB    0         100% done                                                                                                                   \nsub-I45/ses-SPIM/micr/sub-I45_ses-SPIM_sample-BrocaAreaS04_stain-Calretinin_SPIM.ome.zarr   29.8 GB    0         100% done                                                                                                                   \nsub-I45/ses-SPIM/micr/sub-I45_ses-SPIM_sample-BrocaAreaS04_stain-NeuN_SPIM.ome.zarr         30.0 GB    0         100% done                                                                                                                   \nsub-I45/ses-SPIM/micr/sub-I45_ses-SPIM_sample-BrocaAreaS04_stain-Somatostatin_SPIM.ome.zarr 28.3 GB    0         100% done                                                                                                                   \nsub-I45/ses-SPIM/micr/sub-I45_ses-SPIM_sample-BrocaAreaS05_stain-Calretinin_SPIM.ome.zarr   26.8 GB    0          49% ERROR       Error 400 while sending PUT request to https://dandiarchive.s3.amazonaws.com/zarr/40e22a9d-3cf4-4245-aa...\nsub-I45/ses-SPIM/micr/sub-I45_ses-SPIM_sample-BrocaAreaS05_stain-NeuN_SPIM.ome.zarr         28.1 GB    0           6% ERROR       501 Server Error: Not Implemented for url: https://dandiarchive.s3.amazonaws.com/zarr/0205ef2e-71ba-4ba...\nsub-I45/ses-SPIM/micr/sub-I45_ses-SPIM_sample-BrocaAreaS05_stain-Somatostatin_SPIM.ome.zarr 26.7 GB    0          56% ERROR       501 Server Error: Not Implemented for url: https://dandiarchive.s3.amazonaws.com/zarr/fde6ba34-0c45-49b...\nsub-I45/ses-SPIM/micr/sub-I45_ses-SPIM_sample-BrocaAreaS06_stain-Calretinin_SPIM.ome.zarr   28.0 GB    0         100% done                                                                                                                   \nsub-I45/ses-SPIM/micr/sub-I45_ses-SPIM_sample-BrocaAreaS06_stain-NeuN_SPIM.ome.zarr         29.0 GB    0          53% ERROR       501 Server Error: Not Implemented for url: https://dandiarchive.s3.amazonaws.com/zarr/e001a5a3-3949-43b...\nsub-I45/ses-SPIM/micr/sub-I45_ses-SPIM_sample-BrocaAreaS06_stain-Somatostatin_SPIM.ome.zarr 27.7 GB    0         100% done                                                                                                                   \nsub-I45/ses-SPIM/micr/sub-I45_ses-SPIM_sample-BrocaAreaS07_stain-Calretinin_SPIM.ome.zarr   30.3 GB    0          26% ERROR       Error 400 while sending PUT request to https://dandiarchive.s3.amazonaws.com/zarr/4a299473-0876-4f96-b8...\nsub-I45/ses-SPIM/micr/sub-I45_ses-SPIM_sample-BrocaAreaS07_stain-NeuN_SPIM.ome.zarr         32.0 GB    0          39% ERROR       501 Server Error: Not Implemented for url: https://dandiarchive.s3.amazonaws.com/zarr/be69829d-16dd-48c...\nsub-I45/ses-SPIM/micr/sub-I45_ses-SPIM_sample-BrocaAreaS07_stain-Somatostatin_SPIM.ome.zarr 30.3 GB    0          53% ERROR       501 Server Error: Not Implemented for url: https://dandiarchive.s3.amazonaws.com/zarr/ee44994f-7e2c-45a...\nsub-I45/ses-SPIM/micr/sub-I45_ses-SPIM_sample-BrocaAreaS08_stain-Calretinin_SPIM.ome.zarr   29.2 GB    0           2% ERROR       501 Server Error: Not Implemented for url: https://dandiarchive.s3.amazonaws.com/zarr/2e5005d7-efd2-493...\n```\nHere are some (slightly redacted) excerpts from the log:\n```\n2023-03-27T15:49:37+0200 [INFO    ] dandi 3822266:140510692464448 dandi v0.51.0, hdmf v3.5.2, pynwb v2.3.1, h5py v3.8.0\n2023-03-27T15:49:37+0200 [INFO    ] dandi 3822266:140510692464448 sys.argv = ['/opt/bin/dandi', 'upload', '--allow-any-path', '--validation', 'ignore', 'sub-I45/ses-SPIM']\n\n\n2023-03-27T17:01:11+0200 [ERROR   ] dandi 3822266:140508050728704 HTTP connection failed\nTraceback (most recent call last):\n  File \"/opt/lib/python3.8/site-packages/dandi/dandiapi.py\", line 210, in request\n    for i, attempt in enumerate(\n  File \"/opt/lib/python3.8/site-packages/tenacity/__init__.py\", line 347, in __iter__\n    do = self.iter(retry_state=retry_state)\n  File \"/opt/lib/python3.8/site-packages/tenacity/__init__.py\", line 325, in iter\n    raise retry_exc.reraise()\n  File \"/opt/lib/python3.8/site-packages/tenacity/__init__.py\", line 158, in reraise\n    raise self.last_attempt.result()\n  File \"/usr/lib/python3.8/concurrent/futures/_base.py\", line 437, in result\n    return self.__get_result()\n  File \"/usr/lib/python3.8/concurrent/futures/_base.py\", line 389, in __get_result\n    raise self._exception\n  File \"/opt/lib/python3.8/site-packages/dandi/dandiapi.py\", line 240, in request\n    result.raise_for_status()\n  File \"/opt/lib/python3.8/site-packages/requests/models.py\", line 1021, in raise_for_status\n    raise HTTPError(http_error_msg, response=self)\nrequests.exceptions.HTTPError: 501 Server Error: Not Implemented for url: https://dandiarchive.s3.amazonaws.com/zarr/0205ef2e-71ba-4ba1-a4b3-489ee5efe02b/0/0/8/42...\n\n\n2023-03-27T17:01:23+0200 [ERROR   ] dandi 3822266:140509742302976 Error uploading /NIH/DANDI/000026/sub-I45/ses-SPIM/micr/sub-I45_ses-SPIM_sample-BrocaAreaS05_stain-NeuN_SPIM.ome.zarr:\nTraceback (most recent call last):\n  File \"/opt/lib/python3.8/site-packages/dandi/upload.py\", line 240, in process_path\n    for r in dfile.iter_upload(\n  File \"/opt/lib/python3.8/site-packages/dandi/files/zarr.py\", line 470, in iter_upload\n    size = fut.result()\n  File \"/usr/lib/python3.8/concurrent/futures/_base.py\", line 437, in result\n    return self.__get_result()\n  File \"/usr/lib/python3.8/concurrent/futures/_base.py\", line 389, in __get_result\n    raise self._exception\n  File \"/usr/lib/python3.8/concurrent/futures/thread.py\", line 57, in run\n    result = self.fn(*self.args, **self.kwargs)\n  File \"/opt/lib/python3.8/site-packages/dandi/files/zarr.py\", line 544, in _upload_zarr_file\n    storage_session.put(\n  File \"/opt/lib/python3.8/site-packages/dandi/dandiapi.py\", line 311, in put\n    return self.request(\"PUT\", path, **kwargs)\n  File \"/opt/lib/python3.8/site-packages/dandi/dandiapi.py\", line 210, in request\n    for i, attempt in enumerate(\n  File \"/opt/lib/python3.8/site-packages/tenacity/__init__.py\", line 347, in __iter__\n    do = self.iter(retry_state=retry_state)\n  File \"/opt/lib/python3.8/site-packages/tenacity/__init__.py\", line 325, in iter\n    raise retry_exc.reraise()\n  File \"/opt/lib/python3.8/site-packages/tenacity/__init__.py\", line 158, in reraise\n    raise self.last_attempt.result()\n  File \"/usr/lib/python3.8/concurrent/futures/_base.py\", line 437, in result\n    return self.__get_result()\n  File \"/usr/lib/python3.8/concurrent/futures/_base.py\", line 389, in __get_result\n    raise self._exception\n  File \"/opt/lib/python3.8/site-packages/dandi/dandiapi.py\", line 240, in request\n    result.raise_for_status()\n  File \"/opt/lib/python3.8/site-packages/requests/models.py\", line 1021, in raise_for_status\n    raise HTTPError(http_error_msg, response=self)\nrequests.exceptions.HTTPError: 501 Server Error: Not Implemented for url: https://dandiarchive.s3.amazonaws.com/zarr/0205ef2e-71ba-4ba1-a4b3-489ee5efe02b/0/0/8/42...\n\n\n2023-03-27T17:36:08+0200 [DEBUG   ] dandi 3822266:140509784250112 Error uploading zarr: HTTPError: Error 400 while sending PUT request to https://dandiarchive.s3.amazonaws.com/zarr/40e22a9d-3cf4-4245-aa7e-400b65381cd4/0/1/6/86....: \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e\n\u003cError\u003e\u003cCode\u003eBadDigest\u003c/Code\u003e\u003cMessage\u003eThe Content-MD5 you specified did not match what we received.\u003c/Message\u003e\u003cExpectedDigest\u003e4f0daa8170fae2bd0b05e09f61b10d66\u003c/ExpectedDigest\u003e\u003cCalculatedDigest\u003eZvtu9pNAoZlNjjFTrpMhKQ==\u003c/CalculatedDigest\u003e\u003cRequestId\u003e1EEDC8B4XNEJNSJ9\u003c/RequestId\u003e\u003cHostId\u003eAOiMy3L2IOtiyfrA6I+sFe6Nxb0WzDGVoVYyQaTsWWzsSoV9aSl+Y8vGz0oaU8b3u62p9ccCsK4=\u003c/HostId\u003e\u003c/Error\u003e\n2023-03-27T17:36:08+0200 [DEBUG   ] dandi 3822266:140509784250112 Cancelling upload\n```\n\nHope this helps!\nGiacomo","files":null}]}