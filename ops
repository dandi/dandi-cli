{"version":2,"ops":[{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1616159911,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgwMjgyMzEzMA==","github-url":"https://github.com/dandi/dandi-cli/issues/478#issuecomment-802823130"},"message":"@yarikoptic @dchiquito So the changes that affect the CLI side are:\n\n* The payload to \u0026 response from the `/uploads/initialize/` endpoint have changed; it now returns a UUID which needs to be included in the paths of the `/uploads/complete/` and `/uploads/validate/` endpoints.\n    * The payload now needs to include a hash of the file; what algorithms are accepted here?\n* The payload to the `/uploads/validate/` endpoint is gone.\n* An ETag digest for the uploaded file needs to be provided, but where?  In the metadata or in the payload to `/uploads/initialize`?\n* The `/uploads/validations/{filehash}/` endpoint is gone; should the related functionality just be removed from the CLI?\n* Currently, the CLI starts out an upload by making a request to `/uploads/validate/` with the sha256 digest of the file in order to check whether the blob has already been uploaded to the server; what is the equivalent way to do this now?\n* Anything else?","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1616159911,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDQ0NDM5MTY5"},"target":"5535f9b6bcb466e127b8e07e15032a3f250bc88716ba3fc35f3f5efc6a5bab20","message":"@yarikoptic @dchiquito So the changes that affect the CLI side are:\n\n* The payload to \u0026 response from the `/uploads/initialize/` endpoint have changed; it now returns a UUID which needs to be included in the paths of the `/uploads/complete/` and `/uploads/validate/` endpoints — and, I assume, in the payload of the `POST /dandisets/{versions__dandiset__pk}/versions/{versions__version}/assets/` request.\n    * The payload now needs to include a hash of the file; what algorithms are accepted here?\n* The payload to the `/uploads/validate/` endpoint is gone.\n* An ETag digest for the uploaded file needs to be provided, but where?  In the metadata or in the payload to `/uploads/initialize`?\n* The `/uploads/validations/{filehash}/` endpoint is gone; should the related functionality just be removed from the CLI?\n* Currently, the CLI starts out an upload by making a request to `/uploads/validate/` with the sha256 digest of the file in order to check whether the blob has already been uploaded to the server; what is the equivalent way to do this now?\n* Anything else?","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1616159929,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDQ0NDM5MjE5"},"target":"5535f9b6bcb466e127b8e07e15032a3f250bc88716ba3fc35f3f5efc6a5bab20","message":"@yarikoptic @dchiquito So the changes that affect the CLI side are:\n\n* The payload to \u0026 response from the `/uploads/initialize/` endpoint have changed; it now returns a UUID which needs to be included in the paths of the `/uploads/complete/` and `/uploads/validate/` endpoints — and, I assume, in the payload of the `POST /dandisets/{versions__dandiset__pk}/versions/{versions__version}/assets/` request.\n    * The `/uploads/initialize/` payload now needs to include a hash of the file; what algorithms are accepted here?\n* The payload to the `/uploads/validate/` endpoint is gone.\n* An ETag digest for the uploaded file needs to be provided, but where?  In the metadata or in the payload to `/uploads/initialize`?\n* The `/uploads/validations/{filehash}/` endpoint is gone; should the related functionality just be removed from the CLI?\n* Currently, the CLI starts out an upload by making a request to `/uploads/validate/` with the sha256 digest of the file in order to check whether the blob has already been uploaded to the server; what is the equivalent way to do this now?\n* Anything else?","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1616159949,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDQ0NDM5MzI1"},"target":"5535f9b6bcb466e127b8e07e15032a3f250bc88716ba3fc35f3f5efc6a5bab20","message":"@yarikoptic @dchiquito So the changes that affect the CLI side are:\n\n* The payload to \u0026 response from the `/uploads/initialize/` endpoint have changed; it now returns a UUID which needs to be included in the paths of the `/uploads/complete/` and `/uploads/validate/` endpoints — and, I assume, in the payload of the `POST /dandisets/{versions__dandiset__pk}/versions/{versions__version}/assets/` request.\n    * The `/uploads/initialize/` payload now needs to include a hash of the file; what algorithms are accepted here?\n* The payload to the `/uploads/validate/` endpoint is gone.\n* An ETag digest for the uploaded file needs to be provided, but where?  In the metadata or in the payload to `/uploads/initialize/`?\n* The `/uploads/validations/{filehash}/` endpoint is gone; should the related functionality just be removed from the CLI?\n* Currently, the CLI starts out an upload by making a request to `/uploads/validate/` with the sha256 digest of the file in order to check whether the blob has already been uploaded to the server; what is the equivalent way to do this now?\n* Anything else?","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1616161435,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgwMjg0MzEyMA==","github-url":"https://github.com/dandi/dandi-cli/issues/478#issuecomment-802843120"},"message":"@jwodder\n* `/uploads/initialize/` should take a body like this:\n```\n{\n  \"contentSize\": 12345,\n  \"digest\": {\n    \"algorithm\": \"dandi:dandi-etag\",\n    \"value\": \"...\"\n  }\n}\n```\nThe value should be calculated using the `DandiETag` thingy that's being added to dandi.core. This value is the ETag digest for the file being uploaded.\n\n* The background processes no longer block the CLI, so yes, there is no reason for the CLI to wait for them to finish. After calling `POST /dandisets/{versions__dandiset__pk}/versions/{versions__version}/assets/` the CLI is done with the upload.\n\n* You can call `POST /blobs/digest/` with `{\"algorithm\": \"dandi:dandi-etag\", \"value\": \"...\" }`. Alternatively, if you try to start the upload with `/uploads/initialize`, it should throw an error 409 with the `Location` header set to the UUID of an existing asset blob, if an asset blob with a matching etag exists.","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1616176047,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgwMzAwNTA4MA==","github-url":"https://github.com/dandi/dandi-cli/issues/478#issuecomment-803005080"},"message":"@jwodder I made a small change to `/uploads/{uuid}/validate/`, it now returns a 200 with a description of the asset blob for the uploaded data. Since another upload may have completed before yours, the UUID is not necessarily the same as the upload UUID, so you should use the UUID from the response instead of the upload UUID.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1616178438,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgwMzAyNzgwNQ==","github-url":"https://github.com/dandi/dandi-cli/issues/478#issuecomment-803027805"},"message":"@dchiquito Are the `object_key` and `upload_id` fields in the response from `/uploads/initialize/` still used for anything?  Previously, they were passed to `/uploads/complete/` and `/uploads/validate/`, but now they seem to be unused.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1616180541,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgwMzA0NzY2Mg==","github-url":"https://github.com/dandi/dandi-cli/issues/478#issuecomment-803047662"},"message":"Eh, too many UUIDs here without clear demarcation of their domain, and I think that is what leads to confusion.  I wonder if we shouldn't better give them dedicated names (`upload_id`, `blob_id` or `blob_key`) even if values would be UUIDs and leave `uuid`  to refer solely to assets?  \nPer https://github.com/dandi/dandi-api/pull/150/files#diff-c96d4444d1714a52d5d08dd92d94919393a7db8ded038aa84f02ba1075d2c25eR29 (well -- my suggestion there to be precise) where we used dedicated names, it is \n```\n8. CLI `POST /uploads/{upload_id}/validate/` \u003c-- `{}` --\u003e `blobs:key`. API\n```\n\nso in \"uuid\"s it would be\n```\n8. CLI `POST /uploads/{uploads:uuid}/validate/` \u003c-- `{}` --\u003e `blobs:uuid`. API\n```\nor in other words -- `blobs:uuid` should not be given/known to the user in any other prior `/uploads/{uploads:uuid}/operation` until the `.../validate/`.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1616181209,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgwMzA1MzIyOA==","github-url":"https://github.com/dandi/dandi-cli/issues/478#issuecomment-803053228"},"message":"@dchiquito moreover I do not see any reason to have `upload_id` to be a `uuid`, unlike for `blobs:uuid` AKA `blobs:key` (I would have even kept it called `key` for disambiguation) should be something of consistent length and randomly evenly spread out for blobs keystore, and `assets` should be a globally unique identifier, thus also UUID.","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1616428839,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgwNDE4NDQ3OA==","github-url":"https://github.com/dandi/dandi-cli/issues/478#issuecomment-804184478"},"message":"@jwodder You are correct, `object_key` and `upload_id` are unused. They are still returned because it was convenient to do so, and I did not prune that information aggressively enough.","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1616605158,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50NDUwMzE4MDQxMg=="},"status":2}]}