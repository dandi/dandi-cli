{"version":2,"ops":[{"type":6,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1675724312,"metadata":{"github-id":"UCE_lAHODBZtRc5dyF1RzjxKifk"},"target":"6bc546f8fb051d15802667f44fb84c9c9af493eef611b4615a0357b2e75eb768","message":"```python\nfrom dandi.dandiapi import DandiAPIClient\n\nclient = DandiAPIClient()\ndandisets = list(client.get_dandisets())\n\n# this works\ndandisets[-3].get_metadata()\n\n# this does not work\nfor dandiset in dandisets:\n    metadata = dandiset.get_metadata()\n```\n\n\n```pytb\n---------------------------------------------------------------------------\nValidationError                           Traceback (most recent call last)\nCell In[13], line 12\n     10 # this does not work\n     11 for dandiset in tqdm(dandisets):\n---\u003e 12     metadata = dandiset.get_metadata()\n\nFile /opt/conda/lib/python3.10/site-packages/dandi/dandiapi.py:925, in RemoteDandiset.get_metadata(self)\n    920 def get_metadata(self) -\u003e models.Dandiset:\n    921     \"\"\"\n    922     Fetch the metadata for this version of the Dandiset as a\n    923     `dandischema.models.Dandiset` instance\n    924     \"\"\"\n--\u003e 925     return models.Dandiset.parse_obj(self.get_raw_metadata())\n\nFile /opt/conda/lib/python3.10/site-packages/pydantic/main.py:527, in pydantic.main.BaseModel.parse_obj()\n\nFile /opt/conda/lib/python3.10/site-packages/pydantic/main.py:342, in pydantic.main.BaseModel.__init__()\n\nValidationError: 1 validation error for Dandiset\nlicense\n  ensure this value has at least 1 items (type=value_error.list.min_items; limit_value=1)\n```","files":null},{"type":2,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1675724293,"metadata":{"github-id":"RTE_lADODBZtRc5dyF1RzwAAAAH3z_2e"},"title":"`dandiset.get_metadata` not working for all dandisets","was":"`dandiset.get_metadata` not working for some dandisets"},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1675727661,"metadata":{"github-id":"IC_kwDODBZtRc5Uot4A","github-url":"https://github.com/dandi/dandi-cli/issues/1205#issuecomment-1419959808"},"message":"ah - right, now I remembered it, thank you @bendichter  and I searched its previous instantiation in https://github.com/dandi/dandi-cli/issues/1181 which is a twin of https://github.com/dandi/dandi-cli/issues/1189 ;)  So the issue here is pretty much on what is our \"guarantee\" here while returning metadata -- is it valid according to the schema or not.  We have closed two prior instances without discussing, but may be let's discuss here.  What would you Ben prefer it to behave like?  May be if we somehow inform user that if they are interested in possibly invalid metadata, they could use `get_raw_metadata`?","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1675728053,"metadata":{"github-id":"IC_kwDODBZtRc5UovLy","github-url":"https://github.com/dandi/dandi-cli/issues/1205#issuecomment-1419965170"},"message":"for the specific issue, we can add a keyword arg to `get_metadata`, such as `validate=False`, which could internally do: `Dandiset.unvalidated(**dandiset.get_raw_metadata())` if there is a `ValidationError`","files":null},{"type":6,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1675728996,"metadata":{"github-id":"UCE_lALODBZtRc5UovLyzizpItE"},"target":"7b159d4ba73841e3f28decb7ed802934b22d0283e4e67e764b52472a80e16716","message":"for the specific issue, we can add a keyword arg to `get_metadata`, such as `validate=False`, which could internally do: `Dandiset.unvalidated(**dandiset.get_raw_metadata())` if there is a `ValidationError`\n\nof course a user can do that too. \n\nthe bigger question is around what should it return. in this particular case `license` became a required property, now set on creation, but this draft dandiset doesn't have one. i think we should first clean, upgrade, publish dandisets before trying to deal with this particular edge case or others. there are many cases where metadata are invalid since data submitters don't always fix them.","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1675776703,"metadata":{"github-id":"IC_kwDODBZtRc5Ur2fd","github-url":"https://github.com/dandi/dandi-cli/issues/1205#issuecomment-1420781533"},"message":"@satra that would make the query code more convoluted than it already is because we'd have to handle both cases. Also, if I understand correctly it would prevent users from editing metadata using the `DandiAPIClient`. My preferred solution would be:\n\n1. add a `is_valid_draft` flag or something similar on the `dandiset` and `asset` objects (I suppose this is similar to try/except on the user side, but I try to avoid that pattern)\n2. add some stink to the dandiset landing page to encourage users to fix metadata. Note that this is draft validation, not publication validation, so it is not covered by our existing validation messages that only cover publication validation.\n3. identify and try to fix invalid metadata for old dandisets. I can reach out to dandiset owners and try to get them to fix it. In this case, I'm pretty confident they'd be happy with CC-BY, it's just a matter of getting them to change it.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1675778044,"metadata":{"github-id":"IC_kwDODBZtRc5Ur99-","github-url":"https://github.com/dandi/dandi-cli/issues/1205#issuecomment-1420812158"},"message":"\u003e would prevent users from editing metadata using the DandiAPIClient\n\ni don't see why this would be the case. it's still a `Dandiset` model object and can be locally validated/updated and pushed.\n\nfor 1, there is already a field that reflects validity of a dandiset: `\u003cdandiset\u003e.version.status`\n3 is not just license, but other errors as well. all of these are documented in both the DLP (in the validation section), but also in `info` api endpoint. \n\n@jwodder - is the dandiset version `info` api endpoint exposed somewhere in the library, so one could list all the validation errors locally ?\n\ni just checked 2, and no published dandiset is invalid under the current schema.\n\n```python\nfrom pydantic import ValidationError\nfor idx, dandiset in enumerate(dandisets):\n    if dandiset.version.identifier == 'draft':\n        continue\n    try:\n        metadata = dandiset.get_metadata()\n    except ValidationError as e:\n        print(idx, e)\n```","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1675778214,"metadata":{"github-id":"IC_kwDODBZtRc5Ur_G4","github-url":"https://github.com/dandi/dandi-cli/issues/1205#issuecomment-1420816824"},"message":"@satra \n\n\u003e is the dandiset version `info` api endpoint exposed somewhere in the library, so one could list all the validation errors locally ?\n\nThat endpoint is exposed via `Dandiset.get_version()`, but the structure returned does not store the validation errors.","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1675784293,"metadata":{"github-id":"IC_kwDODBZtRc5UsnDM","github-url":"https://github.com/dandi/dandi-cli/issues/1205#issuecomment-1420980428"},"message":"@satra I'd like to homogenize the dandisets to facilitate reasonably terse and simple query code. Ideally users would not have to worry about cases where metadata does not match our schema. Your code would not allow the search to include dandisets that fail validation. It is true that many of these are empty or test datasets of little value, but there are also a substantial number that are high-value contributions including from the Allen Institute and others. I'd prefer to repair these if possible- at least the large ones. Also, if I understand your code correctly you are skipping all non-published dandisets. That's fine as a user option but I would not expect everyone to want to do that.\n\nI went through all the validation errors for existing dandisets. Many are empty dandisets. Most validation errors are a missing license. Some are contributor validation error. I would really prefer if these contributor validation errors were caught in the metadata editor form. Let's use these to try to patch the UI to prevent users from creating invalid metadata.\n\n18, 24, 30, 31, 32, 33, 38, 42, 46, 47, 63, 71, 72, 106, 112, 113, 114, 116, 120, 124, 131, 132 (and probably more, I started skipping them): missing a license but is also empty. 32 does not even have an owner. I'm not sure how that happened. It's not too hard to skip these with something like:\n\n```python\nif dandiset.version.size == 0:\n    continue;\n```\n\n\n**invalid metadata**\n21, 22: important Allen datasets that are missing licenses. Owned by Wayne Wakeman who is no longer with Allen, Josh Siegle is listed as a contact author but not a dandiset owner.\n28: dandiset by Matthias Hennig missing contributors and license. I have sent a request to update.\n36: Allen dandiset missing a license. Owned by Jerome. I sent a request for him to fix it.\n50: Allen dandiset missing a license. Several owners.\n51, 52: Owned by Lee Kamentsky. Missing a license and contributors. Described as a testing datasets.\n58: Owned by Lee Kamentsky. Missing contributor.\n60: Missing license.\n66: Missing a license. @satra you are an owner of this one. Can you add a license?\n68: Testing dataset by Thomas Braun missing a license.\n105: Owned by Lee Kamentsky. Validation error appears to be improper URL.\n107: missing contributors and non-supported license\n144: missing a license.\n149: contributor validation error. See relevant issue [here](https://dandiarchive.org/dandiset/000149)\n235, 236, 237, 238, 297: contributor validation error. Looks like a simple name formatting issue.\n338: validation error due to unusual Disorder metadata entry\n362: title is too long. See relevant issue [here](https://dandiarchive.org/dandiset/000362)","files":null},{"type":6,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1675784854,"metadata":{"github-id":"UCE_lALODBZtRc5UsnDMzizyG6E"},"target":"91d8efd7c6fe982a09181f16e70443b5390b2e3dc268f806fe46d32265da7d9c","message":"@satra I'd like to homogenize the dandisets to facilitate reasonably terse and simple query code. Ideally users would not have to worry about cases where metadata does not match our schema. Your code would not allow the search to include dandisets that fail validation. It is true that many of these are empty or test datasets of little value, but there are also a substantial number that are high-value contributions including from the Allen Institute and others. I'd prefer to repair these if possible- at least the large ones. Also, if I understand your code correctly you are skipping all non-published dandisets. That's fine as a user option but I would not expect everyone to want to do that.\n\nI went through all the validation errors for existing dandisets. Many are empty dandisets. Most validation errors are a missing license. Some are contributor validation error. I would really prefer if these contributor validation errors were caught in the metadata editor form. Let's use these to try to patch the UI to prevent users from creating invalid metadata.\n\n18, 24, 30, 31, 32, 33, 38, 42, 46, 47, 63, 71, 72, 106, 112, 113, 114, 116, 120, 124, 131, 132 (and probably more, I started skipping them): missing a license but is also empty. 32 does not even have an owner. I'm not sure how that happened. It's not too hard to skip these with something like:\n\n```python\nif dandiset.version.size == 0:\n    continue;\n```\n\n\n**invalid metadata**\n21, 22: important Allen datasets that are missing licenses. Owned by Wayne Wakeman who is no longer with Allen, Josh Siegle is listed as a contact author but not a dandiset owner.\n28: dandiset by Matthias Hennig missing contributors and license. I have sent a request to update.\n36: Allen dandiset missing a license. Owned by Jerome. I sent a request for him to fix it.\n50: Allen dandiset missing a license. Several owners.\n51, 52: Owned by Lee Kamentsky. Missing a license and contributors. Described as a testing datasets.\n58: Owned by Lee Kamentsky. Missing contributor.\n60: Missing license.\n66: Missing a license. @satra you are an owner of this one. Can you add a license?\n68: Testing dataset by Thomas Braun missing a license.\n105: Owned by Lee Kamentsky. Validation error appears to be improper URL. See relevant issue [here](https://github.com/dandi/dandi-archive/issues/1477).\n107: missing contributors and non-supported license\n144: missing a license.\n149: contributor validation error. See relevant issue [here](https://dandiarchive.org/dandiset/000149)\n235, 236, 237, 238, 297: contributor validation error. Looks like a simple name formatting issue.\n338: validation error due to unusual Disorder metadata entry\n362: title is too long. See relevant issue [here](https://dandiarchive.org/dandiset/000362)","files":null},{"type":6,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1675792541,"metadata":{"github-id":"UCE_lALODBZtRc5UsnDMziz0GRQ"},"target":"91d8efd7c6fe982a09181f16e70443b5390b2e3dc268f806fe46d32265da7d9c","message":"@satra I'd like to homogenize the dandisets to facilitate reasonably terse and simple query code. Ideally users would not have to worry about cases where metadata does not match our schema. Your code would not allow the search to include dandisets that fail validation. It is true that many of these are empty or test datasets of little value, but there are also a substantial number that are high-value contributions including from the Allen Institute and others. I'd prefer to repair these if possible- at least the large ones. Also, if I understand your code correctly you are skipping all non-published dandisets. That's fine as a user option but I would not expect everyone to want to do that.\n\nI went through all the validation errors for existing dandisets. Many are empty dandisets. Most validation errors are a missing license. Some are contributor validation error. I would really prefer if these contributor validation errors were caught in the metadata editor form. Let's use these to try to patch the UI to prevent users from creating invalid metadata.\n\n18, 24, 30, 31, 32, 33, 38, 42, 46, 47, 63, 71, 72, 106, 112, 113, 114, 116, 120, 124, 131, 132 (and probably more, I started skipping them): missing a license but is also empty. 32 does not even have an owner. I'm not sure how that happened. It's not too hard to skip these with something like:\n\n```python\nif dandiset.version.size == 0:\n    continue;\n```\n\n\n**invalid metadata**\n21, 22: important Allen datasets that are missing licenses. Owned by Wayne Wakeman who is no longer with Allen, Josh Siegle is listed as a contact author but not a dandiset owner.\n28: dandiset by Matthias Hennig missing contributors and license. I have sent a request to update.\n36: Allen dandiset missing a license. Owned by Jerome. I sent a request for him to fix it.\n50: Allen dandiset missing a license. Several owners.\n51, 52: Owned by Lee Kamentsky. Missing a license and contributors. Described as a testing datasets.\n58: Owned by Lee Kamentsky. Missing contributor.\n60: Missing license.\n66: Missing a license. @satra you are an owner of this one. Can you add a license?\n68: Testing dataset by Thomas Braun missing a license.\n105: Owned by Lee Kamentsky. Validation error appears to be improper URL. See relevant issue [here](https://github.com/dandi/dandi-archive/issues/1477).\n107: missing contributors and non-supported license\n144: missing a license.\n149: contributor validation error. See relevant issue [here](https://dandiarchive.org/dandiset/000149)\n235, 236, 237, 238, 297: contributor validation error. Looks like a simple name formatting issue.\n338: validation error due to unusual Disorder metadata entry. Relevant issue [here](https://github.com/dandi/dandi-archive/issues/1478)\n362: title is too long. See relevant issue [here](https://dandiarchive.org/dandiset/000362)","files":null},{"type":6,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1675792622,"metadata":{"github-id":"UCE_lALODBZtRc5UsnDMziz0HcM"},"target":"91d8efd7c6fe982a09181f16e70443b5390b2e3dc268f806fe46d32265da7d9c","message":"@satra I'd like to homogenize the dandisets to facilitate reasonably terse and simple query code. Ideally users would not have to worry about cases where metadata does not match our schema. Your code would not allow the search to include dandisets that fail validation. It is true that many of these are empty or test datasets of little value, but there are also a substantial number that are high-value contributions including from the Allen Institute and others. I'd prefer to repair these if possible- at least the large ones. Also, if I understand your code correctly you are skipping all non-published dandisets. That's fine as a user option but I would not expect everyone to want to do that.\n\nI went through all the validation errors for existing dandisets. Many are empty dandisets. Most validation errors are a missing license. Some are contributor validation error. I would really prefer if these contributor validation errors were caught in the metadata editor form. Let's use these to try to patch the UI to prevent users from creating invalid metadata.\n\n18, 24, 30, 31, 32, 33, 38, 42, 46, 47, 63, 71, 72, 106, 112, 113, 114, 116, 120, 124, 131, 132 (and probably more, I started skipping them): missing a license but is also empty. 32 does not even have an owner. I'm not sure how that happened. It's not too hard to skip these with something like:\n\n```python\nif dandiset.version.size == 0:\n    continue;\n```\n\n\n**invalid metadata**\n21, 22: important Allen datasets that are missing licenses. Owned by Wayne Wakeman who is no longer with Allen, Josh Siegle is listed as a contact author but not a dandiset owner.\n28: dandiset by Matthias Hennig missing contributors and license. I have sent a request to update.\n    update: Matthias requested that we delete this dandiset\n36: Allen dandiset missing a license. Owned by Jerome. I sent a request for him to fix it.\n50: Allen dandiset missing a license. Several owners.\n51, 52: Owned by Lee Kamentsky. Missing a license and contributors. Described as a testing datasets.\n58: Owned by Lee Kamentsky. Missing contributor.\n60: Missing license.\n66: Missing a license. @satra you are an owner of this one. Can you add a license?\n68: Testing dataset by Thomas Braun missing a license.\n105: Owned by Lee Kamentsky. Validation error appears to be improper URL. See relevant issue [here](https://github.com/dandi/dandi-archive/issues/1477).\n107: missing contributors and non-supported license\n144: missing a license.\n149: contributor validation error. See relevant issue [here](https://dandiarchive.org/dandiset/000149)\n235, 236, 237, 238, 297: contributor validation error. Looks like a simple name formatting issue.\n338: validation error due to unusual Disorder metadata entry. Relevant issue [here](https://github.com/dandi/dandi-archive/issues/1478)\n362: title is too long. See relevant issue [here](https://dandiarchive.org/dandiset/000362)","files":null},{"type":6,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1675804153,"metadata":{"github-id":"UCE_lALODBZtRc5UsnDMziz2nU8"},"target":"91d8efd7c6fe982a09181f16e70443b5390b2e3dc268f806fe46d32265da7d9c","message":"@satra I'd like to homogenize the dandisets to facilitate reasonably terse and simple query code. Ideally users would not have to worry about cases where metadata does not match our schema. Your code would not allow the search to include dandisets that fail validation. It is true that many of these are empty or test datasets of little value, but there are also a substantial number that are high-value contributions including from the Allen Institute and others. I'd prefer to repair these if possible- at least the large ones. Also, if I understand your code correctly you are skipping all non-published dandisets. That's fine as a user option but I would not expect everyone to want to do that.\n\nI went through all the validation errors for existing dandisets. Many are empty dandisets. Most validation errors are a missing license. Some are contributor validation error. I would really prefer if these contributor validation errors were caught in the metadata editor form. Let's use these to try to patch the UI to prevent users from creating invalid metadata.\n\n18, 24, 30, 31, 32, 33, 38, 42, 46, 47, 63, 71, 72, 106, 112, 113, 114, 116, 120, 124, 131, 132 (and probably more, I started skipping them): missing a license but is also empty. 32 does not even have an owner. I'm not sure how that happened. It's not too hard to skip these with something like:\n\n```python\nif dandiset.version.size == 0:\n    continue;\n```\n\n\n**invalid metadata**\n21, 22: important Allen datasets that are missing licenses. Owned by Wayne Wakeman who is no longer with Allen, Josh Siegle is listed as a contact author but not a dandiset owner.\n28: dandiset by Matthias Hennig missing contributors and license. I have sent a request to update.\n    update: Matthias requested that we delete this dandiset\n36: Allen dandiset missing a license. Owned by Jerome. I sent a request for him to fix it.\n50: Allen dandiset missing a license. Several owners.\n51, 52: Owned by Lee Kamentsky. Missing a license and contributors. Described as a testing datasets.\n58: Owned by Lee Kamentsky. Missing contributor.\n60: Missing license.\n66: Missing a license. @satra you are an owner of this one. Can you add a license?\n68: Testing dataset by Thomas Braun missing a license.\n105: Owned by Lee Kamentsky. Validation error appears to be improper URL. See relevant issue [here](https://github.com/dandi/dandi-archive/issues/1477).\n107: missing contributors and non-supported license\n144: missing a license.\n149: contributor validation error. See relevant issue [here](https://github.com/dandi/dandi-archive/issues/1477)\n235, 236, 237, 238, 297: contributor validation error. Looks like a simple name formatting issue.\n338: validation error due to unusual Disorder metadata entry. Relevant issue [here](https://github.com/dandi/dandi-archive/issues/1478)\n362: title is too long. See relevant issue [here](https://dandiarchive.org/dandiset/000362)","files":null},{"type":2,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1675784303,"metadata":{"github-id":"RTE_lADODBZtRc5dyF1RzwAAAAH4OIVD"},"title":"`dandiset.get_metadata` not working for some dandisets","was":"`dandiset.get_metadata` not working for all dandisets"},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1675785522,"metadata":{"github-id":"IC_kwDODBZtRc5UsugB","github-url":"https://github.com/dandi/dandi-cli/issues/1205#issuecomment-1421010945"},"message":"my code was simply to show that published dandisets don't have validation errors, nothing beyond that.\n\nregarding the issues. it's going to be two fold:\n1. defining and implementing the stale dandiset policy should remove many of those but this will require both policy creation and implementation. feel free to start a design doc in this archive on this.\n2. for dandisets that seem important to get the authors/team to fix things. we can offer to help fix some of the metadata issues for now. \n\nfor the general issue, we will not necessarily have valid draft dandisets, for whatever reason. hence i don't think any code can assume it to be valid at that stage. we can keep improving all kinds of interfaces, but we have not imposed a zero tolerance model for all aspects of validity. we have only done so for triggering publication.\n\nalso these are the metadata issues, once we trigger layout validation, several of these dandisets will be invalid as well. we need to add that to the validation services. (@yarikoptic - this was done outside of dandi schema and also related to web-based validation, rather than local validation).","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1675786493,"metadata":{"github-id":"IC_kwDODBZtRc5Us1GE","github-url":"https://github.com/dandi/dandi-cli/issues/1205#issuecomment-1421037956"},"message":"\u003e my code was simply to show that published dandisets don't have validation errors, nothing beyond that.\n\nah ok I see.\n\n\u003e for the general issue, we will not necessarily have valid draft dandisets, for whatever reason. hence i don't think any code can assume it to be valid at that stage. we can keep improving all kinds of interfaces, but we have not imposed a zero tolerance model for all aspects of validity. we have only done so for triggering publication.\n\nIt makes sense to me why we would allow for improper metadata for old datasets that were created before certain rules were in place. It seems to me the best approach there is to work with these groups to update the metadata, which ideally would be a simple task. For new dandisets, I don't see why we would allow the creation of metadata that does not follow our schema. Why aren't we properly validating this data in the metadata editor form? In my opinion, every way a user is able to use the web UI to create improper metadata is a bug in the metadata editor form validation. I also think this is true for the API, but I feel a bit less strongly about that. In the current state, there is not enough enforcement on the metadata to facilitate simple structured queries, particularly if you are requiring metadata to fit the schema perfectly to even build the metadata object I am meant to be querying. I can run queries on the `raw_metadata` hierarchical dictionary, which is what I have been doing, but this requires logic all over the place for the random non-compliant metadata dictionaries.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1675792306,"metadata":{"github-id":"IC_kwDODBZtRc5Utd59","github-url":"https://github.com/dandi/dandi-cli/issues/1205#issuecomment-1421205117"},"message":"NB I think the discussion is great but have potential to derail. Hence for \n\n\u003e (@yarikoptic - this was done outside of dandi schema and also related to web-based validation, rather than local validation).\n\nfiled https://github.com/dandi/dandi-schema/issues/157 so we better continue on that aspect there.","files":null}]}