{"version":2,"ops":[{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1627047311,"metadata":{"github-id":"IC_kwDODBZtRc40ydjx","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885643505"},"message":"@satra Exactly what behavior here do you have a problem with?","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1627048167,"metadata":{"github-id":"IC_kwDODBZtRc40yfva","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885652442"},"message":"that the CLI is trying to re-upload a blob that exists according to the server, which returns a 409. CLI should not be trying to re-upload a blob that exists.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1627048282,"metadata":{"github-id":"IC_kwDODBZtRc40ygDY","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885653720"},"message":"also bringing @dchiquito into this thread. there are two 409s in the above log:\n\n1. for blob exists\n2. for path exists\n\nfor the mortal user we need to know what to do when these errors happen.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1627048294,"metadata":{"github-id":"IC_kwDODBZtRc40ygFh","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885653857"},"message":"@satra Be more precise.  What is the earliest point in the logs that you think the client should do something different?","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1627048669,"metadata":{"github-id":"IC_kwDODBZtRc40yhE_","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885657919"},"message":"those 409s should not happen ever (i think). those errors indicate something is problematic in the interaction between the CLI and the API. i think CLI logic should be able to address this properly.\n\nthe first 409, CLI should not try to initialize an upload\nthe second 409, the CLI should use PUT not POST","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1627048749,"metadata":{"github-id":"IC_kwDODBZtRc40yhSh","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885658785"},"message":"@satra The first 409 is 100% intentional and will not change.  The 409 response to the request to start an upload is how the client knows that the blob already exists on the server.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627048828,"metadata":{"github-id":"IC_kwDODBZtRc40yhf6","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885659642"},"message":"I think it is due to https://github.com/dandi/dandi-api/issues/441 isn't it?","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627048897,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDgxMDg1NTY5"},"target":"dcc4841b86199323b5ff1b7ed1285600f33790aaf2d692dbdfe9d4c45ab9cd20","message":"I think it is due to https://github.com/dandi/dandi-api/issues/441 isn't it?\n\nedit: and, if I got it right, it is something to address on dandi-api side - I don't think client should see those as long as desired effect is achieved","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1627048875,"metadata":{"github-id":"IC_kwDODBZtRc40yhoc","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885660188"},"message":"@jwodder - i thought the check whether a blob exists or not happens with this api route (`/blobs/digest/`)","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627048954,"metadata":{"github-id":"IC_kwDODBZtRc40yh3M","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885661132"},"message":"\u003e @jwodder - i thought the check whether a blob exists or not happens with this api route (`/blobs/digest/`)\n\nif it is caused by https://github.com/dandi/dandi-api/issues/441 (do you have identical files you are uploading?) -- then it is \"too late\" -- files were not there before uploading multiple instances of them with the same digest","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1627048969,"metadata":{"github-id":"IC_kwDODBZtRc40yh50","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885661300"},"message":"@yarikoptic - that should not be the issue here i think. the blob is already there and i'm not doing simultaneous uploads of the same blob.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627049422,"metadata":{"github-id":"IC_kwDODBZtRc40yjNY","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885666648"},"message":"\u003e @yarikoptic - that should not be the issue here i think. the blob is already there and i'm not doing simultaneous uploads of the same blob.\n\nah, right... so it all boils down to initial 409 is Ok, we react to it properly but then\n```\n2021-07-23T09:28:12-0400 [DEBUG   ] dandi 1689420:140136165803776 POST https://api.dandiarchive.org/api/dandisets/000108/versions/draft/assets/\n2021-07-23T09:28:12-0400 [DEBUG   ] dandi 1689420:140136165803776 Response: 409\n2021-07-23T09:28:12-0400 [DEBUG   ] dandi 1689420:140136165803776 Error 409 while sending POST request to https://api.dandiarchive.org/api/dandisets/000108/versions/draft/assets/: \"An asset with that path already exists\"\n```\nI think is possibly some new or not yet tested (?) behavior of \"reupload a previously uploaded file under a new filename, which also already known to the dataset version\".  IIRC we did not decide to introduce any guards on dandi-api side for overrides, so in principle it should dandi-api which should handle it instead of returning 409 ?  Or do we want to provide guards for overwrites at dandi-api side, causing it always to 409 when overwriting and leaving it to client to first delete that asset? (wasn't like that I believe in our original thinking)","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627049455,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDgxMDg4MzYy"},"target":"143cb8c474abffea4dda521e2673859b7597f77bcd7c15ff5277b164e6781dce","message":"\u003e @yarikoptic - that should not be the issue here i think. the blob is already there and i'm not doing simultaneous uploads of the same blob.\n\nah, right... so it all boils down to initial 409 is Ok, we react to it properly but then\n```\n2021-07-23T09:28:12-0400 [DEBUG   ] dandi 1689420:140136165803776 POST https://api.dandiarchive.org/api/dandisets/000108/versions/draft/assets/\n2021-07-23T09:28:12-0400 [DEBUG   ] dandi 1689420:140136165803776 Response: 409\n2021-07-23T09:28:12-0400 [DEBUG   ] dandi 1689420:140136165803776 Error 409 while sending POST request to https://api.dandiarchive.org/api/dandisets/000108/versions/draft/assets/: \"An asset with that path already exists\"\n```\nI think is possibly some new or not yet tested (?) behavior of \"reupload a previously uploaded file under a new filename, which also already known to the dataset version\" (edit: might also matter if the same blob or not).  IIRC we did not decide to introduce any guards on dandi-api side for overrides, so in principle it should dandi-api which should handle it instead of returning 409 ?  Or do we want to provide guards for overwrites at dandi-api side, causing it always to 409 when overwriting and leaving it to client to first delete that asset? (wasn't like that I believe in our original thinking)","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1627050073,"metadata":{"github-id":"IC_kwDODBZtRc40ylGA","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885674368"},"message":"IMO:\n\n1. CLI should check if blob is there. if not upload (seems like this is in place, but should just use a different endpoint instead of trying to initialize an upload and thereby checking)\n2. CLI should check if asset path is there and then use PUT instead of POST. the API just introduced the 409 on trying to POST an asset to a path that exists. (this was the duplication issue we saw with the same dataset earlier)\n\nseems both are handleable at the CLI level.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627053626,"metadata":{"github-id":"IC_kwDODBZtRc40yuxx","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885714033"},"message":"\u003e 1. CLI should check if blob is there. if not upload (seems like this is in place, but should just use a different endpoint instead of trying to initialize an upload and thereby checking)\n\nnah... that would cause yet another race condition since operation of \"check and then do or not\" isn't atomic, so you would then even more likely end up in the same situation anyways whenever e.g. parallel uploads would upload the same sizeable blob. I believe it was conscious a decision to avoid that at least for this part and just initiate the upload and react on return value, which is what we do now. I think it is ok as is - that 409 you see is at DEBUG log level, and is ok at that.\n\n\u003e 2\\. CLI should check if asset path is there and then use PUT instead of POST. the API just introduced the 409 on trying to POST an asset to a path that exists. (this was the duplication issue we saw with the same dataset earlier)\n\nin a short term -- \"may be\", since it again opens the door wider for race conditions and thus flaky operation. Reacting to 409 upon POST and switching to PUT for a specific asset id (if only 409 response included it) would also be racy, so in the long term neither of those ways wouldn't be a \"solid\" mechanism. Also I am not yet sure what PUT would do if we are to provide metadata which overwrites asset at some other path -- would it work or 409? ;-)  Note: we already have a race condition anyways since we first check if there is an asset at the path, and handle according to `--overwrite` option.  That is why in a short term indeed we should probably just use PUT instead of POST if we know which asset we are to \"replace\".  @jwodder - please do that for now, with a nice test which would also test on a use case where it is already a known blob. But note I am not yet sure if `PUT` would not 409 and either it would replace an existing asset or breed one more.\n\nI started to write up my thoughts in an issue against dandi-api since PUT semantic is not clear (and doc in swagger just says \"Update the metadata of an asset.\" without hinting on replacement or what would happen in case of path in metadata change or absence), but I guess I will just wait for @jwodder to discover details of behavior.","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627053671,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDgxMTExMjU5"},"target":"3ccb2750b898ce74d271358819e4114d38265783cfcbd0b9eb2e4495549d1918","message":"\u003e 1. CLI should check if blob is there. if not upload (seems like this is in place, but should just use a different endpoint instead of trying to initialize an upload and thereby checking)\n\nnah... that would cause yet another race condition since operation of \"check and then do or not\" isn't atomic, so you would then even more likely end up in the same situation anyways whenever e.g. parallel uploads would upload the same sizeable blob. I believe it was a conscious decision to avoid a race at least for this part, and just initiate the upload and react on return value, which is what we do now. I think it is ok as is - that 409 you see is at DEBUG log level, and is ok at that.\n\n\u003e 2\\. CLI should check if asset path is there and then use PUT instead of POST. the API just introduced the 409 on trying to POST an asset to a path that exists. (this was the duplication issue we saw with the same dataset earlier)\n\nin a short term -- \"may be\", since it again opens the door wider for race conditions and thus flaky operation. Reacting to 409 upon POST and switching to PUT for a specific asset id (if only 409 response included it) would also be racy, so in the long term neither of those ways wouldn't be a \"solid\" mechanism. Also I am not yet sure what PUT would do if we are to provide metadata which overwrites asset at some other path -- would it work or 409? ;-)  Note: we already have a race condition anyways since we first check if there is an asset at the path, and handle according to `--overwrite` option.  That is why in a short term indeed we should probably just use PUT instead of POST if we know which asset we are to \"replace\".  @jwodder - please do that for now, with a nice test which would also test on a use case where it is already a known blob. But note I am not yet sure if `PUT` would not 409 and either it would replace an existing asset or breed one more.\n\nI started to write up my thoughts in an issue against dandi-api since PUT semantic is not clear (and doc in swagger just says \"Update the metadata of an asset.\" without hinting on replacement or what would happen in case of path in metadata change or absence), but I guess I will just wait for @jwodder to discover details of behavior.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1627054931,"metadata":{"github-id":"IC_kwDODBZtRc40yyHS","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885727698"},"message":"indeed we can potentially get into race conditions, but highly unlikely in the same dataset, even if used by multiple owners or the same owner across machines (consider parallel uploads in network bottlenecked machines). \n\ncurrently `PUT` or `POST` always breeds new asset. \n\nif we wanted `PUT` to not breed a new asset id, that's a discussion we need to have. there may be certain advantages and disadvantages to that, and it's going to be a semantic call. at present i prefer the current scenario of minting new asset id on PUT.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1627059051,"metadata":{"github-id":"IC_kwDODBZtRc40y8J3","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885768823"},"message":"@yarikoptic The upload code already uses PUT if uploading an asset to a path that already exists; [see here](https://github.com/dandi/dandi-cli/blob/457c1e519c3daa75f729f686e963e637e5a78e91/dandi/dandiapi.py#L696-L712).\n\n@satra Exactly what was going on with the Dandiset you were uploading?  Had the exact same asset been uploaded to the same path before, or did something change in the local Dandiset between uploads?","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1627059512,"metadata":{"github-id":"IC_kwDODBZtRc40y9MI","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885773064"},"message":"i think the version of the CLI changed, which would change the metadata. so between uploads the local metadata changed.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627060361,"metadata":{"github-id":"IC_kwDODBZtRc40y_KY","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885781144"},"message":"\u003e currently `PUT` or `POST` always breeds new asset.\n\u003e \n\u003e if we wanted `PUT` to not breed a new asset id, that's a discussion we need to have. there may be certain advantages and disadvantages to that, and it's going to be a semantic call. at present i prefer the current scenario of minting new asset id on PUT.\n\nI wasn't exhaustive/confusing in my description:  both PUT and POST should breed new assets and thus asset_ids.  My point was about what is happening to an already existing asset?  if `PUT` is to \"update an asset\", then it should \"remove\" the previous asset from the dandiset_version, and thus in effect \"replace\" it with a new one, which might or might not have a different path (depending on what metadata had, right), and that is where I was afraid (and @jwodder /code seems to confirm) that `PUT` is not doing that and issues 409 since both old and new assets exist and point to the same path.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627060490,"metadata":{"github-id":"IC_kwDODBZtRc40y_cX","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885782295"},"message":"Let's bring @dchiquito into discussion since it seems to boil down to dandi-api:  does `PUT` on an asset in a dandiset removes (from dandiset_version not assets) previous asset first before creating/placing a new one \"to replace the old one\"? if it does not -- then we would be running into recently introduced protection to not breed duplicate assets.","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1627069499,"metadata":{"github-id":"IC_kwDODBZtRc40zWLf","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885875423"},"message":"PUT adds the new asset and removes the old asset in a transaction: https://github.com/dandi/dandi-api/blob/master/dandiapi/api/views/asset.py#L236-L248\n\nI'm not sure why we're discussing `PUT` here. Satra's logs indicate that the 409 related to the duplicate path was returned from a `POST`. The [code John linked](https://github.com/dandi/dandi-cli/blob/457c1e519c3daa75f729f686e963e637e5a78e91/dandi/dandiapi.py#L696-L712) looks correct to me, so my suspicion is that there was a race condition where a different client registered an asset at that path between the GET and the POST.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1627069671,"metadata":{"github-id":"IC_kwDODBZtRc40zWiE","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885876868"},"message":"\u003e my suspicion is that there was a race condition where a different client registered an asset at that path between the GET and the POST.\n\nwould be very unlikely. since i am the only one uploading this data. so remains a mystery how this knot was created.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1627069729,"metadata":{"github-id":"IC_kwDODBZtRc40zWro","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885877480"},"message":"the discussion for PUT is that an asset check for existence of an asset at a given path should then result in a PUT and not a POST.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627076128,"metadata":{"github-id":"IC_kwDODBZtRc40zie-","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-885925822"},"message":"indeed I have missed that it was a POST, whenever it should have been PUT.  Not sure yet what is going on either.  Would be nice if we could reproduce on a small example.   \n@jwodder 's [code](https://github.com/dandi/dandi-cli/blob/457c1e519c3daa75f729f686e963e637e5a78e91/dandi/dandiapi.py#L516) working around the limitation of API (which can in fact contribute to the racing) to not be able to check for exact path (filed https://github.com/dandi/dandi-api/issues/444) seems right, it is a bit \"python idiosyncratic\" and thus I wouldn't be surprised that somehow it fell through some crack.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627306086,"metadata":{"github-id":"IC_kwDODBZtRc402gcl","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-886703909"},"message":"In the `iter_upload_raw_asset` you @jwodder  [pointed to](https://github.com/dandi/dandi-cli/blob/457c1e519c3daa75f729f686e963e637e5a78e91/dandi/dandiapi.py#L696-L712) let's just \n- avoid `self.get_asset_by_path(asset_path)` - as I have mentioned in https://github.com/dandi/dandi-api/issues/444 could be inefficient in its current manifestation, and adds yet another race condition point\n- just react on 509 and switch from POST to PUT if it happens -- we have done check for `existing` above and can't avoid race condition ATM altogether but at least could may be minimize it this way.  The only race at this point could be a removal of an asset to happen between POST and PUT -- less likely IMHO","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1627307262,"metadata":{"github-id":"IC_kwDODBZtRc402kEc","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-886718748"},"message":"@yarikoptic `get_asset_by_path(asset_path)` is required in order to get the ID of the asset to update with PUT.  Would calling that method only in response to a 409 be safe?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627309331,"metadata":{"github-id":"IC_kwDODBZtRc402rQL","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-886748171"},"message":"\u003e @yarikoptic `get_asset_by_path(asset_path)` is required in order to get the ID of the asset to update with PUT.\n\nd'oh, right... so it was not an actionable idea :-/  \n\nlooking at the code, https://github.com/dandi/dandi-cli/blob/457c1e519c3daa75f729f686e963e637e5a78e91/dandi/dandiapi.py#L510:9 provides no guards for path to be relative - I wonder if that is a culprit here somehow since then `self.path == path` comparison could fail for the same path if path is abs on one side.  @satra -- did you use absolute paths in your invocation, do you remember?\n\nIn `upload.py` we use `extant = remote_dandiset.get_asset_by_path(str(relpath))`  so we do use `relpath` whenever `iter_upload_raw_asset(` uses `asset_path` which is coming from `asset_path = asset_metadata[\"path\"]` and I have vague memory we had some issue relating to abs paths sneaking in.  I think we might want to add some guards, even if just an `assert` here where we assume it is relative.\n\nbut then we still ideally should avoid double `get_asset_by_path` invocation.  I think one of the viable ways is to add `replace_asset: Optional[str] = None` argument to `iter_upload_raw_asset` so that `upload` code, in case of replacing an asset, could pass it through.  If provided (and not `None`) -- use `PUT` with that `replace_asset` id not `POST`.  This way\n\n- change semantic of `iter_upload_raw_asset` that it wouldn't silently replace an asset\n- we do amplify the possibility for a race condition (in case some other asset uploaded to that path meanwhile)\n\nbut I think it would be actually for a benefit -- at least will be making it a bit more \"solid\" that we wouldn't be overwriting some other asset which we haven't \"analyzed\" for above, and also a bit faster avoiding 2nd invocation of `get_asset_by_path`.\n\n\u003e Would calling that method only in response to a 409 be safe?\n\nwhat do you mean ?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1627309500,"metadata":{"github-id":"IC_kwDODBZtRc402r06","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-886750522"},"message":"@yarikoptic \n\n\u003e what do you mean ?\n\nI mean, would you consider calling `get_asset_by_path(asset_path)` if \u0026 only if a 409 occurs when POSTing to be a viable solution?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627310031,"metadata":{"github-id":"IC_kwDODBZtRc402tkv","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-886757679"},"message":"ah... well, could have been, unless the original issue is in that code/invocation (e.g. relative paths hypothesis above).  But I think we would be better of making this one to not do magical \"replace an asset\" unless instructed to do so (per my description above) altogether. WDYT about that ?","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1627310057,"metadata":{"github-id":"IC_kwDODBZtRc402tqN","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-886758029"},"message":"\u003e did you use absolute paths in your invocation, do you remember?\n\nno. it was a relative path within the dandiset directory. and i believe i tried with both `.` syntax and the individual file. both resulted in the 509 error.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1627310445,"metadata":{"github-id":"IC_kwDODBZtRc402u5I","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-886763080"},"message":"@yarikoptic If `replace_asset` is added to `iter_upload_raw_asset()`, should the checks that are already in the method for a pre-existing asset be kept, or should the code just error if a race condition occurs?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627312226,"metadata":{"github-id":"IC_kwDODBZtRc4021AI","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-886788104"},"message":"\u003e \u003e did you use absolute paths in your invocation, do you remember?\n\u003e \n@satra \n\n\u003e no. it was a relative path within the dandiset directory. and i believe i tried with both `.` syntax and the individual file. both resulted in the 509 error.\n\nwhat was your `--existing` setting, may be somehow related... ?\n\n@jwodder \n\n\u003e @yarikoptic If `replace_asset` is added to `iter_upload_raw_asset()`, should the checks that are already in the method for a pre-existing asset be kept, or should the code just error if a race condition occurs?\n\nif you mean that invocation of `get_asset_by_path` - I think there should be no checks in `iter_upload_raw_asset` since we have that logic in higher level `upload` ATM.  docstring should just state that if intention is to replace an existing asset, then `replace_asset` should be provided and point to an existing in that dandiset version asset.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1627315962,"metadata":{"github-id":"IC_kwDODBZtRc403BRU","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-886838356"},"message":"\u003e what was your `--existing` setting, may be somehow related... ?\n\nthe default. i didn't override it at all.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627320567,"metadata":{"github-id":"IC_kwDODBZtRc403OQE","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-886891524"},"message":"interesting ... default is\n```\n                                  'refresh' - upload only if local modification time is ahead of the remote.\n                                  [default: refresh]\n```\n@jwodder could you please analyze the logs (we have them on drogon now, `/mnt/backup/dandi/papertrail-logs/dandi-api/2021/07/23` for that date), and/or try to replicate the fail uploading/touch/reupload or alike? ideally we should get to the bottom of this, or we would just keep running into it.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1627322367,"metadata":{"github-id":"IC_kwDODBZtRc403Ssx","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-886909745"},"message":"@yarikoptic I could not find anything relevant in the logs, and I was unable to reproduce the error locally.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627408639,"metadata":{"github-id":"IC_kwDODBZtRc406XOh","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-887714721"},"message":"So, @jwodder let's then proceed with adding `replace_asset` as I described [above](https://github.com/dandi/dandi-cli/issues/736#issuecomment-886748171), unless you have some concerns about such approach.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627424754,"metadata":{"github-id":"IC_kwDODBZtRc406-Wl","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-887874981"},"message":"@satra  - you no longer have that file/situation any longer to try to reproduce and see if #743 somehow magically addresses it, do you?","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1627428932,"metadata":{"github-id":"IC_kwDODBZtRc407E-U","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-887902100"},"message":"that is correct. i manually fixed the issue.","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627481484,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50NTA4MDQyNzIwMg=="},"status":2},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1627499980,"metadata":{"github-id":"IC_kwDODBZtRc409lN2","github-url":"https://github.com/dandi/dandi-cli/issues/736#issuecomment-888558454"},"message":"I guess we will need to wait for it to resurface one way or another to \"resolve the mystery\" since I am still not certain on what lead to it.","files":null}]}