{"version":2,"ops":[{"type":5,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1675299197,"metadata":{"github-id":"LE_lADODBZtRc5daG-0zwAAAAH1o1vs"},"added":["UX"],"removed":[]},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1675700526,"metadata":{"github-id":"IC_kwDODBZtRc5Uma6q","github-url":"https://github.com/dandi/dandi-cli/issues/1197#issuecomment-1419357866"},"message":"@yarikoptic \n\n\u003e To improve feedback to the user, if any upload fails - exit with non-O.\n\nShould failing validation count as an upload failing?","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1675700568,"metadata":{"github-id":"UCE_lALODBZtRc5Uma6qzizjEt4"},"target":"ae35253e989f3631faafa12eff7f34014db1e8377b4a8ed287a2288ec7a10fe4","message":"@yarikoptic \n\n\u003e To improve feedback to the user, if any upload fails - exit with non-O.\n\nShould failing validation count as an upload failing?  What about the various calls to `skip_file()` for things like a file not being found or failure to compute a digest?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1675704759,"metadata":{"github-id":"IC_kwDODBZtRc5Um1D1","github-url":"https://github.com/dandi/dandi-cli/issues/1197#issuecomment-1419464949"},"message":"\u003e \u003e To improve feedback to the user, if any upload fails - exit with non-O.\n\u003e \n\u003e Should failing validation count as an upload failing? \n\nif it is not `--validation ignore`, ie. not resulted in failed upload - then not. If it resulted in failed upload - then yes, should count as upload failing.\n\n\u003e What about the various calls to `skip_file()` for things like a file not being found or failure to compute a digest?\n\nthey result in ERROR status for them, right? then exit with non-0 too.  Pretty much - `exit 0` only if uploads went fine per user instructions (ignore validation or not).","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1675704869,"metadata":{"github-id":"IC_kwDODBZtRc5Um16L","github-url":"https://github.com/dandi/dandi-cli/issues/1197#issuecomment-1419468427"},"message":"@yarikoptic\n\n\u003e they result in ERROR status for them, right?\n\nNo, `skip_file()` results in `\"status\": \"skipped\"`.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1675706283,"metadata":{"github-id":"IC_kwDODBZtRc5UnAkl","github-url":"https://github.com/dandi/dandi-cli/issues/1197#issuecomment-1419512101"},"message":"oh, indeed: we used `skip_file` without discriminating between skipping for \"legit\" (no update to upload,\n\n- we do not skip but raise error if file `existing == \"error\"`:\n```\n    if existing == \"error\":\n        # as promised -- not gentle at all!\n        raise FileExistsError(exists_msg)\n```\n\n- for not found etc, we indeed to not raise an error but add \"ERROR\" into message for status `\"skipped\"`\n```\n                    try:\n                        yield {\"size\": dfile.size}\n                    except FileNotFoundError:\n                        yield skip_file(\"ERROR: File not found\")\n                        return\n                    except Exception as exc:\n                        # without limiting [:50] it might cause some pyout indigestion\n                        yield skip_file(\"ERROR: %s\" % str(exc)[:50])\n                        return\n```\n- we do `yield skip_file(\"failed validation\")`  for `\"required\"` validation\n- for benign `dandiset.yaml` skip we do `yield skip_file(\"should be edited online\")` \n- for failing to digest : `yield skip_file(\"failed to compute digest: %s\" % str(exc))` \n\nif we were to separate our `skip_file` and `error_file` scenarios, I think\n\n\u003cdetails\u003e\n\u003csummary\u003ethis would be the diff (made status `ERROR` capitalized as found being done \u003c/summary\u003e \n\n```patch\ndiff --git a/dandi/upload.py b/dandi/upload.py\nindex 29be508b..399ae135 100644\n--- a/dandi/upload.py\n+++ b/dandi/upload.py\n@@ -129,11 +129,11 @@ def upload(\n                     try:\n                         yield {\"size\": dfile.size}\n                     except FileNotFoundError:\n-                        yield skip_file(\"ERROR: File not found\")\n+                        yield error_file(\"File not found\")\n                         return\n                     except Exception as exc:\n                         # without limiting [:50] it might cause some pyout indigestion\n-                        yield skip_file(\"ERROR: %s\" % str(exc)[:50])\n+                        yield error_file(str(exc)[:50])\n                         return\n \n                 #\n@@ -157,7 +157,7 @@ def upload(\n                             )\n                             for i, e in enumerate(validation_errors, start=1):\n                                 lgr.warning(\" Error %d: %s\", i, e)\n-                            yield skip_file(\"failed validation\")\n+                            yield error_file(\"failed validation\")\n                             return\n                     else:\n                         yield {\"status\": \"validated\"}\n@@ -196,7 +196,7 @@ def upload(\n                     try:\n                         file_etag = dfile.get_digest()\n                     except Exception as exc:\n-                        yield skip_file(\"failed to compute digest: %s\" % str(exc))\n+                        yield error_file(\"failed to compute digest: %s\" % str(exc))\n                         return\n \n                 try:\n@@ -228,7 +228,7 @@ def upload(\n                         digest=file_etag, ignore_errors=allow_any_path\n                     ).json_dict()\n                 except Exception as e:\n-                    yield skip_file(\"failed to extract metadata: %s\" % str(e))\n+                    yield error_file(\"failed to extract metadata: %s\" % str(e))\n                     return\n \n                 #\n@@ -314,7 +314,7 @@ def upload(\n                     else:\n                         rec[tuple(rec_fields[1:])] = process_path(dfile)\n                 except ValueError as exc:\n-                    rec.update(skip_file(exc))\n+                    rec.update(error_file(exc))\n                 out(rec)\n \n         if sync:\n@@ -390,3 +390,7 @@ def check_replace_asset(\n \n def skip_file(msg: Any) -\u003e Dict[str, str]:\n     return {\"status\": \"skipped\", \"message\": str(msg)}\n+\n+\n+def error_file(msg: Any) -\u003e Dict[str, str]:\n+    return {\"status\": \"ERROR\", \"message\": str(msg)}\n```\n\u003c/details\u003e\n\nand then we could exit non-0 if any reported `ERROR` status, but may be then there instead of `return`ing we should just raise some exception -- it then should be caught at https://github.com/dandi/dandi-cli/blob/master/dandi/upload.py#L255, list within `uploaded_paths` and yield ERROR status record.","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1675706301,"metadata":{"github-id":"UCE_lALODBZtRc5UnAklzizkiLk"},"target":"f48a7d5118f86df889f748c5a92b4e5ef9ce33e6b7fcc4d6112e02aae579dd73","message":"oh, indeed: we used `skip_file` without discriminating between skipping for \"legit\" and not reasons:\n\n- we do not skip but raise error if file `existing == \"error\"`:\n```\n    if existing == \"error\":\n        # as promised -- not gentle at all!\n        raise FileExistsError(exists_msg)\n```\n\n- for not found etc, we indeed to not raise an error but add \"ERROR\" into message for status `\"skipped\"`\n```\n                    try:\n                        yield {\"size\": dfile.size}\n                    except FileNotFoundError:\n                        yield skip_file(\"ERROR: File not found\")\n                        return\n                    except Exception as exc:\n                        # without limiting [:50] it might cause some pyout indigestion\n                        yield skip_file(\"ERROR: %s\" % str(exc)[:50])\n                        return\n```\n- we do `yield skip_file(\"failed validation\")`  for `\"required\"` validation\n- for benign `dandiset.yaml` skip we do `yield skip_file(\"should be edited online\")` \n- for failing to digest : `yield skip_file(\"failed to compute digest: %s\" % str(exc))` \n\nif we were to separate our `skip_file` and `error_file` scenarios, I think\n\n\u003cdetails\u003e\n\u003csummary\u003ethis would be the diff (made status `ERROR` capitalized as found being done \u003c/summary\u003e \n\n```patch\ndiff --git a/dandi/upload.py b/dandi/upload.py\nindex 29be508b..399ae135 100644\n--- a/dandi/upload.py\n+++ b/dandi/upload.py\n@@ -129,11 +129,11 @@ def upload(\n                     try:\n                         yield {\"size\": dfile.size}\n                     except FileNotFoundError:\n-                        yield skip_file(\"ERROR: File not found\")\n+                        yield error_file(\"File not found\")\n                         return\n                     except Exception as exc:\n                         # without limiting [:50] it might cause some pyout indigestion\n-                        yield skip_file(\"ERROR: %s\" % str(exc)[:50])\n+                        yield error_file(str(exc)[:50])\n                         return\n \n                 #\n@@ -157,7 +157,7 @@ def upload(\n                             )\n                             for i, e in enumerate(validation_errors, start=1):\n                                 lgr.warning(\" Error %d: %s\", i, e)\n-                            yield skip_file(\"failed validation\")\n+                            yield error_file(\"failed validation\")\n                             return\n                     else:\n                         yield {\"status\": \"validated\"}\n@@ -196,7 +196,7 @@ def upload(\n                     try:\n                         file_etag = dfile.get_digest()\n                     except Exception as exc:\n-                        yield skip_file(\"failed to compute digest: %s\" % str(exc))\n+                        yield error_file(\"failed to compute digest: %s\" % str(exc))\n                         return\n \n                 try:\n@@ -228,7 +228,7 @@ def upload(\n                         digest=file_etag, ignore_errors=allow_any_path\n                     ).json_dict()\n                 except Exception as e:\n-                    yield skip_file(\"failed to extract metadata: %s\" % str(e))\n+                    yield error_file(\"failed to extract metadata: %s\" % str(e))\n                     return\n \n                 #\n@@ -314,7 +314,7 @@ def upload(\n                     else:\n                         rec[tuple(rec_fields[1:])] = process_path(dfile)\n                 except ValueError as exc:\n-                    rec.update(skip_file(exc))\n+                    rec.update(error_file(exc))\n                 out(rec)\n \n         if sync:\n@@ -390,3 +390,7 @@ def check_replace_asset(\n \n def skip_file(msg: Any) -\u003e Dict[str, str]:\n     return {\"status\": \"skipped\", \"message\": str(msg)}\n+\n+\n+def error_file(msg: Any) -\u003e Dict[str, str]:\n+    return {\"status\": \"ERROR\", \"message\": str(msg)}\n```\n\u003c/details\u003e\n\nand then we could exit non-0 if any reported `ERROR` status, but may be then there instead of `return`ing we should just raise some exception -- it then should be caught at https://github.com/dandi/dandi-cli/blob/master/dandi/upload.py#L255, list within `uploaded_paths` and yield ERROR status record.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1675706853,"metadata":{"github-id":"IC_kwDODBZtRc5UnEKo","github-url":"https://github.com/dandi/dandi-cli/issues/1197#issuecomment-1419526824"},"message":"@yarikoptic \n\n\u003e but may be then there instead of returning we should just raise some exception -- it then should be caught at https://github.com/dandi/dandi-cli/blob/master/dandi/upload.py#L255, list within uploaded_paths and yield ERROR status record.\n\nI'm not entirely clear on what you're suggesting here.  Are you saying that, in addition to changing the given uses of `skip_file()` to `error_file()`, we should change the `return`s after them to `raise Something` so that the code under line 255 is run?  That would result in the same error message being emitted twice.  What about making `error_file()` raise a custom exception containing the given message instead of returning a status dict so that the \"ERROR\" status is only emitted under line 255?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1675707358,"metadata":{"github-id":"IC_kwDODBZtRc5UnHrM","github-url":"https://github.com/dandi/dandi-cli/issues/1197#issuecomment-1419541196"},"message":"sorry I was cryptic -- I was thinking of what you suggested:\n\n\u003e making error_file() raise a custom exception containing the given message instead of returning a status dict so that the \"ERROR\" status is only emitted under line 255?","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1675801984,"metadata":{"github-id":"CE_lADODBZtRc5daG-0zwAAAAH4XnsA"},"status":2},{"type":3,"author":{"id":"7a8552494914d3e4116f4b434eb4812a914ca405"},"timestamp":1676065603,"metadata":{"github-id":"IC_kwDODBZtRc5VBOKr","github-url":"https://github.com/dandi/dandi-cli/issues/1197#issuecomment-1426383531"},"message":"\u003c!-- GITHUB_RELEASE COMMENT: released --\u003e\n:rocket: Issue was released in [`0.49.0`](https://github.com/dandi/dandi-cli/releases/tag/0.49.0) :rocket:","files":null},{"type":5,"author":{"id":"7a8552494914d3e4116f4b434eb4812a914ca405"},"timestamp":1676065604,"metadata":{"github-id":"LE_lADODBZtRc5daG-0zwAAAAH6SIyM"},"added":["released"],"removed":[]}]}