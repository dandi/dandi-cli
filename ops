{"version":2,"ops":[{"type":1,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1742845438,"metadata":{"github-id":"I_kwDODBZtRc6vflOk","github-url":"https://github.com/dandi/dandi-cli/issues/1598","origin":"github"},"title":"Make connections retry in more spots","message":"\u003cdetails\u003e\n\u003csummary\u003eeg. this one -- should not just fail, but rather retry a number of times. So we might want to provision it somehow more globally\u003c/summary\u003e \n\n```shell\n=================================== FAILURES ===================================\n_ test_parse_api_url[https://gui.dandiarchive.org/#/dandiset/000001-parsed_url0] _\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/connectionpool.py:787: in urlopen\n    response = self._make_request(\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/connectionpool.py:488: in _make_request\n    raise new_e\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/connectionpool.py:464: in _make_request\n    self._validate_conn(conn)\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/connectionpool.py:1093: in _validate_conn\n    conn.connect()\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/connection.py:741: in connect\n    sock_and_verified = _ssl_wrap_socket_and_match_hostname(\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/connection.py:920: in _ssl_wrap_socket_and_match_hostname\n    ssl_sock = ssl_wrap_socket(\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/util/ssl_.py:460: in ssl_wrap_socket\n    ssl_sock = _ssl_wrap_socket_impl(sock, context, tls_in_tls, server_hostname)\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/util/ssl_.py:504: in _ssl_wrap_socket_impl\n    return ssl_context.wrap_socket(sock, server_hostname=server_hostname)\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/ssl.py:513: in wrap_socket\n    return self.sslsocket_class._create(\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/ssl.py:1104: in _create\n    self.do_handshake()\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/ssl.py:1375: in do_handshake\n    self._sslobj.do_handshake()\nE   ConnectionResetError: [Errno 104] Connection reset by peer\n\nDuring handling of the above exception, another exception occurred:\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/requests/adapters.py:667: in send\n    resp = conn.urlopen(\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/connectionpool.py:841: in urlopen\n    retries = retries.increment(\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/util/retry.py:474: in increment\n    raise reraise(type(error), error, _stacktrace)\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/util/util.py:38: in reraise\n    raise value.with_traceback(tb)\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/connectionpool.py:787: in urlopen\n    response = self._make_request(\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/connectionpool.py:488: in _make_request\n    raise new_e\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/connectionpool.py:464: in _make_request\n    self._validate_conn(conn)\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/connectionpool.py:1093: in _validate_conn\n    conn.connect()\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/connection.py:741: in connect\n    sock_and_verified = _ssl_wrap_socket_and_match_hostname(\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/connection.py:920: in _ssl_wrap_socket_and_match_hostname\n    ssl_sock = ssl_wrap_socket(\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/util/ssl_.py:460: in ssl_wrap_socket\n    ssl_sock = _ssl_wrap_socket_impl(sock, context, tls_in_tls, server_hostname)\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/urllib3/util/ssl_.py:504: in _ssl_wrap_socket_impl\n    return ssl_context.wrap_socket(sock, server_hostname=server_hostname)\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/ssl.py:513: in wrap_socket\n    return self.sslsocket_class._create(\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/ssl.py:1104: in _create\n    self.do_handshake()\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/ssl.py:1375: in do_handshake\n    self._sslobj.do_handshake()\nE   urllib3.exceptions.ProtocolError: ('Connection aborted.', ConnectionResetError(104, 'Connection reset by peer'))\n\nDuring handling of the above exception, another exception occurred:\ndandi/tests/test_dandiarchive.py:358: in test_parse_api_url\n    assert parse_dandi_url(url) == parsed_url\ndandi/dandiarchive.py:755: in parse\n    new_url = cls.follow_redirect(url)\ndandi/dandiarchive.py:894: in follow_redirect\n    r = requests.head(url, allow_redirects=True)\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/requests/api.py:100: in head\n    return request(\"head\", url, **kwargs)\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/requests/api.py:59: in request\n    return session.request(method=method, url=url, **kwargs)\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/requests/sessions.py:589: in request\n    resp = self.send(prep, **send_kwargs)\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/requests/sessions.py:724: in send\n    history = [resp for resp in gen]\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/requests/sessions.py:724: in \u003clistcomp\u003e\n    history = [resp for resp in gen]\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/requests/sessions.py:265: in resolve_redirects\n    resp = self.send(\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/requests/sessions.py:703: in send\n    r = adapter.send(request, **kwargs)\n/opt/hostedtoolcache/Python/3.10.16/x64/lib/python3.10/site-packages/requests/adapters.py:682: in send\n    raise ConnectionError(err, request=request)\nE   requests.exceptions.ConnectionError: ('Connection aborted.', ConnectionResetError(104, 'Connection reset by peer'))\n```\n\u003c/details\u003e\n\n@jwodder do you see the best way to do that overall at requests level to retry all connection resets?","files":null}]}