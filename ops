{"version":2,"ops":[{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1621356233,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlRWRpdDo1NDEwNTEyMTU="},"target":"19d4ff5618ecef56736351138b4de77feedb9cfdc1b82fac5bf595bcf0b31762","message":"It seems that download of files from S3 directly using `datalad get` results in files just to have current date/time as mtime.  git-annex version locally is 8.20210223-1~ndall+1 .  And I thought that in general git-annex does preserve mtime as known to remote and we uploaded that key awhile back.  \n\nATM `dandi-cli` first relies on mtime to decide to either redownload/overwrite the file since default mode is `--existing=refresh` (well - may be not that good of an idea). So I think we should\n\n- ~~check if it is git-annex or our (using URLs from S3) issue which results in files with current date time~~\n- [ ] make default `--existing=error` or add `--existing=ask` (should be made to play nicely with pyout). Related: non-interactive confirmations #620 \n- [ ] become smart about git-annex: ideally ask datalad about key (could be unlocked, or adjusted branch if on windows) and deduce checksum from key.  If used backend one (we use sha256 ATM) present as digest in asset metadata - we could state \"identity\" the same and avoid 'refresh' altogether\n\n\u003cdetails\u003e\n\u003csummary\u003efull demo:\u003c/summary\u003e \n\n```shell\n(git)lena:/tmp[master]git-annex\n$\u003e datalad install -g ///dandi/dandisets/000027\n[INFO   ] Scanning for unlocked files (this may take some time)                                                                                                                                                      \n[INFO   ] access to 1 dataset sibling dandi-dandisets-dropbox not auto-enabled, enable with:                                                                                                                         \n| \t\tdatalad siblings -d \"/tmp/000027\" enable -s dandi-dandisets-dropbox \ninstall(ok): /tmp/000027 (dataset)\nget(ok): /tmp/000027/sub-RAT123/sub-RAT123.nwb (file) [from web...]                                                                                                                                                  \naction summary:\n  get (ok: 1)\n  install (ok: 1)\n(dev3) (dandi-py3.9-troubleshoot) 1 79290.....................................:Fri 07 May 2021 05:54:00 PM EDT:.\n(git)lena:/tmp[master]git-annex\n$\u003e stat -L 000027/sub-RAT123/sub-RAT123.nwb \n  File: 000027/sub-RAT123/sub-RAT123.nwb\n  Size: 18792     \tBlocks: 40         IO Block: 4096   regular file\nDevice: 10305h/66309d\tInode: 16400896    Links: 1\nAccess: (0400/-r--------)  Uid: (47521/     yoh)   Gid: (47522/     yoh)\nAccess: 2021-05-07 17:54:00.792805280 -0400\nModify: 2021-05-07 17:54:00.788805286 -0400\nChange: 2021-05-07 17:54:00.792805280 -0400\n Birth: 2021-05-07 17:54:00.744805350 -0400\n(dev3) (dandi-py3.9-troubleshoot) 1 79291.....................................:Fri 07 May 2021 05:54:10 PM EDT:.\n(git)lena:/tmp[master]git-annex\n$\u003e ls -l -L 000027/sub-RAT123/sub-RAT123.nwb\n-r-------- 1 yoh yoh 18792 May  7 17:54 000027/sub-RAT123/sub-RAT123.nwb\n(dev3) (dandi-py3.9-troubleshoot) 1 79292.....................................:Fri 07 May 2021 05:54:19 PM EDT:.\n(git)lena:/tmp[master]git-annex\n$\u003e dandi download --sync dandi://dandi/000027\nPATH                      SIZE     DONE    DONE% CHECKSUM STATUS          MESSAGE         \ndandiset.yaml                                             skipped         already exists  \nsub-RAT123/sub-RAT123.nwb 18.8 kB  18.8 kB  100%    ok    done                            \nSummary:                  18.8 kB  18.8 kB                1 skipped       1 already exists\n                                   100.00%                1 done                          \n2021-05-07 17:54:49,463 [    INFO] Logs saved in /home/yoh/.cache/dandi-cli/log/20210507215446Z-3813791.log\n(dev3) (dandi-py3.9-troubleshoot) 1 79293.....................................:Fri 07 May 2021 05:54:49 PM EDT:.\n(git)lena:/tmp[master]git-annex\n$\u003e dandi download --sync dandi://dandi/000027\nPATH                      SIZE     DONE    DONE% CHECKSUM STATUS    MESSAGE             \ndandiset.yaml                                             skipped   already exists      \nsub-RAT123/sub-RAT123.nwb                                 skipped   same time and size  \nSummary:                  0 Bytes  0 Bytes                2 skipped 1 already exists    \n                          +18.8 kB 0.00%                            1 same time and size\n2021-05-07 17:54:54,369 [    INFO] Logs saved in /home/yoh/.cache/dandi-cli/log/20210507215452Z-3813835.log\n(dev3) (dandi-py3.9-troubleshoot) 1 79293.....................................:Fri 07 May 2021 05:54:54 PM EDT:.\n(git)lena:/tmp[master]git-annex\n$\u003e ls -l -L 000027/sub-RAT123/sub-RAT123.nwb \n-rw------- 1 yoh yoh 18792 Oct 21  2020 000027/sub-RAT123/sub-RAT123.nwb\n\n```\n\u003c/details\u003e","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1621348281,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg0MzIyMzQyOQ==","github-url":"https://github.com/dandi/dandi-cli/issues/622#issuecomment-843223429"},"message":"@yarikoptic \n\n\u003e check if it is git-annex or our (using URLs from S3) issue which results in files with current date time\n\nDid you leave a word out here, perhaps around \"our\"?  What issue?  And if it is git-annex or whatever, exactly what should change?\n\n\u003e become smart about git-annex: ideally ask datalad about key\n\nDo you want to add datalad as a dependency of dandi?  That would add a lot of packages to the final installation.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1621356729,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg0MzM1NTkzNA==","github-url":"https://github.com/dandi/dandi-cli/issues/622#issuecomment-843355934"},"message":"\u003e @yarikoptic\n\u003e \n\u003e \u003e check if it is git-annex or our (using URLs from S3) issue which results in files with current date time\n\u003e \n\u003e Did you leave a word out here, perhaps around \"our\"?\n\n\"our\" as of DANDI (somewhere -- client or how we store on s3 or ...)\n\n\u003e What issue? \n\nthe one which opens the description of the issue: \"It seems that download of files from S3 directly using datalad get results in files just to have current date/time as mtime.\"\n\n\u003e And if it is git-annex or whatever, exactly what should change?\n\nprobably it is not feasible to expect keys on S3 somehow reflect the original modification time, so `datalad get` would not be able to set it for downloaded files.  So cross-ed out the first item.\n\nSo I think we should \n- default to `--existing=error`\n- for `--existing=refresh` -- if we detect that we are in a dandiset if/which we are under git-annex (there is `.git/annex` in top directory), error out\n- for `--existing=overwrite` get/compare checksum of the file locally with the one in the metadata.  Here we could rely on fscacher'ed digest but before that we could do the similar ad-hoc trick we do in https://github.com/dandi/dandisets/blob/master/tools/backups2datalad.py#L254 to get checksum which annex might know.  And if it is known to digests in metadata -- take that one instead of explicitly computing.  And if the same -- skip as the same.\n\nthis is just my thinking, so not set in stone.  WDYT @jwodder ?\n\n\u003e Do you want to add datalad as a dependency of dandi? \n\nno -- it is too heavy indeed.  Although it could be sensed via `import datalad` and used if present, but let's probably just do ad-hoc analysis although it would work only in some cases.  Then it would just fallback to regular explicit digest computing.","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1621356808,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDYxODMyNzQ1"},"target":"9616bf299ef68bc03faf283da014a44f6842ab606ebebd27fe0885b942362073","message":"\u003e @yarikoptic\n\u003e \n\u003e \u003e check if it is git-annex or our (using URLs from S3) issue which results in files with current date time\n\u003e \n\u003e Did you leave a word out here, perhaps around \"our\"?\n\n\"our\" as of DANDI (somewhere -- client or how we store on s3 or ...)\n\n\u003e What issue? \n\nthe one which opens the description of the issue: \"It seems that download of files from S3 directly using datalad get results in files just to have current date/time as mtime.\"\n\n\u003e And if it is git-annex or whatever, exactly what should change?\n\nprobably it is not feasible to expect keys on S3 somehow reflect the original modification time, so `datalad get` would not be able to set it for downloaded files.  So cross-ed out the first item.\n\nSo I think we should \n- default to `--existing=error`\n- for `--existing=refresh` -- if we detect that we are in a dandiset if/which we are under git-annex (there is `.git/annex` in top directory), error out\n- add `--existing=overwrite-different` get/compare checksum of the file locally with the one in the metadata.  Here we could rely on fscacher'ed digest but before that we could do the similar ad-hoc trick we do in https://github.com/dandi/dandisets/blob/master/tools/backups2datalad.py#L254 to get checksum which annex might know.  And if it is known to digests in metadata -- take that one instead of explicitly computing.  And if the same -- skip as the same.\n- leave `--existing=overwrite` as is\n\nNB I did edit to add explicit `--existing=overwrite-different`\n\nthis is just my thinking, so not set in stone.  WDYT @jwodder ?\n\n\u003e Do you want to add datalad as a dependency of dandi? \n\nno -- it is too heavy indeed.  Although it could be sensed via `import datalad` and used if present, but let's probably just do ad-hoc analysis although it would work only in some cases.  Then it would just fallback to regular explicit digest computing.","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1622576942,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50NDgyNzUxNzUzNA=="},"status":2}]}