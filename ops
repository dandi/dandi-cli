{"version":2,"ops":[{"type":6,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1688397654,"metadata":{"github-id":"UCE_lAHODBZtRc5qeisLzkUmGCs"},"target":"8871800522e9901a5736e9d60505f44443254e8bcfe25ee3186cbbf42275d8bd","message":"In https://github.com/dandi/helpdesk/discussions/100, @GaelleChapuis wanted to know how to query for NWB files within [the big IBL dandiset](https://dandiarchive.org/dandiset/000409) that are associated with a given publication. This dandiset contains data that are relevant to several different publications, and each NWB file lists which publications it is associated with under the field `nwbfile.related_publications`. The dandi cli currently extracts these values and adds them to the dandiset-level metadata, but not the asset-level metadata. As a result, our best approach to query for these files currently is it iterate over all of the NWB files in the dandiset, open them in stream mode, and read this value. This is very slow compared to iterating over the asset-level metadata.\n\nThe solution I would like is to use these extracted values to also populate the asset-level metadata so they can be differentiated by this attribute. Since `RelatedResource` is part of the `CommonModel` that `Asset` inherits, it looks like the schema can support this already. It's just a matter of having the dandi cli extract this information. Note that NWB files do not always contain reference to publications, and they should not be required to, since sometimes data is not associated with any publication, so this extraction logic should be robust to the case where `nwbfile.related_publication is None`.","files":null},{"type":6,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1688397680,"metadata":{"github-id":"UCE_lAHODBZtRc5qeisLzkUmGdk"},"target":"8871800522e9901a5736e9d60505f44443254e8bcfe25ee3186cbbf42275d8bd","message":"In https://github.com/dandi/helpdesk/discussions/100, @GaelleChapuis wanted to know how to query for NWB files within [the big IBL dandiset](https://dandiarchive.org/dandiset/000409) that are associated with a given publication. This dandiset contains data that are relevant to several different publications, and each NWB file lists which publications it is associated with under the field `nwbfile.related_publications`. It looks like the dandi cli currently extracts these values and adds them to the dandiset-level metadata, but not the asset-level metadata. As a result, our best approach to query for these files currently is it iterate over all of the NWB files in the dandiset, open them in stream mode, and read this value. This is very slow compared to iterating over the asset-level metadata.\n\nThe solution I would like is to use these extracted values to also populate the asset-level metadata so they can be differentiated by this attribute. Since `RelatedResource` is part of the `CommonModel` that `Asset` inherits, it looks like the schema can support this already. It's just a matter of having the dandi cli extract this information. Note that NWB files do not always contain reference to publications, and they should not be required to, since sometimes data is not associated with any publication, so this extraction logic should be robust to the case where `nwbfile.related_publication is None`.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1688398257,"metadata":{"github-id":"IC_kwDODBZtRc5gevdh","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1618671457"},"message":"i would suggest creating a function that handles mapping NWB metadata to dandi schema metadata. currently this is all done in the CLI, and reflects adaptations to NWB validation (e.g. where we wanted URIs and details like cell lines). however, the ideal thing would be a mapping function. this could exist in nwbinspector which already handles dandi specific components instead of the CLI, but i leave this to the CLI folks.","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1688399416,"metadata":{"github-id":"IC_kwDODBZtRc5gfCLW","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1618748118"},"message":"That could work. We could create a function for  mapping asset-level NWB metadata to the dandi schema for assets if the dandi cli team would be interested in incorporating this function","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1688579918,"metadata":{"github-id":"IC_kwDODBZtRc5gsTNJ","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1622225737"},"message":"To say I am not quite following why it should reside in nwbinspector which job is to inspect, not to map etc, although I do see that \"inspection\" could be carried out on a \"mapped/converted\" instance of the metadata I guess.  But I don't think that is what is happening anyways ATM.\n\nHere it seems indeed just a matter of adding more extracted metadata, which is what we already do in dandi-cli so I think it should just be done in it.","files":null},{"type":5,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1688579924,"metadata":{"github-id":"LE_lADODBZtRc5qeisLzwAAAAJEPFuQ"},"added":["easy"],"removed":[]},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1688590790,"metadata":{"github-id":"IC_kwDODBZtRc5gtVch","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1622497057"},"message":"@yarikoptic - only suggested it because there was always the lingering notion of removing some of those dictionaries and mappings out the dandi library, but i leave it as your call.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1700509381,"metadata":{"github-id":"IC_kwDODBZtRc5sdkPu","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1819689966"},"message":"@bendichter When you say the field in question is `nwbfile.related_publications`, do you mean:\n\n* The field is keyed by `\"related_publications\"` inside an NWB file\n* The field is keyed by `\"nwbfile.related_publications\"` inside an NWB file\n* The field is keyed by `\"related_publications\"` inside a mapping keyed by `\"nwbfile\"` inside an NWB file\n\nAlso, could you link me to an example NWB that contains this field?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1700509781,"metadata":{"github-id":"IC_kwDODBZtRc5sdmUD","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1819698435"},"message":"@bendichter \n\n\u003e It looks like the dandi cli currently extracts these values and adds them to the dandiset-level metadata\n\nI don't think that's true.  The only times when dandi-cli sets the metadata for a Dandiset in the Archive are (a) when running `dandi upload` — but that's only if the developer option `--upload-dandiset-metadata` is given, and then only the metadata in the `dandiset.yaml` file is sent to the Archive — and (b) when running `dandi service-scripts update-dandiset-from-doi`.  Are you sure it's not the Archive that's removing the values from asset metadata and adding them to Dandiset metadata?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1701265377,"metadata":{"github-id":"IC_kwDODBZtRc5tMOhC","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1831921730"},"message":"@bendichter Ping.","files":null},{"type":5,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1701353066,"metadata":{"github-id":"LE_lADODBZtRc5qeisLzwAAAAKWLgF-"},"added":["awaiting-user-response"],"removed":[]},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1701870807,"metadata":{"github-id":"IC_kwDODBZtRc5t2OuF","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1842932613"},"message":"@bendichter Ping.","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1701873081,"metadata":{"github-id":"IC_kwDODBZtRc5t2frT","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1843002067"},"message":"@jwodder sorry for the delay\n\nHere is an example file:\n* details: https://api.dandiarchive.org/api/dandisets/000409/versions/draft/assets/10762cd8-94b3-4691-8bd0-d690f7890bc6/\n* neurosift page where you can see the related publications field for this asset: https://flatironinstitute.github.io/neurosift/?p=/nwb\u0026url=https://dandiarchive.s3.amazonaws.com/blobs/48a/312/48a31208-724e-4ee0-89b8-e8fa4fcf12ca\u0026dandisetId=000409\u0026dandisetVersion=draft\n\n\nBy `nwbfile.related_publications` I mean that for a local NWB file, I would access this field using PyNWB via:\n\n```python\nfrom pynwb import NWBHDF5IO\n\nwith NWBHDF5IO(\"fpath\", \"r\", load_namespaces=True) as io:\n    nwbfile = io.read()\n    related_publications = nwbfile.related_publications\n```\n\nI was under the impression that this value was extracted by the dandi cli because of this line:\n\nhttps://github.com/dandi/dandi-cli/blob/b9a10999de5a6e5daadbb098c75dd3472175354d/dandi/organize.py#L621\n\nand [a few other places where related_publications shows up in the dandi cli code](https://github.com/search?q=repo%3Adandi%2Fdandi-cli%20related_publications\u0026type=code).","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1701875999,"metadata":{"github-id":"IC_kwDODBZtRc5t23Z-","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1843099262"},"message":"@bendichter \n\n* Could you provide something smaller than 86 GiB?  I'm not going to download something that huge, and extracting metadata over the network takes five to ten minutes.\n* I can confirm that, though the client extracts the `related_publications` field from NWBs, the field is discarded when converting NWB metadata to dandischema metadata.  The client is definitely not including this information in Dandiset metadata.\n* I'm assuming that the `related_publications` field in an NWB can be either a sequence of strings or (based on some of our test cases) a single string.  Is this correct?\n* How exactly should `related_publications` fields be converted to dandischema `Resource`s?  For the provided NWB in particular, the field is a list containing a single string containing two DOI URLs separated by a comma \u0026 space, and one of these DOI URLs was used as the `identifier` field in a `Resource` in the Dandiset metadata.  (CC @satra)","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1701877005,"metadata":{"github-id":"IC_kwDODBZtRc5t2-7C","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1843130050"},"message":"@jwodder \n\nHere's one that's \u003c 1GB: https://api.dandiarchive.org/api/dandisets/000409/versions/draft/assets/64c796e4-3935-4d43-b4ca-9d1df17a07c2/\n\n\u003e I'm assuming that the related_publications field in an NWB can be either a sequence of strings or (based on some of our test cases) a single string. Is this correct?\n\nYes, this field can be a list of strings. See the schema entry [here](https://github.com/NeurodataWithoutBorders/nwb-schema/blob/ec0a87979608c75a785d3a42f61e3366846ed3c2/core/nwb.file.yaml#L209-L213). I think in this case neurosift is doing the JS equivalent of `\", \".join(related_publications)` for the text it is displaying.\n\n\u003e How exactly should related_publications fields be converted to dandischema Resources?\n\nI think we should create one `Resource` object for each entry of `related_publications` where `Resource.identifier` is the value and `Resource.relation` should be \"cite:IsDescribedBy\".","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1701877369,"metadata":{"github-id":"IC_kwDODBZtRc5t3Ce8","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1843144636"},"message":"@bendichter \n\n\u003e I think in this case neurosift is doing the JS equivalent of `\", \".join(related_publications)` for the text it is displaying.\n\nNo, our `_get_pynwb_metadata()` also returns a list of one comma-separated string.\n\n\u003e I think we should create one `Resource` object for each entry of `related_publications` where `Resource.identifier` is the value\n\nWhat about for cases like this where the value isn't a DOI URL (or whatever we require of an identifier)?","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1701880709,"metadata":{"github-id":"IC_kwDODBZtRc5t3e4M","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1843260940"},"message":"\u003e No, our _get_pynwb_metadata() also returns a list of one comma-separated string.\n\nAh, ok, well I would say that's how it's *supposed* to be added, but we don't do any kind of validation on the value in PyNWB. We can add a check for this in nwbinspector so that we can have more trust in future contributions. @CodyCBakerPhD , do you know why the current IBL data is a comma-separated string instead of a list of string?","files":null},{"type":3,"author":{"id":"7eea5bdd45d6b031d3bf16a241db06db985fb528"},"timestamp":1701883528,"metadata":{"github-id":"IC_kwDODBZtRc5t3x73","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1843338999"},"message":"\u003e We can add a check for this in nwbinspector so that we can have more trust in future contributions.\n\nWe've always had a check for DOI format for all entries in the related publication list: https://github.com/NeurodataWithoutBorders/nwbinspector/blob/0e3640048f18838762af98ccbf071b07f0b39e48/src/nwbinspector/checks/nwbfile_metadata.py#L115\n\n\u003e @CodyCBakerPhD , do you know why the current IBL data is a comma-separated string instead of a list of string?\n\nNot sure what you're talking about - the metadata encodes it as a list in the YAML: https://github.com/catalystneuro/IBL-to-nwb/blob/5195b4eada1f3c82416cd3f26d523fd72752fadf/ibl_to_nwb/brainwide_map/brainwide_map_metadata.yml#L6-L8\n\nAnd the HDF5 file contents show each string written as a separate element on that dataset\n\n![image](https://github.com/dandi/dandi-cli/assets/51133164/6f287385-3cca-4e22-bd2b-a05563c09235)","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1701883662,"metadata":{"github-id":"IC_kwDODBZtRc5t3y7p","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1843343081"},"message":"OK, yes, I thought this was the case. Thanks for the clarification, @CodyCBakerPhD \n\n@jwodder , is it possible that `_get_pynwb_metadata()` is doing this join behind the scenes?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1701887475,"metadata":{"github-id":"IC_kwDODBZtRc5t4OaO","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1843455630"},"message":"@CodyCBakerPhD You appear to be looking at [the second NWB Ben provided](https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1843130050), the `related_publications` of which is indeed a list of two strings.  However, [the first NWB Ben provided](https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1843002067) stores its `related_publications` as a list containing a single string containing two comma-separated URLs.\n\n@bendichter I see no join in `_get_pynwb_metadata()`.  I tried to print out just the first NWB's `related_publications` field directly to confirm what it actually looks like, but the script ran for more than thirty minutes without finishing.","files":null},{"type":3,"author":{"id":"7eea5bdd45d6b031d3bf16a241db06db985fb528"},"timestamp":1701895915,"metadata":{"github-id":"IC_kwDODBZtRc5t5DEl","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1843671333"},"message":"@jwodder Right you are - the file with the bulk contents has top level metadata from an earlier draft version that hasn't been updated\n\nWe can definetely add an NWB Inspector check for someone adding single string with comma-separated entires instead of multiple listed entries","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1703000522,"metadata":{"github-id":"IC_kwDODBZtRc5vCzgd","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1863006237"},"message":"@bendichter Repeating some questions from earlier:\n\n* Can `related_publications` legitimately be a single string as an alternative to a list of strings?  I can't make any sense of [the schema entry](https://github.com/NeurodataWithoutBorders/nwb-schema/blob/ec0a87979608c75a785d3a42f61e3366846ed3c2/core/nwb.file.yaml#L209-L213).\n    * If it is not allowed for a `related_publications` field to be a single string, what should happen if the client encounters one that is?\n\n\u003e I think we should create one `Resource` object for each entry of `related_publications` where `Resource.identifier` is the value and `Resource.relation` should be \"cite:IsDescribedBy\".\n\nI'm assuming this is intended for the case where each entry of `related_publications` is a DOI URL.  What if an entry is a different kind of URL?  What if it's not a valid URL at all (as in the case of the two URLs joined by a comma)?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1704202277,"metadata":{"github-id":"IC_kwDODBZtRc5vs2x0","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1874029684"},"message":"@bendichter Ping.","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1704384769,"metadata":{"github-id":"IC_kwDODBZtRc5v5lPC","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1877365698"},"message":"@jwodder \"related publications\" is a list of strings, and each string should be a DOI. It usually only has one entry (and is often empty). If there are multiple related publications, the proper way of entering that would be as a list of DOI strings. We do not do any validation to ensure users are not entering related publications as \"[first_pub], [second_pub]\" or any other kind of custom concatenation, so I do suspect we might run into that every now and then. We can make an NWB Inspector check that minimizes this. Another approach could be to test the validity of each entry as a URL and only accept those that are proper URLs.","files":null},{"type":6,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1704384823,"metadata":{"github-id":"UCE_lALODBZtRc5v5lPCzj2FTvc"},"target":"4a9d40771f1324eb7d7f475cdaf49708ae8c4a9e71a594f57b8dafdf3c57e2c7","message":"@jwodder \"related publications\" is a list of strings, and each string should be a DOI. It usually only has one entry (and is often empty). If there are multiple related publications, the proper way of entering that would be as a list of DOI strings. We do not do any validation to ensure users are not entering related publications as \"[first_pub], [second_pub]\" or any other kind of custom concatenation, so I do suspect we might run into that every now and then. We can make an NWB Inspector check that minimizes this. Another approach could be to test the validity of each entry as a URL and only accept those that are proper URLs, or proper DOIs, depending on how strict we want to be on the DANDI side.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1704385470,"metadata":{"github-id":"IC_kwDODBZtRc5v5qxh","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1877388385"},"message":"@bendichter You didn't answer the crucial question, which is: What should the code do when \"related publications\" *isn't* what you say it should be?","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1704385690,"metadata":{"github-id":"IC_kwDODBZtRc5v5sFt","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1877393773"},"message":"Skip it","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1704394588,"metadata":{"github-id":"IC_kwDODBZtRc5v6ftK","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-1877605194"},"message":"The need to check for valid URLs makes this blocked on #1380.","files":null},{"type":5,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1704394594,"metadata":{"github-id":"UNLE_lADODBZtRc5qeisLzwAAAAKnHqmt"},"added":[],"removed":["awaiting-user-response"]},{"type":5,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1704394594,"metadata":{"github-id":"LE_lADODBZtRc5qeisLzwAAAAKnHqmx"},"added":["blocked"],"removed":[]},{"type":5,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1709823182,"metadata":{"github-id":"UNLE_lADODBZtRc5qeisLzwAAAALN2Xr1"},"added":[],"removed":["blocked"]},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1711390416,"metadata":{"github-id":"CE_lADODBZtRc5qeisLzwAAAALZe4Y_"},"status":2},{"type":3,"author":{"id":"7a8552494914d3e4116f4b434eb4812a914ca405"},"timestamp":1714744664,"metadata":{"github-id":"IC_kwDODBZtRc58wdYl","github-url":"https://github.com/dandi/dandi-cli/issues/1308#issuecomment-2093078053"},"message":"\u003c!-- GITHUB_RELEASE COMMENT: released --\u003e\n:rocket: Issue was released in [`0.62.0`](https://github.com/dandi/dandi-cli/releases/tag/0.62.0) :rocket:","files":null},{"type":5,"author":{"id":"7a8552494914d3e4116f4b434eb4812a914ca405"},"timestamp":1714744665,"metadata":{"github-id":"LE_lADODBZtRc5qeisLzwAAAAL0ykWl"},"added":["released"],"removed":[]}]}