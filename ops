{"version":2,"ops":[{"type":6,"author":{"id":"d8203afd43c9e0a9d07c45dd62b58a81d53a2ebe"},"timestamp":1724180053,"metadata":{"github-id":"UCE_lAHODBZtRc6Tmaq8zmKSp5A"},"target":"47904c048738472420bbe1e3f5bcd16b1df2ddb6ced2ce95019da6cb05535a69","message":"Hi team, @aaronkanzer and I are trying to read the metadata and chunks of an embargoed Zarr (on DANDI and LINC) and are unable to.  What would be the best approach to remotely access a Zarr that is apart of an embargoed Dandiset?\n\nFor the code snippet below, I can get the `zarr_path` in the `dandiarchive` S3 bucket from the File Browser of a Dandiset using the `View Asset Metadata` button, but `s3fs` also requires AWS credentials.\n\n```python \nimport zarr, s3fs\n\naccess_key = 'your-access-key-id'\nsecret_key = 'your-secret-access-key'\nsession_token = 'your-session-token'  # Optional, if using temporary credentials\n\ns3 = s3fs.S3FileSystem(key=access_key, secret=secret_key, token=session_token)\n\nbucket_name = 'dandiarchive'\nzarr_path = 'path/to/your/zarr/data.zarr'\n\nstore = s3fs.S3Map(root=f'{bucket_name}/{zarr_path}', s3=s3, check=False)\n\nzarr_array = zarr.open_array(store, mode='r')\n```\n\nFor reference, I am also hitting a blocker using the DANDI API when trying to access a Zarr.  I am not sure if this would be related to my use case.  Using the code snippet below (which is a derivative of the [OpenScope Databook streaming section](https://alleninstitute.github.io/openscope_databook/basics/stream_nwb.html)) I receive a `Response [400]`.  I presume that this is because the asset is a Zarr and the response is set in [lines 143-148](https://github.com/dandi/dandi-archive/blob/6e4bf727a02985aceb0fb896736883c00929c142/dandiapi/api/views/asset.py#L143-L148).  And perhaps this is related to https://github.com/dandi/dandi-cli/issues/1455.\n\n```python\nfrom dandi import dandiapi\n\ndataset = \"000026\"\nfilepath = \"sub-I58/ses-Hip-CT/micr/sub-I58_sample-01_chunk-01_hipCT.ome.zarr\"\ndandi_api_key = \u003cdandi_api_key\u003e\n\nclient = dandiapi.DandiAPIClient(api_url=\"https://api.dandiarchive.org/api\", token=dandi_api_key)\n\nmy_dandiset = client.get_dandiset(dandiset_id=dataset, version_id=\"draft\")\n\nfile = my_dandiset.get_asset_by_path(filepath)\n\nbase_url = file.client.session.head(file.base_download_url)\n```\n\nThank you.","files":null},{"type":6,"author":{"id":"d8203afd43c9e0a9d07c45dd62b58a81d53a2ebe"},"timestamp":1724180142,"metadata":{"github-id":"UCE_lAHODBZtRc6Tmaq8zmKSr1Q"},"target":"47904c048738472420bbe1e3f5bcd16b1df2ddb6ced2ce95019da6cb05535a69","message":"Hi team, @aaronkanzer and I are trying to read the metadata and chunks of an embargoed Zarr (on DANDI and LINC) and are unable to.  What would be the best approach to remotely access a Zarr that is apart of an embargoed Dandiset?\n\nFor the code snippet below, I can get the `zarr_path` in the `dandiarchive` S3 bucket from the File Browser of a Dandiset using the `View Asset Metadata` button, but `s3fs` also requires AWS credentials.\n\n```python \nimport zarr, s3fs\n\naccess_key = 'your-access-key-id'\nsecret_key = 'your-secret-access-key'\nsession_token = 'your-session-token'  # Optional, if using temporary credentials\n\ns3 = s3fs.S3FileSystem(key=access_key, secret=secret_key, token=session_token)\n\nbucket_name = 'dandiarchive'\nzarr_path = 'path/to/your/zarr/data.zarr'\n\nstore = s3fs.S3Map(root=f'{bucket_name}/{zarr_path}', s3=s3, check=False)\n\nzarr_array = zarr.open_array(store, mode='r')\n```\n\nFor reference, I am also hitting a blocker using the DANDI API when trying to access a public or private Zarr.  I am not sure if this would be related to my use case.  Using the code snippet below (which is a derivative of the [OpenScope Databook streaming section](https://alleninstitute.github.io/openscope_databook/basics/stream_nwb.html)) I receive a `Response [400]`.  I presume that this is because the asset is a Zarr and the response is set in [lines 143-148](https://github.com/dandi/dandi-archive/blob/6e4bf727a02985aceb0fb896736883c00929c142/dandiapi/api/views/asset.py#L143-L148).  And perhaps this is related to https://github.com/dandi/dandi-cli/issues/1455.\n\n```python\nfrom dandi import dandiapi\n\ndataset = \"000026\"\nfilepath = \"sub-I58/ses-Hip-CT/micr/sub-I58_sample-01_chunk-01_hipCT.ome.zarr\"\ndandi_api_key = \u003cdandi_api_key\u003e\n\nclient = dandiapi.DandiAPIClient(api_url=\"https://api.dandiarchive.org/api\", token=dandi_api_key)\n\nmy_dandiset = client.get_dandiset(dandiset_id=dataset, version_id=\"draft\")\n\nfile = my_dandiset.get_asset_by_path(filepath)\n\nbase_url = file.client.session.head(file.base_download_url)\n```\n\nThank you.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1724181512,"metadata":{"github-id":"IC_kwDODBZtRc6JEPLx","github-url":"https://github.com/dandi/dandi-cli/issues/1491#issuecomment-2299589361"},"message":"How are you even creating a Zarr in an embargoed Dandiset?  dandi-cli currently doesn't support that, and — last time I checked — neither does the Archive.\n\nAs to your second snippet, `base_download_url` and `download_url` are useless for Zarrs, as they normally point to a single file, but a Zarr is many files.  What exactly were you expecting to happen there?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1724184543,"metadata":{"github-id":"IC_kwDODBZtRc6JEkrx","github-url":"https://github.com/dandi/dandi-cli/issues/1491#issuecomment-2299677425"},"message":"Indeed, I thought zarrbargo is yet to be implemented, correct @jjnesbitt ?","files":null},{"type":3,"author":{"id":"a9e2633aeb6d7e2366a97d09712312c2442c6054"},"timestamp":1724184606,"metadata":{"github-id":"IC_kwDODBZtRc6JElJ7","github-url":"https://github.com/dandi/dandi-cli/issues/1491#issuecomment-2299679355"},"message":"\u003e Indeed, I thought zarrbargo is yet to be implemented, correct @jjnesbitt ?\n\nCorrect, it is not yet implemented.","files":null},{"type":3,"author":{"id":"d8203afd43c9e0a9d07c45dd62b58a81d53a2ebe"},"timestamp":1724185063,"metadata":{"github-id":"IC_kwDODBZtRc6JEoDk","github-url":"https://github.com/dandi/dandi-cli/issues/1491#issuecomment-2299691236"},"message":"Thanks team.  Sorry, I was a bit loose with my explanation.  The first code snippet does not work on LINC, which requires authentication for all requests since the platform is private.  (LINC does allow for upload and download of private Zarrs.) The second code snippet does not work on both DANDI and LINC.  And as you mentioned, this may not be needed for my use case.\n\nOverall I am just looking for advice on how we should provide LINC users read/streaming access to private Zarrs.  We were thinking about creating a helper function (`get_read_only_credentials`) to work with `s3fs` as shown below.\n\n```python\naws_credentials = lincbrain.get_read_only_credentials(lincbrain_api_key=\u003clincbrain_api_key\u003e)\n\ns3 = s3fs.S3FileSystem(key=aws_credentials['access_key'], \n                       secret=aws_credentials['secret_key'], \n                       token=aws_credentials['session_token'])\n```","files":null},{"type":3,"author":{"id":"d8203afd43c9e0a9d07c45dd62b58a81d53a2ebe"},"timestamp":1724185220,"metadata":{"github-id":"IC_kwDODBZtRc6JEpBw","github-url":"https://github.com/dandi/dandi-cli/issues/1491#issuecomment-2299695216"},"message":"And thanks for clarifying.  I forgot that zarrbargo has not yet been implemented.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1724188228,"metadata":{"github-id":"IC_kwDODBZtRc6JE7-Z","github-url":"https://github.com/dandi/dandi-cli/issues/1491#issuecomment-2299772825"},"message":"on the 000108 examples in the example-notebooks, the code reads and evaluates zarr objects on dandiarchive.","files":null},{"type":3,"author":{"id":"d8203afd43c9e0a9d07c45dd62b58a81d53a2ebe"},"timestamp":1724193028,"metadata":{"github-id":"IC_kwDODBZtRc6JFTrN","github-url":"https://github.com/dandi/dandi-cli/issues/1491#issuecomment-2299869901"},"message":"Thank you.  I will take a look at these examples.","files":null}]}