{"version":2,"ops":[{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1611761007,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlRWRpdDo0ODUxNjU4ODk="},"target":"3bb30ce4f0dac78d9818c217d32771ef8ebe99727da17d04126acf791f944111","message":"We should reintroduce handling of existing files similar to girder based implementation \nhttps://github.com/dandi/dandi-cli/blob/master/dandi/upload.py#L342\nsince dandi-api does verify that there is no asset with a given path (https://github.com/dandi/dandi-api/issues/65). Since\n we have no locking, it would be a \"racy\" code but ATM I do not see another way around: we just would need to report an error if having uploaded an new file we still fail to mint a new asset for it (if another process uploaded for that path meanwhile as well).\n\nTODOs\n- [x] Test for correct behavior upon possible values of `existing`\n- [ ] Test should be added which would\n  - trigger 'publish', i.e. making a release\n  - upload a new file (into a draft)\n  - verify that we can still get released file from the published version and","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1611841369,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlRWRpdDo0ODU2ODk5MDc="},"target":"3bb30ce4f0dac78d9818c217d32771ef8ebe99727da17d04126acf791f944111","message":"We should reintroduce handling of existing files similar to girder based implementation \nhttps://github.com/dandi/dandi-cli/blob/master/dandi/upload.py#L342\nsince dandi-api does verify that there is no asset with a given path (https://github.com/dandi/dandi-api/issues/65). Since\n we have no locking, it would be a \"racy\" code but ATM I do not see another way around: we just would need to report an error if having uploaded an new file we still fail to mint a new asset for it (if another process uploaded for that path meanwhile as well).\n\nTODOs\n- [x] Test for correct behavior upon possible values of `existing`\n- [ ] Test should be added which would\n  - trigger 'publish', i.e. making a release\n  - upload a new file (into a draft)\n  - verify that we can still get released file from the published version and from a draft version\n  - remove file in the draft version\n  - verify that we can still get released file from the published version","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1611844145,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlRWRpdDo0ODU3MTI3NTc="},"target":"3bb30ce4f0dac78d9818c217d32771ef8ebe99727da17d04126acf791f944111","message":"We should reintroduce handling of existing files similar to girder based implementation \nhttps://github.com/dandi/dandi-cli/blob/master/dandi/upload.py#L342\nsince dandi-api does verify that there is no asset with a given path (https://github.com/dandi/dandi-api/issues/65). Since\n we have no locking, it would be a \"racy\" code but ATM I do not see another way around: we just would need to report an error if having uploaded an new file we still fail to mint a new asset for it (if another process uploaded for that path meanwhile as well).\n\nTODOs\n- [x] Test for correct behavior upon possible values of `existing`\n- [x] Test should be added which would\n  - trigger 'publish', i.e. making a release\n  - upload a new file (into a draft)\n  - verify that we can still get released file from the published version and from a draft version\n  - remove file in the draft version\n  - verify that we can still get released file from the published version","files":null},{"type":2,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1611675395,"metadata":{"github-id":"MDE3OlJlbmFtZWRUaXRsZUV2ZW50NDI1MTI5OTQ3OQ=="},"title":"dandi-api: upload - (re)introduce handling of existing files","was":"dandi-api: upload - (re)introduce handling of existing files"},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1611675564,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc2NzYyODI1NQ==","github-url":"https://github.com/dandi/dandi-cli/issues/345#issuecomment-767628255"},"message":"as far as i know @dchiquit designed the api to work with no race condition, so would be good to highlight where race would happen.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1611676163,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc2NzYzNDk0MA==","github-url":"https://github.com/dandi/dandi-cli/issues/345#issuecomment-767634940"},"message":"@yarikoptic\n\n\u003e we just would need to report an error if having uploaded an new file we still fail to mint a new asset for it\n\nYou mean that the code should error if [this call](https://github.com/dandi/dandi-cli/blob/30e06950adb81c80ea89b7c88577c48499aef33d/dandi/dandiapi.py#L459) fails?  Assuming the request returns 4xx on failure, the code will already raise an exception.\n\nAside from the tests, exactly what changes are you asking for?  The new upload already parallels the old upload's handling of pre-existing files (https://github.com/dandi/dandi-cli/blob/30e06950adb81c80ea89b7c88577c48499aef33d/dandi/upload.py#L711); the biggest differences are that \"refresh\" does nothing in the new code, and the new code doesn't bother deleting any pre-existing files, as the server and its garbage collections should take care of that.","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1611676163,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDI5NzYwNzky"},"target":"26ea94dc8d034a7368c61eeceb0df2e675aaf7c98e7d0c6fb8292a44b4e4c6df","message":"@yarikoptic\n\n\u003e we just would need to report an error if having uploaded an new file we still fail to mint a new asset for it\n\nYou mean that the code should error if [this call](https://github.com/dandi/dandi-cli/blob/30e06950adb81c80ea89b7c88577c48499aef33d/dandi/dandiapi.py#L459) fails?  Assuming the request returns 4xx on failure, the code will already raise an exception.\n\nAside from the tests, exactly what changes are you asking for?  [The new upload already parallels the old upload's handling of pre-existing files](https://github.com/dandi/dandi-cli/blob/30e06950adb81c80ea89b7c88577c48499aef33d/dandi/upload.py#L711); the biggest differences are that \"refresh\" does nothing in the new code, and the new code doesn't bother deleting any pre-existing files, as the server and its garbage collections should take care of that.","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1611676324,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDI5NzYxNjM4"},"target":"26ea94dc8d034a7368c61eeceb0df2e675aaf7c98e7d0c6fb8292a44b4e4c6df","message":"@yarikoptic\n\n\u003e we just would need to report an error if having uploaded an new file we still fail to mint a new asset for it\n\nYou mean that the code should error if [this call](https://github.com/dandi/dandi-cli/blob/30e06950adb81c80ea89b7c88577c48499aef33d/dandi/dandiapi.py#L459) fails?  Assuming the request returns 4xx on failure, the code will already raise an exception if that happens.\n\nAside from the tests, exactly what changes are you asking for?  [The new upload already parallels the old upload's handling of pre-existing files](https://github.com/dandi/dandi-cli/blob/30e06950adb81c80ea89b7c88577c48499aef33d/dandi/upload.py#L711); the biggest differences are that \"refresh\" does nothing in the new code, and the new code doesn't bother deleting any pre-existing files, as the server and its garbage collections should take care of that.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1611682713,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc2NzcwODAzMQ==","github-url":"https://github.com/dandi/dandi-cli/issues/345#issuecomment-767708031"},"message":"oh, missed that the logic is there.  So we are almost there then.\n\nI think we should just record which asset UUID (from [extant](https://github.com/dandi/dandi-cli/blob/30e06950adb81c80ea89b7c88577c48499aef33d/dandi/upload.py#L710) ) is to be removed right before  we `client.iter_upload(`, like we do in old code by storing it in `delete_before_upload` : https://github.com/dandi/dandi-cli/blob/master/dandi/upload.py#L362 . This way we do not remove it ahead of time (validation might fail etc)","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1611758770,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc2ODMzNDI2Mw==","github-url":"https://github.com/dandi/dandi-cli/issues/345#issuecomment-768334263"},"message":"@dchiquit `POST /dandisets/{version__dandiset__pk}/versions/{version__version}/assets/` is returning a 500 when completing an upload to a path that an asset was previously uploaded to.  The response body begins with:\n\n```\nIntegrityError at /api/dandisets/000006/versions/draft/assets/\nduplicate key value violates unique constraint \"api_asset_path_version_id_0267c3d9_uniq\"\nDETAIL:  Key (path, version_id)=(subdir/file.txt, 6) already exists.\n```","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1611759615,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc2ODM0Mzk5NQ==","github-url":"https://github.com/dandi/dandi-cli/issues/345#issuecomment-768343995"},"message":"Filed https://github.com/dandi/dandi-api/issues/70 -- I have not realized there is no DELETE endpoint to the asset.  We would need it one way or another.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1611759772,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc2ODM0NTc2Nw==","github-url":"https://github.com/dandi/dandi-cli/issues/345#issuecomment-768345767"},"message":"@yarikoptic While that endpoint would be useful, it was my understanding that the API would be able to handle multiple uploads to the same path automatically without having to make a DELETE call.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1611760055,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc2ODM0ODk2OQ==","github-url":"https://github.com/dandi/dandi-cli/issues/345#issuecomment-768348969"},"message":"and then that endpoint should be called before upload (i.e. here in the WiP PR: https://github.com/dandi/dandi-cli/pull/347/files#diff-4e39d697f6d28e2e5d67ba80609f3bc7ceebe2d6be0ff9ae3020331c4bfe48a2R797 ) although I would have actually preferred more atomic operation for replacement of asset on the -api side (filed https://github.com/dandi/dandi-api/issues/71)","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1611760154,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc2ODM1MDEwMg==","github-url":"https://github.com/dandi/dandi-cli/issues/345#issuecomment-768350102"},"message":"\u003e @yarikoptic While that endpoint would be useful, it was my understanding that the API would be able to handle multiple uploads to the same path automatically without having to make a DELETE call.\n\nWell, our thinking and API is still WiP ;) I think we should not just silently and unconditionally replace an asset (for the path), and we are not aiming to support having multiple assets for the PATH ATM (AFAIK) since that would open a bigger can of warms.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1611760198,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc2ODM1MDYyNw==","github-url":"https://github.com/dandi/dandi-cli/issues/345#issuecomment-768350627"},"message":"BTW, may be @satra has ideas which are different...?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1611761033,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc2ODM2MDU5Ng==","github-url":"https://github.com/dandi/dandi-cli/issues/345#issuecomment-768360596"},"message":"@yarikoptic \n\n\u003e verify that we can still get released file from the published version and\n\nYou didn't finish this sentence.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1611761262,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc2ODM2MjA1NQ==","github-url":"https://github.com/dandi/dandi-cli/issues/345#issuecomment-768362055"},"message":"@dchiquit @yarikoptic What is the \"dandiset\" field in the body of `POST /dandisets/{dandiset__pk}/versions/{version}/publish/` supposed to be?  The Dandiset metadata?  I would expect that to be named \"metadata\".","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1611761262,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDMwMTA3MjMz"},"target":"a1fc885c88a962f214578924e89b7ad46d78ffe61eb31d622ca35c2195cdfb5a","message":"@dchiquit @yarikoptic What is the \"dandiset\" field in the body of `POST /dandisets/{dandiset__pk}/versions/{version}/publish/` supposed to be?  The Dandiset metadata?  I would expect that to be named \"metadata\".\n\nAlso, is the `version` path component of the request supposed to be the name of the pre-existing version to use to create the new version (so usually \"draft\")?","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1611765503,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc2ODQxMTU1Nw==","github-url":"https://github.com/dandi/dandi-cli/issues/345#issuecomment-768411557"},"message":"@jwodder https://github.com/dandi/dandi-api/issues/68 will replace the 500 error with something more informative, I plan to fix it this week.\n\nThat shouldn't be there at all. Peeking at the code, that view already specifies `request_body=None`, so I'm not sure why it's still there. I made https://github.com/dandi/dandi-api/issues/72 to address that.","files":null},{"type":6,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1611765503,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDMwMTMwMTA3"},"target":"17f0d664c04b6c427a60639582087aad592cf56e34b62361f9e0cd3854698a31","message":"@jwodder https://github.com/dandi/dandi-api/issues/68 will replace the 500 error with something more informative, I plan to fix it this week.\n\nThat `data` field shouldn't be there at all, and can be ignored if you're experimenting with swagger or writing code to use the endpoint. Peeking at the code, that view already specifies `request_body=None`, so I'm not sure why it's still there. I made https://github.com/dandi/dandi-api/issues/72 to address that.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1611766464,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc2ODQyMjc2NQ==","github-url":"https://github.com/dandi/dandi-cli/issues/345#issuecomment-768422765"},"message":"@yarikoptic Should the method for publishing a version construct the version ID itself (I assume as `time.strftime(\"0.%y%m%d.%H%M\", time.gmtime())`), or should that be left to the method caller?","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1611769874,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc2ODQ2MDkxNg==","github-url":"https://github.com/dandi/dandi-cli/issues/345#issuecomment-768460916"},"message":"When you use the publish endpoint, the response body is the newly published version object, version ID included. The server calculates the new version ID and has some extra logic to ensure the version ID is unique, even if there were multiple publishes in the same minute.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1611770043,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc2ODQ2MjYxMQ==","github-url":"https://github.com/dandi/dandi-cli/issues/345#issuecomment-768462611"},"message":"@dchiquit If the server calculates the version ID, what's the `{version}` parameter in the request URL then?  The ID of the pre-existing version (usually \"draft\") to publish as a new version?","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1611770270,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc2ODQ2NTA5OQ==","github-url":"https://github.com/dandi/dandi-cli/issues/345#issuecomment-768465099"},"message":"Correct. Behind the scenes, the `publish` operation simply calculates the new version ID based on time stamp, then creates a copy of the given version with that new version ID. Realistically you would only publish `draft` versions, but the source version ID is still included in the URL to make it clear that you are publishing the draft.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1611777659,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc2ODU0MTA4NA==","github-url":"https://github.com/dandi/dandi-cli/issues/345#issuecomment-768541084"},"message":"@yarikoptic I'm not sure if you saw [my comment above](https://github.com/dandi/dandi-cli/issues/345#issuecomment-768360596), but I'm still not 100% clear on what the publish test should do.  After publishing, should a separate file be uploaded to the draft version, or should a file in the draft version be overwritten with an modified file?  What exactly should the test verify?","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1611777659,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDMwMTkxMjAy"},"target":"79f48ddfaa3b0db8141b4a9b422970165f5fe0dc7c9929bebfdcf6a3de8eea11","message":"@yarikoptic I'm not sure if you saw [my comment above](https://github.com/dandi/dandi-cli/issues/345#issuecomment-768360596), but I'm still not 100% clear on what the publish test should do.  After publishing, should a separate file be uploaded to the draft version, or should a file in the draft version be overwritten with a modified file?  What exactly should the test verify?","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1611777681,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDMwMTkxMzI5"},"target":"79f48ddfaa3b0db8141b4a9b422970165f5fe0dc7c9929bebfdcf6a3de8eea11","message":"@yarikoptic I'm not sure if you saw [my comment above](https://github.com/dandi/dandi-cli/issues/345#issuecomment-768360596), but I'm still not 100% clear on what the publish test should do.  After publishing, should a new file be uploaded to the draft version, or should a path already in the draft version be overwritten with a modified file?  What exactly should the test verify?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1611841398,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc2OTA2MTA0MA==","github-url":"https://github.com/dandi/dandi-cli/issues/345#issuecomment-769061040"},"message":"Thank you @jwodder for the buzz. I have finished the description for that item","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1612884648,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50NDMwOTgzNDg3MQ=="},"status":2}]}