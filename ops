{"version":2,"ops":[{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1614611066,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc4Nzk5NjczMg==","github-url":"https://github.com/dandi/dandi-cli/issues/430#issuecomment-787996732"},"message":"@yarikoptic \n\nIt turns out that `validate_file()` is already cached.  However:\n\n* `validate_dandi_nwb()` uses the environment variable `DANDI_SCHEMA` as one of the methods to enable validation against the new schema.  As long as that is supported, caching won't work entirely right.\n* Using `validate_file()` in dandi-api-datasets means that (a) PyNWB errors will be grouped together with validation errors, and (b) tracebacks won't be reported in the errors files, only the error messages.  Do you care about that?","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1614611066,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDM4ODM2ODI4"},"target":"067141a24279db457c5aef181aa90d6f934de9f1f4b8bb8a8298e2e2bcce332f","message":"@yarikoptic \n\nIt turns out that `validate_file()` is already cached.  However:\n\n* `validate_dandi_nwb()` uses the environment variable `DANDI_SCHEMA` as one of the methods to enable validation against the new schema.  As long as that is supported, caching won't work entirely right.\n* Using `validate_file()` in dandi-api-datasets means that (a) PyNWB errors, conversion errors, and validation errors will all be grouped together, and (b) tracebacks won't be reported in the errors files, only the error messages.  Do you care about that?","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1614611630,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDM4ODM5OTkx"},"target":"067141a24279db457c5aef181aa90d6f934de9f1f4b8bb8a8298e2e2bcce332f","message":"@yarikoptic \n\nIt turns out that `validate_file()` is already cached.  However:\n\n* `validate_dandi_nwb()` uses the environment variable `DANDI_SCHEMA` as one of the methods to enable validation against the new schema.  As long as that is supported, caching won't work entirely right.\n* Using `validate_file()` in dandi-api-datasets means that (a) PyNWB errors, conversion errors, and validation errors will all be grouped together, and (b) tracebacks won't be reported in the errors files, only the error messages, and (c) the asset metadata will have to be calculated twice.  Do you care about that?","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1614611679,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDM4ODQwMzQ0"},"target":"067141a24279db457c5aef181aa90d6f934de9f1f4b8bb8a8298e2e2bcce332f","message":"@yarikoptic \n\nIt turns out that `validate_file()` is already cached.  However:\n\n* `validate_dandi_nwb()` uses the environment variable `DANDI_SCHEMA` as one of the methods to enable validation against the new schema.  As long as that is supported, caching won't work entirely right.\n* Using `validate_file()` in dandi-api-datasets means that (a) PyNWB errors, conversion errors, and validation errors will all be grouped together, (b) tracebacks won't be reported in the errors files, only the error messages, and (c) the asset metadata will have to be calculated twice.  Do you care about that?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1614613096,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc4ODA0MjczMA==","github-url":"https://github.com/dandi/dandi-cli/issues/430#issuecomment-788042730"},"message":"- good catch on `DANDI_SCHEMA` env var.  I guess we are doomed to add it to tokens (if present) for now.\n- (b) what tracebacks do you have in mind? I thought that if there is an exception raised by a `fscached` function, we do not memoize that, so exception should be raised again.  \n- (c) don't we fscache reading metadata as well?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1614614750,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc4ODA0OTAzNQ==","github-url":"https://github.com/dandi/dandi-cli/issues/430#issuecomment-788049035"},"message":"@yarikoptic \n\n\u003e good catch on DANDI_SCHEMA env var. I guess we are doomed to add it to tokens (if present) for now.\n\nThat wouldn't work if the value of `DANDI_SCHEMA` changes after importing `dandi`.  I would recommend just eliminating `DANDI_SCHEMA` and using the `schema_version` argument to select the new schema.\n\n\u003e what tracebacks do you have in mind?\n\nTracebacks like the ones [seen here](https://github.com/dandi/dandi-api-datasets/blob/0f6643b59d100d3f4f79406de9bfe5ab31690435/000006/CONVERSION.errors).\n\n\u003e I thought that if there is an exception raised by a fscached function, we do not memoize that, so exception should be raised again\n\nThe fscached `validate_file()` should only raise an exception when given an invalid schema version.  Any other exceptions raised inside are returned as a list of strings.  Currently, instead of calling `validate_file()`, `populate_dandiset_asset_yamls.py` copies its code in order to get access to the actual exceptions and their tracebacks.\n\n\u003e don't we fscache reading metadata as well?\n\nNo.  There's a cache named \"dandi-metadata\", but it's for a pynwb function.","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1614614750,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDM4ODU4NzUz"},"target":"ee024c224b7e94b033009b5a806f245e945f0e56e64d55a6b3eeee2f8d9d6e27","message":"@yarikoptic \n\n\u003e good catch on DANDI_SCHEMA env var. I guess we are doomed to add it to tokens (if present) for now.\n\nThat wouldn't work if the value of `DANDI_SCHEMA` changes after importing `dandi`.  I would recommend just eliminating `DANDI_SCHEMA` and using the `schema_version` argument to select the new schema.\n\n\u003e what tracebacks do you have in mind?\n\nTracebacks like the ones [seen here](https://github.com/dandi/dandi-api-datasets/blob/0f6643b59d100d3f4f79406de9bfe5ab31690435/000006/CONVERSION.errors).\n\n\u003e I thought that if there is an exception raised by a fscached function, we do not memoize that, so exception should be raised again\n\nThe fscached `validate_file()` should only raise an exception when given an invalid schema version.  Any other exceptions raised inside are returned as a list of strings.  Currently, instead of calling `validate_file()`, `populate_dandiset_asset_yamls.py` copies its code in order to get access to the actual exceptions and their tracebacks.\n\n\u003e don't we fscache reading metadata as well?\n\n~No.  There's a cache named \"dandi-metadata\", but it's for a pynwb function.~ Yes, it's cached.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1614619018,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc4ODEyMDI3NA==","github-url":"https://github.com/dandi/dandi-cli/issues/430#issuecomment-788120274"},"message":"\u003e  I would recommend just eliminating DANDI_SCHEMA and using the schema_version argument to select the new schema.\n\n+ 1\n\nI guess we could sacrifice printout of tracebacks for now.  We would need to re-approach the whole validation setup which grew to being \"too organically\" and entrenched into nwb ecosystem.  We are to RF it to support other standards and validators (ref: #431 )","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1614619018,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDM4ODgzNjYx"},"target":"5ab1d615f0e8399ef979b98b408a22acdb77354cde5213a7114bca46ea6f0faa","message":"\u003e  I would recommend just eliminating DANDI_SCHEMA and using the schema_version argument to select the new schema.\n\n`+ 1`\n\nI guess we could sacrifice printout of tracebacks for now.  We would need to re-approach the whole validation setup which grew to being \"too organically\" and entrenched into nwb ecosystem.  We are to RF it to support other standards and validators (ref: #431 )","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1614623786,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50NDM5MTI1NjU5Ng=="},"status":2}]}