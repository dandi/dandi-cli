{"version":2,"ops":[{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1637109951,"metadata":{"github-id":"IC_kwDODBZtRc4536La","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-970957530"},"message":"that doesn't sound good.  What version of the dandi-cli? (0.31.0? want to make sure that we aren't chasing ghosts)\n\ndid you provide `-J|--jobs` argument?\n\nmay be some thread unsafe code @jwodder ?","files":null},{"type":3,"author":{"id":"0e75956bc1f9bf7e3cd1dc71486886c85ad6bfb7"},"timestamp":1637111124,"metadata":{"github-id":"IC_kwDODBZtRc454ElA","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-971000128"},"message":"Yep, I'm using the current dandi release (installed via pip). I didn't provide the `--jonbs` argument, just followed [the handbook](https://www.dandiarchive.org/handbook/10_using_dandi/) exactly","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1637111280,"metadata":{"github-id":"IC_kwDODBZtRc454FfU","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-971003860"},"message":"My initial guess is that the `part[\"size\"]` is invalid, which would mean the API server is returning bogus upload schematics, but such an error would likely result in a `ValueError` or `TypeError` instead of an `OSError`.  The only thing I can think of that might cause an `OSError` there would be the file descriptor being prematurely closed, but I don't see how that could happen.  Also note that lack of thread safety should be minimized for the specific line in question, as [it's wrapped in a thread lock](https://github.com/dandi/dandi-cli/blob/0.31.0/dandi/dandiapi.py#L1482).","files":null},{"type":3,"author":{"id":"0e75956bc1f9bf7e3cd1dc71486886c85ad6bfb7"},"timestamp":1637126622,"metadata":{"github-id":"IC_kwDODBZtRc4542BC","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-971202626"},"message":"All the files with this error also generate a DEBUG line in the log that it failed to compute digest. An example:\n```\n[DEBUG   ] pyout.interface 55364:66748 Duplicating line 31 with\n {'status': 'skipped', 'message': 'failed to compute digest: [Errno 22] Invalid argument', \n'path': 'sub-Aphid\\\\sub-Aphid_ses-Aphid07-HomeCage_behavior+ecephys.nwb'}\n```\nThis debug message also appears for several other files which failed to upload, but which didn't generate an ERROR line in the log. There are several other similar DEBUG lines in the log that all convey the same information (`[Errno 22] Invalid argument`), this I've just included as an example since its the only one that lists a filename.","files":null},{"type":3,"author":{"id":"0e75956bc1f9bf7e3cd1dc71486886c85ad6bfb7"},"timestamp":1637126761,"metadata":{"github-id":"IC_kwDODBZtRc4542Pc","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-971203548"},"message":"I think this might be related to #836. I was copying files from the original to the organized upload folder and renaming them to get around the `organize` bug, and decided to do the same for all the files that had this upload error as well. Those files are now uploading properly.","files":null},{"type":6,"author":{"id":"0e75956bc1f9bf7e3cd1dc71486886c85ad6bfb7"},"timestamp":1637126811,"metadata":{"github-id":"UCE_lALODBZtRc4542Pczh7_49I"},"target":"1d97a4d380bee632eac822cd0fda131de84d57f2f029c045ef6bd56b9f6f381c","message":"I think this might be related to #836. I was copying files from the original to the organized upload folder and renaming them to get around the `organize` bug, and decided to do the same for all the files that had this upload error as well (even though these files passed validation even after being organized). Those files are now uploading properly.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1637157347,"metadata":{"github-id":"IC_kwDODBZtRc456YUW","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-971605270"},"message":"I wonder if somehow Windows doesn't tolerate `+` in the filename somehow or may be a matter of shortened vs long filenames... but I have tried in an anaconda shell and this worked fine:\n\n```shell\n(base) C:\\Users\\DataLad\\tmp\u003epython -c \"print(open('sub-Aphid\\\\sub-Aphid_ses-Aphid07-HomeCage_behavior+ecephys.nwb').read())\" \n\"123\"   \n```\n\nre `organize` - did it use symlinks somehow? can you just open that file somehow otherwise - e.g. \n```\npython -c \"print(open(r'sub-Aphid\\\\sub-Aphid_ses-Aphid07-HomeCage_behavior+ecephys.nwb').read()[:2])\"                                                                                                                         \n```\n?","files":null},{"type":3,"author":{"id":"0e75956bc1f9bf7e3cd1dc71486886c85ad6bfb7"},"timestamp":1637165167,"metadata":{"github-id":"IC_kwDODBZtRc4561qj","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-971725475"},"message":"Update from the most recent upload attempt: files are still failing to upload, but different subsets of files are failing with the original error or failing with [the DEBUG failure I posted in my comment](https://github.com/dandi/dandi-cli/issues/837#issuecomment-971202626). The vast majority of files to appear to have this bug fixed by copying the files from the original folder to the organized one and renaming them, so this does seem to boil down to an `organize` issue.","files":null},{"type":3,"author":{"id":"0e75956bc1f9bf7e3cd1dc71486886c85ad6bfb7"},"timestamp":1637165400,"metadata":{"github-id":"IC_kwDODBZtRc4562g5","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-971728953"},"message":"I am using symlinks. Specifically, I have Anaconda prompt running on a Windows 10 machine, `pwd` is a mapped network drive Z: which points to a server where my data is stored. So my workflow is:\n```\nZ:/DREADDs_NWB/000165\u003e dandi validate Z:/DREADDs_NWB/000165\nZ:/DREADDs_NWB/000165\u003e dandi upload\n```","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1637167753,"metadata":{"github-id":"IC_kwDODBZtRc456_IY","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-971764248"},"message":"\u003e I am using symlinks.\n\nhm, on windows... (might explain why copying resolves the issue). mapped Windows drive or some other beast (I still wonder how a rare to windows world symlinks come to life there)?\nBTW, `organize` has an option to copy files as well.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1637168132,"metadata":{"github-id":"IC_kwDODBZtRc457Agr","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-971769899"},"message":"\u003e Z:/DREADDs_NWB/000165\u003e dandi validate Z:/DREADDs_NWB/000165\n\u003e Z:/DREADDs_NWB/000165\u003e dandi upload\n\nwhat does `dandi digest sub-Aphid\\sub-Aphid_ses-Aphid07-HomeCage_behavior+ecephys.nwb` says?","files":null},{"type":3,"author":{"id":"0e75956bc1f9bf7e3cd1dc71486886c85ad6bfb7"},"timestamp":1637176512,"metadata":{"github-id":"IC_kwDODBZtRc457exV","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-971893845"},"message":"Running `dandi digest` outputs no errors, just returns a long hex value. Log output also shows no errors. \n\n```\n2021-11-17T11:08:36-0800 [INFO    ] dandi 55028:41224 dandi v0.31.0, hdmf v3.1.1, pynwb v2.0.0, h5py v3.5.0\n2021-11-17T11:08:36-0800 [INFO    ] dandi 55028:41224 sys.argv = ['C:\\\\Users\\\\emily.jones\\\\Anaconda3\\\\envs\\\\nwb\\\\Scripts\\\\dandi', 'digest', 'sub-Honeybee/sub-Honeybee_ses-Honeybee01-HomeCage_behavior+ecephys.nwb']\n2021-11-17T11:08:36-0800 [INFO    ] dandi 55028:41224 os.getcwd() = Z:\\DREADDs_NWB\\000165\n2021-11-17T11:08:36-0800 [DEBUG   ] urllib3.connectionpool 55028:41224 Starting new HTTPS connection (1): rig.mit.edu:443\n2021-11-17T11:08:37-0800 [DEBUG   ] urllib3.connectionpool 55028:41224 https://rig.mit.edu:443 \"GET /et/projects/dandi/dandi-cli HTTP/1.1\" 200 471\n2021-11-17T11:08:37-0800 [DEBUG   ] dandi 55028:41224 Could not check dandi/dandi-cli for version updates: __init__() got an unexpected keyword argument 'encoding'\n2021-11-17T11:08:38-0800 [DEBUG   ] fscacher.cache 55028:41224 Calling memoized version of \u003cfunction get_digest at 0x000001F0A2A2ECA0\u003e for \\\\hub.gladstone.internal\\huanglab-lfp\\Emily\\DREADDs_NWB\\000165\\sub-Honeybee\\sub-Honeybee_ses-Honeybee01-HomeCage_behavior+ecephys.nwb\n2021-11-17T11:08:38-0800 [DEBUG   ] fscacher.cache 55028:41224 Running original \u003cfunction get_digest at 0x000001F0A2A2ECA0\u003e on '\\\\\\\\hub.gladstone.internal\\\\huanglab-lfp\\\\Emily\\\\DREADDs_NWB\\\\000165\\\\sub-Honeybee\\\\sub-Honeybee_ses-Honeybee01-HomeCage_behavior+ecephys.nwb'\n2021-11-17T11:08:38-0800 [DEBUG   ] fscacher.cache 55028:41224 Calling memoized version of \u003cfunction get_dandietag at 0x000001F0A2A34280\u003e for \\\\hub.gladstone.internal\\huanglab-lfp\\Emily\\DREADDs_NWB\\000165\\sub-Honeybee\\sub-Honeybee_ses-Honeybee01-HomeCage_behavior+ecephys.nwb\n2021-11-17T11:08:38-0800 [DEBUG   ] fscacher.cache 55028:41224 Running original \u003cfunction get_dandietag at 0x000001F0A2A34280\u003e on '\\\\\\\\hub.gladstone.internal\\\\huanglab-lfp\\\\Emily\\\\DREADDs_NWB\\\\000165\\\\sub-Honeybee\\\\sub-Honeybee_ses-Honeybee01-HomeCage_behavior+ecephys.nwb'\n2021-11-17T11:09:49-0800 [INFO    ] dandi 55028:41224 Logs saved in C:\\Users\\emily.jones\\AppData\\Local\\dandi\\dandi-cli\\Logs\\20211117190836Z-55028.log\n```\n\nNote that I ran this on a different session which just failed to upload with the `failed to compute digest` error. For reasons I don't understand, Aphid07-HomeCage uploaded with no issues on this iteration. I didn't change anything, it just uploaded fine.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1637178158,"metadata":{"github-id":"IC_kwDODBZtRc457jrF","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-971913925"},"message":"heh, \"mystery mystery\". I wonder if there is a chance to blame the mount (filesystem)/unstable network? ;-)","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1637178747,"metadata":{"github-id":"IC_kwDODBZtRc457lUs","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-971920684"},"message":"BTW -- could it have been that there were two processes (possibly on some other box where this volume originates) modifying that dandiset? \n\nI really do not throw away an idea that it might be a network issue since it gets saturated with both incoming (to fetch for the mount) and outgoing (to upload) traffic.\n\nanother relevant(ish) hit is https://stackoverflow.com/questions/48122798/oserror-errno-22-invalid-argument-when-reading-a-huge-file -- but there it talks about reading one large chunk of data at once, as if `part['size']` here was \"too large\" (more than 2-4 GB according to the post). And IIRC our largest part size is 5GB.  How large are those files? (hitting the above is unlikely but who knows)\nthat could explain may be original `","files":null},{"type":3,"author":{"id":"0e75956bc1f9bf7e3cd1dc71486886c85ad6bfb7"},"timestamp":1637178779,"metadata":{"github-id":"IC_kwDODBZtRc457laF","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-971921029"},"message":"Definitely possible it's a filesystem issue, thought I've never had any issues with this filesystem over the 7 years I've used it. I ran all the NWB file generation on it without issue and have uploaded larger datasets to CRCNS directly from it without any problem.","files":null},{"type":3,"author":{"id":"0e75956bc1f9bf7e3cd1dc71486886c85ad6bfb7"},"timestamp":1637178940,"metadata":{"github-id":"IC_kwDODBZtRc457l3R","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-971922897"},"message":"There should only have been 1 process modifying the dataset at a time. I'm the only person working on this dataset, and I only have one Conda shell open with a single process running. No one else is modifying the dataset either through dandi or otherwise.\n\nThe files are 100-250MB, so not very large","files":null},{"type":3,"author":{"id":"0e75956bc1f9bf7e3cd1dc71486886c85ad6bfb7"},"timestamp":1637179104,"metadata":{"github-id":"IC_kwDODBZtRc457mVr","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-971924843"},"message":"Rerunning `dandi upload` without changing anything does upload a few more files, which could point to a network issue. I'm not having any issues with network connectivity outside of that dandi process. What I don't understand is why I'm getting 2 separate issues (`[Errno 22] Invalid argument` and `failed to compute digest`), neither of which say anything about a network connection.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1637185317,"metadata":{"github-id":"IC_kwDODBZtRc458NLr","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-972083947"},"message":"well, since it is a (network) filesystem - nothing can/should know about network.  But indeed why errors are not really about filesystem -- that remains a puzzle.  But we also derailed from \"symlinks\" aspect.  What if you have proper copies -- does any of those happen?\n\nAFAIK symlink support in windows is ... peculiar (IIRC requires admin privileges to enable etc), and I think you are the first person I see using them on windows.  So I wonder if may be something \"symlinks on Windows related\"?\n\nquick google gives me https://www.py4u.net/discuss/176524 . wild guess - `/` in symlink path?  is there way to see where symlink points on windows?","files":null},{"type":3,"author":{"id":"0e75956bc1f9bf7e3cd1dc71486886c85ad6bfb7"},"timestamp":1637198325,"metadata":{"github-id":"IC_kwDODBZtRc459Z-B","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-972398465"},"message":"Not sure what you mean by proper copies?\n\nI eventually got everything to upload simply by running the upload command over and over, uploading a subset of the error-generating files each time, not changing anything between runs.\n\nI can't replicate this bug anymore because everything is uploaded, and even when it was generating errors it was a random subset of files so I don't know what was causing the failures.\n\nHere are all the steps I did:\n1. Used MatNWB to generate the NWB files. Original data and subsequent NWB files were all on a server. Matlab was running on my local machine.\n2. Mounted the server as a mapped network drive.\n3. Generated the conda env with required packages and set the pwd to a directory inside the mapped drive.\n4. Ran `dandi validate` on the original NWB files, then `dandi download \u003carchive\u003e`, cd to the newly created archive directory, then `dandi organize \u003cdirectory of the original data\u003e. This generated a copy of the original NWB files in the archive directory with files renamed.\n5. Several files in the archive directory had validation errors that they didn't have in the original NWB directory, resolved by copying the files from the original to the archive directory and renaming them. Collectively about 1/3rd of the NWB files wouldn't upload on the first attempt, due to either the error message or the debug message I posted above. Running `dandi upload` again would upload a subset of those files without anything changing between runs. After running `dandi upload` 6 times, managed to get all the data uploaded.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1637199366,"metadata":{"github-id":"IC_kwDODBZtRc459flM","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-972421452"},"message":"eh, so we would let the bugs prosper :-/  would you be so kind to do smth like `grep \"setting files_mode\" C:\\Users\\emily.jones\\AppData\\Local\\dandi\\dandi-cli\\Logs\\20211117*` -- I still desire confirmation that mode was set to symlink.","files":null},{"type":3,"author":{"id":"0e75956bc1f9bf7e3cd1dc71486886c85ad6bfb7"},"timestamp":1637249614,"metadata":{"github-id":"IC_kwDODBZtRc45_nKh","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-972976801"},"message":"That returns no results. None of my log files, from uploading or validating, contain anything resembling it (setting file, setting file_mode, files_mode all return nothing).","files":null},{"type":3,"author":{"id":"0e75956bc1f9bf7e3cd1dc71486886c85ad6bfb7"},"timestamp":1637250481,"metadata":{"github-id":"IC_kwDODBZtRc45_qbW","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-972990166"},"message":"Github won't allow me to upload the log files, so here they are on a Google drive:\n * [Log file with several errors and failures in uploading](https://drive.google.com/file/d/19Gno6Sj5wdfAUaR3CVLZu7hAoNxfy8Jm/view?usp=sharing)\n * [Log file where nothing changed since the last upload, but everything uploaded fine](https://drive.google.com/file/d/1lFUg0xIb8O44pFVcUOGRGNKHs0ID-Ob8/view?usp=sharing)","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1637260821,"metadata":{"github-id":"IC_kwDODBZtRc46ARwh","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-973151265"},"message":"\u003e That returns no results. None of my log files, from uploading or validating, contain anything resembling it (setting file, setting file_mode, files_mode all return nothing).\n\nI guess we do not safe log to file for some other commands (like `organize`) -- filed https://github.com/dandi/dandi-cli/issues/838 .","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1645556017,"metadata":{"github-id":"IC_kwDODBZtRc4-eOOF","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-1048109957"},"message":"@emilyasterjones did you have a chance/need to upload since back then, and either you encountered similar issues?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1648241510,"metadata":{"github-id":"IC_kwDODBZtRc5AVrja","github-url":"https://github.com/dandi/dandi-cli/issues/837#issuecomment-1079425242"},"message":"I am afraid the mystery would remain for now, until/if someone would run into a similar odd behavior.  Meanwhile I will close this issue but feel free to reopen if issue persists.","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1648241510,"metadata":{"github-id":"CE_lADODBZtRc4-6s_mzwAAAAF4GrIM"},"status":2}]}