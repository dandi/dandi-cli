{"version":2,"ops":[{"type":5,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1616683008,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDQ1MDgyMzQzMjE="},"added":["enhancement"],"removed":[]},{"type":5,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1616683008,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDQ1MDgyMzQzMjQ="},"added":["UX"],"removed":[]},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1616686569,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgwNjk2MzIzOA==","github-url":"https://github.com/dandi/dandi-cli/issues/501#issuecomment-806963238"},"message":"i think there are two possible sets of operations:\n\n1. what happens with a sync with `--delete` option. sync can be in both directions. \n2. what one can do in a shell like mode. it would be nice to have `dandi [ls, delete, rename]` to operate like a shell on the server.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1616689774,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgwNzA0OTYzOQ==","github-url":"https://github.com/dandi/dandi-cli/issues/501#issuecomment-807049639"},"message":"@yarikoptic To be clear:\n* This command is only for deleting local and remote assets, not deleting Dandisets.\n* The command should take a set of URLs and/or paths on the command line.\n    * URL arguments must specify assets, which will be deleted on the remote end.\n    * Path arguments are only valid when running inside a local Dandiset.  They cause the corresponding remote assets to be deleted, along with the local assets if `--remote-only` is not given.\n\nIs that how you want this to work?\n\n\u003e deletion is forbidden by API server for assets in released versions\n\nThis would be better as a test in `test_dandiapi.py` rather than as a test of the command.\n\n\u003e deletion in the draft does not delete assets (by downloading so we are certain that blobs are not removed from keystore) present in prior released versions\n\nWe already have a test of that in `test_dandiapi:test_publish_and_manipulate`.","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1616689774,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDQ2MTc3ODgz"},"target":"4c1b2081770b99cf9c02ebb67b2c7b33062c31a3457e95a0944c9e8b645f8b58","message":"@yarikoptic To be clear:\n* This command is only for deleting local and remote assets, not deleting Dandisets.\n* The command should take a set of URLs and/or paths on the command line.\n    * URL arguments must specify assets on a new Dandi API instance, and the assets will be deleted on the remote end.\n    * Path arguments are only valid when running inside a local Dandiset.  They cause the corresponding remote assets to be deleted, along with the local assets if `--remote-only` is not given.\n        * Should paths only be accepted if `-i` is given with a new Dandi API instance?\n\nIs that how you want this to work?\n\n\u003e deletion is forbidden by API server for assets in released versions\n\nThis would be better as a test in `test_dandiapi.py` rather than as a test of the command.\n\n\u003e deletion in the draft does not delete assets (by downloading so we are certain that blobs are not removed from keystore) present in prior released versions\n\nWe already have a test of that in `test_dandiapi:test_publish_and_manipulate`.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1616690545,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgwNzA3MTc1Nw==","github-url":"https://github.com/dandi/dandi-cli/issues/501#issuecomment-807071757"},"message":"re @satra :\n\u003e 1. what happens with a sync with `--delete` option. sync can be in both directions.\n\nLet's keep non-existing `sync` (#365) mode or command out of this issue for now.\n\n\u003e 2. what one can do in a shell like mode. it would be nice to have `dandi [ls, delete, rename]` to operate like a shell on the server.\n\nyeap, we have `ls` already. This issue for `delete`  and eventually we might want `rename` indeed.  Then implemented interfaces could be used for `sync`.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1616691232,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgwNzA4OTY5NA==","github-url":"https://github.com/dandi/dandi-cli/issues/501#issuecomment-807089694"},"message":"\u003e @yarikoptic To be clear:\n\u003e \n\u003e * This command is only for deleting local and remote assets, not deleting Dandisets.\n\nI would say - if provided specification resolves to a dandiset without specification of any path, we could as well call out to `DELETE /dandisets/{dandiset__pk}/` end-point.  It would be a good test for dandi-api to disallow that (unless admin) ;-)\n\n\u003e * The command should take a set of URLs and/or paths on the command line.\n\nyeah, to the same degree as `download` does (I believe mixing of paths and URLs is not allowed)\n\n\u003e   * URL arguments must specify assets on a new Dandi API instance, and the assets will be deleted on the remote end.\n\nmight be an asset, a \"folder\" (location?) or entire dandiset (see above) -- similarly to `download`.\n\n\u003e   * Path arguments are only valid when running inside a local Dandiset. \n\nI think that is true if the same is true for download ATM (i.e. could I `download  /tmp/000001/` which has `dandiset.yaml` and I am outside of `/tmp/000001`?)\n\n\u003e  They cause the corresponding remote assets to be deleted, along with the local assets if `--remote-only` is not given.\n\ncorrect... not sure if we should worry about possible empty directories left locally \n   \n\u003e     * Should paths only be accepted if `-i` is given with a new Dandi API instance?\n\nI would say \"no\" in a sense that we should default to some instance (ATM girder - NotImplemented).\nIf remote dandiset is not found - error out stating that this dandiset does not exist on server.\n\n\u003e Is that how you want this to work?\n\u003e \n\u003e \u003e deletion is forbidden by API server for assets in released versions\n\nyes (although I am not sure if admin user is allowed ATM, better not for now I would say)\n \n\u003e This would be better as a test in `test_dandiapi.py` rather than as a test of the command.\n\nup to you\n \n\u003e \u003e deletion in the draft does not delete assets (by downloading so we are certain that blobs are not removed from keystore) present in prior released versions\n\u003e \n\u003e We already have a test of that in `test_dandiapi:test_publish_and_manipulate`.\n\nI see it indeed having `client.delete_asset_bypath(dandiset_id, \"draft\", \"subdir/file.txt\")` and that one in turn queries first for asset uuid and then calls delete on it -- great!  I hope that would be sufficient!","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1616692126,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgwNzExMjczNw==","github-url":"https://github.com/dandi/dandi-cli/issues/501#issuecomment-807112737"},"message":"@yarikoptic \n\n\u003e\u003e The command should take a set of URLs and/or paths on the command line.\n\u003e\n\u003e yeah, to the same degree as download does (I believe mixing of paths and URLs is not allowed)\n\nIt appears that `download` only accepts URLs, and no more than one per invocation.  What should `delete` do?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1616701351,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgwNzM1NTkzMQ==","github-url":"https://github.com/dandi/dandi-cli/issues/501#issuecomment-807355931"},"message":"oh, I guess I confused myself with all the datalad dandisets and/or `dandi ls` which IIRC does take both paths and URLs. So let's proceed with support of both, if needed adopting the same logic as ls on deciding if url is given or a path","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1616704537,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgwNzQxNDY0Nw==","github-url":"https://github.com/dandi/dandi-cli/issues/501#issuecomment-807414647"},"message":"@yarikoptic New write-up of command behavior; is this what you want?\n\n* The command takes a set of URLs and/or paths on the command line.\n* URL arguments must specify Dandisets or assets (the latter by pointing to either folders or individual items).\n    * A URL pointing to a Dandiset indicates that the Dandiset should be deleted on the server.\n        * **Question:** Should each Dandiset be deleted (after prompting for confirmation) as its URL is processed, or should they all be saved up for the end of the command and deleted with a single confirmation?  If the latter, should the Dandiset deletion confirmation be part of the asset deletion confirmation, or should they be two separate confirmations?\n    * A URL pointing to one or more assets indicates that the given assets should be deleted on the server.\n    * A URL pointing to a Girder instance results in an error.\n    * **Question:** What should happen if a non-asset URL includes a version component?\n* Path arguments are only valid when running inside a local Dandiset. They cause the corresponding remote assets to be deleted, along with the local assets if `--remote-only` is not given.\n    * The server from which to delete the assets is specified by the `-i` option.  By default, this points to the Girder server, which raises an error.\n    * Local Dandisets which do not exist on the server should be detected and result in an error.\n    * **Question:** Should path arguments require the current directory to be the root of the local Dandiset, or is it also acceptable for the current directory to be a subdirectory of the Dandiset?\n* **Question:** If the `-i` option is given with URL arguments and the URLs point to a different instance than that given by `-i`, should anything happen?\n\n\u003e before jumping to the action, should ask user confirmation alike \"Do you want to delete {len(assets)} from the {dandiset} on the server and {len(files)} local files?\"\n\nThis implies that you want a separate confirmation for each Dandiset from which assets are being deleted.  Do you?","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1616704537,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDQ2MjY3NDEy"},"target":"ca31b00539c0ac002a5cd7d148743c35a5eeef5e6ddf553a2bee80fe1db20edc","message":"@yarikoptic New write-up of command behavior; is this what you want?\n\n* The command takes a set of URLs and/or paths on the command line.\n* URL arguments must specify Dandisets or assets (the latter by pointing to either folders or individual items).\n    * A URL pointing to a Dandiset indicates that the Dandiset should be deleted on the server.\n        * **Question:** Should each Dandiset be deleted (after prompting for confirmation) as its URL is processed, or should they all be saved up for the end of the command and deleted with a single confirmation?  If the latter, should the Dandiset deletion confirmation be part of the asset deletion confirmation, or should they be two separate confirmations?\n    * A URL pointing to one or more assets indicates that the given assets should be deleted on the server.\n    * A URL pointing to a Girder instance results in an error.\n    * **Question:** What should happen if a non-asset URL includes a version component?\n* Path arguments are only valid when running inside a local Dandiset. They cause the corresponding remote assets to be deleted, along with the local assets if `--remote-only` is not given.\n    * The server from which to delete the assets is specified by the `-i` option.  By default, this points to the Girder server, which raises an error.\n    * Local Dandisets which do not exist on the server should be detected and result in an error.\n    * **Question:** What should happen when a given local path does not exist on the server?\n    * **Question:** When a path to a directory is given, how should the assets within be identified?  Should all files be searched for on the server, with those not found simply ignored?\n    * **Question:** Should path arguments require the current directory to be the root of the local Dandiset, or is it also acceptable for the current directory to be a subdirectory of the Dandiset?\n* **Question:** If the `-i` option is given with URL arguments and the URLs point to a different instance than that given by `-i`, should anything happen?\n\n\u003e before jumping to the action, should ask user confirmation alike \"Do you want to delete {len(assets)} from the {dandiset} on the server and {len(files)} local files?\"\n\nThis implies that you want a separate confirmation for each Dandiset from which assets are being deleted.  Do you?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1616706978,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgwNzUwMzMwNQ==","github-url":"https://github.com/dandi/dandi-cli/issues/501#issuecomment-807503305"},"message":"I feel that we should not even support operations across dandisets ATM, so multiple dandisets are \"detected\" and we can abort right away with ValueError.\n\nI composed the reply but all good questions made me decide that we should not bother about any local files deletion whatsoever.  `delete` though should still allow for paths as to determine what to delete on the remote server.  Later all the `--sync` command/modes could be used for more \"advanced\" operation which could lead to local files deletion.\n\nWith that in mind let me give answers:\n\nOn per-file/path basis ideally we should provide similar to other commands pyout based interface which would allow for errors to be reported but operation would continue, with non-0 exit code if any error was detected.\n\n\u003e * **Question:** What should happen if a non-asset URL includes a version component?\n\nI guess if it is a path or full dandiset -- proceed with request to server, and it should error (thus again we would test dandi-api)\n\n\u003e Question: What should happen when a given local path does not exist on the server?\n\n`dandi.exceptions.NotFoundError`\n\n\u003e Question: When a path to a directory is given, how should the assets within be identified? Should all files be searched for on the server, with those not found simply ignored?\n\nlet's operate \"semantically\", i.e. if `dandi delete --delete-local sub-X` is given, we take it to query remote for that path on remote side and delete those assets, without traversing local `sub-X` which might have different ones.\n\n\u003e Question: Should path arguments require the current directory to be the root of the local Dandiset, or is it also acceptable for the current directory to be a subdirectory of the Dandiset?\n\nyes - allow to be in a subdirectory, I believe we already have code to deduce top directory of the dandiset to compose paths relative to it.\n\n\u003e Question: If the -i option is given with URL arguments and the URLs point to a different instance than that given by -i, should anything happen?\n\nLet's make URLs simply supersede what `-i` might say.  Alternatively we could play safer and default it to `None` so if any value specified explicitly, only then abort with an error that URL is pointing to a different than explicitly specified archive.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1616762491,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgwODE4NTA4OA==","github-url":"https://github.com/dandi/dandi-cli/issues/501#issuecomment-808185088"},"message":"@yarikoptic\n\n* Do you want this to be implemented as a `delete()` function that does all the work and is simply called by the `delete` command?  Because, if not, I don't see the point of specifying what types of exceptions to raise, since they'll all be the same to the user.\n* Should each Dandiset be deleted (after prompting for confirmation) as its URL is processed, or should they all be saved up for the end of the command and deleted with a single confirmation? If the latter, should the Dandiset deletion confirmation be part of the asset deletion confirmation, or should they be two separate confirmations?\n\n\u003e \u003e * **Question:** What should happen if a non-asset URL includes a version component?\n\u003e \n\u003e I guess if it is a path or full dandiset -- proceed with request to server, and it should error (thus again we would test dandi-api)\n\nDo you mean that the request should be made to the Dandiset deletion endpoint, ignoring the version?  And what kind of path argument would include a version component?\n\n\u003e \u003e Question: When a path to a directory is given, how should the assets within be identified? Should all files be searched for on the server, with those not found simply ignored?\n\u003e \n\u003e let's operate \"semantically\", i.e. if `dandi delete --delete-local sub-X` is given, we take it to query remote for that path on remote side and delete those assets, without traversing local `sub-X` which might have different ones.\n\nWhat exactly is `--delete-local` supposed to do?  What happens if the user runs `dandi delete sub-X` without `--delete-local`?","files":null}]}