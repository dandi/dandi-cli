{"version":2,"ops":[{"type":1,"author":{"id":"f3856669ae05db18871381e4a2bf44e84858d017"},"timestamp":1700537506,"metadata":{"github-id":"I_kwDODBZtRc53aUut","github-url":"https://github.com/dandi/dandi-cli/issues/1362","origin":"github"},"title":"`client.dandi_authenticate` blocks during programmatic use","message":"Hello!\n\nI'm downloading datasets programmatically, and ran into a stumbling block with auth.\n\n## Problem\n\nCurrently, when trying to download an embargoed dataset, the client (when invoked with the cli `download` command or the underlying `download` function) will stop and wait for user authentication input. This happens in the `ParsedDandiURL.navigation` method:\n\nhttps://github.com/dandi/dandi-cli/blob/10d076e7bd9625840d8a4e1cab8a49d986c415ea/dandi/dandiarchive.py#L170-L180\n\ncalled by the `Downloader.download_generator` method:\n\nhttps://github.com/dandi/dandi-cli/blob/10d076e7bd9625840d8a4e1cab8a49d986c415ea/dandi/download.py#L229\n\nThis makes sense for interactive use, but makes programmatic use difficult - since the exception is not thrown, there is no way to catch it. So eg. when downloading a list of datasets where we aren't certain in advance whether we have access to them, i would want to skip the ones we don't have access to, but in order to do that I had to pre-check each dataset like this:\n\n```python\ndef check_auth(url:ParsedDandiURL) -\u003e bool:\n    with url.get_client() as client:\n        try:\n            dandiset = url.get_dandiset(client, lazy=False)\n        except requests.HTTPError as e:\n            if e.response.status_code == 401:\n                return False\n            else:\n                raise\n        return True\n```\n\n## Options\n\n### Detect click\n\nclick allows you to check whether you are inside of a click context, so the `dandi_authenticate` method could check if we're in an interactive session and only ask for credentials if so (eg. before getting to the interactive block here: https://github.com/dandi/dandi-cli/blob/master/dandi/dandiapi.py#L499\n\n```python\nimport click\n\ndef is_interactive() -\u003e bool:\n    try:\n        _ = click.get_current_context()\n        return True\n    except RuntimeError as e:\n        if 'no active click context' in str(e).lower():\n            return False\n        else:\n            raise\n\ndef dandi_authenticate(self) -\u003e None:\n    # ... \n    if is_interactive():\n        while True:\n            # ...\n    else:\n        raise UnauthorizedError('need to provide credentials...') # or whatever the exception would be named\n\n```\n\nI see that there [already is](https://github.com/dandi/dandi-cli/blob/10d076e7bd9625840d8a4e1cab8a49d986c415ea/dandi/utils.py#L71) a `is_interactive` function, so not sure if that is the more appropriate check or whether looking for a click context is.\n\n### Provide Auth explicitly\n\nCurrently the `authenticate` arg to `navigate` is a bool, and it's not possible to pass auth information from the top-level `download` function. If instead the `download` function had a `credentials` or `key` or whatever you want to call it arg, then absence of credentials could always raise an exception rather than prompting when not invoked via the click download command. \n\nIt is currently possible to provide credentials to the `DandiAPIClient` object, though it is not possible to provide an already-instantiated client to the `download` method, so it is possible to authenticate properly in a few ways, but it is not possible to purposely skip authentication when we intend/expect to fail auth. Propagating creds from the top-level `download` function would be one way of a) allowing explicit auth while also b) allowing explicit non-auth, depending on whether creds are provided.\n\n---\n\nas usual, lmk if there is something i'm missing, or if there is an intended way to skip unauthorized downloads when using the API programmatically. I'd be happy to draft PRs for either of the above options or for docs if i'm just missing some intended use.","files":null}]}