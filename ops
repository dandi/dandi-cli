{"version":2,"ops":[{"type":1,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1711827512,"metadata":{"github-id":"I_kwDODBZtRc6EHzxy","github-url":"https://github.com/dandi/dandi-cli/issues/1426","origin":"github"},"title":"`dandi delete` doesn't get all assets to delete.","message":"Needed to delete errorneously uploaded `code/venvs`.  Got alarmed first when number of assets reported by `delete` was smaller than the ones I get from `dandi ls`:\n\n```\n❯ dandi delete dandi://dandi/000876/code/venvs/\nDelete 22138 assets on server from Dandiset 000876? [y/N]: ^C\n2024-03-30 15:19:43,325 [    INFO] Logs saved in /home/yoh/.local/state/dandi-cli/log/20240330191859Z-261412.log\n\n❯ dandi ls dandi://dandi/000876/code/ \u003e /tmp/ls-out\n2024-03-30 15:20:13,599 [    INFO] Logs saved in /home/yoh/.local/state/dandi-cli/log/20240330191952Z-261644.log\n\n❯ grep 'path: code/venvs' /tmp/ls-out | nl | tail\n...\n28262\t  path: code/venvs/reposit/share/man/man1/ttx.1\n```\n\nso we got 22138 offered to be removed out of 28262?  Then I deleted a folder with 3 for a test:\n```\n❯ dandi delete dandi://dandi/000876/code/venvs/reposit/share/jupyter/nbextensions/jupyter-js-widgets/\nDelete 3 assets on server from Dandiset 000876? [y/N]: y\nPATH                                                                   STATUS     MESSAGE\n.../reposit/share/jupyter/nbextensions/jupyter-js-widgets/extension.js Deleted           \n...re/jupyter/nbextensions/jupyter-js-widgets/extension.js.LICENSE.txt Deleted           \n...osit/share/jupyter/nbextensions/jupyter-js-widgets/extension.js.map Deleted           \nSummary:                                                               3 Deleted         \n2024-03-30 15:22:07,795 [    INFO] Logs saved in /home/yoh/.local/state/dandi-cli/log/20240330192204Z-262295.log\n```\n\nand upon subsequent full delete request I got larger number of assets!\n```shell\n❯ dandi delete dandi://dandi/000876/code/venvs/\nDelete 23025 assets on server from Dandiset 000876? [y/N]: \n```\n\nThere were changes in listing of assets on dandi-archive side, but I would not expect `delete` differ from `ls` where afaik they likely use the same end point and `ls` seems to reflect number of deleted files correctly going down:\n\n```\n❯ dandi ls dandi://dandi/000876/code/ \u003e /tmp/ls-out2\n2024-03-30 15:28:24,988 [    INFO] Logs saved in /home/yoh/.local/state/dandi-cli/log/20240330192803Z-263470.log\n❯ grep 'path: code/venvs' /tmp/ls-out | nl | tail -n 1\n 28262\t  path: code/venvs/reposit/share/man/man1/ttx.1\n❯ grep 'path: code/venvs' /tmp/ls-out2 | nl | tail -n 1\n 28259\t  path: code/venvs/reposit/share/man/man1/ttx.1\n``` \n\nInteresting the logs for `delete` seems to have some `Caught exception` (without detail) whenever ls didn't:\n\n```\n❯ grep 'Caught exception' /home/yoh/.local/state/dandi-cli/log/20240330*.log\n/home/yoh/.local/state/dandi-cli/log/20240330191859Z-261412.log:2024-03-30T15:19:43-0400 [DEBUG   ] dandi 261412:139629642821696 Caught exception \n/home/yoh/.local/state/dandi-cli/log/20240330192136Z-262149.log:2024-03-30T15:21:38-0400 [DEBUG   ] dandi 262149:140064119992384 Caught exception Asset path 'code/__pycache__' points to a directory but lacks trailing /\n/home/yoh/.local/state/dandi-cli/log/20240330192239Z-262435.log:2024-03-30T15:28:01-0400 [DEBUG   ] dandi 262435:139637496152128 Caught exception \n```\n\nit seems that pagination is not sequential requests (or at least not necessarily arriving in the order sent), so I wonder if there is some race condition and some exception causes early exit from collation of paginated requests?  \n\nAttests to that differing number of assets it lists across invocations:\n\n```shell\n❯ dandi delete dandi://dandi/000876/code/venvs/\nDelete 22560 assets on server from Dandiset 000876? [y/N]: n\n2024-03-30 15:33:02,301 [    INFO] Logs saved in /home/yoh/.local/state/dandi-cli/log/20240330193213Z-264477.log\ndandi delete dandi://dandi/000876/code/venvs/  22.10s user 0.24s system 45% cpu 49.470 total\n❯ dandi delete dandi://dandi/000876/code/venvs/\nDelete 22634 assets on server from Dandiset 000876? [y/N]: \n```\n\nBTW that \"Caught exception\" is not always logged for `delete` -- another sign of some inconsistent execution seems to me.\n\nI will not delete and exclude dataladification (does not work with .gitignore!) of this dandiset for now so we have working example of problematic case to ease troubleshooting...","files":null}]}