{"version":2,"ops":[{"type":1,"author":{"id":"2db4f5da888e2bc30bfef7de9879ca52bb0fac9e"},"timestamp":1749147473,"metadata":{"github-id":"I_kwDODBZtRc66GMeb","github-url":"https://github.com/dandi/dandi-cli/issues/1650","origin":"github"},"title":"Duplicate blob when uploading via CLI","message":"I'm running a local instance of dandi-archive (master) using dandi-schema (master).\n\nI've installed dandi cli via `pip install dandi` in a separate venv \n\n```\npip freeze | grep dandi  \ndandi==0.69.3\ndandischema==0.11.1\n```\n\n```\n$ dandi organize .\n$ dandi upload . \n```\n\n\u003cdetails\u003e\u003csummary\u003e  Output and traceback\u003c/summary\u003e\n\n```\n2025-06-05 13:11:07,679 [    INFO] Found 3 files to consider\nPATH                                                                     SIZE    ERRORS PROGRESS STATUS           MESSAGE                  \ndandiset.yaml                                                            2.3 kB                  skipped          should be edited online  \n...-unsorted-nac/sub-Temp-pref-F30-B30-5dpf-01-unsorted-nac_behavior.nwb 9.3 MB                  pre-validating                            \n...mp-pref-F30-B30-5dpf-01-unsorted-nac_ses-20230808T111800_behavior.nwb 9.3 MB                  pre-validating                            \nSummary:                                                                 18.7 MB                 1 skipped        1 should be edited online\n                                                                                                 2 pre-validating                          \n/home/austin/.pyenv/versions/3.11.12/envs/tmp-dandi-cli/lib/python3.11/site-packages/hdmf/spec/namespace.py:583: UserWarning: Ignoring the following cached namespace(s) because another version is already loaded:\ncore - cached version: 2.4.0, loaded version: 2.8.0\nThe loaded extension(s) may not be compatible with the cached extension(s) in the file. Please check the extension documentation and ignore this warning if these versions are compatible.\n  self.warn_for_ignored_namespaces(ignored_namespaces)\nPATH                                                    SIZE    ERRORS PROGRESS STATUS                MESSAGE                              dandiset.yaml                                           2.3 kB                  skipped               should be edited online              \n...-Temp-pref-F30-B30-5dpf-01-unsorted-nac_behavior.nwb 9.3 MB    0             ERROR                 Error 404 while sending POST reque...\n...dpf-01-unsorted-nac_ses-20230808T111800_behavior.nwb 9.3 MB    0             ERROR                 Error 404 while sending POST reque...\nSummary:                                                18.7 MB                 1 skipped             1 should be edited online            \n                                                                                2 ERROR               2 Error some while sending POST re...\n2025-06-05 13:11:08,841 [    INFO] Logs saved in /home/austin/.local/state/dandi-cli/log/2025.06.05-18.11.07Z-553648.log\nTraceback (most recent call last):\n  File \"/home/austin/.pyenv/versions/tmp-dandi-cli/bin/dandi\", line 8, in \u003cmodule\u003e\n    sys.exit(main())\n             ^^^^^^\n  File \"/home/austin/.pyenv/versions/3.11.12/envs/tmp-dandi-cli/lib/python3.11/site-packages/click/core.py\", line 1161, in __call__\n    return self.main(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/austin/.pyenv/versions/3.11.12/envs/tmp-dandi-cli/lib/python3.11/site-packages/click/core.py\", line 1082, in main\n    rv = self.invoke(ctx)\n         ^^^^^^^^^^^^^^^^\n  File \"/home/austin/.pyenv/versions/3.11.12/envs/tmp-dandi-cli/lib/python3.11/site-packages/click/core.py\", line 1697, in invoke\n    return _process_result(sub_ctx.command.invoke(sub_ctx))\n                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/austin/.pyenv/versions/3.11.12/envs/tmp-dandi-cli/lib/python3.11/site-packages/click/core.py\", line 1443, in invoke\n    return ctx.invoke(self.callback, **ctx.params)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/austin/.pyenv/versions/3.11.12/envs/tmp-dandi-cli/lib/python3.11/site-packages/click/core.py\", line 788, in invoke\n    return __callback(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/austin/.pyenv/versions/3.11.12/envs/tmp-dandi-cli/lib/python3.11/site-packages/click/decorators.py\", line 45, in new_func\n    return f(get_current_context().obj, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/austin/.pyenv/versions/3.11.12/envs/tmp-dandi-cli/lib/python3.11/site-packages/dandi/cli/base.py\", line 126, in wrapper\n    return f(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/home/austin/.pyenv/versions/3.11.12/envs/tmp-dandi-cli/lib/python3.11/site-packages/dandi/cli/cmd_upload.py\", line 103, in upload\n    upload(\n  File \"/home/austin/.pyenv/versions/3.11.12/envs/tmp-dandi-cli/lib/python3.11/site-packages/dandi/upload.py\", line 461, in upload\n    raise upload_err\n  File \"/home/austin/.pyenv/versions/3.11.12/envs/tmp-dandi-cli/lib/python3.11/site-packages/dandi/upload.py\", line 359, in process_path\n    for r in dfile.iter_upload(\n  File \"/home/austin/.pyenv/versions/3.11.12/envs/tmp-dandi-cli/lib/python3.11/site-packages/dandi/files/bases.py\", line 363, in iter_upload\n    resp = client.post(\n           ^^^^^^^^^^^^\n  File \"/home/austin/.pyenv/versions/3.11.12/envs/tmp-dandi-cli/lib/python3.11/site-packages/dandi/dandiapi.py\", line 317, in post\n    return self.request(\"POST\", path, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/austin/.pyenv/versions/3.11.12/envs/tmp-dandi-cli/lib/python3.11/site-packages/dandi/dandiapi.py\", line 285, in request\n    raise HTTP404Error(msg, response=result)\ndandi.exceptions.HTTP404Error: Error 404 while sending POST request to http://localhost:8000/api/uploads/initialize/: {\"detail\":\"Not found.\"}\n```\n\u003c/details\u003e\n\nThe upload has made it into my dandiset locally, but we do have that traceback. Looking closer, I think this happens because `dandi organize` created a symlink, and `dandi upload` essentially tries to upload the same file twice.","files":null}]}