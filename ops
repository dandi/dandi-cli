{"version":2,"ops":[{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1623715721,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlRWRpdDo1NTU2OTM5MDc="},"target":"6979fbe91546d45a29c7086d92d2c646c49646ba78ae5168862e4a610ce89994","message":"use case brought up by @bendichter but also would be common for any user: ATM it is quite some exercise to get the \"canonical\" url for an asset content to e.g. use ROS3 driver to load it.  E.g. with dandi-cli API we can do\n\n```shell\n$\u003e python -c 'from dandi.dandiapi import DandiAPIClient; print(list(DandiAPIClient(\"https://api.dandiarchive.org/api\").get_dandiset_assets(\"000027\", \"draft\", path=\"sub-RAT123/sub-RAT123.nwb\", include_metadata=True))[0][\"metadata\"][\"contentUrl\"])' \n['https://api.dandiarchive.org/api/dandisets/000027/versions/draft/assets/ff453f4c-a435-4a5d-a48b-128abca5ec47/download/', 'https://dandiarchive.s3.amazonaws.com/blobs/2db/af0/2dbaf0fd-5003-4a0a-b4c0-bc8cdbdb3826?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAUBRWC5GAEKH3223E%2F20210614%2Fus-east-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20210614T233243Z\u0026X-Amz-Expires=21600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=8566a53bfc2677f08f3998625cf1256952cfdf7c0211d3e321be746aabfd735a']\n```\nso a good implementation would need to check first that we get a single asset, and then filter urls for the one which is provided by that API.  I think we should have a convenience function which accomplishes the same but easier and just return the URL matching the API endpoint .  Should be done as a part of the Python API refactoring","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1623716145,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2MTA3NDE0OQ==","github-url":"https://github.com/dandi/dandi-cli/issues/672#issuecomment-861074149"},"message":"do note that this is one of the things that should change on the API side, the injected metadata should not contain the signed url.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1623759409,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2MTQ0ODk0NQ==","github-url":"https://github.com/dandi/dandi-cli/issues/672#issuecomment-861448945"},"message":"@yarikoptic What arguments should this function take?  What URL should it return: the asset endpoint or the download URL?  Is it acceptable to implement this as just a property of the `RemoteAsset` class?","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1623760883,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2MTQ2NDU0OA==","github-url":"https://github.com/dandi/dandi-cli/issues/672#issuecomment-861464548"},"message":"let's not hack this in the CLI. we should just return the appropriate content URL in the CLI, and the API should return either presigned (for future embargoed datasets) or public URLs. otherwise the CLI would have to determine if the bucket is public or private.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1623761811,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2MTQ3NDc0OQ==","github-url":"https://github.com/dandi/dandi-cli/issues/672#issuecomment-861474749"},"message":"@satra -- the idea above was to return the API's `/download` endpoint url and then it would be for people to use it.  There is not that much \"hack\" for that in CLI -- just a convenience shortcut IMHO which would work even whenever API mutates (e.g. whenever `/files` returns full records after https://github.com/dandi/dandi-api/pull/312 we could avoid needing two calls etc).\n\n@jwodder -- property would be fine I think.  So it would be `DandiAPIClient().get_dandiset('000027').get_asset_by_path('sub-RAT123/sub-RAT123.nwb').url` ? If we add some sugarings I had mentioned, I think it could eventually be as `DandiAPIClient()['000027']['sub-RAT123/sub-RAT123.nwb'].url`","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1623762150,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2MTQ3ODY2OA==","github-url":"https://github.com/dandi/dandi-cli/issues/672#issuecomment-861478668"},"message":"@yarikoptic \n\n\u003e So it would be `DandiAPIClient().get_dandiset('000027').get_asset_by_path('sub-RAT123/sub-RAT123.nwb').url`?\n\nIf it's meant to return the download URL, then I'm going to name the property `download_url`.  Plain `url` should be used for the `/assets/{asset_id}/` endpoint (though I'd prefer to call that one `api_url`).\n\nAnyway, I've added it to #660: https://github.com/dandi/dandi-cli/pull/660/commits/7d4541fe9875baf73fcda2716074d20fa75c786a","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1623762620,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2MTQ4NDQ5OA==","github-url":"https://github.com/dandi/dandi-cli/issues/672#issuecomment-861484498"},"message":"the download endpoint is fine. it's just that the download endpoint will all always return a presigned url, whereas the `contentUrl` when fixed should return both the download url and the blob url. so perhaps having those as separate would be useful in any API on the library side.","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1623765107,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2MTUxNjc3MA==","github-url":"https://github.com/dandi/dandi-cli/issues/672#issuecomment-861516770"},"message":"This is the function I have come up with for my own purposes:\n\n```python\ndef get_data_location(dandiset_id, filepath, s3=False):\n    \"\"\"Get the location for any NWB file on DANDI\"\"\"\n    \n    asset_id = requests.request(\n        \"GET\",\n        f\"https://api.dandiarchive.org/api/dandisets/{dandiset_id}/versions/draft/assets/\",\n        headers={\"Accept\": \"application/json\"},\n        params={\"path\": filepath},\n    ).json()['results'][0]['asset_id']\n    \n    url = f\"https://api.dandiarchive.org/api/dandisets/{dandiset_id}/versions/draft/assets/{asset_id}/download/\"\n    if not s3:\n        return url\n    \n    s3_url = requests.request(url=url, method='head').url\n    if '?' in s3_url:\n        return s3_url[:s3_url.index('?')]\n    return s3_url\n```\n\nI have found it useful to add this flag for whether I want to forward on to the blob url. For streaming you need the s3 url, but the download url is better for downloading because the file name is preserved.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1623772356,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2MTYxODA3Ng==","github-url":"https://github.com/dandi/dandi-cli/issues/672#issuecomment-861618076"},"message":"@satra :\n\n\u003e the download endpoint is fine. it's just that the download endpoint will all always return a presigned url, whereas the `contentUrl` when fixed should return both the download url and the blob url. so perhaps having those as separate would be useful in any API on the library side.\n\nright! because of the content disposition need, `/download` end-point would mint a presigned url... \nWell -- we could consider that a \"plus\" to have it exposed, instead of a direct blob one since may be that would also come handy whenever an asset is \"embargoed\", so only the \"authorized\" user then could get that URL and the rest of the script/machinery would work just as fine.  If we expose `blob_url`, then users might start using that instead and then we would need to instruct them to switch to `download_url`.   So may be just keep it to `download_url` for now and switch only if we see that load on the server is getting high or something like that which would warrant to expose also the direct url?\n\n@bendichter : using dandi-cli 0.19.0-17-g7d4541f from #660 it looks like\n\n```shell\n$\u003e python -c 'from dandi.dandiapi import DandiAPIClient; print(DandiAPIClient(\"https://api.dandiarchive.org/api\").get_dandiset(\"000027\").get_asset_by_path(\"sub-RAT123/sub-RAT123.nwb\").download_url)'\nhttps://api.dandiarchive.org/api/dandisets/000027/versions/draft/assets/ff453f4c-a435-4a5d-a48b-128abca5ec47/download/\n```\ngood enough? ;)","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1623801589,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2MTkwOTc0Mw==","github-url":"https://github.com/dandi/dandi-cli/issues/672#issuecomment-861909743"},"message":"@yarikoptic can I request that the DandiAPIClient.__init__'s `api_path` arg have default value \"https://api.dandiarchive.org/api\"? I understand you want this interface to work for other DANDI instances that might be in other locations, but I think having a default value here would still allow you to do that and would be more user-friendly. Also, what would be the syntax for getting the s3 path? I think I need that for data streaming, and it would be convenient if it was packaged into this function.","files":null},{"type":6,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1623802079,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDcwMDY0NTk3"},"target":"e85bfb7c30e3c286bd9e1ca4869af5eede61e4da7d469650fd95030cfa064c0b","message":"@yarikoptic can I request that the `DandiAPIClient.__init__`'s `api_path` arg have default value \"https://api.dandiarchive.org/api\"? I understand you want this interface to work for other DANDI instances that might be in other locations, but I think having a default value here would still allow you to do that and would be more user-friendly. Also, what would be the syntax for getting the s3 path? I need that for data streaming, and it would be convenient if it was packaged into this function.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1623812447,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2MTk5OTIxNQ==","github-url":"https://github.com/dandi/dandi-cli/issues/672#issuecomment-861999215"},"message":"already done by @jwodder so with current master (0.20.0-11-g1c76c3b) you get\n\n```shell\n$\u003e python -c 'from dandi.dandiapi import DandiAPIClient; print(DandiAPIClient().get_dandiset(\"000027\").get_asset_by_path(\"sub-RAT123/sub-RAT123.nwb\").download_url)'\nhttps://api.dandiarchive.org/api/dandisets/000027/versions/draft/assets/ff453f4c-a435-4a5d-a48b-128abca5ec47/download/\n```\n\n\u003e Also, what would be the syntax for getting the s3 path? I need that for data streaming, and it would be convenient if it was packaged into this function.\n\nshouldn't it works without s3 path url and just with our redirect from `/download/` URL?  For more reasoning to not bother with direct `/blobs/`, left some above in https://github.com/dandi/dandi-cli/issues/672#issuecomment-861618076\n\nunfortunately I have failed ATM to install ROS3 enabled setup + dandi-cli master...  e.g. using Python (NWBstream) env on the hub, and calling `!pip install git+https://github.com/dandi/dandi-cli` within the notebook leads to downgrade of h5py below 3 (although we do not demand that in dandi-cli, most likely reciprocating through some pynwb versioned depends) and then fails installation anyways altogether.","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1623813214,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2MjAwNDYyMg==","github-url":"https://github.com/dandi/dandi-cli/issues/672#issuecomment-862004622"},"message":"I can write my own redirect function, but I'll need to copy it into every notebook that streams data, which is most of them. \n\nYes, currently it is tricky to get an environment working with streaming. Satra got it working in the hub by editing some dependencies in the PyNWB chain.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1623813597,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2MjAwNjUyMQ==","github-url":"https://github.com/dandi/dandi-cli/issues/672#issuecomment-862006521"},"message":"unfortunately, the ros3 driver does not follow a redirect. it needs a direct s3 url.","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1624381364,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2NjE2NjY5MA==","github-url":"https://github.com/dandi/dandi-cli/issues/672#issuecomment-866166690"},"message":"@yarikoptic close?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1624384473,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDg2NjIwMjg1NQ==","github-url":"https://github.com/dandi/dandi-cli/issues/672#issuecomment-866202855"},"message":"I guess lets close for now as resolved by https://github.com/dandi/dandi-cli/pull/675 although I still feel that we might want to provide some extra convenience here :-/","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1624384473,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50NDkyNDM0NjIyMA=="},"status":2}]}