{"version":2,"ops":[{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1618333115,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlRWRpdDo1MjI3ODM2MDM="},"target":"ac225b7a522473a5ceb087b044a4f8fb51e90e4a52813affffa4300324d09c4b","message":"ATM that one reports\n```json\n{\n\"version\": \"1.0.0\",\n\"cli-minimal-version\": \"0.6.0\",\n\"cli-bad-versions\": [],\n\"services\": {\n\"girder\": {\n\"url\": \"https://girder.dandiarchive.org\"\n},\n\"webui\": {\n\"url\": \"https://gui.dandiarchive.org\"\n},\n\"api\": {\n\"url\": \"https://publish.dandiarchive.org/api\"\n},\n\"jupyterhub\": {\n\"url\": \"https://hub.dandiarchive.org\"\n}\n}\n}\n```\n\nI think  we should \n- [ ] change redirector it to remove entry for `\"api\"` since that service is long gone (and boost `version` to e.g. `1.1.0`)\n- [ ] double check that `dandi-cli` would refuse to interact with the archive if its version is below minimal one specified in that `server-info`\n- [ ] adjust `dandi-cli` so if there is a url for `\"api\"`, we would use `dandi-api` instance by default and not the girder one. (alternative - do that if there is no \"girder\")\n- [ ] release `dandi-cli` 0.14.0\n\nUpon migration\n- in redirector - adjust minimal version of the client to become `0.14.0` (assuming that is the one which it would be with default switch) and add `\"url\"` for the `\"api\"` and remove \"girder\", so released client would automagically switch to use `dandi-api` instance \n\nany flaw in above plan/logic @satra ?","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1618503869,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlRWRpdDo1MjQwODMwNTI="},"target":"ac225b7a522473a5ceb087b044a4f8fb51e90e4a52813affffa4300324d09c4b","message":"ATM that one reports\n```json\n{\n\"version\": \"1.0.0\",\n\"cli-minimal-version\": \"0.6.0\",\n\"cli-bad-versions\": [],\n\"services\": {\n\"girder\": {\n\"url\": \"https://girder.dandiarchive.org\"\n},\n\"webui\": {\n\"url\": \"https://gui.dandiarchive.org\"\n},\n\"api\": {\n\"url\": \"https://publish.dandiarchive.org/api\"\n},\n\"jupyterhub\": {\n\"url\": \"https://hub.dandiarchive.org\"\n}\n}\n}\n```\n\nI think  we should \n- ~~change redirector it to remove entry for `\"api\"` since that service is long gone (and boost `version` to e.g. `1.1.0`)~~. that was a bad idea, replaced with\n  -  [x] make \"api\" empty (null == None)\n- [ ] double check that `dandi-cli` would refuse to interact with the archive if its version is below minimal one specified in that `server-info`\n- [ ] adjust `dandi-cli` so if there is a url for `\"api\"`, we would use `dandi-api` instance by default and not the girder one. (alternative - do that if there is no \"girder\")\n- [ ] release `dandi-cli` 0.14.0\n\nUpon migration\n- in redirector - adjust minimal version of the client to become `0.14.0` (assuming that is the one which it would be with default switch) and add `\"url\"` for the `\"api\"` and remove \"girder\", so released client would automagically switch to use `dandi-api` instance \n\nany flaw in above plan/logic @satra ?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1618337643,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgxODk1MTkyMw==","github-url":"https://github.com/dandi/dandi-cli/issues/541#issuecomment-818951923"},"message":"@yarikoptic \n\n\u003e * double check that dandi-cli would refuse to interact with the archive if its version is below minimal one specified in that server-info\n\u003e * adjust dandi-cli so if there is a url for \"api\", we would use dandi-api instance by default and not the girder one. (alternative - do that if there is no \"girder\")\n\nThese steps are or would be performed by `get_instance()`, which is only used by `upload()`, `delete()`, `register()`, and when `parse_dandi_url()` receives a `*dandiarchive-org.netlify.app` or `dandi://*` URL.  The only other commands that can interact with an archive are `ls` and `download`, which don't do version checks and don't care where their URL arguments point (though `download` can take an explicit `-i` option to set the instance from which to download a locally-mirrored Dandiset; as this behavior only occurs when an instance name is explicitly given, there is no default instance to change for `download`).","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1618340147,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgxODk3ODE2Mg==","github-url":"https://github.com/dandi/dandi-cli/issues/541#issuecomment-818978162"},"message":"Well, `ls` and `download` could do a version check since they are to interact with the dandi-api and issue at least a WARNING that they would proceed but server is known to require newer dandi-cli.\n\n\u003e though download can take an explicit -i option to set the instance from which to download a locally-mirrored Dandiset; as this behavior only occurs when an instance name is explicitly given, there is no default instance to change for download.\n\nrright... but in dandiarchive.py we setup regexes to decide between instances:\n```\n        # New DANDI API, ATM can be reached only via enable('DJANGO_API')  in\n        # browser console\n        # https://gui.dandiarchive.org/#/dandiset/000001/0.201104.2302/files\n        # TODO: upload something to any dandiset to see what happens when there\n        # are files and adjust for how path is provided (if not ?location=)\n        (\n            re.compile(\n                r\"(?P\u003cserver\u003e(?P\u003cprotocol\u003ehttps?)://\"\n                r\"(?P\u003chostname\u003egui-beta-dandiarchive-org\\.netlify\\.app)/)\"\n                rf\"#/(?P\u003casset_type\u003edandiset)/{dandiset_id_grp}\"\n                r\"(/(?P\u003cversion\u003e[.0-9]{5,}|draft))?\"\n                rf\"(/files(\\?location=(?P\u003clocation\u003e.*)?)?)?\"\n            ),\n            {\"server_type\": \"api\"},\n            \"https://gui-beta-dandiarchive-org.netflif.app/#/dandiset\"\n            \"/\u003cdandiset id\u003e[/\u003cversion\u003e][/files[?location=\u003cpath\u003e]]\",\n        ),\n        # PRs are also on netlify - so above takes precedence. TODO: make more\n        # specific?\n        (\n            re.compile(r\"https?://[^/]*dandiarchive-org\\.netlify\\.app/.*\"),\n            {\"map_instance\": \"dandi\"},\n            \"https://*dandiarchive-org.netflify.app/...\",\n        ),\n...\n        # But for drafts files navigator it is a bit different beast and there\n        # could be no versions, only draft\n        # https://deploy-preview-341--gui-dandiarchive-org.netlify.app/#/dandiset/000027/draft/files?_id=5f176583f63d62e1dbd06943\u0026_modelType=folder\n        (\n            re.compile(\n                rf\"{server_grp}#/(?P\u003casset_type\u003edandiset)/{dandiset_id_grp}\"\n                r\"(/(?P\u003cversion\u003edraft))?\"\n                rf\"(/files(\\?_id={id_grp}(\u0026_modelType=folder)?)?)?\"\n            ),\n            {\"server_type\": \"girder\"},\n            \"https://\u003cserver\u003e[/api]#/dandiset/\u003cdandiset id\u003e[/draft]\"\n            \"[/files[?_id=\u003cid\u003e[\u0026_modelType=folder]]]\",\n        ),\n```\nso it would be only for gui-beta-dandiarchive-org.netlify.app instance when we explicitly instruct to handle it as `dandi-api`. \n\nAnd URLs for both girder based and new dandi-api based instances are identical (e.g. https://gui.dandiarchive.org/#/dandiset/000003 and https://gui-beta-dandiarchive-org.netlify.app/#/dandiset/000003) now. So we can't automagically tell based on the full dandiset url alone either it is a girder or dandi-api instance :-/ That is why I wondered how we could automate such a switch. I thought to (ab)use redirector for this purpose as to consult on which type of instance it should be:  if there is a redirector for the instance (`dandi`), we can consult it and disregard hard-coded server addresses.  \n\nIt indeed seems to just over-complicate situation though and we might just adjust regexes and the records in known_instances whenever migration happens for `download` to correctly handle download of entire dandisets (folders might be ok since URLs differ).\n\nWDYT?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1618404602,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgxOTQ5MjMxOA==","github-url":"https://github.com/dandi/dandi-cli/issues/541#issuecomment-819492318"},"message":"@yarikoptic \n\n\u003e Well, ls and download could do a version check since they are to interact with the dandi-api and issue at least a WARNING that they would proceed but server is known to require newer dandi-cli.\n\n`ls` and `download` only interact with the API via explicit URLs.  If someone uses a Girder URL, it'll fail once Girder is no longer available, and if they use a dandi-api URL, it'll succeed, so I don't see the need for those two commands to perform version checks, as whether they work is not dependent on having the most recent version of the client.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1618504108,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgyMDU2NDA1Mw==","github-url":"https://github.com/dandi/dandi-cli/issues/541#issuecomment-820564053"},"message":"what will happen in my example above whenever https://gui-beta-dandiarchive-org.netlify.app/#/dandiset/000003 would become https://gui.dandiarchive.org/#/dandiset/000003 and require interaction with dandi-api to get to that dandiset instead of girder?  I just want to make sure that for that instance record `dandi`, we would consult the redirector to get the information that for `gui.dandiarchive.org/` we then need to talk to dandi-api and not girder (as hardcoded ATM within `dandi` instance record).","files":null},{"type":5,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1618504358,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDQ2MDAzNjkwNjI="},"added":["cmd-download"],"removed":[]},{"type":5,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1618504358,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDQ2MDAzNjkwNjQ="},"added":["cmd-ls"],"removed":[]},{"type":5,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1618504358,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDQ2MDAzNjkwNjc="},"added":["cmd-upload"],"removed":[]},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1618511335,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgyMDY0MTkzMQ==","github-url":"https://github.com/dandi/dandi-cli/issues/541#issuecomment-820641931"},"message":"@yarikoptic I've updated my PR to use `get_instance()` to resolve GUI URLs, so https://gui.dandiarchive.org/#/dandiset/000003 will be mapped to the Django API once the redirector starts pointing to it.","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1618519661,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50NDYwMTUyMTk1NQ=="},"status":2}]}