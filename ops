{"version":2,"ops":[{"type":6,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1637708352,"metadata":{"github-id":"UCE_lAHODBZtRc4_Sa-xzibM6os"},"target":"080d71ba5ace4d8aa5dc900a1bfc82be02e5b82be44b0011522583d3c8caebd9","message":"DANDI does not currently have a good way of handling external links. Eventually, we should find a good way to handle them. For now, we at least need a way to check whether they exist. Here is how you would do that. I don't know how you would want to integrate this into dandi-cli, but you can copy/paste this code:\n\nCreate an NWB file with an external link. Here, file4 has an external link to file1:\n```python\nfrom datetime import datetime\nfrom dateutil.tz import tzlocal\nfrom pynwb import NWBFile\nfrom pynwb import TimeSeries\nfrom pynwb import NWBHDF5IO\nimport numpy as np\nimport h5py\n\n# Create the base data\nstart_time = datetime(2017, 4, 3, 11, tzinfo=tzlocal())\ncreate_date = datetime(2017, 4, 15, 12, tzinfo=tzlocal())\ndata = np.arange(1000).reshape((100, 10))\ntimestamps = np.arange(100)\nfilename1 = 'external1_example.nwb'\nfilename4 = 'external_linkdataset_example.nwb'\n\n# Create the first file\nnwbfile1 = NWBFile(session_description='demonstrate external files',\n                   identifier='NWBE1',\n                   session_start_time=start_time,\n                   file_create_date=create_date)\n# Create the second file\ntest_ts1 = TimeSeries(name='test_timeseries1',\n                      data=data,\n                      unit='SIunit',\n                      timestamps=timestamps)\nnwbfile1.add_acquisition(test_ts1)\n# Write the first file\nio = NWBHDF5IO(filename1, 'w')\nio.write(nwbfile1)\nio.close()\n\n# Create the second file\nnwbfile2 = NWBFile(session_description='demonstrate external files',\n                   identifier='NWBE2',\n                   session_start_time=start_time,\n                   file_create_date=create_date)\n\n# Create the first file\nnwbfile4 = NWBFile(\n    session_description='demonstrate external files',\n    identifier='NWBE4',\n    session_start_time=start_time,\n    file_create_date=create_date\n)\n\n# Get the first timeseries\nio1 = NWBHDF5IO(filename1, 'r')\nnwbfile1 = io1.read()\ntimeseries_1 = nwbfile1.get_acquisition('test_timeseries1')\ntimeseries_1_data = timeseries_1.data\n\n# Create a new timeseries that links to our data\ntest_ts4 = TimeSeries(\n    name='test_timeseries4',\n    data=timeseries_1_data,   # \u003c-------\n    unit='SIunit',\n    timestamps=timestamps\n)\nnwbfile4.add_acquisition(test_ts4)\n\n\nio4 = NWBHDF5IO(filename4, 'w')\nio4.write(nwbfile4, link_data=True)\nio4.close()\n```\n\ntest whether files have external links:\n```python\ndef has_external_links(file):\n    \n    external_links = set()\n    visited = set()\n    \n    # cannot use built-in `visititems` because it skips external links\n    def my_visit(node, func, path='/'):\n        if isinstance(node[path], h5py.Group):\n            for key in node[path].keys():\n                key_path = path + '/' + key\n                if key_path not in visited:\n                    func(key_path, node)\n                    visited.add(key_path)\n                    my_visit(node, func, key_path)\n        else:\n            func(path, node)\n\n    def func(path, node):\n        if isinstance(f.get(path, getlink=True), h5py.ExternalLink):\n            external_links.add(path)\n\n    my_visit(f, func)\n\n    if external_links:\n        return True\n    else:\n        return False\n\n    \nwith h5py.File(filename1, 'r') as f:\n    print(has_external_links(f))\n\nwith h5py.File(filename4, 'r') as f:\n    print(has_external_links(f))\n```","files":null},{"type":6,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1637708677,"metadata":{"github-id":"UCE_lAHODBZtRc4_Sa-xzibM89E"},"target":"080d71ba5ace4d8aa5dc900a1bfc82be02e5b82be44b0011522583d3c8caebd9","message":"DANDI does not currently have a good way of handling external links. Eventually, we should find a good way to handle them. For now, we at least need a way to check whether they exist. Here is how you would do that. I don't know how you would want to integrate this into dandi-cli, but you can copy/paste this code:\n\nCreate an NWB file with an external link. Here, file4 has an external link to file1:\n```python\nfrom datetime import datetime\nfrom dateutil.tz import tzlocal\nfrom pynwb import NWBFile\nfrom pynwb import TimeSeries\nfrom pynwb import NWBHDF5IO\nimport numpy as np\nimport h5py\n\n# Create the base data\nstart_time = datetime(2017, 4, 3, 11, tzinfo=tzlocal())\ncreate_date = datetime(2017, 4, 15, 12, tzinfo=tzlocal())\ndata = np.arange(1000).reshape((100, 10))\ntimestamps = np.arange(100)\nfilename1 = 'external1_example.nwb'\nfilename4 = 'external_linkdataset_example.nwb'\n\n# Create the first file\nnwbfile1 = NWBFile(session_description='demonstrate external files',\n                   identifier='NWBE1',\n                   session_start_time=start_time,\n                   file_create_date=create_date)\n# Create the second file\ntest_ts1 = TimeSeries(name='test_timeseries1',\n                      data=data,\n                      unit='SIunit',\n                      timestamps=timestamps)\nnwbfile1.add_acquisition(test_ts1)\n# Write the first file\nio = NWBHDF5IO(filename1, 'w')\nio.write(nwbfile1)\nio.close()\n\n# Create the second file\nnwbfile2 = NWBFile(session_description='demonstrate external files',\n                   identifier='NWBE2',\n                   session_start_time=start_time,\n                   file_create_date=create_date)\n\n# Create the first file\nnwbfile4 = NWBFile(\n    session_description='demonstrate external files',\n    identifier='NWBE4',\n    session_start_time=start_time,\n    file_create_date=create_date\n)\n\n# Get the first timeseries\nio1 = NWBHDF5IO(filename1, 'r')\nnwbfile1 = io1.read()\ntimeseries_1 = nwbfile1.get_acquisition('test_timeseries1')\ntimeseries_1_data = timeseries_1.data\n\n# Create a new timeseries that links to our data\ntest_ts4 = TimeSeries(\n    name='test_timeseries4',\n    data=timeseries_1_data,   # \u003c-------\n    unit='SIunit',\n    timestamps=timestamps\n)\nnwbfile4.add_acquisition(test_ts4)\n\n\nio4 = NWBHDF5IO(filename4, 'w')\nio4.write(nwbfile4, link_data=True)\nio4.close()\n```\n\ntest whether files have external links:\n```python\ndef has_external_links(file):\n    \n    external_links = set()\n    visited = set()\n    \n    # cannot use`file.visititems` because it skips external links (https://github.com/h5py/h5py/issues/671)\n    def my_visit(node, func, path='/'):\n        if isinstance(node[path], h5py.Group):\n            for key in node[path].keys():\n                key_path = path + '/' + key\n                if key_path not in visited:\n                    func(key_path, node)\n                    visited.add(key_path)\n                    my_visit(node, func, key_path)\n        else:\n            func(path, node)\n\n    def func(path, node):\n        if isinstance(f.get(path, getlink=True), h5py.ExternalLink):\n            external_links.add(path)\n\n    my_visit(f, func)\n\n    if external_links:\n        return True\n    else:\n        return False\n\n    \nwith h5py.File(filename1, 'r') as f:\n    print(has_external_links(f))\n\nwith h5py.File(filename4, 'r') as f:\n    print(has_external_links(f))\n```","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1637710601,"metadata":{"github-id":"IC_kwDODBZtRc46QCmz","github-url":"https://github.com/dandi/dandi-cli/issues/840#issuecomment-977283507"},"message":"Dear @jwodder please adopt @bendichter 's `has_external_links` to be `fscached` and shipped along with other nwb helpers.  It could exit as early as it can say `True` ;)\nThen IMHO it should be used in `organize` and `validate` functionality to error out on a file if it has an external link or @bendichter and @satra you think we should support them, and thus indeed add validation that they point to existing files?","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1637710633,"metadata":{"github-id":"UCE_lALODBZtRc46QCmzzh8l8rg"},"target":"62434e6378012c90a55da13dc010281e4236bcd6e68fe7badc407eb256fde489","message":"Dear @jwodder please adopt @bendichter 's `has_external_links` to be `fscached` and shipped along with other nwb helpers.  It could exit as early as it can say `True` ;)\nThen IMHO it should be used in `organize` and `validate` functionality to error out on a file if it has an external link or @bendichter and @satra you think we should support them, and thus indeed add validation that they point to existing files? (in a context of a dandiset, those external links should not leave the boundary of a dandiset)","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1637873139,"metadata":{"github-id":"IC_kwDODBZtRc46YWgV","github-url":"https://github.com/dandi/dandi-cli/issues/840#issuecomment-979462165"},"message":"I think error for now, then we can relax that once we decide how we want to handle external links","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1639421312,"metadata":{"github-id":"CE_lADODBZtRc4_Sa-xzwAAAAFXQuwZ"},"status":2}]}