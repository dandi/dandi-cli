{"version":2,"ops":[{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1745434657,"metadata":{"github-id":"UCE_lAHODBZtRc5_-mmSznihTiU"},"target":"4f210d1f9996280bc40adba81b17c2cff06534447b763e8069991a9de09166e2","message":"A part inspired from \n- #1281\nand current problem of presumably having LOTS of non-compliant zarrs in the archive:\n- https://github.com/dandisets/000108/issues/14\n\nFor any .zarr we encounter we should\n- check if it is  actually an OME .zarr.  I think we can do that by looking for `.omero` top level key in .zattrs\n- NB if that is the best way was asked:\n  - https://github.com/ome/ngff/issues/228\n  \nFor any OME .zarr (be either detected through above or having `.ome.zarr` extension), validate that zarr against the specified version (if no version -- validation error)\n\n```shell\n❯ jq '.omero.version' .zattrs\n\"0.4\"\n```\n\nof schema as provided on https://github.com/ome/ngff under `{schema_version}/schemas/` folder in `.schema` json files and issue corresponding validation errors to the users trying to upload non-compliant OME .ngffs.\n\nTODO:\n- [ ] check with https://github.com/ome/ngff and https://github.com/ome-zarr-models/ome-zarr-models-py folks on either may be it is worth just converting their models from jsonschemas into linkml?  please check on those pydantic models functioning of pydantic2linkml .","files":null},{"type":5,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1708531061,"metadata":{"github-id":"LE_lADODBZtRc5_-mmSzwAAAALEBJEf"},"added":["zarr"],"removed":[]},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1708715888,"metadata":{"github-id":"IC_kwDODBZtRc5076J3","github-url":"https://github.com/dandi/dandi-cli/issues/1409#issuecomment-1961861751"},"message":"following advice in https://github.com/ome/ngff/issues/228#issuecomment-1957119902 let's :\n\n- consider versions from `.multiscales[].version` and `.omero.version`.\n- if more than 1 found -- issue a validation error on inconsistency of OME/NGFF version, stop validation\n- if 1 version found -- load that schema and validate against\n- if no version found -- not OME/NGFF, no OME specific validation","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1708721874,"metadata":{"github-id":"IC_kwDODBZtRc508XD2","github-url":"https://github.com/dandi/dandi-cli/issues/1409#issuecomment-1961980150"},"message":"here is stats across zarrs on S3 - first one for .ome.version, 2nd for .multiscales[].version:\n\n```shell\ndandi@drogon:~$ sort /tmp/ome-versions.out | uniq -c\n     20 [0.2,0.2]\n   4303 [\"0.4\",\"0.4\"]\n    572 [null,\"0.4\"]\n```\nwhere that file was created using `for d in *-*-*; do git -C $d annex whereis .zattrs | awk '/versionId=/{print $2;}'  | xargs curl --silent | jq -c '[.omero.version, .multiscales[].version]'; done | tee /tmp/ome-versions.out`\n\nnote that some had it (incorrectly) as floats I think. Might be worth making code robust there and explicitly test for it being a string and otherwise issue validation error","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1709045227,"metadata":{"github-id":"IC_kwDODBZtRc51ObGs","github-url":"https://github.com/dandi/dandi-cli/issues/1409#issuecomment-1966715308"},"message":"@yarikoptic\n\n* So should dandi-cli just download the OME schemata on the fly when needed?\n* Could you link me to an example valid (or nearly-valid) OME Zarr?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1709084447,"metadata":{"github-id":"IC_kwDODBZtRc51TclD","github-url":"https://github.com/dandi/dandi-cli/issues/1409#issuecomment-1968032067"},"message":"well -- ideally cache locally. I thought we already do something similar to dandi schema or used to do for bids at some point.\n\n\"nearly-valid\" I think most of  zarrs in 000108 according to e.g. https://ome.github.io/ome-ngff-validator/?source=https://dandiarchive.s3.amazonaws.com/zarr/e41844a2-dad0-4b1c-9c53-d55883e0553f which errors with\n\n```json\n{\n  \"instancePath\": \"/omero/channels/0/window\",\n  \"schemaPath\": \"#/properties/omero/properties/channels/items/properties/window/required\",\n  \"keyword\": \"required\",\n  \"params\": {\n    \"missingProperty\": \"start\"\n  },\n  \"message\": \"must have required property 'start'\"\n}\n```\nbut then otherwise is happy to report `7 Datasets checked ✓`.\n\nI also found one in https://dandiarchive.org/dandiset/000243/draft/files?location=sub-S01%2Fanat\u0026page=1 which fully valid  https://ome.github.io/ome-ngff-validator/?source=https://dandiarchive.s3.amazonaws.com/zarr/7723d02f-1f71-4553-a7b0-47bda1ae8b42 \n\nalso those in 000026 seems to be good: https://dandiarchive.org/dandiset/000026/draft/files?location=sub-I45%2Fses-SPIM%2Fmicr\u0026page=1","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1740427286,"metadata":{"github-id":"IC_kwDODBZtRc6ftjA5","github-url":"https://github.com/dandi/dandi-cli/issues/1409#issuecomment-2679517241"},"message":"There is now https://ome-zarr-models-py.readthedocs.io/en/stable/ so we should start using it. As @candleindark is working on metadata/validation schemes, I am reassigning it to him","files":null},{"type":2,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1740427306,"metadata":{"github-id":"RTE_lADODBZtRc5_-mmSzwAAAAPTuzuB"},"title":"Validate (.ome).zarr against ngff schema using ome-zarr-models-py","was":"Validate (.ome).zarr against ngff schema using ome-zarr-models-py"},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1762462803,"metadata":{"github-id":"IC_kwDODBZtRc7QlDPP","github-url":"https://github.com/dandi/dandi-cli/issues/1409#issuecomment-3499373519"},"message":"@candleindark could you please have a fresh look at the situation in that space?","files":null},{"type":3,"author":{"id":"d8203afd43c9e0a9d07c45dd62b58a81d53a2ebe"},"timestamp":1762463121,"metadata":{"github-id":"IC_kwDODBZtRc7QlHUN","github-url":"https://github.com/dandi/dandi-cli/issues/1409#issuecomment-3499390221"},"message":"For reference, I have implemented a simple validation with `ome-zarr-models-py` for a different project.  See code [here](https://github.com/neuroscales/nifti-zarr-py/blob/dad0ed6dbb60beee795ff3ae32fdab813343f174/niizarr/_nii2zarr.py#L656-L665).","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1762464777,"metadata":{"github-id":"IC_kwDODBZtRc7QlbBR","github-url":"https://github.com/dandi/dandi-cli/issues/1409#issuecomment-3499470929"},"message":"SWEET!  Care to contribute here to dandi-cli @kabilar ? looks like not that much to do.","files":null},{"type":3,"author":{"id":"d8203afd43c9e0a9d07c45dd62b58a81d53a2ebe"},"timestamp":1762523733,"metadata":{"github-id":"IC_kwDODBZtRc7QxwPr","github-url":"https://github.com/dandi/dandi-cli/issues/1409#issuecomment-3502703595"},"message":"Yes, definitely, I was planning to, but it may not happen for a little while.","files":null}]}