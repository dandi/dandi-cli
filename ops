{"version":2,"ops":[{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1604597673,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcyMjUyMzEyOA==","github-url":"https://github.com/dandi/dandi-cli/issues/263#issuecomment-722523128"},"message":"\u003e check with keyring if credential store(s) available.\n\nThere does not appear to be a way to check what backends are useable without making a query to each \u0026 every one in turn, which (I think) would involve the user being prompted for decryption passwords and the like for each \u0026 every one of them.","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1604597673,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDExODg2MjQ3"},"target":"d77ce7a5bea41d7d7d54fc432155b706a6480ae1114f74232b88753a809adb66","message":"\u003e check with keyring if credential store(s) available.\n\nThere does not appear to be a way to check what backends are useable without making a query to each \u0026 every one in turn, which (I think) would involve the user being prompted for decryption passwords and the like for most of them.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1604604279,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcyMjU4OTgzOQ==","github-url":"https://github.com/dandi/dandi-cli/issues/263#issuecomment-722589839"},"message":"well, if something prompts that means that the backend is available, but if it raises InitError or alike -- means that it is not... if we get to the end of the loop without any available, we need to make a new one.  Or you see scenario where such logic would be flawed?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1604606432,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcyMjYxMTQ4NA==","github-url":"https://github.com/dandi/dandi-cli/issues/263#issuecomment-722611484"},"message":"@yarikoptic So the flow you're proposing is:\n\n* Query each available keyring backend\n    * If it errors, go to the next one.\n    * Maybe: If it doesn't contain a password for the given service \u0026 username, go to the next one.\n* If none of the backends are suitable, ask the user whether we can use an encrypted file as the backend (`keyrings.alt.file.EncryptedKeyring` seems to be the candidate for this).\n\nIf we continue on when a candidate backend doesn't contain a password for us, this will lead to users being prompted about permission or credentials for multiple different backends (and there isn't a way to test whether a user's been prompted in such a way).  If we *don't* continue on, then we will always find a backend (as the PlaintextKeyring backend — and possibly others — is always available while `keyrings.alt` is installed) and we won't end up asking the user about setting up a backend that they very well might have never used before.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1604672032,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcyMzEwMjExNg==","github-url":"https://github.com/dandi/dandi-cli/issues/263#issuecomment-723102116"},"message":"Thanks for the analysis! What about following (in pseudo-python code) so we do not sweep backends?\n```python\ntry:\n    return keyring.get_password(...)\nexcept keyring.errors.InitError as exc:\n    if check_if_encrypted_keyring_available():\n         lgr.info(\"Default keyring is not available, but encrypted keyring found. Original error: %s\", exc)\n         return encrypted_keyring.get_password(...)\n    if ask(\"Default keyring is not available.  Would you like to establish an encryptedkeyring? Original error: %s\", exc):\n         establish_encrypted_keyring()\n         return encrypted_keyring.get_password(...)\n    raise exc\n```","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1604672198,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcyMzEwMzIyMg==","github-url":"https://github.com/dandi/dandi-cli/issues/263#issuecomment-723103222"},"message":"BTW, in DataLad we have a home-brewed support for centralizing UIs, e.g. https://github.com/datalad/datalad/blob/master/datalad/ui/dialog.py#L178 for interactive.  I wonder if you might know some or we could/should adopt that one here?","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1604672198,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDEyMTIyMjgw"},"target":"e8ea0c7c8d7204e9f4a670213464b11769cabfddeb90ab1763ec37f89dd58dc6","message":"BTW, in DataLad we have a home-brewed support for centralizing UIs, e.g. https://github.com/datalad/datalad/blob/master/datalad/ui/dialog.py#L178 for  interactive and not UIs with helpers for choice and binary (yes/no) questions to unify presentation etc.  I wonder if you might know some or we could/should adopt that one here?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1604673446,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcyMzExMzg0MA==","github-url":"https://github.com/dandi/dandi-cli/issues/263#issuecomment-723113840"},"message":"@yarikoptic That works if by \"check if encrypted keyring available\" you mean something like \"check whether the file used by `EncryptedKeyring` to store secrets already exists.\"\n\n(When I mentioned \"available\" backends in my last comment, I meant backends whose classes could be instantiated without error, which basically means backends for which the necessary dependency libraries are already installed.  By that definition, a backend that's not available can't be established without installing libraries, which I don't think dandi should be doing.)\n\nOne additional wrinkle: The `keyring` library lets a user specify a specific backend via either an environment variable or a `keyringrc.cfg` file, and only if neither of those are set does it fall back to looking up all backends.  I think we should do likewise, and furthermore, I think that if an explicitly-specified backend errors on a query, we should consider it the user's fault and not try to set up an encrypted backend.\n\nSpeaking of `keyringrc.cfg`, I got the implication from the initial post in this issue that you wanted `keyringrc.cfg` to be configured to specify `EncryptedKeyring` in the event an `EncryptedKeyring` was created.  Do you want that to happen or not?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1604674104,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcyMzExOTM4Ng==","github-url":"https://github.com/dandi/dandi-cli/issues/263#issuecomment-723119386"},"message":"Can we know if failed backend was explicitly specified via config or env var?   if so, then we indeed should not do anything and just fail if explicitly specified was used.  If it was not explicitly specified -- then yes, lets create one, and explicitly specify in `keyringrc.cfg` on user's behalf (and inform user about that).","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1604674236,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcyMzEyMDUyMg==","github-url":"https://github.com/dandi/dandi-cli/issues/263#issuecomment-723120522"},"message":"\u003e Can we know if failed backend was explicitly specified via config or env var?\n\nEffectively, yes.  I can retrieve the explicitly-specified backend and, if it's non-`None`, use that, otherwise continue with the default backend.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1604678336,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcyMzE1Njk4OQ==","github-url":"https://github.com/dandi/dandi-cli/issues/263#issuecomment-723156989"},"message":"sounds good, thank you!","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1604939606,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50Mzk3NDY3NTY5Mg=="},"status":2}]}