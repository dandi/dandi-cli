{"version":2,"ops":[{"type":6,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1636568438,"metadata":{"github-id":"UCE_lAHODBZtRc48l41aziZPRLo"},"target":"c4372025e330ac23c67b808a2c764fd0f0207b36be9805691513b5f29bb50ece","message":"This is a continuation of https://github.com/dandi/helpdesk/discussions/30\n\nIt would be more disk space efficient to store behavioral video files outside of an nwbfile since the compression is not at par with the codecs for mp4 etc. If there is a standard to organize video files and then link those to the nwb file as `external_file` argument, it would help. \n\nIf a user has a video file stored locally and an nwbfile that links to that local file on disc, uploading the nwb on DANDI would break the link. So we should come up with a design for organizing the nwb associated video files on DANDI and update the link stored in the nwbfile. \n\n `dandi organize` for video files specifically should:\n1. Rename the video files prior to uploading on DANDI.\n2. Update the nwbfile in real time and change the external file link based on the new name of the video file. \n\n@satra @bendichter I have created a design draft for us to collaborate on\nhttps://docs.google.com/document/d/1oclxWFRNbakjYBlrze4DiFWkh_v0yVhmGjNar09skx4/edit?usp=sharing","files":null},{"type":3,"author":{"id":"83fae958856b684c15b81b726620f7b946f24143"},"timestamp":1636564699,"metadata":{"github-id":"IC_kwDODBZtRc45jVNj","github-url":"https://github.com/dandi/dandi-cli/issues/785#issuecomment-965563235"},"message":"As an example, I have created a script that takes in a folder containing nwb files and accompanying video files (linked with `external_file` tag in the `ImageSeries` container. \n[Here is an example folder](https://drive.google.com/drive/folders/1jnyU7iY-kbAhjWWYATJ8RmKiP0Uk2ifN?usp=sharing) that contains 4 nwb files and linked videos (mp4). And [here is the output](https://drive.google.com/drive/folders/13gfzopQYi2CIPv4xyhsMWqAtcUBJBsZv?usp=sharing)\nafter running the script below, on the downloaded folder: \n```python\nimport pynwb.image\nfrom pynwb import NWBHDF5IO\nfrom pathlib import Path\nimport shutil\n\n\ndef dandi_organize(file_name: str, idx: int, nwb_object, create_symlink=False):\n    \"\"\"\n    1. Renames the file_name based on the defined naming method\n    2. Creates a symlink (with the same name) to the actual file on disk\n    \"\"\"\n    nwbfile = nwb_object.parent\n    fileext = file_name.split('.')[-1]\n    parent_folder = Path(nwb_object.container_source).with_suffix(\"\")\n    if not parent_folder.exists():\n        parent_folder.mkdir()\n    video_name = Path(f'{nwb_object.object_id}_external_file_{idx}.{fileext}')\n    symlink_path = parent_folder/video_name\n    if create_symlink:\n        symlink_path.symlink_to(Path(file_name))\n    else:\n        shutil.copy(file_name, str(symlink_path))\n    return str(symlink_path)\n\n\ndef get_image_series(container):\n    image_series_containers = dict()\n    for name, ob in container.items():\n        if isinstance(ob, pynwb.image.ImageSeries) and ob.external_file is not None:\n            image_series_containers[name] = ob\n    return image_series_containers\n\nbase_path = Path(\"~/DANDI-video\") # enter the path of the downloaded gdrive folder\nfor file in base_path.glob('**/*.nwb'):\n\n    with NWBHDF5IO(str(file), mode='r+', load_namespaces=True) as io:\n        nwbfile = io.read()\n        nwbfile_containers = [nwbfile.acquisition, nwbfile.processing]\n        for data_interface in nwbfile_containers:\n            for name, image_series in get_image_series(data_interface).items():\n                for no, ext_file in enumerate(image_series.external_file):\n                    if ext_file.split('.')[-1] in [\"mp4\", \"tif\"]:\n                        image_series.external_file[no] = dandi_organize(ext_file, no, image_series,\n                                                                        create_symlink=False)\n        io.write(nwbfile)\n\n```\n\nEssentially it performs 2 functions:\n1. Renames the video files and places them in a sub-folder with the same name as the nwbfile. Its renames the file with the uuid of the parent `ImageSeries` container + 'external_file_\u003cvideo_no\u003e.mp4 : \n    `\u003cnwbfile_name\u003e/{UUID}_external_file_0.mp4`\n2. Updates the `external_file` arg in all the nwb files.","files":null},{"type":6,"author":{"id":"83fae958856b684c15b81b726620f7b946f24143"},"timestamp":1636568051,"metadata":{"github-id":"UCE_lALODBZtRc45jVNjzh7cxnk"},"target":"e007032371b4101d2906b3dbc79c2ad2ecee83c94a2ba24a325fe7135a6e8da4","message":"As an example, I have created a script that takes in a folder containing nwb files and accompanying video files (linked with `external_file` tag in the `ImageSeries` container. \n[Here is an example folder](https://drive.google.com/drive/folders/1jnyU7iY-kbAhjWWYATJ8RmKiP0Uk2ifN?usp=sharing) that contains 3 video files and linked videos (mp4). And [here is the output](https://drive.google.com/drive/folders/13gfzopQYi2CIPv4xyhsMWqAtcUBJBsZv?usp=sharing)\n\n**Step 1: create the nwb files with video files as external args:**\n```python\nfrom datetime import datetime\n\nfrom dateutil.tz import tzlocal\nfrom pynwb import NWBFile, NWBHDF5IO\nfrom pynwb.device import Device\nfrom pynwb.file import Subject\nfrom pynwb.ophys import ImageSeries\n\nbase = r\"C:\\Users\\Saksham\\Documents\\NWB\\DANDI-video\" #path to gdrive downloaded folder\n\ndef create_nwb(name, no):\n    subject = Subject(subject_id=f'mouse{no}', species=\"Mus musculus\", sex=\"M\",\n                      description='lab mouse ')\n    device = Device(f'imaging_device_{no}')\n    nwbfile = NWBFile(f'{name}{no}', 'desc: contains movie for dandi .mp4 storage as external',\n                      datetime.now(tzlocal()),\n                      experimenter='Dr. Bilbo Baggins',\n                      session_id=f'sessionid{no}',\n                      subject=subject,\n                      devices=[device])\n    image_series = ImageSeries(name=f'MouseWhiskers{no}',\n                               format='external',\n                               external_file=[base+fr\"\\video{no}.mp4\",base+fr\"\\video{no+1}.mp4\"],\n                               starting_frame=[0], starting_time=0.0, rate=150.0)\n    nwbfile.add_acquisition(image_series)\n\n    with NWBHDF5IO(f'{name}{no}.nwb', 'w') as io:\n        io.write(nwbfile)\n\nfor i in [0,2,4]:\n    create_nwb('test', i)\n```\n\n**Step 2: re-organize:**\n\n```python\nimport pynwb.image\nfrom pynwb import NWBHDF5IO\nfrom pathlib import Path\nimport shutil\n\n\ndef dandi_organize(file_name: str, idx: int, nwb_object, create_symlink=False):\n    \"\"\"\n    1. Renames the file_name based on the defined naming method\n    2. Creates a symlink (with the same name) to the actual file on disk\n    \"\"\"\n    nwbfile = nwb_object.parent\n    fileext = file_name.split('.')[-1]\n    parent_folder = Path(nwb_object.container_source).with_suffix(\"\")\n    if not parent_folder.exists():\n        parent_folder.mkdir()\n    video_name = Path(f'{nwb_object.object_id}_external_file_{idx}.{fileext}')\n    symlink_path = parent_folder/video_name\n    if create_symlink:\n        symlink_path.symlink_to(Path(file_name))\n    else:\n        shutil.copy(file_name, str(symlink_path))\n    return str(symlink_path)\n\n\ndef get_image_series(container):\n    image_series_containers = dict()\n    for name, ob in container.items():\n        if isinstance(ob, pynwb.image.ImageSeries) and ob.external_file is not None:\n            image_series_containers[name] = ob\n    return image_series_containers\n\nbase_path = Path(\"~/DANDI-video\") # enter the path of the downloaded gdrive folder with nwbfiles generated after step1\nfor file in base_path.glob('**/*.nwb'):\n\n    with NWBHDF5IO(str(file), mode='r+', load_namespaces=True) as io:\n        nwbfile = io.read()\n        nwbfile_containers = [nwbfile.acquisition, nwbfile.processing]\n        for data_interface in nwbfile_containers:\n            for name, image_series in get_image_series(data_interface).items():\n                for no, ext_file in enumerate(image_series.external_file):\n                    if ext_file.split('.')[-1] in [\"mp4\", \"tif\"]:\n                        image_series.external_file[no] = dandi_organize(ext_file, no, image_series,\n                                                                        create_symlink=False)\n        io.write(nwbfile)\n\n```\n\nEssentially it performs 2 functions:\n1. Renames the video files and places them in a sub-folder with the same name as the nwbfile. Its renames the file with the uuid of the parent `ImageSeries` container + 'external_file_\u003cvideo_no\u003e.mp4 : \n    `\u003cnwbfile_name\u003e/{UUID}_external_file_0.mp4`\n2. Updates the `external_file` arg in all the nwb files.","files":null},{"type":6,"author":{"id":"83fae958856b684c15b81b726620f7b946f24143"},"timestamp":1636568187,"metadata":{"github-id":"UCE_lALODBZtRc45jVNjzh7cyi4"},"target":"e007032371b4101d2906b3dbc79c2ad2ecee83c94a2ba24a325fe7135a6e8da4","message":"As an example, I have created a script that takes in a folder containing nwb files and accompanying video files (linked with `external_file` tag in the `ImageSeries` container. \n[Here is an example folder](https://drive.google.com/drive/folders/1jnyU7iY-kbAhjWWYATJ8RmKiP0Uk2ifN?usp=sharing) that contains 3 video files (mp4). And [here is the output](https://drive.google.com/drive/folders/13gfzopQYi2CIPv4xyhsMWqAtcUBJBsZv?usp=sharing) with the created nwbfiles (with changed `external_file` arg)\n\n**Step 1: create the nwb files with video files as external args:**\n```python\nfrom datetime import datetime\n\nfrom dateutil.tz import tzlocal\nfrom pynwb import NWBFile, NWBHDF5IO\nfrom pynwb.device import Device\nfrom pynwb.file import Subject\nfrom pynwb.ophys import ImageSeries\n\nbase = r\"C:\\Users\\Saksham\\Documents\\NWB\\DANDI-video\" #path to gdrive downloaded folder\n\ndef create_nwb(name, no):\n    subject = Subject(subject_id=f'mouse{no}', species=\"Mus musculus\", sex=\"M\",\n                      description='lab mouse ')\n    device = Device(f'imaging_device_{no}')\n    nwbfile = NWBFile(f'{name}{no}', 'desc: contains movie for dandi .mp4 storage as external',\n                      datetime.now(tzlocal()),\n                      experimenter='Dr. Bilbo Baggins',\n                      session_id=f'sessionid{no}',\n                      subject=subject,\n                      devices=[device])\n    image_series = ImageSeries(name=f'MouseWhiskers{no}',\n                               format='external',\n                               external_file=[base+fr\"\\video{no}.mp4\",base+fr\"\\video{no+1}.mp4\"],\n                               starting_frame=[0], starting_time=0.0, rate=150.0)\n    nwbfile.add_acquisition(image_series)\n\n    with NWBHDF5IO(f'{name}{no}.nwb', 'w') as io:\n        io.write(nwbfile)\n\nfor i in [0,2,4]:\n    create_nwb('test', i)\n```\n\n**Step 2: re-organize:**\n\n```python\nimport pynwb.image\nfrom pynwb import NWBHDF5IO\nfrom pathlib import Path\nimport shutil\n\n\ndef dandi_organize(file_name: str, idx: int, nwb_object, create_symlink=False):\n    \"\"\"\n    1. Renames the file_name based on the defined naming method\n    2. Creates a symlink (with the same name) to the actual file on disk\n    \"\"\"\n    nwbfile = nwb_object.parent\n    fileext = file_name.split('.')[-1]\n    parent_folder = Path(nwb_object.container_source).with_suffix(\"\")\n    if not parent_folder.exists():\n        parent_folder.mkdir()\n    video_name = Path(f'{nwb_object.object_id}_external_file_{idx}.{fileext}')\n    symlink_path = parent_folder/video_name\n    if create_symlink:\n        symlink_path.symlink_to(Path(file_name))\n    else:\n        shutil.copy(file_name, str(symlink_path))\n    return str(symlink_path)\n\n\ndef get_image_series(container):\n    image_series_containers = dict()\n    for name, ob in container.items():\n        if isinstance(ob, pynwb.image.ImageSeries) and ob.external_file is not None:\n            image_series_containers[name] = ob\n    return image_series_containers\n\nbase_path = Path(\"~/DANDI-video\") # enter the path of the downloaded gdrive folder with nwbfiles generated after step1\nfor file in base_path.glob('**/*.nwb'):\n\n    with NWBHDF5IO(str(file), mode='r+', load_namespaces=True) as io:\n        nwbfile = io.read()\n        nwbfile_containers = [nwbfile.acquisition, nwbfile.processing]\n        for data_interface in nwbfile_containers:\n            for name, image_series in get_image_series(data_interface).items():\n                for no, ext_file in enumerate(image_series.external_file):\n                    if ext_file.split('.')[-1] in [\"mp4\", \"tif\"]:\n                        image_series.external_file[no] = dandi_organize(ext_file, no, image_series,\n                                                                        create_symlink=False)\n        io.write(nwbfile)\n\n```\n\nEssentially it performs 2 functions:\n1. Renames the video files and places them in a sub-folder with the same name as the nwbfile. Its renames the file with the uuid of the parent `ImageSeries` container + 'external_file_\u003cvideo_no\u003e.mp4 : \n    `\u003cnwbfile_name\u003e/{UUID}_external_file_0.mp4`\n2. Updates the `external_file` arg in all the nwb files.","files":null},{"type":6,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1636568621,"metadata":{"github-id":"UCE_lALODBZtRc45jVNjzh7c2Ek"},"target":"e007032371b4101d2906b3dbc79c2ad2ecee83c94a2ba24a325fe7135a6e8da4","message":"As an example, I have created a script that takes in a folder containing nwb files and accompanying video files (linked with `external_file` tag in the `ImageSeries` container. \n[Here is an example folder](https://drive.google.com/drive/folders/1jnyU7iY-kbAhjWWYATJ8RmKiP0Uk2ifN?usp=sharing) that contains 3 video files (mp4). And [here is the output](https://drive.google.com/drive/folders/13gfzopQYi2CIPv4xyhsMWqAtcUBJBsZv?usp=sharing) with the created nwbfiles (with changed `external_file` arg)\n\n**Step 1: create the nwb files with video files as external args:**\n```python\nfrom datetime import datetime\n\nfrom dateutil.tz import tzlocal\nfrom pynwb import NWBFile, NWBHDF5IO\nfrom pynwb.device import Device\nfrom pynwb.file import Subject\nfrom pynwb.ophys import ImageSeries\n\nbase = r\"C:\\Users\\Saksham\\Documents\\NWB\\DANDI-video\" #path to gdrive downloaded folder\n\ndef create_nwb(name, no):\n    subject = Subject(subject_id=f'mouse{no}', species=\"Mus musculus\", sex=\"M\",\n                      description='lab mouse ')\n    device = Device(f'imaging_device_{no}')\n    nwbfile = NWBFile(f'{name}{no}', 'desc: contains movie for dandi .mp4 storage as external',\n                      datetime.now(tzlocal()),\n                      experimenter='Dr. Bilbo Baggins',\n                      session_id=f'sessionid{no}',\n                      subject=subject,\n                      devices=[device])\n    image_series = ImageSeries(name=f'MouseWhiskers{no}',\n                               format='external',\n                               external_file=[base+fr\"\\video{no}.mp4\",base+fr\"\\video{no+1}.mp4\"],\n                               starting_frame=[0], starting_time=0.0, rate=150.0)\n    nwbfile.add_acquisition(image_series)\n\n    with NWBHDF5IO(f'{name}{no}.nwb', 'w') as io:\n        io.write(nwbfile)\n\nfor i in [0,2,4]:\n    create_nwb('test', i)\n```\n\n**Step 2: re-organize:**\n\n```python\nimport pynwb.image\nfrom pynwb import NWBHDF5IO\nfrom pathlib import Path\nimport shutil\n\n\ndef dandi_organize(file_name: str, idx: int, nwb_object, create_symlink=False):\n    \"\"\"\n    1. Renames the file_name based on the defined naming method\n    2. Creates a symlink (with the same name) to the actual file on disk\n    \"\"\"\n    nwbfile = nwb_object.parent\n    fileext = file_name.split('.')[-1]\n    parent_folder = Path(nwb_object.container_source).with_suffix(\"\")\n    if not parent_folder.exists():\n        parent_folder.mkdir()\n    video_name = Path(f'{nwb_object.object_id}_external_file_{idx}.{fileext}')\n    symlink_path = parent_folder/video_name\n    if create_symlink:\n        symlink_path.symlink_to(Path(file_name))\n    else:\n        shutil.copy(file_name, str(symlink_path))\n    return str(symlink_path)\n\n\ndef get_image_series(container):\n    image_series_containers = dict()\n    for name, ob in container.items():\n        if isinstance(ob, pynwb.image.ImageSeries) and ob.external_file is not None:\n            image_series_containers[name] = ob\n    return image_series_containers\n\nbase_path = Path(\"~/DANDI-video\") # enter the path of the downloaded gdrive folder with nwbfiles generated after step1\nfor file in base_path.glob('**/*.nwb'):\n\n    with NWBHDF5IO(str(file), mode='r+', load_namespaces=True) as io:\n        nwbfile = io.read()\n        nwbfile_containers = [nwbfile.acquisition, nwbfile.processing]\n        for data_interface in nwbfile_containers:\n            for name, image_series in get_image_series(data_interface).items():\n                for no, ext_file in enumerate(image_series.external_file):\n                    if ext_file.split('.')[-1] in [\"mp4\"]:\n                        image_series.external_file[no] = dandi_organize(ext_file, no, image_series,\n                                                                        create_symlink=False)\n        io.write(nwbfile)\n\n```\n\nEssentially it performs 2 functions:\n1. Renames the video files and places them in a sub-folder with the same name as the nwbfile. Its renames the file with the uuid of the parent `ImageSeries` container + 'external_file_\u003cvideo_no\u003e.mp4 : \n    `\u003cnwbfile_name\u003e/{UUID}_external_file_0.mp4`\n2. Updates the `external_file` arg in all the nwb files.","files":null},{"type":6,"author":{"id":"83fae958856b684c15b81b726620f7b946f24143"},"timestamp":1636632577,"metadata":{"github-id":"UCE_lALODBZtRc45jVNjzh7hr-U"},"target":"e007032371b4101d2906b3dbc79c2ad2ecee83c94a2ba24a325fe7135a6e8da4","message":"As an example, I have created a script that takes in a folder containing nwb files and accompanying video files (linked with `external_file` tag in the `ImageSeries` container. \n[Here is an example folder](https://drive.google.com/drive/folders/1jnyU7iY-kbAhjWWYATJ8RmKiP0Uk2ifN?usp=sharing) that contains 3 video files (mp4). And [here is the output](https://drive.google.com/drive/folders/13gfzopQYi2CIPv4xyhsMWqAtcUBJBsZv?usp=sharing) with the created nwbfiles (with changed `external_file` arg)\n\n**Step 1: create the nwb files with video files as external args:**\n```python\nfrom datetime import datetime\n\nfrom dateutil.tz import tzlocal\nfrom pynwb import NWBFile, NWBHDF5IO\nfrom pynwb.device import Device\nfrom pynwb.file import Subject\nfrom pynwb.ophys import ImageSeries\n\nbase = r\"C:\\Users\\Saksham\\Documents\\NWB\\DANDI-video\" #path to gdrive downloaded folder\n\ndef create_nwb(name, no):\n    subject = Subject(subject_id=f'mouse{no}', species=\"Mus musculus\", sex=\"M\",\n                      description='lab mouse ')\n    device = Device(f'imaging_device_{no}')\n    nwbfile = NWBFile(f'{name}{no}', 'desc: contains movie for dandi .mp4 storage as external',\n                      datetime.now(tzlocal()),\n                      experimenter='Dr. Bilbo Baggins',\n                      session_id=f'sessionid{no}',\n                      subject=subject,\n                      devices=[device])\n    image_series = ImageSeries(name=f'MouseWhiskers{no}',\n                               format='external',\n                               external_file=[base+fr\"\\video{no}.mp4\",base+fr\"\\video{no+1}.mp4\"],\n                               starting_frame=[0], starting_time=0.0, rate=150.0)\n    nwbfile.add_acquisition(image_series)\n\n    with NWBHDF5IO(base+f'{name}{no}.nwb', 'w') as io:\n        io.write(nwbfile)\n\nfor i in [0,2,4]:\n    create_nwb('test', i)\n```\n\n**Step 2: re-organize:**\n\n```python\nimport pynwb.image\nfrom pynwb import NWBHDF5IO\nfrom pathlib import Path\nimport shutil\n\n\ndef dandi_organize(file_name: str, idx: int, nwb_object, create_symlink=False):\n    \"\"\"\n    1. Renames the file_name based on the defined naming method\n    2. Creates a symlink (with the same name) to the actual file on disk\n    \"\"\"\n    nwbfile = nwb_object.parent\n    fileext = file_name.split('.')[-1]\n    parent_folder = Path(nwb_object.container_source).with_suffix(\"\")\n    if not parent_folder.exists():\n        parent_folder.mkdir()\n    video_name = Path(f'{nwb_object.object_id}_external_file_{idx}.{fileext}')\n    symlink_path = parent_folder/video_name\n    if create_symlink:\n        symlink_path.symlink_to(Path(file_name))\n    else:\n        shutil.copy(file_name, str(symlink_path))\n    return str(symlink_path)\n\n\ndef get_image_series(container):\n    image_series_containers = dict()\n    for name, ob in container.items():\n        if isinstance(ob, pynwb.image.ImageSeries) and ob.external_file is not None:\n            image_series_containers[name] = ob\n    return image_series_containers\n\nbase_path = Path(\"~/DANDI-video\") # enter the path of the downloaded gdrive folder with nwbfiles generated after step1\nfor file in base_path.glob('**/*.nwb'):\n\n    with NWBHDF5IO(str(file), mode='r+', load_namespaces=True) as io:\n        nwbfile = io.read()\n        nwbfile_containers = [nwbfile.acquisition, nwbfile.processing]\n        for data_interface in nwbfile_containers:\n            for name, image_series in get_image_series(data_interface).items():\n                for no, ext_file in enumerate(image_series.external_file):\n                    if ext_file.split('.')[-1] in [\"mp4\"]:\n                        image_series.external_file[no] = dandi_organize(ext_file, no, image_series,\n                                                                        create_symlink=False)\n        io.write(nwbfile)\n\n```\n\nEssentially it performs 2 functions:\n1. Renames the video files and places them in a sub-folder with the same name as the nwbfile. Its renames the file with the uuid of the parent `ImageSeries` container + 'external_file_\u003cvideo_no\u003e.mp4 : \n    `\u003cnwbfile_name\u003e/{UUID}_external_file_0.mp4`\n2. Updates the `external_file` arg in all the nwb files.","files":null},{"type":6,"author":{"id":"83fae958856b684c15b81b726620f7b946f24143"},"timestamp":1636632743,"metadata":{"github-id":"UCE_lALODBZtRc45jVNjzh7hszo"},"target":"e007032371b4101d2906b3dbc79c2ad2ecee83c94a2ba24a325fe7135a6e8da4","message":"As an example, I have created a script that takes in a folder containing nwb files and accompanying video files (linked with `external_file` tag in the `ImageSeries` container. \n[Here is an example folder](https://drive.google.com/drive/folders/1jnyU7iY-kbAhjWWYATJ8RmKiP0Uk2ifN?usp=sharing) that contains 3 video files (mp4). And [here is the output](https://drive.google.com/drive/folders/13gfzopQYi2CIPv4xyhsMWqAtcUBJBsZv?usp=sharing) with the created nwbfiles (with changed `external_file` arg)\n\n**Step 1: create the nwb files with video files as external args:**\n```python\nfrom datetime import datetime\n\nfrom dateutil.tz import tzlocal\nfrom pynwb import NWBFile, NWBHDF5IO\nfrom pynwb.device import Device\nfrom pynwb.file import Subject\nfrom pynwb.ophys import ImageSeries\nfrom pathlib import Path\nbase = r\"C:\\Users\\Saksham\\Documents\\NWB\\DANDI-video\" #path to gdrive downloaded folder\n\ndef create_nwb(name, no):\n    subject = Subject(subject_id=f'mouse{no}', species=\"Mus musculus\", sex=\"M\",\n                      description='lab mouse ')\n    device = Device(f'imaging_device_{no}')\n    nwbfile = NWBFile(f'{name}{no}', 'desc: contains movie for dandi .mp4 storage as external',\n                      datetime.now(tzlocal()),\n                      experimenter='Dr. Bilbo Baggins',\n                      session_id=f'sessionid{no}',\n                      subject=subject,\n                      devices=[device])\n    image_series = ImageSeries(name=f'MouseWhiskers{no}',\n                               format='external',\n                               external_file=[base+fr\"\\video{no}.mp4\",base+fr\"\\video{no+1}.mp4\"],\n                               starting_frame=[0], starting_time=0.0, rate=150.0)\n    nwbfile.add_acquisition(image_series)\n\n    with NWBHDF5IO(str(Path(base)/f'{name}{no}.nwb'), 'w') as io:\n        io.write(nwbfile)\n\nfor i in [0,2,4]:\n    create_nwb('test', i)\n```\n\n**Step 2: re-organize:**\n\n```python\nimport pynwb.image\nfrom pynwb import NWBHDF5IO\nfrom pathlib import Path\nimport shutil\n\n\ndef dandi_organize(file_name: str, idx: int, nwb_object, create_symlink=False):\n    \"\"\"\n    1. Renames the file_name based on the defined naming method\n    2. Creates a symlink (with the same name) to the actual file on disk\n    \"\"\"\n    nwbfile = nwb_object.parent\n    fileext = file_name.split('.')[-1]\n    parent_folder = Path(nwb_object.container_source).with_suffix(\"\")\n    if not parent_folder.exists():\n        parent_folder.mkdir()\n    video_name = Path(f'{nwb_object.object_id}_external_file_{idx}.{fileext}')\n    symlink_path = parent_folder/video_name\n    if create_symlink:\n        symlink_path.symlink_to(Path(file_name))\n    else:\n        shutil.copy(file_name, str(symlink_path))\n    return str(symlink_path)\n\n\ndef get_image_series(container):\n    image_series_containers = dict()\n    for name, ob in container.items():\n        if isinstance(ob, pynwb.image.ImageSeries) and ob.external_file is not None:\n            image_series_containers[name] = ob\n    return image_series_containers\n\nbase_path = Path(\"~/DANDI-video\") # enter the path of the downloaded gdrive folder with nwbfiles generated after step1\nfor file in base_path.glob('**/*.nwb'):\n\n    with NWBHDF5IO(str(file), mode='r+', load_namespaces=True) as io:\n        nwbfile = io.read()\n        nwbfile_containers = [nwbfile.acquisition, nwbfile.processing]\n        for data_interface in nwbfile_containers:\n            for name, image_series in get_image_series(data_interface).items():\n                for no, ext_file in enumerate(image_series.external_file):\n                    if ext_file.split('.')[-1] in [\"mp4\"]:\n                        image_series.external_file[no] = dandi_organize(ext_file, no, image_series,\n                                                                        create_symlink=False)\n        io.write(nwbfile)\n\n```\n\nEssentially it performs 2 functions:\n1. Renames the video files and places them in a sub-folder with the same name as the nwbfile. Its renames the file with the uuid of the parent `ImageSeries` container + 'external_file_\u003cvideo_no\u003e.mp4 : \n    `\u003cnwbfile_name\u003e/{UUID}_external_file_0.mp4`\n2. Updates the `external_file` arg in all the nwb files.","files":null},{"type":6,"author":{"id":"83fae958856b684c15b81b726620f7b946f24143"},"timestamp":1636639451,"metadata":{"github-id":"UCE_lALODBZtRc45jVNjzh7iTFY"},"target":"e007032371b4101d2906b3dbc79c2ad2ecee83c94a2ba24a325fe7135a6e8da4","message":"As an example, I have created a script that takes in a folder containing nwb files and accompanying video files (linked with `external_file` tag in the `ImageSeries` container. \n[Here is an example folder](https://drive.google.com/drive/folders/1jnyU7iY-kbAhjWWYATJ8RmKiP0Uk2ifN?usp=sharing) that contains 3 video files (mp4). And [here is the output](https://drive.google.com/drive/folders/13gfzopQYi2CIPv4xyhsMWqAtcUBJBsZv?usp=sharing) with the created nwbfiles (with changed `external_file` arg)\n\n**Step 1: create the nwb files with video files as external args:**\n```python\nfrom datetime import datetime\n\nfrom dateutil.tz import tzlocal\nfrom pynwb import NWBFile, NWBHDF5IO\nfrom pynwb.device import Device\nfrom pynwb.file import Subject\nfrom pynwb.ophys import ImageSeries\nfrom pathlib import Path\nbase = r\"C:\\Users\\Saksham\\Documents\\NWB\\DANDI-video\" #path to gdrive downloaded folder\n\ndef create_nwb(name, no):\n    subject = Subject(subject_id=f'mouse{no}', species=\"Mus musculus\", sex=\"M\",\n                      description='lab mouse ')\n    device = Device(f'imaging_device_{no}')\n    nwbfile = NWBFile(f'{name}{no}', 'desc: contains movie for dandi .mp4 storage as external',\n                      datetime.now(tzlocal()),\n                      experimenter='Dr. Bilbo Baggins',\n                      session_id=f'sessionid{no}',\n                      subject=subject,\n                      devices=[device])\n    image_series = ImageSeries(name=f'MouseWhiskers{no}',\n                               format='external',\n                               external_file=[base+fr\"\\video{no}.mp4\",base+fr\"\\video{no+1}.mp4\"],\n                               starting_frame=[0], starting_time=0.0, rate=150.0)\n    nwbfile.add_acquisition(image_series)\n\n    with NWBHDF5IO(str(Path(base)/f'{name}{no}.nwb'), 'w') as io:\n        io.write(nwbfile)\n\nfor i in [0,2,4]:\n    create_nwb('test', i)\n```\n\n**Step 2: re-organize:**\n\n```python\nimport pynwb.image\nfrom pynwb import NWBHDF5IO\nfrom pathlib import Path\nimport shutil\n\n\ndef dandi_organize(file_name: str, idx: int, nwb_object, create_symlink=False):\n    \"\"\"\n    1. Renames the file_name based on the defined naming method\n    2. Creates a symlink (with the same name) to the actual file on disk\n    \"\"\"\n    nwbfile = nwb_object.parent\n    fileext = file_name.split('.')[-1]\n    parent_folder = Path(nwb_object.container_source).with_suffix(\"\")\n    if not parent_folder.exists():\n        parent_folder.mkdir()\n    video_name = Path(f'{nwb_object.object_id}_external_file_{idx}.{fileext}')\n    symlink_path = parent_folder/video_name\n    if create_symlink:\n        symlink_path.symlink_to(Path(file_name))\n    else:\n        shutil.move(file_name, str(symlink_path))\n    return str(symlink_path)\n\n\ndef get_image_series(container):\n    image_series_containers = dict()\n    for name, ob in container.items():\n        if isinstance(ob, pynwb.image.ImageSeries) and ob.external_file is not None:\n            image_series_containers[name] = ob\n    return image_series_containers\n\nbase_path = Path(\"~/DANDI-video\") # enter the path of the downloaded gdrive folder with nwbfiles generated after step1\nfor file in base_path.glob('**/*.nwb'):\n\n    with NWBHDF5IO(str(file), mode='r+', load_namespaces=True) as io:\n        nwbfile = io.read()\n        nwbfile_containers = [nwbfile.acquisition, nwbfile.processing]\n        for data_interface in nwbfile_containers:\n            for name, image_series in get_image_series(data_interface).items():\n                for no, ext_file in enumerate(image_series.external_file):\n                    if ext_file.split('.')[-1] in [\"mp4\"]:\n                        image_series.external_file[no] = dandi_organize(ext_file, no, image_series,\n                                                                        create_symlink=False)\n        io.write(nwbfile)\n\n```\n\nEssentially it performs 2 functions:\n1. Renames the video files and places them in a sub-folder with the same name as the nwbfile. Its renames the file with the uuid of the parent `ImageSeries` container + 'external_file_\u003cvideo_no\u003e.mp4 : \n    `\u003cnwbfile_name\u003e/{UUID}_external_file_0.mp4`\n2. Updates the `external_file` arg in all the nwb files.","files":null},{"type":6,"author":{"id":"83fae958856b684c15b81b726620f7b946f24143"},"timestamp":1636777756,"metadata":{"github-id":"UCE_lALODBZtRc45jVNjzh7sn2Y"},"target":"e007032371b4101d2906b3dbc79c2ad2ecee83c94a2ba24a325fe7135a6e8da4","message":"As an example, I have created a script that takes in a folder containing nwb files and accompanying video files (linked with `external_file` tag in the `ImageSeries` container. \n[Here is an example folder](https://drive.google.com/drive/folders/1jnyU7iY-kbAhjWWYATJ8RmKiP0Uk2ifN?usp=sharing) that contains 6 video files (mp4). And [here is the output](https://drive.google.com/drive/folders/13gfzopQYi2CIPv4xyhsMWqAtcUBJBsZv?usp=sharing) with the created nwbfiles (with changed `external_file` arg)\n\n**Step 1: create the nwb files with video files as external args:**\n```python\nfrom datetime import datetime\n\nfrom dateutil.tz import tzlocal\nfrom pynwb import NWBFile, NWBHDF5IO\nfrom pynwb.device import Device\nfrom pynwb.file import Subject\nfrom pynwb.ophys import ImageSeries\nfrom pathlib import Path\nbase = r\"C:\\Users\\Saksham\\Documents\\NWB\\DANDI-video\" #path to gdrive downloaded folder\n\ndef create_nwb(name, no):\n    subject = Subject(subject_id=f'mouse{no}', species=\"Mus musculus\", sex=\"M\",\n                      description='lab mouse ')\n    device = Device(f'imaging_device_{no}')\n    nwbfile = NWBFile(f'{name}{no}', 'desc: contains movie for dandi .mp4 storage as external',\n                      datetime.now(tzlocal()),\n                      experimenter='Dr. Bilbo Baggins',\n                      session_id=f'sessionid{no}',\n                      subject=subject,\n                      devices=[device])\n    image_series = ImageSeries(name=f'MouseWhiskers{no}',\n                               format='external',\n                               external_file=[base+fr\"\\video{no}.mp4\",base+fr\"\\video{no+1}.mp4\"],\n                               starting_frame=[0], starting_time=0.0, rate=150.0)\n    nwbfile.add_acquisition(image_series)\n\n    with NWBHDF5IO(str(Path(base)/f'{name}{no}.nwb'), 'w') as io:\n        io.write(nwbfile)\n\nfor i in [0,2,4]:\n    create_nwb('test', i)\n```\n\n**Step 2: re-organize:**\n\n```python\nimport pynwb.image\nfrom pynwb import NWBHDF5IO\nfrom pathlib import Path\nimport shutil\n\n\ndef dandi_organize(file_name: str, idx: int, nwb_object, create_symlink=False):\n    \"\"\"\n    1. Renames the file_name based on the defined naming method\n    2. Creates a symlink (with the same name) to the actual file on disk\n    \"\"\"\n    nwbfile = nwb_object.parent\n    fileext = file_name.split('.')[-1]\n    parent_folder = Path(nwb_object.container_source).with_suffix(\"\")\n    if not parent_folder.exists():\n        parent_folder.mkdir()\n    video_name = Path(f'{nwb_object.object_id}_external_file_{idx}.{fileext}')\n    symlink_path = parent_folder/video_name\n    if create_symlink:\n        symlink_path.symlink_to(Path(file_name))\n    else:\n        shutil.move(file_name, str(symlink_path))\n    return str(symlink_path)\n\n\ndef get_image_series(container):\n    image_series_containers = dict()\n    for name, ob in container.items():\n        if isinstance(ob, pynwb.image.ImageSeries) and ob.external_file is not None:\n            image_series_containers[name] = ob\n    return image_series_containers\n\nbase_path = Path(\"~/DANDI-video\") # enter the path of the downloaded gdrive folder with nwbfiles generated after step1\nfor file in base_path.glob('**/*.nwb'):\n\n    with NWBHDF5IO(str(file), mode='r+', load_namespaces=True) as io:\n        nwbfile = io.read()\n        nwbfile_containers = [nwbfile.acquisition, nwbfile.processing]\n        for data_interface in nwbfile_containers:\n            for name, image_series in get_image_series(data_interface).items():\n                for no, ext_file in enumerate(image_series.external_file):\n                    if ext_file.split('.')[-1] in [\"mp4\"]:\n                        image_series.external_file[no] = dandi_organize(ext_file, no, image_series,\n                                                                        create_symlink=False)\n        io.write(nwbfile)\n\n```\n\nEssentially it performs 2 functions:\n1. Renames the video files and places them in a sub-folder with the same name as the nwbfile. Its renames the file with the uuid of the parent `ImageSeries` container + 'external_file_\u003cvideo_no\u003e.mp4 : \n    `\u003cnwbfile_name\u003e/{UUID}_external_file_0.mp4`\n2. Updates the `external_file` arg in all the nwb files.","files":null},{"type":6,"author":{"id":"83fae958856b684c15b81b726620f7b946f24143"},"timestamp":1636777855,"metadata":{"github-id":"UCE_lALODBZtRc45jVNjzh7sn_c"},"target":"e007032371b4101d2906b3dbc79c2ad2ecee83c94a2ba24a325fe7135a6e8da4","message":"As an example, I have created a script that takes in a folder containing nwb files and accompanying video files (linked with `external_file` tag in the `ImageSeries` container. \n[Here is an example folder](https://drive.google.com/drive/folders/1jnyU7iY-kbAhjWWYATJ8RmKiP0Uk2ifN?usp=sharing) that contains 6 video files (mp4). And [here is the output](https://drive.google.com/drive/folders/13gfzopQYi2CIPv4xyhsMWqAtcUBJBsZv?usp=sharing) with the created nwbfiles (with changed `external_file` arg)\n\n**Step 1: create the nwb files with video files as external args:**\n```python\nimport shutil\n\nimport pynwb.image\nfrom pynwb import NWBHDF5IO, NWBFile\nfrom pathlib import Path\n\n\n## create the nwbfiles:\nfrom datetime import datetime\n\nfrom dateutil.tz import tzlocal\nfrom pynwb.device import Device\nfrom pynwb.file import Subject\nfrom pynwb.ophys import ImageSeries\n\ndown_loc = '/Users/sakshamsharda/Downloads' #path to gdrive downloaded folder please update\n\nvideo_base_path = Path(down_loc)/\"dandi_video\"/\"video_files\"\ndandi_base_path = video_base_path.parent/\"DANDI\"/\"000999\"\n\n\ndef create_nwb(name, no):\n    subject_id = f'mouse{no}'\n    session_id=f'sessionid{no}'\n    subject = Subject(subject_id=subject_id, species=\"Mus musculus\", sex=\"M\",\n                      description='lab mouse ')\n    device = Device(f'imaging_device_{no}')\n    nwbfile = NWBFile(f'{name}{no}', 'desc: contains movie for dandi .mp4 storage as external',\n                      datetime.now(tzlocal()),\n                      experimenter='Dr. Bilbo Baggins',\n                      session_id=session_id,\n                      subject=subject,\n                      devices=[device])\n\n    image_series = ImageSeries(name=f'MouseWhiskers{no}',\n                               format='external',\n                               external_file=[str(video_base_path/fr\"video{no}.mp4\"),\n                                              str(video_base_path/fr\"video{no+1}.mp4\")],\n                               starting_frame=[0], starting_time=0.0, rate=150.0)\n    nwbfile.add_acquisition(image_series)\n    nwbfile_path = video_base_path/f'{name}_{no}.nwb'\n    with NWBHDF5IO(str(nwbfile_path), 'w') as io:\n        io.write(nwbfile)\n\n## organize:\n\ndef dandi_organize(nwb_object, symlink=True):\n    \"\"\"\n    1. Renames the file_name based on the defined naming method\n    2. Creates a symlink (with the same name) to the actual file on disk\n    \"\"\"\n    nwbfile = nwb_object.parent\n    subject_id = nwbfile.subject.subject_id\n    session_id = nwbfile.session_id\n\n    #create nwb symlinks:\n    dandi_nwb_base = dandi_base_path/f'sub-{subject_id}'\n    dandi_nwb_base.mkdir(parents=True, exist_ok=True)\n    dandi_nwb_name = dandi_nwb_base/f'sub-{subject_id}_ses-{session_id}_image.nwb'\n    if symlink:\n        dandi_nwb_name.symlink_to(Path(nwb_object.container_source))\n    else:\n        shutil.copy(nwb_object.container_source, dandi_nwb_name)\n        io = NWBHDF5IO(str(dandi_nwb_name), mode='r+', load_namespaces=True)\n        nwbfile = io.read()\n        nwb_object = [i for i in nwbfile.children if i.name==nwb_object.name][0]\n\n    new_video_path = dandi_nwb_base/dandi_nwb_name.stem\n    new_video_path.mkdir(parents=True, exist_ok=True)\n        \n    for idx, ext_file in enumerate(nwb_object.external_file):\n        video_name = new_video_path/Path(f'{nwb_object.object_id}_external_file_{idx}.{ext_file.split(\".\")[-1]}')\n        if symlink:\n            video_name.symlink_to(Path(ext_file))\n        else:\n            shutil.copy(ext_file, video_name)\n        nwb_object.external_file[idx] = video_name\n\n\ndef get_image_series(container):\n    image_series_containers = dict()\n    for name, ob in container.items():\n        if isinstance(ob, pynwb.image.ImageSeries) and ob.external_file is not None:\n            image_series_containers[name] = ob\n    return image_series_containers\n\n\n# main script:\n# 1. Create teh nwb files:\nfor i in [0,2,4]:\n    create_nwb('dandi_video_test', i)\n\n# 2. Organize:\nfor nwb_path in Path(video_base_path).glob('**/*.nwb'):\n    with NWBHDF5IO(str(nwb_path), mode='r+', load_namespaces=True) as io:\n        nwbfile = io.read()\n        nwbfile_containers = [nwbfile.acquisition, nwbfile.processing]\n        for data_interface in nwbfile_containers:\n            for name, image_series in get_image_series(data_interface).items():\n                if image_series.external_file[0].split('.')[-1] in [\"mp4\", \"tif\"]:\n                    dandi_organize(image_series, symlink=False)\n        io.write(nwbfile)\n\n\n```\n\nEssentially it performs 2 functions:\n1. Renames the video files and places them in a sub-folder with the same name as the nwbfile. Its renames the file with the uuid of the parent `ImageSeries` container + 'external_file_\u003cvideo_no\u003e.mp4 : \n    `\u003cnwbfile_name\u003e/{UUID}_external_file_0.mp4`\n2. Updates the `external_file` arg in all the nwb files.","files":null},{"type":6,"author":{"id":"83fae958856b684c15b81b726620f7b946f24143"},"timestamp":1636777922,"metadata":{"github-id":"UCE_lALODBZtRc45jVNjzh7soGg"},"target":"e007032371b4101d2906b3dbc79c2ad2ecee83c94a2ba24a325fe7135a6e8da4","message":"As an example, I have created a script that takes in a folder containing nwb files and accompanying video files (linked with `external_file` tag in the `ImageSeries` container. \n[Here is an example folder](https://drive.google.com/drive/folders/1jnyU7iY-kbAhjWWYATJ8RmKiP0Uk2ifN?usp=sharing) that contains 6 video files (mp4). And [here is the output](https://drive.google.com/drive/folders/13gfzopQYi2CIPv4xyhsMWqAtcUBJBsZv?usp=sharing) with the created nwbfiles (with changed `external_file` arg)\n\n**Step 1: create the nwb files with video files as external args:**\n```python\nimport shutil\n\nimport pynwb.image\nfrom pynwb import NWBHDF5IO, NWBFile\nfrom pathlib import Path\n\n\n## create the nwbfiles:\nfrom datetime import datetime\n\nfrom dateutil.tz import tzlocal\nfrom pynwb.device import Device\nfrom pynwb.file import Subject\nfrom pynwb.ophys import ImageSeries\n\ndown_loc = '/Users/sakshamsharda/Downloads' #path to browser downloads folder\n\nvideo_base_path = Path(down_loc)/\"dandi_video\"/\"video_files\" # after unzipping gdrive downloaded file\ndandi_base_path = video_base_path.parent/\"DANDI\"/\"000999\"\n\n\ndef create_nwb(name, no):\n    subject_id = f'mouse{no}'\n    session_id=f'sessionid{no}'\n    subject = Subject(subject_id=subject_id, species=\"Mus musculus\", sex=\"M\",\n                      description='lab mouse ')\n    device = Device(f'imaging_device_{no}')\n    nwbfile = NWBFile(f'{name}{no}', 'desc: contains movie for dandi .mp4 storage as external',\n                      datetime.now(tzlocal()),\n                      experimenter='Dr. Bilbo Baggins',\n                      session_id=session_id,\n                      subject=subject,\n                      devices=[device])\n\n    image_series = ImageSeries(name=f'MouseWhiskers{no}',\n                               format='external',\n                               external_file=[str(video_base_path/fr\"video{no}.mp4\"),\n                                              str(video_base_path/fr\"video{no+1}.mp4\")],\n                               starting_frame=[0], starting_time=0.0, rate=150.0)\n    nwbfile.add_acquisition(image_series)\n    nwbfile_path = video_base_path/f'{name}_{no}.nwb'\n    with NWBHDF5IO(str(nwbfile_path), 'w') as io:\n        io.write(nwbfile)\n\n## organize:\n\ndef dandi_organize(nwb_object, symlink=True):\n    \"\"\"\n    1. Renames the file_name based on the defined naming method\n    2. Creates a symlink (with the same name) to the actual file on disk\n    \"\"\"\n    nwbfile = nwb_object.parent\n    subject_id = nwbfile.subject.subject_id\n    session_id = nwbfile.session_id\n\n    #create nwb symlinks:\n    dandi_nwb_base = dandi_base_path/f'sub-{subject_id}'\n    dandi_nwb_base.mkdir(parents=True, exist_ok=True)\n    dandi_nwb_name = dandi_nwb_base/f'sub-{subject_id}_ses-{session_id}_image.nwb'\n    if symlink:\n        dandi_nwb_name.symlink_to(Path(nwb_object.container_source))\n    else:\n        shutil.copy(nwb_object.container_source, dandi_nwb_name)\n        io = NWBHDF5IO(str(dandi_nwb_name), mode='r+', load_namespaces=True)\n        nwbfile = io.read()\n        nwb_object = [i for i in nwbfile.children if i.name==nwb_object.name][0]\n\n    new_video_path = dandi_nwb_base/dandi_nwb_name.stem\n    new_video_path.mkdir(parents=True, exist_ok=True)\n        \n    for idx, ext_file in enumerate(nwb_object.external_file):\n        video_name = new_video_path/Path(f'{nwb_object.object_id}_external_file_{idx}.{ext_file.split(\".\")[-1]}')\n        if symlink:\n            video_name.symlink_to(Path(ext_file))\n        else:\n            shutil.copy(ext_file, video_name)\n        nwb_object.external_file[idx] = video_name\n\n\ndef get_image_series(container):\n    image_series_containers = dict()\n    for name, ob in container.items():\n        if isinstance(ob, pynwb.image.ImageSeries) and ob.external_file is not None:\n            image_series_containers[name] = ob\n    return image_series_containers\n\n\n# main script:\n# 1. Create teh nwb files:\nfor i in [0,2,4]:\n    create_nwb('dandi_video_test', i)\n\n# 2. Organize:\nfor nwb_path in Path(video_base_path).glob('**/*.nwb'):\n    with NWBHDF5IO(str(nwb_path), mode='r+', load_namespaces=True) as io:\n        nwbfile = io.read()\n        nwbfile_containers = [nwbfile.acquisition, nwbfile.processing]\n        for data_interface in nwbfile_containers:\n            for name, image_series in get_image_series(data_interface).items():\n                if image_series.external_file[0].split('.')[-1] in [\"mp4\", \"tif\"]:\n                    dandi_organize(image_series, symlink=False)\n        io.write(nwbfile)\n\n\n```\n\nEssentially it performs 2 functions:\n1. Renames the video files and places them in a sub-folder with the same name as the nwbfile. Its renames the file with the uuid of the parent `ImageSeries` container + 'external_file_\u003cvideo_no\u003e.mp4 : \n    `\u003cnwbfile_name\u003e/{UUID}_external_file_0.mp4`\n2. Updates the `external_file` arg in all the nwb files.","files":null},{"type":6,"author":{"id":"83fae958856b684c15b81b726620f7b946f24143"},"timestamp":1636777974,"metadata":{"github-id":"UCE_lALODBZtRc45jVNjzh7soKw"},"target":"e007032371b4101d2906b3dbc79c2ad2ecee83c94a2ba24a325fe7135a6e8da4","message":"As an example, I have created a script that takes in a folder containing nwb files and accompanying video files (linked with `external_file` tag in the `ImageSeries` container. \n[Here is an example folder](https://drive.google.com/drive/folders/1jnyU7iY-kbAhjWWYATJ8RmKiP0Uk2ifN?usp=sharing) that contains 6 video files (mp4). And [here is the output](https://drive.google.com/drive/folders/13gfzopQYi2CIPv4xyhsMWqAtcUBJBsZv?usp=sharing) with the created nwbfiles (with changed `external_file` arg)\n\n**Step 1: create the nwb files with video files as external args:**\n```python\nimport shutil\n\nimport pynwb.image\nfrom pynwb import NWBHDF5IO, NWBFile\nfrom pathlib import Path\n\n\n## create the nwbfiles:\nfrom datetime import datetime\n\nfrom dateutil.tz import tzlocal\nfrom pynwb.device import Device\nfrom pynwb.file import Subject\nfrom pynwb.ophys import ImageSeries\n\ndown_loc = '/Users/sakshamsharda/Downloads' #path to browser downloads folder\n\nvideo_base_path = Path(down_loc)/\"dandi_video\"/\"video_files\" # after unzipping gdrive downloaded file\ndandi_base_path = video_base_path.parent/\"DANDI\"/\"000999\"\n\n\ndef create_nwb(name, no):\n    subject_id = f'mouse{no}'\n    session_id=f'sessionid{no}'\n    subject = Subject(subject_id=subject_id, species=\"Mus musculus\", sex=\"M\",\n                      description='lab mouse ')\n    device = Device(f'imaging_device_{no}')\n    nwbfile = NWBFile(f'{name}{no}', 'desc: contains movie for dandi .mp4 storage as external',\n                      datetime.now(tzlocal()),\n                      experimenter='Dr. Bilbo Baggins',\n                      session_id=session_id,\n                      subject=subject,\n                      devices=[device])\n\n    image_series = ImageSeries(name=f'MouseWhiskers{no}',\n                               format='external',\n                               external_file=[str(video_base_path/fr\"video{no}.mp4\"),\n                                              str(video_base_path/fr\"video{no+1}.mp4\")],\n                               starting_frame=[0], starting_time=0.0, rate=150.0)\n    nwbfile.add_acquisition(image_series)\n    nwbfile_path = video_base_path/f'{name}_{no}.nwb'\n    with NWBHDF5IO(str(nwbfile_path), 'w') as io:\n        io.write(nwbfile)\n\n## organize:\n\ndef dandi_organize(nwb_object, symlink=True):\n    \"\"\"\n    1. Renames the file_name based on the defined naming method\n    2. Creates a symlink (with the same name) to the actual file on disk\n    \"\"\"\n    nwbfile = nwb_object.parent\n    subject_id = nwbfile.subject.subject_id\n    session_id = nwbfile.session_id\n\n    #create nwb symlinks:\n    dandi_nwb_base = dandi_base_path/f'sub-{subject_id}'\n    dandi_nwb_base.mkdir(parents=True, exist_ok=True)\n    dandi_nwb_name = dandi_nwb_base/f'sub-{subject_id}_ses-{session_id}_image.nwb'\n    if symlink:\n        dandi_nwb_name.symlink_to(Path(nwb_object.container_source))\n    else:\n        shutil.copy(nwb_object.container_source, dandi_nwb_name)\n        io = NWBHDF5IO(str(dandi_nwb_name), mode='r+', load_namespaces=True)\n        nwbfile = io.read()\n        nwb_object = [i for i in nwbfile.children if i.name==nwb_object.name][0]\n\n    new_video_path = dandi_nwb_base/dandi_nwb_name.stem\n    new_video_path.mkdir(parents=True, exist_ok=True)\n        \n    for idx, ext_file in enumerate(nwb_object.external_file):\n        video_name = new_video_path/Path(f'{nwb_object.object_id}_external_file_{idx}.{ext_file.split(\".\")[-1]}')\n        if symlink:\n            video_name.symlink_to(Path(ext_file))\n        else:\n            shutil.copy(ext_file, video_name)\n        nwb_object.external_file[idx] = video_name\n\n\ndef get_image_series(container):\n    image_series_containers = dict()\n    for name, ob in container.items():\n        if isinstance(ob, pynwb.image.ImageSeries) and ob.external_file is not None:\n            image_series_containers[name] = ob\n    return image_series_containers\n\n\n# main script:\n# 1. Create teh nwb files:\nfor i in [0,2,4]:\n    create_nwb('dandi_video_test', i)\n\n# 2. Organize:\nfor nwb_path in Path(video_base_path).glob('**/*.nwb'):\n    with NWBHDF5IO(str(nwb_path), mode='r+', load_namespaces=True) as io:\n        nwbfile = io.read()\n        nwbfile_containers = [nwbfile.acquisition, nwbfile.processing]\n        for data_interface in nwbfile_containers:\n            for name, image_series in get_image_series(data_interface).items():\n                if image_series.external_file[0].split('.')[-1] == \"mp4\":\n                    dandi_organize(image_series, symlink=False)\n        io.write(nwbfile)\n\n\n```\n\nEssentially it performs 2 functions:\n1. Renames the video files and places them in a sub-folder with the same name as the nwbfile. Its renames the file with the uuid of the parent `ImageSeries` container + 'external_file_\u003cvideo_no\u003e.mp4 : \n    `\u003cnwbfile_name\u003e/{UUID}_external_file_0.mp4`\n2. Updates the `external_file` arg in all the nwb files.","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1636572985,"metadata":{"github-id":"IC_kwDODBZtRc45jwyd","github-url":"https://github.com/dandi/dandi-cli/issues/785#issuecomment-965676189"},"message":"If you need to go multiple levels deep in a relative path, replace \"/\" with \"__\"","files":null},{"type":3,"author":{"id":"83fae958856b684c15b81b726620f7b946f24143"},"timestamp":1636771172,"metadata":{"github-id":"IC_kwDODBZtRc45ru-n","github-url":"https://github.com/dandi/dandi-cli/issues/785#issuecomment-967765927"},"message":"\u003e If you need to go multiple levels deep in a relative path, replace \"/\" with \"__\"\n\nyes I agree, using double underscores is a better separator. \n\nHowever, currently, the way the files are named do not require separators in the name: `\u003cobjectUUID\u003e_external_file_\u003cno\u003e.mp4` is how the video file is renamed; its placed in a folder with the same name as the parent nwbfile and location is next to the nwbfile.","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1636772698,"metadata":{"github-id":"IC_kwDODBZtRc45rvt_","github-url":"https://github.com/dandi/dandi-cli/issues/785#issuecomment-967768959"},"message":"Yes I was just thinking how we would support this if it came up in an\nextension\n\nOn Fri, Nov 12, 2021 at 8:39 PM Saksham Sharda ***@***.***\u003e\nwrote:\n\n\u003e If you need to go multiple levels deep in a relative path, replace \"/\"\n\u003e with \"__\"\n\u003e\n\u003e yes I agree, using double underscores is a better separator.\n\u003e\n\u003e However, currently, the way the files are named do not require separators\n\u003e in the name: \u003cobjectUUID\u003e_external_file_\u003cno\u003e.mp4 is how the video file is\n\u003e renamed; its placed in a folder with the same name as the parent nwbfile\n\u003e and location is next to the nwbfile.\n\u003e\n\u003e \n\u003e You are receiving this because you were mentioned.\n\u003e Reply to this email directly, view it on GitHub\n\u003e \u003chttps://github.com/dandi/dandi-cli/issues/785#issuecomment-967765927\u003e,\n\u003e or unsubscribe\n\u003e \u003chttps://github.com/notifications/unsubscribe-auth/AAGOEERUYULJ7MMZK4A25ZDULXFW5ANCNFSM5FMFJSBA\u003e\n\u003e .\n\u003e\n-- \nBen Dichter, PhD\nData Science Consultant\npersonal website \u003chttp://bendichter.com/\u003e","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1644334538,"metadata":{"github-id":"CE_lADODBZtRc48l41azwAAAAFnSKL_"},"status":2}]}