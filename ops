{"version":2,"ops":[{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1656435752,"metadata":{"github-id":"IC_kwDODBZtRc5FrW0G","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1168993542"},"message":"@jwodder - any thoughts on this error?\n\n@slaytonmarx - did you retry this? and does it give the same error?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1656439945,"metadata":{"github-id":"IC_kwDODBZtRc5Frnej","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1169061795"},"message":"The error message indicates that S3 didn't like that a Zarr upload request had a \"Transfer-Encoding\" header.  dandi-cli doesn't set that header, so it would have to be coming from the `requests` library.\n\n@slaytonmarx What version of `requests` do you have installed in your dandi-cli environment?","files":null},{"type":3,"author":{"id":"adccd23cf679e6fb55b1c23d1d08cb100dec6f4e"},"timestamp":1656443022,"metadata":{"github-id":"IC_kwDODBZtRc5Frz8G","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1169112838"},"message":"Let me check on the version! Thank you!","files":null},{"type":3,"author":{"id":"adccd23cf679e6fb55b1c23d1d08cb100dec6f4e"},"timestamp":1656443718,"metadata":{"github-id":"IC_kwDODBZtRc5Fr2n5","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1169123833"},"message":"Apologies, I'm not entirely familiar with conda environments. How would I check the version of a specific module within the dandi-cli environment? I can say that my dandi/dandi-cli is out of date though, I'm still using 40.1, let me upgrade to 41.0 and rerun the command.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1656443787,"metadata":{"github-id":"IC_kwDODBZtRc5Fr24d","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1169124893"},"message":"@slaytonmarx While the environment is active, just run `python -m pip show requests`.","files":null},{"type":3,"author":{"id":"adccd23cf679e6fb55b1c23d1d08cb100dec6f4e"},"timestamp":1656444566,"metadata":{"github-id":"IC_kwDODBZtRc5Fr7nM","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1169144268"},"message":"My version is 2.25.1, though I did just upgrade Dandi to version 41.0 so it's possible that prior to this it was a past version","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1656445145,"metadata":{"github-id":"IC_kwDODBZtRc5Fr932","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1169153526"},"message":"@slaytonmarx For the record, requests 2.25.1 was released in December 2020; the latest version (released earlier this month) is 2.28.0.  I'm looking to see if any changes since 2.25.1 would explain the error, but I'm not seeing anything at the moment.  Regardless, try upgrading requests and uploading again.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1656445659,"metadata":{"github-id":"IC_kwDODBZtRc5Fr_31","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1169161717"},"message":"@slaytonmarx Actually, now that I really look at the logs and see that the Zarr upload progressed quite a bit before erroring, I'm really not sure what was different about that one failed request.  Is the `0/0/0/9/4/35` file in your Zarr special in some way?  Is it on a flakey NFS system?","files":null},{"type":3,"author":{"id":"adccd23cf679e6fb55b1c23d1d08cb100dec6f4e"},"timestamp":1656447723,"metadata":{"github-id":"IC_kwDODBZtRc5FsH3s","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1169194476"},"message":"Everything is stored in the same FS, though it is our most highly access one. Let me see if that one file is suspicious","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1656539186,"metadata":{"github-id":"IC_kwDODBZtRc5FxMZC","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1170523714"},"message":"@slaytonmarx please update us on the situation, and either upgrade of requests helped.  If not -- we need to figure out what is so special about that file if it errors only on that file specifically.  `ls -l 0/0/0/9/4/35` , `file --mime-type 0/0/0/9/4/35` might be first steps for that, or we might need to gain access to that file -- what would be the path on `levi**sensored**lab.mit.ed` if that is where it is stored?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1657113423,"metadata":{"github-id":"IC_kwDODBZtRc5GG42j","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1176210851"},"message":"ping @slaytonmarx on this issue.  if it is gone, I guess we would close.","files":null},{"type":3,"author":{"id":"adccd23cf679e6fb55b1c23d1d08cb100dec6f4e"},"timestamp":1657125626,"metadata":{"github-id":"IC_kwDODBZtRc5GHxMB","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1176441601"},"message":"Opening this issue up again. \n\nhttps://drive.google.com/file/d/1xaQ1Apnj3ltN0AnpUY-5TTxqiJ-cLjHp/view?usp=sharing\n\nI've investigated `0/0/0/9/4/35` as well as the other \"problem files\" in the above log but they don't seem to have anything out of the ordinary with them compared to other files. Permissions are all the same, file structure seems to be the same, file size is roughly similar to those around it. Here's the output of file --mime-type for a problem file and one that uploaded without issue:\n\n**Problem File**\n```\nsmarx@rodan:~$ file --mime-type /mnt/beegfs/Lee/dandi/sub-MITU01/ses-20220326h13m51s50/micr/sub-MITU01_ses-20220326h13m51s50_sample-10_stain-NN_run-1_chunk-3_SPIM.ome.zarr/0/0/0/14/3/45\n/mnt/beegfs/Lee/dandi/sub-MITU01/ses-20220326h13m51s50/micr/sub-MITU01_ses-20220326h13m51s50_sample-10_stain-NN_run-1_chunk-3_SPIM.ome.zarr/0/0/0/14/3/45: application/octet-stream\n```\n\n**Safe File**\n```\nsmarx@rodan:~$ file --mime-type /mnt/beegfs/Lee/dandi/sub-MITU01/ses-20220326h13m51s50/micr/sub-MITU01_ses-20220326h13m51s50_sample-10_stain-NN_run-1_chunk-3_SPIM.ome.zarr/0/0/0/14/3/44\n/mnt/beegfs/Lee/dandi/sub-MITU01/ses-20220326h13m51s50/micr/sub-MITU01_ses-20220326h13m51s50_sample-10_stain-NN_run-1_chunk-3_SPIM.ome.zarr/0/0/0/14/3/44: application/octet-stream\n```","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1657126024,"metadata":{"github-id":"IC_kwDODBZtRc5GHyoe","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1176447518"},"message":"For the record, based on a brief look at `requests`'s code, it appears that `requests` only sends a \"Transfer-Encoding\" (with value \"chunked\") when it's unable to determine the size of the request payload.  For Zarr entry uploads, the payload is just a file object, so `requests` should get the size from the underlying file object on the filesystem, and only if that fails should it use chunked encoding.  The only reason I can think of as to why getting the file size should fail would be due to some sort of filesystem hiccup.\n\n@slaytonmarx Exactly what kind of filesystem is the file on?  NFS?","files":null},{"type":3,"author":{"id":"adccd23cf679e6fb55b1c23d1d08cb100dec6f4e"},"timestamp":1657128107,"metadata":{"github-id":"IC_kwDODBZtRc5GH7_n","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1176485863"},"message":"It's NFS, though the data itself is stored on a Beegfs data cluster. Maybe I could attempt to upload the same .zarr twice to see if it's consistently failing on the same file, or if it's more or less random?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1657128919,"metadata":{"github-id":"IC_kwDODBZtRc5GH_AX","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1176498199"},"message":"good idea to redo upload and see if hiccups the same way. Also, if I get it right, might be worth doing the same upload then from leviathan which has the same path mounted as well. \n\nPS you mention it is NFS but looking at mount of /mnt/beegfs it seems beegfs directly, although I don't know much about beegfs to say that it is not NFS somehow under that.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1657131550,"metadata":{"github-id":"IC_kwDODBZtRc5GIH0T","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1176534291"},"message":"If @slaytonmarx confirms that it is due to some flaky performance from filesystem, we @jwodder might need then to catch/retry a few times on this specific error being reported from requests.","files":null},{"type":3,"author":{"id":"adccd23cf679e6fb55b1c23d1d08cb100dec6f4e"},"timestamp":1657132465,"metadata":{"github-id":"IC_kwDODBZtRc5GIKxF","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1176546373"},"message":"Re-running `sub-MITU01_ses-20220326h13m51s50_sample-10_stain-NN_run-1_chunk-3_SPIM.ome.zarr` from leviathan this time. Earlier we got the header error almost immediately but this seems to be mulling things over. Will give updates as it goes. For a sanity check, last time this file failed when attempting to upload `/0/0/0/14/3/45`, so if it's a different file it may just be network FS shenanigans.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1657135566,"metadata":{"github-id":"IC_kwDODBZtRc5GIWYm","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1176593958"},"message":"\u003e  Earlier we got the header error almost immediately but this seems to be mulling things over. \n\nprobably because in the previous run it did upload many other files to that `.zarr/` folder and now needs to get information on them and compare to what it finds locally -- so more work to be done ;)\n\n\u003e ... if it's a different file it may just be network FS shenanigans.\n\nyeah, might as well be, especially since this particular one is exotic (not used too widely) enough and did show some *interesting* behaviors in the past, such as https://git-annex.branchable.com/bugs/beegfs__58___init_tests_FAIL_resource_busy/ .","files":null},{"type":3,"author":{"id":"adccd23cf679e6fb55b1c23d1d08cb100dec6f4e"},"timestamp":1657137687,"metadata":{"github-id":"IC_kwDODBZtRc5GIjeB","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1176647553"},"message":"We've unfortunately run into the \"Zarr Archive Already Ingested\" bug for the second run. I thought we fixed this issue with 0.42.0. Triple checked the version and we're definitely on 0.43.0.\n\n[20220706183202Z-2424966.log](https://github.com/dandi/dandi-cli/files/9057696/20220706183202Z-2424966.log)","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1657138064,"metadata":{"github-id":"IC_kwDODBZtRc5GIlmB","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1176656257"},"message":"@slaytonmarx v0.42.0 addressed the \"Zarr already exists\" error.  \"Zarr archive already ingested\" is a different error that should be addressed by #1047.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1657139521,"metadata":{"github-id":"IC_kwDODBZtRc5GIu4k","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1176694308"},"message":"@slaytonmarx \"Zarr Archive Already Ingested\" is overall benign, so please just ignore it for now - I didn't even bother releasing for that reason. Let's catch more of nasty bugs meanwhile ;-)","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1657297849,"metadata":{"github-id":"CE_lADODBZtRc5MvzAtzwAAAAGe7tkw"},"status":2},{"type":3,"author":{"id":"7a8552494914d3e4116f4b434eb4812a914ca405"},"timestamp":1657297919,"metadata":{"github-id":"IC_kwDODBZtRc5GSMC4","github-url":"https://github.com/dandi/dandi-cli/issues/1033#issuecomment-1179173048"},"message":"\u003c!-- GITHUB_RELEASE COMMENT: released --\u003e\n:rocket: Issue was released in [`0.44.1`](https://github.com/dandi/dandi-cli/releases/tag/0.44.1) :rocket:","files":null},{"type":5,"author":{"id":"7a8552494914d3e4116f4b434eb4812a914ca405"},"timestamp":1657297921,"metadata":{"github-id":"LE_lADODBZtRc5MvzAtzwAAAAGe7vJR"},"added":["released"],"removed":[]},{"type":5,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1716419974,"metadata":{"github-id":"LE_lADODBZtRc5MvzAtzwAAAAMA_psJ"},"added":["HIFNI"],"removed":[]}]}