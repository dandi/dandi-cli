{"version":2,"ops":[{"type":1,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1708116656,"metadata":{"github-id":"I_kwDODBZtRc5_hYFP","github-url":"https://github.com/dandi/dandi-cli/issues/1408","origin":"github"},"title":"zarr re-upload might still be suffering from \"A header you provided implies functionality that is not implemented\"","message":"I was trying to produce 2nd version of a sample zarr under https://dandiarchive.org/dandiset/000029/draft/files?location=sub-randomzarrlike\u0026page=1 \nhttps://dandi.centerforopenneuroscience.org/zarrs/fd6/ab3/fd6ab3ea-cff6-4006-a9bf-acfa5d983985/\nwhich is also freshly created https://github.com/dandizarrs/fd6ab3ea-cff6-4006-a9bf-acfa5d983985/ . \n\nWas created using `python3 mktree.py /home/yoh/proj/dandi/dandisets/000029/sub-randomzarrlike/sub-randomzarrlike_junk.zarr layouts/zarr128-smallfiles.json` and now \"modified\" using `python3 mktree.py /home/yoh/proj/dandi/dandisets/000029/sub-randomzarrlike/sub-randomzarrlike_junk.zarr layouts/zarr64-smallfiles.json` (after `rm -rf`  prior existing subfolders) so that checksum went from `af1b4b5849cd2b79a29762d716863379-37480--38379520` to `422bd4b0fa7a06d2655d3c1f67fd4a6f-263522--269846528`.\n\nDuring re-upload screen was showing\n\n```shell\n❯ dandi upload --validation ignore -J 5:200 ./sub-randomzarrlike_junk.zarr\n2024-02-16 15:16:27,754 [    INFO] Found 2 files to consider\nPATH                                            SIZE       ERRORS     UPLOAD STATUS                MESSAGE                  \ndandiset.yaml                                   3.0 kB                       skipped               should be edited online  \nsub-randomzarrlike/sub-randomzarrlike_junk.zarr               1              producing asset       exists - reuploading     \n```\n\nand that \"producing asset\" made me worry since AFAIK we should have just modified existing zarr, not generate a new one... but it talks about \"asset\", not \"zarr\", so hope remained... \n\nThen dandi CLI was showing no progress or anything with 100% CPU in comparing against remote Zarr   exists - reuploading state for a few minutes but then upload commenced.  I have used `-J 5:200` which resulted in dandi CLI somehow taking over 400% CPU according to top...  I decided to look into the log file (on my laptop) `20240216201625Z-3182147.log` and saw those errors search for which brought me to \n- #1048 \nbut it seems that we might be getting them also not quite handled since errors seems to bubble up all the way to the top?\n\n```\n2024-02-16T15:16:25-0500 [INFO    ] dandi 3182147:140109695737920 dandi v0.59.1+2.g7ca670b9, hdmf v3.12.0, pynwb v2.5.0, h5py v3.10.0\n...\n2024-02-16T15:37:17-0500 [WARNING ] dandi 3182147:140099501135552 Will retry: Error 501 while sending PUT request to https://dandiarchive.s3.amazonaws.com/zarr/fd6ab3ea-cff6-4006-a9bf-acfa5d983985/0/0/d0/d2/d26/f1.dat?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=SENSORED240216%2Fus-east-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20240216T203627Z\u0026X-Amz-Expires=600\u0026X-Amz-SignedHeaders=content-md5%3Bhost%3Bx-amz-acl\u0026X-Amz-Signature=SENSOREDabc18760fa95f5a1d68d81b26cde2092acc8d49: \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e\n\u003cError\u003e\u003cCode\u003eNotImplemented\u003c/Code\u003e\u003cMessage\u003eA header you provided implies functionality that is not implemented\u003c/Message\u003e\u003cHeader\u003eTransfer-Encoding\u003c/Header\u003e\u003cRequestId\u003eZJ4G67HNV35TE36A\u003c/RequestId\u003e\u003cHostId\u003eepCo3E+XFJuxZoX15VXH9bHprpU36w8U9GHzrNePQWtJ3CuOq+B9xABYDDfizeojW1+KSztpXU4=\u003c/HostId\u003e\u003c/Error\u003e\n2024-02-16T15:37:29-0500 [DEBUG   ] urllib3.connectionpool 3182147:140099501135552 Resetting dropped connection: dandiarchive.s3.amazonaws.com\n2024-02-16T15:37:29-0500 [DEBUG   ] urllib3.connectionpool 3182147:140099501135552 https://dandiarchive.s3.amazonaws.com:443 \"PUT /zarr/fd6ab3ea-cff6-4006-a9bf-acfa5d983985/0/0/d0/d2/d26/f1.dat?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=SENSORED240216%2Fus-east-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20240216T203627Z\u0026X-Amz-Expires=600\u0026X-Amz-SignedHeaders=content-md5%3Bhost%3Bx-amz-acl\u0026X-Amz-Signature=SENSOREDabc18760fa95f5a1d68d81b26cde2092acc8d49 HTTP/1.1\" 501 None\n2024-02-16T15:37:29-0500 [DEBUG   ] charset_normalizer 3182147:140099501135552 Encoding detection: utf_8 is most likely the one.\n2024-02-16T15:37:29-0500 [DEBUG   ] charset_normalizer 3182147:140099501135552 Encoding detection: utf_8 is most likely the one.\n2024-02-16T15:37:29-0500 [ERROR   ] dandi 3182147:140099501135552 HTTP request failed repeatedly: Error 501 while sending PUT request to https://dandiarchive.s3.amazonaws.com/zarr/fd6ab3ea-cff6-4006-a9bf-acfa5d983985/0/0/d0/d2/d26/f1.dat?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=SENSORED240216%2Fus-east-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20240216T203627Z\u0026X-Amz-Expires=600\u0026X-Amz-SignedHeaders=content-md5%3Bhost%3Bx-amz-acl\u0026X-Amz-Signature=SENSOREDabc18760fa95f5a1d68d81b26cde2092acc8d49: \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e\n\u003cError\u003e\u003cCode\u003eNotImplemented\u003c/Code\u003e\u003cMessage\u003eA header you provided implies functionality that is not implemented\u003c/Message\u003e\u003cHeader\u003eTransfer-Encoding\u003c/Header\u003e\u003cRequestId\u003eTMYXYY9Z0KK9MPP8\u003c/RequestId\u003e\u003cHostId\u003eTE19VW1d0HD+zXm8jUdRWkcpfi0UnUkOK8ml04mZGUo+t375JtA3ZzcX2xFdDLZWiuFDDxRPSME=\u003c/HostId\u003e\u003c/Error\u003e\n2024-02-16T15:37:29-0500 [DEBUG   ] dandi 3182147:140107868591808 Error uploading zarr: HTTPError: 501 Server Error: Not Implemented for url: https://dandiarchive.s3.amazonaws.com/zarr/fd6ab3ea-cff6-4006-a9bf-acfa5d983985/0/0/d0/d2/d26/f1.dat?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=SENSORED240216%2Fus-east-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20240216T203627Z\u0026X-Amz-Expires=600\u0026X-Amz-SignedHeaders=content-md5%3Bhost%3Bx-amz-acl\u0026X-Amz-Signature=SENSOREDabc18760fa95f5a1d68d81b26cde2092acc8d49\n2024-02-16T15:37:29-0500 [DEBUG   ] dandi 3182147:140107868591808 Cancelling upload\n2024-02-16T15:37:29-0500 [ERROR   ] dandi 3182147:140107868591808 Error uploading /home/yoh/proj/dandi/dandisets/000029/sub-randomzarrlike/sub-randomzarrlike_junk.zarr:\nTraceback (most recent call last):\n  File \"/home/yoh/proj/dandi/dandi-cli-master/dandi/upload.py\", line 357, in process_path\n    for r in dfile.iter_upload(\n  File \"/home/yoh/proj/dandi/dandi-cli-master/dandi/files/zarr.py\", line 486, in iter_upload\n    size = fut.result()\n           ^^^^^^^^^^^^\n  File \"/usr/lib/python3.11/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ^^^^^^^^^^^^^^^^^^^\n  File \"/usr/lib/python3.11/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/usr/lib/python3.11/concurrent/futures/thread.py\", line 58, in run\n    result = self.fn(*self.args, **self.kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/yoh/proj/dandi/dandi-cli-master/dandi/files/zarr.py\", line 561, in _upload_zarr_file\n    storage_session.put(\n  File \"/home/yoh/proj/dandi/dandi-cli-master/dandi/dandiapi.py\", line 315, in put\n    return self.request(\"PUT\", path, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/yoh/proj/dandi/dandi-cli-master/dandi/dandiapi.py\", line 199, in request\n    for i, attempt in enumerate(\n  File \"/home/yoh/proj/dandi/dandi-cli-master/venvs/dev3.11/lib/python3.11/site-packages/tenacity/__init__.py\", line 347, in __iter__\n    do = self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/yoh/proj/dandi/dandi-cli-master/venvs/dev3.11/lib/python3.11/site-packages/tenacity/__init__.py\", line 325, in iter\n    raise retry_exc.reraise()\n          ^^^^^^^^^^^^^^^^^^^\n  File \"/home/yoh/proj/dandi/dandi-cli-master/venvs/dev3.11/lib/python3.11/site-packages/tenacity/__init__.py\", line 158, in reraise\n    raise self.last_attempt.result()\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/lib/python3.11/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ^^^^^^^^^^^^^^^^^^^\n  File \"/usr/lib/python3.11/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/home/yoh/proj/dandi/dandi-cli-master/dandi/dandiapi.py\", line 235, in request\n    result.raise_for_status()\n  File \"/home/yoh/proj/dandi/dandi-cli-master/venvs/dev3.11/lib/python3.11/site-packages/requests/models.py\", line 1021, in raise_for_status\n    raise HTTPError(http_error_msg, response=self)\nrequests.exceptions.HTTPError: 501 Server Error: Not Implemented for url: https://dandiarchive.s3.amazonaws.com/zarr/fd6ab3ea-cff6-4006-a9bf-acfa5d983985/0/0/d0/d2/d26/f1.dat?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=SENSORED240216%2Fus-east-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20240216T203627Z\u0026X-Amz-Expires=600\u0026X-Amz-SignedHeaders=content-md5%3Bhost%3Bx-amz-acl\u0026X-Amz-Signature=SENSOREDabc18760fa95f5a1d68d81b26cde2092acc8d49\n```\n\nupload did after all fail with\n\n```shell\n❯ dandi upload --validation ignore -J 5:200 ./sub-randomzarrlike_junk.zarr\n2024-02-16 15:16:27,754 [    INFO] Found 2 files to consider\nPATH                                            SIZE        ERRORS          UPLOAD STATUS                          MESSAGE                                                                                                                                         \ndandiset.yaml                                   3.0 kB                             skipped                         should be edited online                                                                                                                         \nsub-randomzarrlike/sub-randomzarrlike_junk.zarr 269.8 MB       1               19% ERROR                           501 Server Error: Not Implemented for url: https://dandiarchive.s3.amazonaws.com/zarr/fd6ab3ea-cff6-4006-a9bf-acfa5d983985/0/0/d0/d2/d26/f1.d...\nSummary:                                        269.8 MB 1 with errors   42.0 kB/s 1 skipped                       1 should be edited online                                                                                                                       \n                                                                                   1 ERROR                         1 501 Server Error: Not Implemented for url: https://dandiarchive.s3.amazonaws.com/zarr/fd6ab3ea-cff6-4006-a9bf-acfa5d983985/0/0/d0/d2/d26/f1...\n2024-02-16 15:37:30,390 [    INFO] Logs saved in /home/yoh/.local/state/dandi-cli/log/20240216201625Z-3182147.log\nError: 501 Server Error: Not Implemented for url: https://dandiarchive.s3.amazonaws.com/zarr/fd6ab3ea-cff6-4006-a9bf-acfa5d983985/0/0/d0/d2/d26/f1.dat?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAUBRWC5GAEKH3223E%2F20240216%2Fus-east-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20240216T203627Z\u0026X-Amz-Expires=600\u0026X-Amz-SignedHeaders=content-md5%3Bhost%3Bx-amz-acl\u0026X-Amz-Signature=249ff2f8f4a98480a09b11160abc18760fa95f5a1d68d81b26cde2092acc8d49\n```","files":null}]}