{"version":2,"ops":[{"type":3,"author":{"id":"1d7d442aa1925df5e89cbf71d597eb72205cfee1"},"timestamp":1665171968,"metadata":{"github-id":"IC_kwDODBZtRc5L742L","github-url":"https://github.com/dandi/dandi-cli/issues/1134#issuecomment-1273990539"},"message":"I'd like to know a bit more about what's going on. Naively, I would think something like [s3fs](https://github.com/s3fs-fuse/s3fs-fuse) could be used to mount the bucket path on the user's system. What's preventing a simple solution like that?","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1665206879,"metadata":{"github-id":"IC_kwDODBZtRc5L742O","github-url":"https://github.com/dandi/dandi-cli/issues/1134#issuecomment-1273990542"},"message":"we want to do this programmatically as we do with any other asset. this specific question is about an embargoed asset and using fsspec so we can stream. a regular asset can be streamed as shown here: https://pynwb.readthedocs.io/en/stable/tutorials/advanced_io/streaming.html#streaming-method-2-fsspec","files":null},{"type":3,"author":{"id":"1d7d442aa1925df5e89cbf71d597eb72205cfee1"},"timestamp":1665419335,"metadata":{"github-id":"IC_kwDODBZtRc5L742Q","github-url":"https://github.com/dandi/dandi-cli/issues/1134#issuecomment-1273990544"},"message":"Is the problem that a script like that will run into permission problems? What's the exact error you get when attempting to use an approach like that on an embargoed asset?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1665420897,"metadata":{"github-id":"IC_kwDODBZtRc5L742R","github-url":"https://github.com/dandi/dandi-cli/issues/1134#issuecomment-1273990545"},"message":"@satra sorry for the delay: without looking deeper \n- @satra did you look into providing the minted http URL pointing to embargoed asset which would include all needed auth detail?\n- @waxlamp @satra - do we have some \"test embargoed\" dandiset on the main instance similar to 000029 to \"play with\"?","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1665422440,"metadata":{"github-id":"IC_kwDODBZtRc5L742U","github-url":"https://github.com/dandi/dandi-cli/issues/1134#issuecomment-1273990548"},"message":"@yarikoptic - there is no way to receive the minted url using the API that i could find.\n\n- a head request against the `/download` endpoint of the asset returns a 403 when asked to follow redirects\n- a get request succeeds but returns all the bytes (i don't need that).\n\nthere is no embargoed dandiset, but we should create one.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1665429625,"metadata":{"github-id":"IC_kwDODBZtRc5L742X","github-url":"https://github.com/dandi/dandi-cli/issues/1134#issuecomment-1273990551"},"message":"\u003e @yarikoptic - there is no way to receive the minted url using the API that i could find.\n\u003e * a head request against the `/download` endpoint of the asset returns a 403 when asked to follow redirects\n\nif `fsspec` uses that one then we might be out of luck.  I was thinking that if we forget about local caching (since would need direct urls to S3, and thus provision somehow giving user some temp credentials to access that url, unlikely anything to work out) we could at least get range requests working:\n\n\u003e * a get request succeeds but returns all the bytes (i don't need that).\n\nwhat would happen if you give Range: there?  FWIW -- created https://dandiarchive.org/dandiset/000344 on which could be tried. Added everyone (if not forgot) to owners.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1665438605,"metadata":{"github-id":"IC_kwDODBZtRc5L742a","github-url":"https://github.com/dandi/dandi-cli/issues/1134#issuecomment-1273990554"},"message":"i think i found a way to get the signed url (direct calling the rest api instead of using the dandi library). i'm going to try it after dinner.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1665453814,"metadata":{"github-id":"IC_kwDODBZtRc5L742b","github-url":"https://github.com/dandi/dandi-cli/issues/1134#issuecomment-1273990555"},"message":"i was able to make this work. will transfer this issue to CLI. the key is that i had to get the signed url through reading the headers of a requests response.\n\n```\nfrom getpass import getpass\ntoken = getpass(\"Enter API key: \")\n\napi = DandiAPIClient(token=token)\nds = api.get_dandiset(\u003cid\u003e)\nasset = ds.get_asset(\u003cid\u003e)\n\nasset.base_download_url\nres = asset.client.session.head(asset.base_download_url)\ns3_url = res.headers['Location']\n\nimport fsspec\nimport pynwb\nimport h5py\nfrom fsspec.implementations.cached import CachingFileSystem\n\nfs = CachingFileSystem(\n    fs=fsspec.filesystem(\"http\"),\n    cache_storage=\"nwb-cache\",  # Local folder for the cache\n)\nwith fs.open(s3_url, \"rb\") as f:\n    with h5py.File(f) as file:\n        with pynwb.NWBHDF5IO(file=file, load_namespaces=True) as io:\n            nwbfile = io.read()\n            print(nwbfile.acquisition)\n```","files":null},{"type":6,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1665455225,"metadata":{"github-id":"UCE_lALODBZtRc5L742bzig1i9c"},"target":"dd2824e9afded71bed9ae94bb6b1482703b133aa3a265fe02a1201579364fb80","message":"i was able to make this work. will transfer this issue to CLI. the key is that i had to get the signed url through reading the headers of a requests response.\n\n```python\nfrom getpass import getpass\ntoken = getpass(\"Enter API key: \")\n\napi = DandiAPIClient(token=token)\nds = api.get_dandiset(\u003cid\u003e)\nasset = ds.get_asset(\u003cid\u003e)\n\nasset.base_download_url\nres = asset.client.session.head(asset.base_download_url)\ns3_url = res.headers['Location']\n\nimport fsspec\nimport pynwb\nimport h5py\nfrom fsspec.implementations.cached import CachingFileSystem\n\nfs = CachingFileSystem(\n    fs=fsspec.filesystem(\"http\"),\n    cache_storage=\"nwb-cache\",  # Local folder for the cache\n)\nwith fs.open(s3_url, \"rb\") as f:\n    with h5py.File(f) as file:\n        with pynwb.NWBHDF5IO(file=file, load_namespaces=True) as io:\n            nwbfile = io.read()\n            print(nwbfile.acquisition)\n```","files":null},{"type":2,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1665453862,"metadata":{"github-id":"RTE_lADODBZtRc5TrcLezwAAAAHCgSCx"},"title":"add support for signed url location to access embargoed data with fsspec","was":"add support for signed url location to access embargoed data with fsspec"},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1665687335,"metadata":{"github-id":"IC_kwDODBZtRc5MLW9y","github-url":"https://github.com/dandi/dandi-cli/issues/1134#issuecomment-1278046066"},"message":"no need for header access etc, should work, and seems to work for me to get that download url as shown on https://pynwb.readthedocs.io/en/stable/tutorials/advanced_io/streaming.html#getting-the-location-of-the-file-on-dandi via `asset.get_content_url(follow_redirects=1, strip_query=True)`:\n\n```\n❯ cat embargo_url.py\nfrom dandi.dandiapi import DandiAPIClient\nimport sys\ndandiset_id = sys.argv[1] or '000006'  # ephys dataset from the Svoboda Lab\nfilepath = sys.argv[2] or 'sub-anm372795/sub-anm372795_ses-20170718.nwb'  # 450 kB file\nwith DandiAPIClient() as client:\n    client.dandi_authenticate()\n    asset = client.get_dandiset(dandiset_id, 'draft').get_asset_by_path(filepath)\n    s3_url = asset.get_content_url(follow_redirects=1, strip_query=True)\n    print(f\"{dandiset_id}/{filepath} has {s3_url}\")\n❯ python embargo_url.py '000344' 'sub-private/sub-private.dat'\n000344/sub-private/sub-private.dat has https://dandiarchive-embargo.s3.amazonaws.com/000344/blobs/127/efb/127efb7b-4261-4f91-80f3-43ba23f3f9f1\n```\nit was important though to authenticate via ` client.dandi_authenticate()` since if I don't do - kaboom with 401. Filed https://github.com/dandi/dandi-cli/issues/1137 for that but agreed with @jwodder that for library mode we might not want to do magic/prompts here.\n\nWhat would also be needed to adjust also in those docs for embargoed dandisets to not do `strip_query=True` since it carries all needed auth args. And then we come to the next aspect:  as far as I see it caching would not work properly then since it would use the entire URL as the cache key. Asked https://github.com/fsspec/filesystem_spec/issues/1073 on the best course of action for that aspect.\n\nAfter we figure out both aspects, we should adjust docs.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1665687567,"metadata":{"github-id":"IC_kwDODBZtRc5MLYBs","github-url":"https://github.com/dandi/dandi-cli/issues/1134#issuecomment-1278050412"},"message":"@yarikoptic - take a look at the code above and try to get the bytes partially (as with s3fs). the existing content urls will not allow you to map via s3fs. in the client it retrieves the entire byte stream from the download endpoint.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1665687712,"metadata":{"github-id":"IC_kwDODBZtRc5MLYqQ","github-url":"https://github.com/dandi/dandi-cli/issues/1134#issuecomment-1278053008"},"message":"@yarikoptic - it's more about streaming not caching. i just used the same example as the pynwb docs which uses caching.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1665688429,"metadata":{"github-id":"IC_kwDODBZtRc5MLb1t","github-url":"https://github.com/dandi/dandi-cli/issues/1134#issuecomment-1278066029"},"message":"@satra please give full example on what you want to achieve and/or how it doesn't work since I did try to get bytes partially and it worked for me on embargoed dandiset.  Here is a more complete example you can tune up:\n\n```python\nfrom dandi.dandiapi import DandiAPIClient\nimport fsspec\nimport pynwb\nimport h5py\nfrom fsspec.implementations.cached import CachingFileSystem\nimport sys\nimport re\n\ndandiset_id = '000344' # (len(sys.argv) \u003e 1 and sys.argv[1]) or '000006'  # ephys dataset from the Svoboda Lab\nfilepath = 'sub-private/sub-private.dat'  # (len(sys.argv) \u003e 2 and sys.argv[2]) or  'sub-anm372795/sub-anm372795_ses-20170718.nwb'  # 450 kB file\n\nwith DandiAPIClient() as client:\n    client.dandi_authenticate()\n    asset = client.get_dandiset(dandiset_id, 'draft').get_asset_by_path(filepath)\n    s3_url = asset.get_content_url(follow_redirects=1)\n    s3_url_sensored = re.sub('(X-Amz-Credential|X-Amz-Signature)=\\w*', '\\\\1=___SENSORED___', s3_url)\n    print(f\"{dandiset_id}/{filepath} has {s3_url_sensored}\")\n\nfs = CachingFileSystem(\n    fs=fsspec.filesystem(\"http\"),\n    cache_storage=\"nwb-cache\",  # Local folder for the cache\n)\nwith fs.open(s3_url, \"rb\") as f:\n    f.seek(2)\n    print(\"Read some byte \", f.read(1))\n```\n\n```\n❯ python embargo_url2_fsspec.py\n000344/sub-private/sub-private.dat has https://dandiarchive-embargo.s3.amazonaws.com/000344/blobs/127/efb/127efb7b-4261-4f91-80f3-43ba23f3f9f1?response-content-disposition=attachment%3B%20filename%3D%22sub-private.dat%22\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=___SENSORED___%2F20221013%2Fus-east-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20221013T190723Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=___SENSORED___\nRead some byte  b'r'\n```\n\nalthough I asked fsspec about stripping, I think we should just `follow_redirects=0` so we get api.dandiarchive.org URL and operate on that one.  We would just need to figure out how to authenticate https://docs.aiohttp.org  for which fsspec allows to pass via `client_kwargs` option to `HTTPFileSystem`.  Anyone @dandi/archive-maintainers @dandi/dandi-cli sees right away how to create authenticated aiohttp session?","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1665688862,"metadata":{"github-id":"IC_kwDODBZtRc5MLfLB","github-url":"https://github.com/dandi/dandi-cli/issues/1134#issuecomment-1278079681"},"message":"@yarikoptic - ok - i think i interpreted the 403 as an exception. is there a reason that is printed? \n\nso getting the signed url is there. i'll close this issue. \n\nthe download endpoint does not pass on range requests i think. i don't believe i got fsspec to work with the download endpoint.","files":null},{"type":4,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1665688862,"metadata":{"github-id":"CE_lADODBZtRc5TrcLezwAAAAHEEMMq"},"status":2},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1665695924,"metadata":{"github-id":"IC_kwDODBZtRc5ML6Bw","github-url":"https://github.com/dandi/dandi-cli/issues/1134#issuecomment-1278189680"},"message":"\u003e . is there a reason that is printed?\n\nwhat is printed? if error if it happens  -- sounds logical to me.\n\n\u003e the download endpoint does not pass on range requests i think. i don't believe i got fsspec to work with the download endpoint.\n\nI recall us trying smth but forgot detail... trying it out on a public one -- seems to work just fine!\n\n```\n❯ python public_url2_fsspec-range.py\n000003/sub-YutaMouse20/sub-YutaMouse20_ses-YutaMouse20-140321_behavior+ecephys.nwb has https://api.dandiarchive.org/api/assets/d426ff9a-bab3-446d-8104-e373ae188bd3/download/\nRead some byte  b'\\x9c'\n❯ du -sck nwb-cache/*\n5124\tnwb-cache/6044c4a6d96fafee40c79bb7fa45d2f8443648ac25e0fc461561e5aefe38fbca\n4\tnwb-cache/cache\n5128\ttotal\n❯ cat public_url2_fsspec-range.py\nfrom dandi.dandiapi import DandiAPIClient\nimport fsspec\nimport pynwb\nimport h5py\nfrom fsspec.implementations.cached import CachingFileSystem\nimport sys\nimport re\n\ndandiset_id = '000003'\nfilepath = 'sub-YutaMouse20/sub-YutaMouse20_ses-YutaMouse20-140321_behavior+ecephys.nwb'  # 11GB\n\nwith DandiAPIClient() as client:\n    client.dandi_authenticate()\n    asset = client.get_dandiset(dandiset_id, 'draft').get_asset_by_path(filepath)\n    s3_url = asset.get_content_url(follow_redirects=0)\n    print(f\"{dandiset_id}/{filepath} has {s3_url}\")\n\nfs = CachingFileSystem(\n    fs=fsspec.filesystem(\"http\"),\n    cache_storage=\"nwb-cache\",  # Local folder for the cache\n)\nwith fs.open(s3_url, \"rb\") as f:\n    f.seek(200000000)\n    print(\"Read some byte \", f.read(1))\n\n```\nso I seek deep into and then read 1 b, fetched is just 5 MB block... should have tried pynwb I guess ... so next would be to figure out aiohttp auth...\n\nMeanwhile we got answer from fsspec folks -- we can split URL away from params\n```\ns3_url_parts = s3_url.split('?', 1)\nfrom urllib.parse import unquote\nwith fs.open(s3_url_parts[0], \"rb\", params=unquote(s3_url_parts[1])) as f:\n```\n\n(just now noted that we have no versionId among them there?!) and then indeed we get clean cache with base url:\n\n```\n❯ python -c \"import json, re, pickle; print(json.dumps(eval(re.sub('(X-Amz-Credential|X-Amz-Signature)=\\w*', '\\\\1=___SENSORED___', str(pickle.load(open('nwb-cache/cache', 'rb'))))), indent=4))\"\n{\n    \"https://dandiarchive-embargo.s3.amazonaws.com/000344/blobs/127/efb/127efb7b-4261-4f91-80f3-43ba23f3f9f1\": {\n        \"original\": \"https://dandiarchive-embargo.s3.amazonaws.com/000344/blobs/127/efb/127efb7b-4261-4f91-80f3-43ba23f3f9f1\",\n        \"fn\": \"9a2b1361f9c4a3a436bdfc250c8393d7b5ae4cd651cd71de4712a38c98a7fd93\",\n        \"blocks\": true,\n        \"time\": 1665694987.767868,\n        \"uid\": \"72dddceb347a2032e194736f160891bc\",\n        \"blocksize\": 5242880\n    }\n}\n```\nso we have a way.. might indeed want to have a helper of some kind.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1665696437,"metadata":{"github-id":"IC_kwDODBZtRc5ML71B","github-url":"https://github.com/dandi/dandi-cli/issues/1134#issuecomment-1278197057"},"message":"\u003e what is printed? if error if it happens -- sounds logical to me.\n\nError 403 while sending HEAD request to https://api.dandiarchive.org/api/assets/463fc0cb-cea5-4cd9-b477-5b1747e0ccbf/download/: \n\nit just prints this, doesn't raise an exception.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1665716921,"metadata":{"github-id":"IC_kwDODBZtRc5MMwdQ","github-url":"https://github.com/dandi/dandi-cli/issues/1134#issuecomment-1278412624"},"message":"hm... again not sure what prints that and why just prints ... cut/paste code/output would have cleared it up... anyways -- seems to work this code on direct download url! try with hdf5 etc (originally posted to https://github.com/fsspec/filesystem_spec/issues/1073#issuecomment-1278203802 by mistake ;))\n\n```python\nfrom dandi.dandiapi import DandiAPIClient\nimport fsspec\nimport pynwb\nimport h5py\nfrom fsspec.implementations.cached import CachingFileSystem\nimport sys\nimport re\n\ndandiset_id = '000344' # (len(sys.argv) \u003e 1 and sys.argv[1]) or '000006'  # ephys dataset from the Svoboda Lab\nfilepath = 'sub-private/sub-private.dat'  # (len(sys.argv) \u003e 2 and sys.argv[2]) or  'sub-anm372795/sub-anm372795_ses-20170718.nwb'  # 450 kB file\n\n# TODO: make helper\nfrom dandi.keyring import keyring_lookup\nclient_name = 'dandi'\napp_id = f\"dandi-api-{client_name}\"\nkeyring_backend, api_key = keyring_lookup(app_id, \"key\")\nif not api_key:\n    raise ValueError(\"empty key\")\n# fs._session.headers.update({\"Authorization\": f\"token {api_key}\"})\n\nfs = CachingFileSystem(\n    fs=fsspec.filesystem(\"http\",\n                         client_kwargs={'headers': {\"Authorization\": f\"token {api_key}\"}}\n                         ),\n    cache_storage=\"nwb-cache\",  # Local folder for the cache\n)\n\nwith DandiAPIClient() as client:\n    client.dandi_authenticate()\n    asset = client.get_dandiset(dandiset_id, 'draft').get_asset_by_path(filepath)\n    down_url = asset.get_content_url(follow_redirects=0)\n    print(f\"{dandiset_id}/{filepath} has {down_url}\")\n\nwith fs.open(down_url, \"rb\") as f:\n    f.seek(2)\n    print(\"Read some byte \", f.read(1))\n```\n\nwith output\n\n```\n$\u003e python embargo_url4_fsspec.py        \n000344/sub-private/sub-private.dat has https://api.dandiarchive.org/api/assets/8f998a62-ac4c-465d-9989-656c90fb4668/download/\nRead some byte  b'r'\n```","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1665801816,"metadata":{"github-id":"IC_kwDODBZtRc5MRcE3","github-url":"https://github.com/dandi/dandi-cli/issues/1134#issuecomment-1279639863"},"message":"that's nice. we should document this in our handbook. can you try it on a larger file in jerome's embargoed dataset? it would also be good to know if the api will keep generating presigned url's each time a request is made or is smart enough to reuse one till it expires.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1666020557,"metadata":{"github-id":"IC_kwDODBZtRc5MW1vw","github-url":"https://github.com/dandi/dandi-cli/issues/1134#issuecomment-1281055728"},"message":"which dandiset is that? (search probably doesn't search through embargoed ATM)","files":null}]}