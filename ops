{"version":2,"ops":[{"type":6,"author":{"id":"adccd23cf679e6fb55b1c23d1d08cb100dec6f4e"},"timestamp":1656596766,"metadata":{"github-id":"UCE_lAHODBZtRc5M0hyHzjBFGyk"},"target":"b85f5b860186fbb428eb5364a541906371448249bc0faa60428d598e8e95eda8","message":"I received the below error while trying to upload a file using the following command:\n\n`DANDI_DEVEL=1 dandi upload --validation skip --allow-any-path /mnt/beegfs/Lee/dandi/sub-MITU01/ses-20220326h13m51s50/micr/sub-MITU01_ses-20220326h13m51s50_sample-10_stain-YO_run-1_chunk-4_SPIM.ome.zarr`\n\nFull log attached below.\n\n```\n2022-06-29T10:34:15-0400 [ERROR   ] dandi 715731:140277145179904 Error 400 while sending POST request to https://api.dandiarchive.org/api/zarr/: [\"Zarr already exists\"]\n2022-06-29T10:34:15-0400 [ERROR   ] dandi 715731:140277145179904 Error uploading /mnt/beegfs/Lee/dandi/sub-MITU01/ses-20220326h13m51s50/micr/sub-MITU01_ses-20220326h13m51s50_sample-10_stain-YO_run-1_chunk-4_SPIM.ome.zarr:\nTraceback (most recent call last):\n  File \"/mnt/beegfs/satra/miniconda3/envs/dandi/lib/python3.8/site-packages/dandi/upload.py\", line 232, in process_path\n    for r in dfile.iter_upload(\n  File \"/mnt/beegfs/satra/miniconda3/envs/dandi/lib/python3.8/site-packages/dandi/files.py\", line 838, in iter_upload\n    r = client.post(\n  File \"/mnt/beegfs/satra/miniconda3/envs/dandi/lib/python3.8/site-packages/dandi/dandiapi.py\", line 288, in post\n    return self.request(\"POST\", path, **kwargs)\n  File \"/mnt/beegfs/satra/miniconda3/envs/dandi/lib/python3.8/site-packages/dandi/dandiapi.py\", line 254, in request\n    raise requests.HTTPError(msg, response=result)\nrequests.exceptions.HTTPError: Error 400 while sending POST request to https://api.dandiarchive.org/api/zarr/\n2022-06-29T10:34:16-0400 [DEBUG   ] pyout.interface 715731:140277145179904 Received result for ('size', 'errors', 'upload', 'status', 'message'): {'status': 'ERROR', 'message': 'Error 400 while sending POST request to https://api.dandiarchive.org/api/zarr/'}\n\n```\n\nThe file does not already exist within the dandi archive:\n![image](https://user-images.githubusercontent.com/36866774/176465261-1beee7c7-bdba-47c4-9687-059979e58747.png)\n\nMy dandi version is 41.0\n\nFull Log:\n[20220629143352Z-715731.log](https://github.com/dandi/dandi-cli/files/9011552/20220629143352Z-715731.log)","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1656514263,"metadata":{"github-id":"IC_kwDODBZtRc5FvgcJ","github-url":"https://github.com/dandi/dandi-cli/issues/1034#issuecomment-1170081545"},"message":"I can confirm through the API that there is no Zarr in 000108 with a name of \"sub-MITU01/ses-20220326h13m51s50/micr/sub-MITU01_ses-20220326h13m51s50_sample-10_stain-YO_run-1_chunk-4_SPIM.ome.zarr\".\n\n@dandi/dandiarchive Under what other conditions would this error occur?","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1656514551,"metadata":{"github-id":"IC_kwDODBZtRc5Fvhwt","github-url":"https://github.com/dandi/dandi-cli/issues/1034#issuecomment-1170086957"},"message":"@jwodder - there is one:\n\n```\ncurl -X GET \"https://api.dandiarchive.org/api/zarr/?dandiset=000108\u0026name=sub-MITU01%2Fses-20220326h13m51s50%2Fmicr%2Fsub-MITU01_ses-20220326h13m51s50_sample-10_stain-YO_run-1_chunk-4_SPIM.ome.zarr\" -H  \"accept: application/json\"\n```\n\n```\n{\n  \"count\": 1,\n  \"next\": null,\n  \"previous\": null,\n  \"results\": [\n    {\n      \"name\": \"sub-MITU01/ses-20220326h13m51s50/micr/sub-MITU01_ses-20220326h13m51s50_sample-10_stain-YO_run-1_chunk-4_SPIM.ome.zarr\",\n      \"dandiset\": \"000108\",\n      \"zarr_id\": \"e64e9cb7-9f2b-4563-b224-267e49a3a90f\",\n      \"status\": \"Complete\",\n      \"checksum\": \"5a3cdb1c9b65e077011e80bbd1003222-255--602198343\",\n      \"upload_in_progress\": true,\n      \"file_count\": 255,\n      \"size\": 602198343\n    }\n  ]\n}\n```","files":null},{"type":3,"author":{"id":"adccd23cf679e6fb55b1c23d1d08cb100dec6f4e"},"timestamp":1656514813,"metadata":{"github-id":"IC_kwDODBZtRc5Fvi-q","github-url":"https://github.com/dandi/dandi-cli/issues/1034#issuecomment-1170091946"},"message":"That's very strange. Is there a way it could be \"hidden\" from view in the regular archive? Looking at sample 10's directory through the ui only yields the .json files for the YO stain.\n\n`https://dandiarchive.org/dandiset/000108/draft/files?location=sub-MITU01%2Fses-20220326h13m51s50%2Fmicr%2F`","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1656514954,"metadata":{"github-id":"IC_kwDODBZtRc5FvjoK","github-url":"https://github.com/dandi/dandi-cli/issues/1034#issuecomment-1170094602"},"message":"FTR: filed a dedicated issue about suboptimal rendering @slaytonmarx observed - https://github.com/dandi/dandi-archive/issues/1135","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1656515133,"metadata":{"github-id":"IC_kwDODBZtRc5FvkcK","github-url":"https://github.com/dandi/dandi-cli/issues/1034#issuecomment-1170097930"},"message":"@satra Oh, I hit the wrong endpoint.  However, if I try to look up the Zarr in 000108's list of assets (on the theory that it might have been renamed), nothing comes up:\n\n```python\nfrom dandi.dandiapi import AssetType, DandiAPIClient\n\nwith DandiAPIClient.for_dandi_instance(\"dandi\") as client:\n    d = client.get_dandiset(\"000108\")\n    for asset in d.get_assets():\n        if asset.asset_type is AssetType.ZARR and asset.zarr == \"e64e9cb7-9f2b-4563-b224-267e49a3a90f\":\n            print(asset.path)\n```\n\n@dandi/dandiarchive Can someone check the database to see what's going on?","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1656515283,"metadata":{"github-id":"UCE_lALODBZtRc5FvkcKziSmsNI"},"target":"a2a901dfeb50ffaeadf28665c40534edb7000617d036e945dbe4fcc2294d0e96","message":"@satra Oh, I hit the wrong endpoint.  However, if I try to look up the Zarr in 000108's list of assets (on the theory that it might have been renamed), nothing comes up:\n\n```python\nfrom dandi.dandiapi import AssetType, DandiAPIClient\n\nwith DandiAPIClient.for_dandi_instance(\"dandi\") as client:\n    d = client.get_dandiset(\"000108\")\n    for asset in d.get_assets():\n        if asset.asset_type is AssetType.ZARR and asset.zarr == \"e64e9cb7-9f2b-4563-b224-267e49a3a90f\":\n            print(asset.path)\n```\n\n@dandi/dandiarchive Can someone check the database to see what's going on?\n\nEDIT: Perhaps the Zarr was simply never associated with an asset, either due to being uploaded partially by an older version of dandi-cli or due to a bug in satra's s5cmd usage?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1656518758,"metadata":{"github-id":"IC_kwDODBZtRc5Fv37a","github-url":"https://github.com/dandi/dandi-cli/issues/1034#issuecomment-1170177754"},"message":"@jwodder - could you prep a little script to sweep through all zarrs in the archive (not -- do not make page_size too big - see https://github.com/dandi/dandi-archive/issues/1137) and list all zarrs for which do not have associated asset in their dandisets (just in `draft` since we AFAIK do not yet support publishing versioned dandisets with zarrs)?\n\nmost likely we should just have it a part of the `gc` to prune zarr archives without associated assets because I would guess that is what could happen if a zarr asset is removed for the archive.  I will add a note to https://github.com/dandi/dandi-archive/issues/177 \n\nIn the short term I guess we should just review those specific zarrs we would find not associated and many be \"manually\" associate them to assets.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1656518924,"metadata":{"github-id":"IC_kwDODBZtRc5Fv4s9","github-url":"https://github.com/dandi/dandi-cli/issues/1034#issuecomment-1170180925"},"message":"@jwodder actually in that script, could you also please \"find\" the zarr in the dandiset not via its path but rather by zarr_id.  And if zarr is present under a different name -- also alert.  I am not sure if we are anyhow working out renaming of zarrs correctly. That duplicity of `name` in zarr record and `asset` might be also biting us.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1656519649,"metadata":{"github-id":"IC_kwDODBZtRc5Fv9nz","github-url":"https://github.com/dandi/dandi-cli/issues/1034#issuecomment-1170201075"},"message":"@yarikoptic This script:\n\n```python\nfrom dandi.dandiapi import AssetType, DandiAPIClient\n\nwith DandiAPIClient.for_dandi_instance(\"dandi\") as client:\n    dandisets_with_zarrs = set()\n    zarr_info = {}\n    for zinfo in client.paginate(\"/zarr/\", page_size=25):\n        zarr_info[zinfo[\"zarr_id\"]] = zinfo\n        dandisets_with_zarrs.add(zinfo[\"dandiset\"])\n    for did in dandisets_with_zarrs:\n        for asset in client.get_dandiset(did).get_assets():\n            if asset.asset_type is AssetType.ZARR:\n                zinfo = zarr_info.pop(asset.zarr)\n                if zinfo[\"dandiset\"] != did:\n                    print(f\"Zarr {asset.zarr}: Zarr is associated with Dandiset {zinfo['dandiset']} but asset belongs to {did}\")\n                elif zinfo[\"name\"] != asset.path:\n                    print(f\"Dandiset {did}: Zarr {asset.zarr}: Zarr name is {zinfo['name']!r}, but asset path is {asset.path!r}\")\n    for zinfo in zarr_info.values():\n        print(f\"Dandiset {zinfo['dandiset']}: Zarr {zinfo['zarr_id']} ({zinfo['name']}): Zarr does not have asset\")\n```\n\noutputted the following:\n\n```\nDandiset 000108: Zarr 66b0a418-ef47-4542-bdfb-ff3bf5cc8aba (sub-MITU01/ses-20220326h13m51s50/micr/sub-MITU01_ses-20220326h13m51s50_sample-10_stain-YO_run-1_chunk-5_SPIM.ome.zarr): Zarr does not have asset\nDandiset 000108: Zarr 5f1fdae7-6ebc-4f36-a98e-9760078a77c2 (sub-MITU01/ses-20220326h13m51s50/micr/sub-MITU01_ses-20220326h13m51s50_sample-10_stain-YO_run-1_chunk-2_SPIM.ome.zarr): Zarr does not have asset\nDandiset 000108: Zarr 9a06b493-bffd-4ebe-9851-5b7ce12f90c6 (sub-MITU01/ses-20220326h13m51s50/micr/sub-MITU01_ses-20220326h13m51s50_sample-10_stain-YO_run-1_chunk-3_SPIM.ome.zarr): Zarr does not have asset\nDandiset 000108: Zarr e64e9cb7-9f2b-4563-b224-267e49a3a90f (sub-MITU01/ses-20220326h13m51s50/micr/sub-MITU01_ses-20220326h13m51s50_sample-10_stain-YO_run-1_chunk-4_SPIM.ome.zarr): Zarr does not have asset\nDandiset 000108: Zarr e1641fdc-142e-443c-aec0-66cf2e289c12 (sub-MITU01/ses-20220326h13m51s50/micr/sub-MITU01_ses-20220326h13m51s50_sample-10_stain-YO_run-1_chunk-1_SPIM.ome.zarr): Zarr does not have asset\n```","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1656520706,"metadata":{"github-id":"IC_kwDODBZtRc5FwCZY","github-url":"https://github.com/dandi/dandi-cli/issues/1034#issuecomment-1170220632"},"message":"coolio, thank you @jwodder . @satra @slaytonmarx - what is the \"provenance\" for these or what should we do with them?  I see us either\n- associating them with asset, and then I believe it should just work ok to \"update\" them\n- removing them and starting a fresh","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1656521695,"metadata":{"github-id":"IC_kwDODBZtRc5FwGZ3","github-url":"https://github.com/dandi/dandi-cli/issues/1034#issuecomment-1170237047"},"message":"it's possible asset creation broke or upload broke at some point. when the cli tries to upload it should allow updating the zarr blob and creating a new asset if necessary. this is exactly what @slaytonmarx is trying to do for some of these chunks. \n\ndandi upload \u003cfilname.ome.zarr\u003e\n\nshould check via zarr blob if it's there. if so it should update, and then also create an asset if an asset is missing. \n\ni feel there might be some order of operations assumptions that may be made. anything that is not associated with an asset should indeed be garbage collected eventually (but that's true of both regular blobs and zarrs).","files":null},{"type":3,"author":{"id":"a9e2633aeb6d7e2366a97d09712312c2442c6054"},"timestamp":1656527451,"metadata":{"github-id":"IC_kwDODBZtRc5Fwh-J","github-url":"https://github.com/dandi/dandi-cli/issues/1034#issuecomment-1170349961"},"message":"I'm a bit lost, is there anything immediately actionable on the API side?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1656531295,"metadata":{"github-id":"IC_kwDODBZtRc5FwwFN","github-url":"https://github.com/dandi/dandi-cli/issues/1034#issuecomment-1170407757"},"message":"\u003e it's possible asset creation broke or upload broke at some point.\n\nIIRC at some point (before https://github.com/dandi/dandi-cli/pull/907, released in 0.36.0 this Feb) we could have ended up in such scenario but should not now since asset would be created first for the zarr.  Also, may be, we might end up in such scenario if we just remove an asset with zarr, and then zarr would still be lurking behind (like blob does) until GC.  For blob it doesn't matter since those are \"identified\" by their content. For zarr - situation is more ambiguous since (for reason I don't remember) it has that `name` field which really stores `path`.  @AlmightyYakob  - can you grasp from design docs/code (now that @dchiquito is gone) why we need `name` and may be could we get rid of it?  then association of `Asset` -\u003e `zarr` would become solely at the level of an asset.  I filed a dedicated https://github.com/dandi/dandi-archive/issues/1141 for that .  I do not think it is urgent but we better clarify situation/design on this and remove possibility of ending up in similar \"tricky\" situations.\n\nSince I do not have personal preference between the two ways out [I suggested](https://github.com/dandi/dandi-cli/issues/1034#issuecomment-1170220632), let's proceed with the first which is what @satra also has in mind [above](https://github.com/dandi/dandi-cli/issues/1034#issuecomment-1170237047). @jwodder could you please adjust code so that if \"Zarr already exists\" error received , we \n- log a warning that we found a \"loose zarr\" which was already associated with that path, and that it will be reused for a new asset\n- \"find\" `zarr_id` for that zarr, and associate it with that asset which we have created (I assume) at the beginning of `upload`\n\nOverall policy would be of \"reuse of loose zarrs\".  I guess if in the course of https://github.com/dandi/dandi-archive/issues/1141 we remove/deprecate those `name` and `dandiset` associations, such reusal would no longer be possible.","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1656700483,"metadata":{"github-id":"CE_lADODBZtRc5M0hyHzwAAAAGcfHKP"},"status":2},{"type":3,"author":{"id":"7a8552494914d3e4116f4b434eb4812a914ca405"},"timestamp":1656700626,"metadata":{"github-id":"IC_kwDODBZtRc5F5LaL","github-url":"https://github.com/dandi/dandi-cli/issues/1034#issuecomment-1172616843"},"message":"\u003c!-- GITHUB_RELEASE COMMENT: released --\u003e\n:rocket: Issue was released in [`0.42.0`](https://github.com/dandi/dandi-cli/releases/tag/0.42.0) :rocket:","files":null},{"type":5,"author":{"id":"7a8552494914d3e4116f4b434eb4812a914ca405"},"timestamp":1656700627,"metadata":{"github-id":"LE_lADODBZtRc5M0hyHzwAAAAGcfKnY"},"added":["released"],"removed":[]}]}