{"version":2,"ops":[{"type":1,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1619120463,"metadata":{"github-id":"MDU6SXNzdWU4NjU0MDM4ODA=","github-url":"https://github.com/dandi/dandi-cli/issues/590","origin":"github"},"title":"More informative error (or proper fallback to default record) when redirector is not working","message":"Testing #588 on 0.14.1-7-g82cf684\n\n```shell\n$\u003e dandi download https://gui.dandiarchive.org/#/dandiset/000027\n2021-04-22 15:33:21,404 [    INFO] Logs saved in /home/yoh/.cache/dandi-cli/log/20210422193320Z-1492782.log\nError: Unknown instance metadata_version: 0\n\n$\u003e cat /home/yoh/.cache/dandi-cli/log/20210422193320Z-1492782.log\n2021-04-22T15:33:20-0400 [INFO    ] dandi 1492782:139758538225472 dandi v0.14.1+7.g82cf684, hdmf v2.3.0, pynwb v1.4.0, h5py v2.10.0\n2021-04-22T15:33:20-0400 [INFO    ] dandi 1492782:139758538225472 sys.argv = ['/home/yoh/proj/dandi/dandi-cli-master/venvs/dev3/bin/dandi', 'download', 'https://gui.dandiarchive.org/#/dandiset/000027']\n2021-04-22T15:33:20-0400 [INFO    ] dandi 1492782:139758538225472 os.getcwd() = /tmp\n2021-04-22T15:33:21-0400 [WARNING ] dandi 1492782:139758538225472 Request to https://dandiarchive.org failed (502 Server Error: Bad Gateway for url: https://dandiarchive.org/server-info)\n2021-04-22T15:33:21-0400 [WARNING ] dandi 1492782:139758538225472 Using hard-coded URLs\n2021-04-22T15:33:21-0400 [INFO    ] dandi 1492782:139758538225472 Logs saved in /home/yoh/.cache/dandi-cli/log/20210422193320Z-1492782.log\n```\n\n\n\u003cdetails\u003e\n\u003csummary\u003ewith 0.14.1 we fall back to girder instance (which currently rightfully fails)\u003c/summary\u003e \n\n```shell\n$\u003e dandi download https://gui.dandiarchive.org/#/dandiset/000027\n2021-04-22 15:31:05,462 [    INFO] Logs saved in /home/yoh/.cache/dandi-cli/log/20210422193103Z-1492215.log\nError: Cannot download from https://gui.dandiarchive.org/#/dandiset/000027\n(dev3) (dandi-py3.9-troubleshoot) 1 74859 -\u003e1.....................................:Thu 22 Apr 2021 03:31:05 PM EDT:.\nlena:/tmp\n$\u003e dandi download https://gui.dandiarchive.org/#/dandiset/000027\n(dev3) (dandi-py3.9-troubleshoot) 1 74859 -\u003e130.....................................:Thu 22 Apr 2021 03:31:12 PM EDT:.\nlena:/tmp\n$\u003e cat /home/yoh/.cache/dandi-cli/log/20210422193103Z-1492215.log\n2021-04-22T15:31:03-0400 [INFO    ] dandi 1492215:140596294952768 dandi v0.14.1, hdmf v2.3.0, pynwb v1.4.0, h5py v2.10.0\n2021-04-22T15:31:03-0400 [INFO    ] dandi 1492215:140596294952768 sys.argv = ['/home/yoh/proj/dandi/dandi-cli-master/venvs/dev3/bin/dandi', 'download', 'https://gui.dandiarchive.org/#/dandiset/000027']\n2021-04-22T15:31:03-0400 [INFO    ] dandi 1492215:140596294952768 os.getcwd() = /tmp\n2021-04-22T15:31:04-0400 [WARNING ] dandi 1492215:140596294952768 Request to https://dandiarchive.org failed (502 Server Error: Bad Gateway for url: https://dandiarchive.org/server-info)\n2021-04-22T15:31:04-0400 [WARNING ] dandi 1492215:140596294952768 Using hard-coded URLs\n2021-04-22T15:31:05-0400 [WARNING ] dandi 1492215:140596294952768 Request to https://dandiarchive.org failed (502 Server Error: Bad Gateway for url: https://dandiarchive.org/server-info)\n2021-04-22T15:31:05-0400 [WARNING ] dandi 1492215:140596294952768 Using hard-coded URLs\n2021-04-22T15:31:05-0400 [WARNING ] dandi 1492215:140596294952768 Request to https://dandiarchive.org failed (502 Server Error: Bad Gateway for url: https://dandiarchive.org/server-info)\n2021-04-22T15:31:05-0400 [WARNING ] dandi 1492215:140596294952768 Using hard-coded URLs\n2021-04-22T15:31:05-0400 [WARNING ] urllib3.connection 1492215:140596294952768 Certificate did not match expected hostname: girder.dandiarchive.org. Certificate: {'subject': ((('commonName', 'dandiarchive.org'),),), 'issuer': ((('countryName', 'US'),), (('organizationName', \"Let's Encrypt\"),), (('commonName', 'R3'),)), 'version': 3, 'serialNumber': '03264F1E931CDECFC1C049E11A0582B971D9', 'notBefore': 'Apr 19 14:13:08 2021 GMT', 'notAfter': 'Jul 18 14:13:08 2021 GMT', 'subjectAltName': (('DNS', 'dandiarchive.org'),), 'OCSP': ('http://r3.o.lencr.org',), 'caIssuers': ('http://r3.i.lencr.org/',)}\n2021-04-22T15:31:05-0400 [WARNING ] dandi 1492215:140596294952768 Failed to lookup girder information for drafts/000027\n\n```\n\u003c/details\u003e\n\nand it seems we fall to it here too but need version boost in the record\n\n```\ndiff --git a/dandi/consts.py b/dandi/consts.py\nindex a10ba81..b614db3 100644\n--- a/dandi/consts.py\n+++ b/dandi/consts.py\n@@ -87,14 +87,14 @@ known_instances = {\n         None,\n     ),\n     \"dandi\": dandi_instance(\n-        0,\n+        1,\n         \"https://girder.dandiarchive.org\",\n         \"https://gui.dandiarchive.org\",\n         \"https://dandiarchive.org\",\n         None,  # publish. is gone, superseded by API which did not yet fully superseded the rest\n     ),\n     \"dandi-api\": dandi_instance(\n-        1,\n+        0,\n         None,\n         \"https://gui-beta-dandiarchive-org.netlify.app\",\n         None,\n```\nbut then it still fails\n\n```\n$\u003e dandi --pdb -l debug download https://gui.dandiarchive.org/#/dandiset/000027\n2021-04-22 15:39:35,091 [   DEBUG] Running a newer version (0.14.1+7.g82cf684.dirty) of dandi/dandi-cli than available (0.14.1)\n2021-04-22 15:39:35,469 [   DEBUG] Caught exception 'NoneType' object has no attribute 'endswith'\n2021-04-22 15:39:35,469 [    INFO] Logs saved in /home/yoh/.cache/dandi-cli/log/20210422193934Z-1493901.log\nTraceback (most recent call last):\n  File \"/home/yoh/proj/dandi/dandi-cli-master/venvs/dev3/bin/dandi\", line 33, in \u003cmodule\u003e\n    sys.exit(load_entry_point('dandi', 'console_scripts', 'dandi')())\n  File \"/usr/lib/python3/dist-packages/click/core.py\", line 829, in __call__\n    return self.main(*args, **kwargs)\n  File \"/usr/lib/python3/dist-packages/click/core.py\", line 782, in main\n    rv = self.invoke(ctx)\n  File \"/usr/lib/python3/dist-packages/click/core.py\", line 1259, in invoke\n    return _process_result(sub_ctx.command.invoke(sub_ctx))\n  File \"/usr/lib/python3/dist-packages/click/core.py\", line 1066, in invoke\n    return ctx.invoke(self.callback, **ctx.params)\n  File \"/usr/lib/python3/dist-packages/click/core.py\", line 610, in invoke\n    return callback(*args, **kwargs)\n  File \"/usr/lib/python3/dist-packages/click/decorators.py\", line 33, in new_func\n    return f(get_current_context().obj, *args, **kwargs)\n  File \"/home/yoh/proj/dandi/dandi-cli-master/dandi/cli/base.py\", line 105, in wrapper\n    return f(*args, **kwargs)\n  File \"/home/yoh/proj/dandi/dandi-cli-master/dandi/cli/cmd_download.py\", line 128, in download\n    return download.download(\n  File \"/home/yoh/proj/dandi/dandi-cli-master/dandi/download.py\", line 79, in download\n    for rec in gen_:\n  File \"/home/yoh/proj/dandi/dandi-cli-master/dandi/download.py\", line 119, in download_generator\n    server_type, _, asset_type, asset_id = parse_dandi_url(urls[0])\n  File \"/home/yoh/proj/dandi/dandi-cli-master/dandi/dandiarchive.py\", line 346, in parse\n    if not server.endswith(\"/\"):\nAttributeError: 'NoneType' object has no attribute 'endswith'\n\n\u003e /home/yoh/proj/dandi/dandi-cli-master/dandi/dandiarchive.py(346)parse()\n-\u003e if not server.endswith(\"/\"):\n(Pdb) p server\nNone\n(Pdb) \n```","files":null}]}