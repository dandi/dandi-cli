{"version":2,"ops":[{"type":5,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1661886312,"metadata":{"github-id":"LE_lADODBZtRc5Q1btRzwAAAAGyh-bt"},"added":["cmd-organize"],"removed":[]},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1661886359,"metadata":{"github-id":"IC_kwDODBZtRc5Jb6M4","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1232053048"},"message":"also just noticed \"hard link support autodetected\" -- not sure if that is really supported on windows","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1661951127,"metadata":{"github-id":"IC_kwDODBZtRc5JfMGn","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1232912807"},"message":"@yarikoptic Could you be precise about exactly what change you want done to the code for this?  We can't just switch to an unconditional `shutil` without throwing away the code for autodetecting hardlink/symlink support.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1661953859,"metadata":{"github-id":"IC_kwDODBZtRc5JfZV7","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1232967035"},"message":"`dandi organize PATH_ON_ANOTHERDRIVE` on windows should use \"compatible\" copy  operation.  \n\nI am not sure why user also saw error about \"move\"ing since we should not move unless asked to be moved, we should copy.  So might need fix up of logic as well, unless that error was some kind of a sideeffect of trying to \"hardlink\"","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1661953988,"metadata":{"github-id":"IC_kwDODBZtRc5JfaBd","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1232969821"},"message":"@yarikoptic \n\n\u003e `dandi organize PATH_ON_ANOTHERDRIVE` on windows should use \"compatible\" copy operation.\n\nHow should it tell what operation to use?\n\n\u003e I am not sure why user also saw error about \"move\"ing\n\nMy best guess is that that's just a generic system message used for both moving and copying.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1661954901,"metadata":{"github-id":"IC_kwDODBZtRc5JfetQ","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1232989008"},"message":"\u003e How should it tell what operation to use?\n\nI would have first troubleshooted why it decided that hardlinking across drives was available!  if can be resolved at that stage \"Generally\" -- good.  If not -- disable hardlinking on windows altogether so it proceeds with `copy` and then ensure that copy works across drives","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1661955190,"metadata":{"github-id":"IC_kwDODBZtRc5JfgMU","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1232995092"},"message":"@yarikoptic\n\n\u003e I would have first troubleshooted why it decided that hardlinking across drives was available!\n\nThe test of linking capabilities operates on two temp files in the dandiset root directory.  `os.link()` apparently works on Windows, so the test of it succeeded, and so the code proceeded to attempt a hardlink from the source path to the destination path.\n\nCouldn't this be solved by the user just passing `--files-mode move` to `dandi organize`?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1661956462,"metadata":{"github-id":"IC_kwDODBZtRc5JfmsW","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1233021718"},"message":"\u003e Couldn't this be solved by the user just passing `--files-mode move` to `dandi organize`?\n\nExplicitly using `--files-mode copy` (AFAIK we should not `move` \"by default\") is [what I recommended to the user as a workaround](https://github.com/dandi/helpdesk/discussions/80#discussioncomment-3511824).  The point is that specification of `--files-mode` should not be necessary!  \n\n\u003e The test of linking capabilities operates on two temp files in the dandiset root directory. `os.link()` apparently works on Windows, so the test of it succeeded, and so the code proceeded to attempt a hardlink from the source path to the destination path.\n\noh, ok. Please then change that by testing hardlinking one sample source file (not just temp file) into \" file in the dandiset root directory\".  Then we would know better if hardlinking would be possible (on windows or not) for other files in the particular case like here (on different drives... could be similarly on different file systems on linux, so not windows specific then)","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1661957790,"metadata":{"github-id":"IC_kwDODBZtRc5JftjU","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1233049812"},"message":"@yarikoptic\n\n\u003e Please then change that by testing hardlinking one sample source file (not just temp file) into \" file in the dandiset root directory\".\n\nLooking at the source code, I see some problems with that approach:\n\n* `organize` can be passed multiple directories of NWB files to operate on at once, so the various input files can exist on multiple different filesystems.\n* [`organize` accepts a file of JSON metadata instead of an NWB file path](https://github.com/dandi/dandi-cli/blob/ef097cc124629556d94544b4ca40f2f1ee567425/dandi/organize.py#L794-L796); I'm not clear what files it operates on in that case.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1661969557,"metadata":{"github-id":"IC_kwDODBZtRc5Jgg87","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1233260347"},"message":"- operate on `metadata[\"path\"]` which I believe must be present in that loaded json metadata (list I assume)\n- provide `detect_link_type` list of folders for those paths, inside loop through those folders and \"trim down\" list of possible choices `['symlink', 'hardlink', 'copy']` until you end up just with copy or you exit that loop with some other value (i.e. all folders are ok with symlink or hardlink)","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1662476464,"metadata":{"github-id":"IC_kwDODBZtRc5JzpPD","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1238275011"},"message":"@yarikoptic To be clear, the metadata loaded from the file is a list of dicts, each of which contains a `\"path\"` field, correct?  Is this `\"path\"` a path to a file or a directory?\n\n\u003e provide `detect_link_type` list of folders for those paths, inside loop through those folders\n\nDo you mean loop through just the folders passed to `dandi organize` (or through the containing folders for paths that point to files) or loop through all folders containing files found by `find_files()`?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1662477061,"metadata":{"github-id":"IC_kwDODBZtRc5JzsXm","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1238287846"},"message":"\u003e Is this \"path\" a path to a file or a directory?\n\nI would assume of files since we do not have notion of \"folder\" within dandi API/metadata.\n\n \u003e Do you mean loop through just the folders passed to `dandi organize` (or through the containing folders for paths that point to files) or loop through all folders containing files found by `find_files()`?\n\nloop through the folders of files we would be organized.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1662477266,"metadata":{"github-id":"IC_kwDODBZtRc5JztYk","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1238292004"},"message":"@yarikoptic \n\n\u003e loop through the folders of files we would be organized.\n\nThat doesn't answer my question.  If the user runs `dandi organize foo/bar` where `foo/bar` is laid out like so:\n\n```\nfoo/bar\n├── glarch/\n│   └── quux.nwb\n└── cleesh.nwb\n```\n\nshould we test just `foo/bar` and/or `foo/bar/glarch`?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1662477757,"metadata":{"github-id":"IC_kwDODBZtRc5Jzv15","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1238302073"},"message":"In theory `foo/bar/glarch` could be a different mount point from `foo/bar`, but pragmatically - let's just test the \"top most\" disjoint paths, e.g. for `foo/bar`, `foo/bar/glarch` and `a/b` it would be `foo/bar` and `a/b`.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1663007641,"metadata":{"github-id":"IC_kwDODBZtRc5KKA8T","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1244139283"},"message":"@yarikoptic Does \"'top most' paths\" here mean \"those paths given on the command line that contain all other paths on the command line\"?  For example, given just `foo/bar/baz` and `foo/gnusto/cleesh`, would the two directories be tested separately or would `foo/` be tested?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1663007950,"metadata":{"github-id":"IC_kwDODBZtRc5KKCRk","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1244144740"},"message":"\u003e @yarikoptic Does \"'top most' paths\" here mean \"those paths given on the command line that contain all other paths on the command line\"?\n\ncorrect\n\n\u003e For example, given just `foo/bar/baz` and `foo/gnusto/cleesh`, would the two directories be tested separately or would `foo/` be tested?\n\njust `foo/`.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1663008152,"metadata":{"github-id":"IC_kwDODBZtRc5KKDCQ","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1244147856"},"message":"@yarikoptic But `foo/` *isn't* a path given on the command line, which contradicts the definition you just agreed with.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1663009960,"metadata":{"github-id":"IC_kwDODBZtRc5KKOhL","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1244194891"},"message":"I guess   I got misguided by `foo/gnusto/cleesh` which was not mentioned before. Then it means that topmost paths are not necessarily the ones which were explicitly given!","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1663011114,"metadata":{"github-id":"IC_kwDODBZtRc5KKZ9e","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1244241758"},"message":"@yarikoptic So you still want `foo/` to be the one tested?  On Unix systems, this can easily end up with trying to test only `/`, which we likely won't have write access to and which won't serve the purpose of checking for differing mount points.","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1663011130,"metadata":{"github-id":"UCE_lALODBZtRc5KKZ9ezicuPAQ"},"target":"440031faaa89c3fbb4ef8217caa2a444f82a4839fc630db28c2a071c3cb2ec64","message":"@yarikoptic So you still want `foo/` to be the one tested?  On Unix systems, this can easily end up with trying to test only the root directory `/`, which we likely won't have write access to and which won't serve the purpose of checking for differing mount points.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1663015317,"metadata":{"github-id":"IC_kwDODBZtRc5KLHsr","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1244429099"},"message":"you are right but let's say \"that is ok\". As I have mentioned [above](https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1233260347) we need to consider paths from `metadata['path']` so we would not operate only with what is provided on CLI. \nUnder assumption that all paths user would provide would come from the same mount point we can just take first (or last, doesn't matter) path on the list and use it for testing -- try to hardlink/symlink/... somewhere into destination path. So just make `detect_link_type` get a srcpath (instead of using the same workdir) and do not unlink srcpath at the end as it does now.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1663080679,"metadata":{"github-id":"IC_kwDODBZtRc5KPUYK","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1245529610"},"message":"@yarikoptic\n\n\u003e do not unlink srcpath at the end as it does now.\n\n(Assuming you meant \"do not unlink srcfile\", where \"srcfile\" is the temporary file used as the src for copy-like testing) Why shouldn't srcfile be unlinked?  Not unlinking it would result in a junk temp file being left in the destination directory.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1663186732,"metadata":{"github-id":"IC_kwDODBZtRc5KV6kR","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1247258897"},"message":"I'm comment above I suggested to use actual path among those given to organize. So we don't need to create any temporary but just can stmymlink or hardlink it instead of creating some temporary one. This would also allow organize to symlink etc on source directories which do not belong to the user","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1663604363,"metadata":{"github-id":"CE_lADODBZtRc5Q1btRzwAAAAG5-hOO"},"status":2},{"type":3,"author":{"id":"7a8552494914d3e4116f4b434eb4812a914ca405"},"timestamp":1663604443,"metadata":{"github-id":"IC_kwDODBZtRc5KlHtM","github-url":"https://github.com/dandi/dandi-cli/issues/1110#issuecomment-1251244876"},"message":"\u003c!-- GITHUB_RELEASE COMMENT: released --\u003e\n:rocket: Issue was released in [`0.46.3`](https://github.com/dandi/dandi-cli/releases/tag/0.46.3) :rocket:","files":null},{"type":5,"author":{"id":"7a8552494914d3e4116f4b434eb4812a914ca405"},"timestamp":1663604445,"metadata":{"github-id":"LE_lADODBZtRc5Q1btRzwAAAAG5-jj9"},"added":["released"],"removed":[]}]}