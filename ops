{"version":2,"ops":[{"type":3,"author":{"id":"c8082a0f6b38dd60d28641b213f904bcd85419c2"},"timestamp":1572530662,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU0ODM5MDg1OQ==","github-url":"https://github.com/dandi/dandi-cli/issues/27#issuecomment-548390859"},"message":"We are working on a [docker compose setup](https://github.com/dandi/dandiarchive/pull/53) for the dandiarchive, which might be a solution here. That might also end up being too heavyweight and perhaps we should just mock a few endpoints instead. After we finish that PR I can think about this issue more.","files":null},{"type":2,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1584131459,"metadata":{"github-id":"MDE3OlJlbmFtZWRUaXRsZUV2ZW50MzEyODEwMDc3OA=="},"title":"upload: establish testing","was":"upload: establish testing"},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1596482692,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2ODE5OTQ0NQ==","github-url":"https://github.com/dandi/dandi-cli/issues/27#issuecomment-668199445"},"message":"There is a working docker compose setup, so it is time to establish within tests (on CI or not) a fixture which would use docker-compose to start an instance of the archive.  Possibly of help and code to adopt: within reproman we have \"fixture generators\" https://github.com/ReproNim/reproman/blob/master/reproman/tests/fixtures.py#L23  to create fixtures needing specific docker or singularity container etc.  May be could come useful here.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1596483461,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2ODIwNDk2MQ==","github-url":"https://github.com/dandi/dandi-cli/issues/27#issuecomment-668204961"},"message":"@yarikoptic The images for the docker-compose setup are built by copying in the dandiarchive source, so either dandi-cli's GitHub actions need to check out a copy of dandiarchive (not the cleanest idea) or else the dandiarchive images need to be pushed to Docker Hub or a similar registry.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1596488020,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2ODIzNjI5MQ==","github-url":"https://github.com/dandi/dandi-cli/issues/27#issuecomment-668236291"},"message":"Ok, we already have `dandiarchive` organization on hub.docker  linked to github via `dandibot` user... I have initiated a build for dandiarchive/dandiarchive-client - let's see if that one works out.  I will update whenever I know more.\n@jwodder - do you have hub.docker.com account?  I could add you to dandiarchive organization","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1596488090,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2ODIzNjgwMg==","github-url":"https://github.com/dandi/dandi-cli/issues/27#issuecomment-668236802"},"message":"@yarikoptic Yes; username: jwodder","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1596491493,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2ODI1OTU0Ng==","github-url":"https://github.com/dandi/dandi-cli/issues/27#issuecomment-668259546"},"message":"ok, added you to the owners! (as well as developers for that first repo dandiarchive-client).  So I have prepared one for dandiarchive-client, seems to work fine! now up to you @jwodder to link to other components (I have made it to rebuild for master and for any tagged release which are yet to come in dandiarchive).","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1596543023,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2ODU1NzI4Ng==","github-url":"https://github.com/dandi/dandi-cli/issues/27#issuecomment-668557286"},"message":"@yarikoptic The \"girder\" image should be uploaded as well, as that's built by copying in the girder-dandi-archive directory from dandiarchive.  That just leaves the \"provision\" image; it'd be easiest if that was uploaded to Docker Hub too.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1596557237,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2ODY4NTkzNw==","github-url":"https://github.com/dandi/dandi-cli/issues/27#issuecomment-668685937"},"message":"\u003e @yarikoptic The \"girder\" image should be uploaded as well, as that's built by copying in the girder-dandi-archive directory from dandiarchive. That just leaves the \"provision\" image; it'd be easiest if that was uploaded to Docker Hub too.\n\njust to make sure re \"uploaded\".  Did you upload it or it was built on docker hub with linkage to the repository so whenever we push new changes it would get rebuilt?\n\n (now I wonder -- would docker hub react only to changes to Dockerfile(s) or to any commit to rebuild \"latest\"?)","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1596557445,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2ODY4Nzc4Mw==","github-url":"https://github.com/dandi/dandi-cli/issues/27#issuecomment-668687783"},"message":"I did not upload anything to Docker Hub, as I wasn't sure as to the best way to go about it (though I believe I could set up automated builds of the other images).\n\nI believe Docker Hub rebuilds on all commits, regardless of where they are in the repository.  I've also seen Docker Hub keep a triggered build queued for over three hours, so, if possible, we might want to create an action to build images and push them to the Hub rather than relying on the Hub's infrastructure.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1596559625,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2ODcwNjIzNw==","github-url":"https://github.com/dandi/dandi-cli/issues/27#issuecomment-668706237"},"message":"\u003e I did not upload anything to Docker Hub, as I wasn't sure as to the best way to go about it (though I believe I could set up automated builds of the other images).\n\nsorry I was not clear in my description of desired actions!  \n\nI do not see girder component build setup on the hub so I did it while recording a screen cast.  Unfortunately middle portion where I actually added a triggered build was not recorded :-(  FWIW here is two parts:\n- http://www.onerussian.com/tmp/dockerhub-dandiarchive-girder-part1.webm  -- checked existing one, and started to establish one for girder\n- http://www.onerussian.com/tmp/dockerhub-dandiarchive-girder-part3.webm -- after I setup - decided to check on the girder one that it is pending\n\n\u003e , if possible, we might want to create an action to build images and push them to the Hub rather than relying on the Hub's infrastructure.\n\nyeap, in the long(er) run it might be desired.  For now, and for tagged releases of the dandiarchive, getting some images built automagically by docker hub, even with a delay, would suffice IMHO.  But I would not stop anyone to prepare a proper action.","files":null},{"type":5,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1596729138,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDM2Mjk3MTE0MDA="},"added":["severity-important"],"removed":[]},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1596729251,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY3MDAxNTA4Ng==","github-url":"https://github.com/dandi/dandi-cli/issues/27#issuecomment-670015086"},"message":"Now that #159 is merged, and we had some small fall-outs due to absent upload testing, I am giving this issue an explicit urgency so that upcoming release would have `upload` tested at least to some minimal degree.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1596734072,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY3MDA2MTkxOA==","github-url":"https://github.com/dandi/dandi-cli/issues/27#issuecomment-670061918"},"message":"@yarikoptic Should the tests just run `upload` and then check that the uploaded files exist on the Dandi instance, or should they be more in-depth somehow?\n\nIt looks like `upload` will have to be converted into a function that the command calls (in order to make it possible to specify the Dandi instance without depending on `DANDI_DEVEL`); should this function return anything (say, progress information for the caller to pass to pyout if it so chooses) or not?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1596735554,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY3MDA3NjI1OQ==","github-url":"https://github.com/dandi/dandi-cli/issues/27#issuecomment-670076259"},"message":"For now even the simple upload you outlined would suffice. May be doing it a few times as a smoke test for handling --existing option.\n\nFor now it doesn't need to return anything. We will need to decide on upload/download/... return (or making them into generators even) later on consistently across commands based on the target needs/use cases. That should also later allow for better testing of different options (eg how to handle existing files).","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1596737416,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY3MDA4OTUyMQ==","github-url":"https://github.com/dandi/dandi-cli/issues/27#issuecomment-670089521"},"message":"@yarikoptic The `pyout.Tabular` constructor is failing in the tests because [`curses.setupterm()`](https://docs.python.org/3/library/curses.html#curses.setupterm) \"could not find terminal\".","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1596737416,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6MzkxMzE2NjYw"},"target":"a7b7ec3407071b1ac82443bc105f64c215796b7fddc8262de73d8d020af39715","message":"@yarikoptic The `pyout.Tabular` constructor is failing in the tests because [`curses.setupterm()`](https://docs.python.org/3/library/curses.html#curses.setupterm) \"could not find terminal\".  This doesn't happen if the `-s` (`--capture=no`) option is removed from the pytest invocation.","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1596737655,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6MzkxMzE3NTgw"},"target":"a7b7ec3407071b1ac82443bc105f64c215796b7fddc8262de73d8d020af39715","message":"@yarikoptic The `pyout.Tabular` constructor is failing in the tests because [`curses.setupterm()`](https://docs.python.org/3/library/curses.html#curses.setupterm) \"could not find terminal\".  This doesn't happen if the `-s` (`--capture=no`) option is removed from the pytest invocation.\n\nOnce I removed the `-s` option, the upload test failed because the post-upload check couldn't find the uploaded file.  Is the below code the correct way to check that a file `sub-anm369962/sub-anm369962_ses-20170309.nwb` that has been uploaded from a local Dandiset with id 000006 exists on the Dandi instance?\n\n```\ngirder.lookup(\n    client,\n    collection_drafts,\n    path=f\"{dandi_id}/sub-anm369962/sub-anm369962_ses-20170309.nwb\",\n)\n```","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1596741260,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY3MDE0Mjg5Mw==","github-url":"https://github.com/dandi/dandi-cli/issues/27#issuecomment-670142893"},"message":"I've fixed the above problem; I forgot to `chdir`.  `dandi upload` should probably fail when given a path that doesn't exist.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1596741446,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY3MDE0NDIyMA==","github-url":"https://github.com/dandi/dandi-cli/issues/27#issuecomment-670144220"},"message":"re `pyout`: I would file an issue on https://github.com/pyout/pyout/issues since AFAIK it should have automagically determine if no terminal is available and switch to a \"static renderer\" like I believe it does already whenever there is no TTY.\n\nas for test either it was uploaded, although it would bind with `download` - I would just `download` into a new temp folder and thus verify full round-trip.  The reason is - I do not want tests to assume girder as the backend.\n\nIn #134 I am unifying a bit \"list assets on the remote server\" so we could later may be use that instead of full `download`.\n\n~~~~\n\ntyped above and the \"fixed above\" message appeared... will keep the comment anyways. And indeed `upload` should fail one way or another if any file upload has failed (e.g. pointed to non-existing path, or just failed to upload).  I think it is along the lines of figuring out the returned value(s) etc. ATM it  doesn't do any of that indeed besides reporting in its output to the human (which was primary target use-case).","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1596741446,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6MzkxMzMzNTIx"},"target":"50a5beb1e6d0a368722128be991309814235345e50b005006580de21385143d9","message":"re `pyout`: I would file an issue on https://github.com/pyout/pyout/issues since AFAIK it should have automagically determine if no terminal is available and switch to a \"static renderer\" like I believe it does already whenever there is no TTY.\n\nas for test either it was uploaded, although it would bind with `download` - I would just `download` into a new temp folder and thus verify full round-trip.  The reason is - I do not want tests to assume girder as the backend.\n\nIn #134 I am unifying a bit \"list assets on the remote server\" so we could later may be use that instead of full `download`.\n\n----\n\ntyped above and the \"fixed above\" message appeared... will keep the comment anyways. And indeed `upload` should fail one way or another if any file upload has failed (e.g. pointed to non-existing path, or just failed to upload).  I think it is along the lines of figuring out the returned value(s) etc. ATM it  doesn't do any of that indeed besides reporting in its output to the human (which was primary target use-case).","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1596743737,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY3MDE1NzY1MQ==","github-url":"https://github.com/dandi/dandi-cli/issues/27#issuecomment-670157651"},"message":"\u003e re `pyout`: I would file an issue on https://github.com/pyout/pyout/issues since AFAIK it should have automagically determine if no terminal is available and switch to a \"static renderer\" like I believe it does already whenever there is no TTY.\n\nI tried creating an MVCE for the problem, and the error disappeared.\n\n\u003e as for test either it was uploaded, although it would bind with `download` - I would just `download` into a new temp folder and thus verify full round-trip. The reason is - I do not want tests to assume girder as the backend.\n\nThe `download()` function requires a URL containing the Girder ID of the uploaded file.  There doesn't seem to be a way to avoid Girder at the moment.","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1596743737,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6MzkxMzQyNjM2"},"target":"91aeca8cc6b246e195fc0c19cb73f32d41a9a5db437d2ae3d284a2a9afee6ad7","message":"\u003e re `pyout`: I would file an issue on https://github.com/pyout/pyout/issues since AFAIK it should have automagically determine if no terminal is available and switch to a \"static renderer\" like I believe it does already whenever there is no TTY.\n\nI tried creating an MVCE for the problem, and the error disappeared; I can't figure out how to make it happen again without copying all of dandi-cli.\n\n\u003e as for test either it was uploaded, although it would bind with `download` - I would just `download` into a new temp folder and thus verify full round-trip. The reason is - I do not want tests to assume girder as the backend.\n\nThe `download()` function requires a URL containing the Girder ID of the uploaded file.  There doesn't seem to be a way to avoid Girder at the moment.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1596745534,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY3MDE3NDQ5Mg==","github-url":"https://github.com/dandi/dandi-cli/issues/27#issuecomment-670174492"},"message":"\u003e I tried creating an MVCE for the problem, and the error disappeared; I can't figure out how to make it happen again without copying all of dandi-cli.\n\nthe \"best\" kind of problems... I would still report (even though without MVCE) it against `pyout` referencing relevant message here, @kyleam might have an immediate clue just based on the fact that we ran it via `python -m pytest -s v`\n\n\u003e The download() function requires a URL containing the Girder ID of the uploaded file. There doesn't seem to be a way to avoid Girder at the moment.\n\nright! forgot that we do not interface instances there... Please proceed with the direct `girder` interface for now. I filed a separate https://github.com/dandi/dandi-cli/issues/170 which should allow us to setup \"fuller\" test deployment which would allow to test downloads from it via urls mapping done by the redirector ATM.","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1596765115,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50MzYzMTQzMzgwNw=="},"status":2}]}