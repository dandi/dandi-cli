{"version":2,"ops":[{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1708116821,"metadata":{"github-id":"IC_kwDODBZtRc50MEdQ","github-url":"https://github.com/dandi/dandi-cli/issues/1408#issuecomment-1949321040"},"message":"@yarikoptic Do the logs contain any messages about `super_len()` or `stat()`?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1708117210,"metadata":{"github-id":"IC_kwDODBZtRc50MGSH","github-url":"https://github.com/dandi/dandi-cli/issues/1408#issuecomment-1949328519"},"message":"I don't think so:\n\n```shell\n❯ zgrep -e super_len  -e stat 20240216201625Z-3182147.log.gz\n    do = self.iter(retry_state=retry_state)\n    result.raise_for_status()\n  File \"/home/yoh/proj/dandi/dandi-cli-master/venvs/dev3.11/lib/python3.11/site-packages/requests/models.py\", line 1021, in raise_for_status\n2024-02-16T15:37:30-0500 [INFO    ] dandi 3182147:140109695737920 Logs saved in /home/yoh/.local/state/dandi-cli/log/20240216201625Z-3182147.log\n```\nfull log (compressed) now available from `dandi@drogon:20240216201625Z-3182147.log.gz`","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1708117432,"metadata":{"github-id":"IC_kwDODBZtRc50MHT_","github-url":"https://github.com/dandi/dandi-cli/issues/1408#issuecomment-1949332735"},"message":"@yarikoptic The errors all seem to be associated with the file `0/0/d0/d2/d26/f1.dat`.  Is that file empty or somehow odd in any way?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1708117566,"metadata":{"github-id":"IC_kwDODBZtRc50MH9B","github-url":"https://github.com/dandi/dandi-cli/issues/1408#issuecomment-1949335361"},"message":"@yarikoptic Can you try redoing the upload with `DANDI_DEVEL_INSTRUMENT_REQUESTS_SUPERLEN=1` set?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1708118224,"metadata":{"github-id":"IC_kwDODBZtRc50MK3a","github-url":"https://github.com/dandi/dandi-cli/issues/1408#issuecomment-1949347290"},"message":"\u003cdetails\u003e\n\u003csummary\u003elooks \"regular\" to me... \n\u003c/summary\u003e \n\n```shell\n❯ ls sub-randomzarrlike_junk.zarr/0/0/d0/d2/d26/f1.dat -l\n-rw------- 1 yoh yoh 1024 Feb 16 15:14 sub-randomzarrlike_junk.zarr/0/0/d0/d2/d26/f1.dat\n❯ md5sum -l\nmd5sum: invalid option -- 'l'\nTry 'md5sum --help' for more information.\n❯ md5sum sub-randomzarrlike_junk.zarr/0/0/d0/d2/d26/f1.dat\n4bd9951479a6a7b2b36b6c8b80f1e5f5  sub-randomzarrlike_junk.zarr/0/0/d0/d2/d26/f1.dat\n❯ cat sub-randomzarrlike_junk.zarr/0/0/d0/d2/d26/f1.dat\n��\n  �Կ�[�\\������#;r�1�\u003e��G/1{���J�/�ճ]��,L-z����%AT�J��驇c�S��%�\n�7f�����,����$�,�\u003c@��⍩\u0026�P��ߑ�����...\n```\n\u003c/details\u003e\n\nseems to be a new file since there is no d26 under https://github.com/dandizarrs/fd6ab3ea-cff6-4006-a9bf-acfa5d983985/tree/0.231017.2004%2Bzarr1/0/0/d0 which should reflect prior version .","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1708356128,"metadata":{"github-id":"IC_kwDODBZtRc50Y4Zv","github-url":"https://github.com/dandi/dandi-cli/issues/1408#issuecomment-1952679535"},"message":"@yarikoptic What if you set the envvar `DANDI_DEVEL_INSTRUMENT_REQUESTS_SUPERLEN=1` while uploading?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1708358278,"metadata":{"github-id":"IC_kwDODBZtRc50ZMuV","github-url":"https://github.com/dandi/dandi-cli/issues/1408#issuecomment-1952762773"},"message":"that re-upload succeeded without error \n```\n❯ DANDI_DEVEL_INSTRUMENT_REQUESTS_SUPERLEN=1 dandi upload --validation ignore -J 5:200 ./sub-randomzarrlike_junk.zarr\n2024-02-16 17:58:38,651 [    INFO] Found 2 files to consider\nPATH                                            SIZE        ERRORS          UPLOAD STATUS                          MESSAGE                  \ndandiset.yaml                                   3.0 kB                             skipped                         should be edited online  \nsub-randomzarrlike/sub-randomzarrlike_junk.zarr 269.8 MB       1              100% done                            exists - reuploading     \nSummary:                                        269.8 MB 1 with errors   41.5 kB/s 1 skipped                       1 should be edited online\n                                                                                   1 done                          1 exists - reuploading   \n2024-02-16 19:25:44,541 [    INFO] Logs saved in /home/yoh/.local/state/dandi-cli/log/20240216225836Z-3262469.log\nDANDI_DEVEL_INSTRUMENT_REQUESTS_SUPERLEN=1 dandi upload --validation ignore -  10097.05s user 294.08s system 198% cpu 1:27:08.90 total\n```\n\nlog is at `dandi@drogon.dartmouth.edu:20240216225836Z-3262469.log.gz` .","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1708985001,"metadata":{"github-id":"IC_kwDODBZtRc51JUoa","github-url":"https://github.com/dandi/dandi-cli/issues/1408#issuecomment-1965378074"},"message":"uploaded also 20240223192140Z-306046.log.gz from another successful upload.   I now wonder if that instrumentation is what makes it pass.  `grep` for anything diagnostic due to `super_len` seems to be not there:\n\n```\ngrep -e 'super_len() report size' -e '- ' 20240216201625Z-3182147.log.gz 20240216225836Z-3262469.log.gz 20240223192140Z-306046.log.gz\n```","files":null},{"type":5,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1709218218,"metadata":{"github-id":"LE_lADODBZtRc5_hYFPzwAAAALJTINX"},"added":["cmd-upload"],"removed":[]},{"type":5,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1709218218,"metadata":{"github-id":"LE_lADODBZtRc5_hYFPzwAAAALJTINm"},"added":["zarr"],"removed":[]},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1712004394,"metadata":{"github-id":"IC_kwDODBZtRc55B2HF","github-url":"https://github.com/dandi/dandi-cli/issues/1408#issuecomment-2030526917"},"message":"@jwodder - please try (script) a few uploads like that. May be against staging instance. Original description provides all the commands needed. Would be nice to catch this and figure out why AWS wasn't happy to not make users surprised later on.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1712331908,"metadata":{"github-id":"IC_kwDODBZtRc55mfL2","github-url":"https://github.com/dandi/dandi-cli/issues/1408#issuecomment-2040132342"},"message":"@yarikoptic As I have stated previous times this has come up, the \"A header you provided implies functionality that is not implemented\" error from AWS occurs when an upload is made using \"chunked\" transfer-encoding, and `requests` uses \"chunked\" whenever (a) the data being uploaded is zero-length or (b) a file is being uploaded and `requests` fails to determine its size.  What exactly do you want me to do about this?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1712596657,"metadata":{"github-id":"IC_kwDODBZtRc55yeKr","github-url":"https://github.com/dandi/dandi-cli/issues/1408#issuecomment-2043273899"},"message":"Figure out either it is a. or b. or some other c. and in the end/accordingly make sure that we do not error out when we `upload`.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1716396394,"metadata":{"github-id":"IC_kwDODBZtRc5-rU_K","github-url":"https://github.com/dandi/dandi-cli/issues/1408#issuecomment-2125287370"},"message":"@yarikoptic I'm currently uploading a randomly-generated Zarr to staging from my MacBook Pro with `DANDI_DEVEL_INSTRUMENT_REQUESTS_SUPERLEN=1` set.  No errors have occurred yet (aside from a \"too many open files\" error at the start which was apparently fixed by lowering the number of upload threads per asset).  However, this is taking a long time, so I'm now running the following on my account on smaug:\n\n`meta-run.sh`:\n\n```shell\n#!/bin/bash\nset -x\n\ncd \"$(dirname \"$0\")\"\nmkdir -p logs\nfor i in {1..10}\ndo\n    DANDI_DEVEL_INSTRUMENT_REQUESTS_SUPERLEN=1 \\\n        ./run.sh |\u0026 tee logs/\"$(date -u %Y.%m.%d.%H.%M.%SZ)\"-spy.log\n    ./run.sh |\u0026 tee logs/\"$(date -u %Y.%m.%d.%H.%M.%SZ)\"-nospy.log\ndone\n```\n\n`run.sh`:\n\n```shell\n#!/bin/bash\nexport DANDI_API_KEY=---REDACTED---\nexport DANDI_DEVEL=1\n\nset -ex\ncd \"$(dirname \"$0\")\"\n. venv/bin/activate\n\ncd 214256\nfor layout in zarr128-smallfiles zarr64-smallfiles\ndo\n    rm -rf random.zarr\n    echo Generating random.zarr from $layout ...\n    chronic python3 ../zarr-digest-timings/mktree.py \\\n        random.zarr \\\n        ../zarr-digest-timings/layouts/$layout.json\n    echo \"Now: $(date)\"\n    if ! dandi upload --devel-debug -i dandi-staging --validation ignore -J 5:200 random.zarr\n    then echo \"Failed at: $(date)\"\n         exit 1\n    fi\n    echo \"Now: $(date)\"\ndone\n```","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1716396544,"metadata":{"github-id":"UCE_lALODBZtRc5-rU_KzkbcCzw"},"target":"456364b62f1847614a64d805e006f3b0dd03ff08ab44b8cf7de88ed5d51288a2","message":"@yarikoptic I'm currently uploading a randomly-generated Zarr to staging from my MacBook Pro with `DANDI_DEVEL_INSTRUMENT_REQUESTS_SUPERLEN=1` set.  No errors have occurred yet (aside from a \"too many open files\" error at the start which was apparently fixed by lowering the number of upload threads per asset).  However, this is taking a long time, so I'm now running the following on my account on smaug:\n\n`meta-run.sh`:\n\n```shell\n#!/bin/bash\nset -x\n\ncd \"$(dirname \"$0\")\"\nmkdir -p logs\nfor i in {1..10}\ndo\n    DANDI_DEVEL_INSTRUMENT_REQUESTS_SUPERLEN=1 \\\n        ./run.sh |\u0026 tee logs/\"$(date -u +%Y.%m.%d.%H.%M.%SZ)\"-spy.log\n    ./run.sh |\u0026 tee logs/\"$(date -u +%Y.%m.%d.%H.%M.%SZ)\"-nospy.log\ndone\n```\n\n`run.sh`:\n\n```shell\n#!/bin/bash\nexport DANDI_API_KEY=---REDACTED---\nexport DANDI_DEVEL=1\n\nset -ex\ncd \"$(dirname \"$0\")\"\n. venv/bin/activate\n\ncd 214256\nfor layout in zarr128-smallfiles zarr64-smallfiles\ndo\n    rm -rf random.zarr\n    echo Generating random.zarr from $layout ...\n    chronic python3 ../zarr-digest-timings/mktree.py \\\n        random.zarr \\\n        ../zarr-digest-timings/layouts/$layout.json\n    echo \"Now: $(date)\"\n    if ! dandi upload --devel-debug -i dandi-staging --validation ignore -J 5:200 random.zarr\n    then echo \"Failed at: $(date)\"\n         exit 1\n    fi\n    echo \"Now: $(date)\"\ndone\n```","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1716398194,"metadata":{"github-id":"IC_kwDODBZtRc5-rnr8","github-url":"https://github.com/dandi/dandi-cli/issues/1408#issuecomment-2125363964"},"message":"Update: I just got the following error on smaug:\n\n```\nError uploading zarr: RuntimeError: requests.utils.super_len() reported size of 0 for '/home/jwodder/dandi-1408/214256/random.zarr/0/0/d0/d10/d7/f3.dat', but os.stat() reported size 1024 bytes 1 tries later\n```\n\nAccording to `df -T`, the `/home` directory on smaug is btrfs.","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1716398461,"metadata":{"github-id":"UCE_lALODBZtRc5-rnr8zkbcyqU"},"target":"36b51603c33fc3192926130c1a93ec09588d8c538e73842c95c4f122cb6c0149","message":"Update: I just got the following errors on smaug:\n\n- In a run with `DANDI_DEVEL_INSTRUMENT_REQUESTS_SUPERLEN=1` set:\n\n      Error uploading zarr: RuntimeError: requests.utils.super_len() reported size of 0 for '/home/jwodder/dandi-1408/214256/random.zarr/0/0/d0/d10/d7/f3.dat', but os.stat() reported size 1024 bytes 1 tries later\n\n- In a run without the envvar set, trying to upload a certain Zarr entry failed with the \"header implies functionality not implemented\" message.\n\nAccording to `df -T`, the `/home` directory on smaug is btrfs.","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1716399927,"metadata":{"github-id":"UCE_lALODBZtRc5-rnr8zkbdU-w"},"target":"36b51603c33fc3192926130c1a93ec09588d8c538e73842c95c4f122cb6c0149","message":"Update: I just got the following errors on smaug:\n\n- In a run with `DANDI_DEVEL_INSTRUMENT_REQUESTS_SUPERLEN=1` set:\n\n      Error uploading zarr: RuntimeError: requests.utils.super_len() reported size of 0 for '/home/jwodder/dandi-1408/214256/random.zarr/0/0/d0/d10/d7/f3.dat', but os.stat() reported size 1024 bytes 1 tries later\n\n- In a run without the envvar set, trying to upload a certain Zarr entry failed with the \"header implies functionality not implemented\" message.\n\nAccording to `df -T`, the `/home` directory on smaug is btrfs.\n\nEDIT: And now I've gotten \"Error: requests.utils.super_len() reported size of 0 for '/Users/jwodder/dartmouth/tmp/dandi-1408/214255/random.zarr/1/0/d0/d1/d9/f34.dat', but os.stat() reported size 1024 bytes 1 tries later\" on macOS (filesystem type: apfs).","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1716405834,"metadata":{"github-id":"IC_kwDODBZtRc5-seWn","github-url":"https://github.com/dandi/dandi-cli/issues/1408#issuecomment-2125587879"},"message":"\"fun!\" . \n- we can't trust `super_len` value of 0\n- worth reporting to requests or even Python itself (iirc it is some python library provided value)?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1716406248,"metadata":{"github-id":"IC_kwDODBZtRc5-shbT","github-url":"https://github.com/dandi/dandi-cli/issues/1408#issuecomment-2125600467"},"message":"@yarikoptic I'm going to try editing the source code of `super_len()` to add logging statements to see exactly what's going on, and then I'll likely (hopefully) end up filing an issue with `requests`.","files":null},{"type":5,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1716420019,"metadata":{"github-id":"LE_lADODBZtRc5_hYFPzwAAAAMA_qvv"},"added":["HIFNI"],"removed":[]},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1716420482,"metadata":{"github-id":"IC_kwDODBZtRc5-t0O7","github-url":"https://github.com/dandi/dandi-cli/issues/1408#issuecomment-2125939643"},"message":"@yarikoptic See #1444.","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1716502946,"metadata":{"github-id":"CE_lADODBZtRc5_hYFPzwAAAAMB2fMG"},"status":2},{"type":3,"author":{"id":"7a8552494914d3e4116f4b434eb4812a914ca405"},"timestamp":1716503006,"metadata":{"github-id":"IC_kwDODBZtRc5-2MeL","github-url":"https://github.com/dandi/dandi-cli/issues/1408#issuecomment-2128136075"},"message":"\u003c!-- GITHUB_RELEASE COMMENT: released --\u003e\n:rocket: Issue was released in [`0.62.1`](https://github.com/dandi/dandi-cli/releases/tag/0.62.1) :rocket:","files":null},{"type":5,"author":{"id":"7a8552494914d3e4116f4b434eb4812a914ca405"},"timestamp":1716503007,"metadata":{"github-id":"LE_lADODBZtRc5_hYFPzwAAAAMB2glg"},"added":["released"],"removed":[]}]}