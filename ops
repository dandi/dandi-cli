{"version":2,"ops":[{"type":1,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1702474640,"metadata":{"github-id":"I_kwDODBZtRc55k9k3","github-url":"https://github.com/dandi/dandi-cli/issues/1375","origin":"github"},"title":"add automagic retries on connection timeouts for dandiapi calls such as get_assets","message":"We have some daily test fail https://github.com/dandi/dandi-cli/actions/runs/7191372309/job/19585973231#step:8:41481\n\nwhile smoke testing example:\n```\nRun set -ex\n+ cd docs/source/examples\n+ for f in *.py\n+ python dandiapi-as_readable.py\nb'\\x89HDF'\nb'\\x0[1](https://github.com/dandi/dandi-cli/actions/runs/7191372309/job/19585973231#step:8:1)\\x00\\x00\\x00'\n+ for f in *.py\n+ python dandiapi-example.py\n```\n\n\u003cdetails\u003e\n\u003csummary\u003etimeout traceback\u003c/summary\u003e \n\n```shell\nTraceback (most recent call last):\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/urllib3/connectionpool.py\", line 467, in _make_request\n    six.raise_from(e, None)\n  File \"\u003cstring\u003e\", line 3, in raise_from\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/urllib3/connectionpool.py\", line 462, in _make_request\n    httplib_response = conn.getresponse()\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/http/client.py\", line 1348, in getresponse\n    response.begin()\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/http/client.py\", line 316, in begin\n    version, status, reason = self._read_status()\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/http/client.py\", line 277, in _read_status\n    line = str(self.fp.readline(_MAXLINE + 1), \"iso-8859-1\")\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/socket.py\", line 669, in readinto\n    return self._sock.recv_into(b)\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/ssl.py\", line 1274, in recv_into\n    return self.read(nbytes, buffer)\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/ssl.py\", line 1132, in read\n    return self._sslobj.read(len, buffer)\nTimeoutError: [Errno 110] Connection timed out\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/requests/adapters.py\", line 486, in send\n    resp = conn.urlopen(\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/urllib3/connectionpool.py\", line 799, in urlopen\n    retries = retries.increment(\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/urllib3/util/retry.py\", line 550, in increment\n    raise six.reraise(type(error), error, _stacktrace)\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/urllib3/packages/six.py\", line 770, in reraise\n    raise value\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/urllib3/connectionpool.py\", line 715, in urlopen\n    httplib_response = self._make_request(\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/urllib3/connectionpool.py\", line 469, in _make_request\n    self._raise_timeout(err=e, url=url, timeout_value=read_timeout)\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/urllib3/connectionpool.py\", line 375, in _raise_timeout\n    raise ReadTimeoutError(\nurllib3.exceptions.ReadTimeoutError: HTTPSConnectionPool(host='api.dandiarchive.org', port=443): Read timed out. (read timeout=None)\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"dandiapi-example.py\", line 10, in \u003cmodule\u003e\n    for asset in latest_dandiset.get_assets():\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/dandi/dandiapi.py\", line 1068, in get_assets\n    for a in self.client.paginate(\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/dandi/dandiapi.py\", line 393, in paginate\n    yield from f.result()\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/concurrent/futures/_base.py\", line 444, in result\n    return self.__get_result()\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/concurrent/futures/_base.py\", line 389, in __get_result\n    raise self._exception\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/concurrent/futures/thread.py\", line 57, in run\n    result = self.fn(*self.args, **self.kwargs)\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/dandi/dandiapi.py\", line 385, in get_page\n    results = self.get(path, params=params2)[\"results\"]\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/dandi/dandiapi.py\", line 303, in get\n    return self.request(\"GET\", path, **kwargs)\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/dandi/dandiapi.py\", line 199, in request\n    for i, attempt in enumerate(\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/tenacity/__init__.py\", line 347, in __iter__\n    do = self.iter(retry_state=retry_state)\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/tenacity/__init__.py\", line 314, in iter\n    return fut.result()\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/concurrent/futures/_base.py\", line 437, in result\n    return self.__get_result()\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/concurrent/futures/_base.py\", line 389, in __get_result\n    raise self._exception\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/dandi/dandiapi.py\", line 214, in request\n    result = self.session.request(\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/requests/sessions.py\", line 589, in request\n    resp = self.send(prep, **send_kwargs)\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/requests/sessions.py\", line 703, in send\n    r = adapter.send(request, **kwargs)\n  File \"/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages/requests/adapters.py\", line 532, in send\n    raise ReadTimeout(e, request=request)\nrequests.exceptions.ReadTimeout: HTTPSConnectionPool(host='api.dandiarchive.org', port=443): Read timed out. (read timeout=None)\nError: Process completed with exit code 1.\n```\n\u003c/details\u003e\n\nI guess we are either not retrying or not retrying enough.","files":null}]}