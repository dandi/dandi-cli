{"version":2,"ops":[{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1654102270,"metadata":{"github-id":"IC_kwDODBZtRc5ELhCt","github-url":"https://github.com/dandi/dandi-cli/issues/1025#issuecomment-1143869613"},"message":"@bendichter Can you post the logs for the download session (preferrably as a gist)?  On macOS, they are located in `~/Library/logs/dandi-cli`.","files":null},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1654102719,"metadata":{"github-id":"IC_kwDODBZtRc5ELjFC","github-url":"https://github.com/dandi/dandi-cli/issues/1025#issuecomment-1143877954"},"message":"https://gist.github.com/bendichter/25dfdcf75cc1ede9e86c6cd57f3052ce","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1654104259,"metadata":{"github-id":"IC_kwDODBZtRc5ELrWW","github-url":"https://github.com/dandi/dandi-cli/issues/1025#issuecomment-1143911830"},"message":"I see the problem.  URLs ending in `.../assets/?path={path}` are treated the same way as ones that end in `.../files/?location={path}/` for the purposes of determining the local path at which to save the file.  The problem is that the code assumes `{path}` in both cases points to a folder, which doesn't necessarily apply to the first type of URL, as such URLs can point to a single asset â€” or even a prefix of multiple asset paths that ends in the middle of a path component.\n\n@yarikoptic How should we determine the paths at which to download assets pointed to by `.../assets/?path={path}` URLs?  Currently, if `{path}` is `foo/bar` and it matches an asset `foo/bar/baz/quux`, the asset gets saved to `bar/baz/quux`.  In particular, what should we do when `{path}` is a prefix that stops in the middle of a path component, like `foo/ba`?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1654106495,"metadata":{"github-id":"IC_kwDODBZtRc5EL4Nk","github-url":"https://github.com/dandi/dandi-cli/issues/1025#issuecomment-1143964516"},"message":"lovely ... Given that `.../assets/?path={path}` could indeed point to **any** portion within real `{path}`, and results would not include \"folders\", It feels that we need to become \"smarty pants\" of some kind here.  What if we just strip away `Path(path).parent` here, i.e. for asset with path `f` it would be `{f[len(op.dirname(f)):]}`?\n\nhere is some experimentation -- seems to be sensible:\n\n```\nIn [39]: path='/a/b'; print(f\"path={path}\")\npath=/a/b\n\nIn [40]: for f in ['.nwb', '/c', '/a.nwb']: fp=f\"{path}{f}\".replace('//','/'); print(f\"asset {fp} -\u003e {fp[len(op.dirname(path)):].lstrip('/')}\")\nasset /a/b.nwb -\u003e b.nwb\nasset /a/b/c -\u003e b/c\nasset /a/b/a.nwb -\u003e b/a.nwb\n```\nso if `b` is really a folder -- we would get that folder locally.  But if `b` is a folder and `{path}` has trailing `/`:\n\n```\nIn [41]: path='/a/b/'; print(f\"path={path}\")\npath=/a/b/\n\nIn [42]: for f in ['.nwb', '/c', '/a.nwb']: fp=f\"{path}{f}\".replace('//','/'); print(f\"asset {fp} -\u003e {fp[len(op.dirname(path)):].lstrip('/')}\")\nasset /a/b/.nwb -\u003e .nwb\nasset /a/b/c -\u003e c\nasset /a/b/a.nwb -\u003e a.nwb\n```\n\nsimilarly to `rsync` we would get its content in curdir.  And just a test for \"top level\":\n\n```\nIn [43]: path='/'; print(f\"path={path}\")\npath=/\n\nIn [44]: for f in ['.nwb', '/c', '/a.nwb']: fp=f\"{path}{f}\".replace('//','/'); print(f\"asset {fp} -\u003e {fp[len(op.dirname(path)):].lstrip('/')}\")\nasset /.nwb -\u003e .nwb\nasset /c -\u003e c\nasset /a.nwb -\u003e a.nwb\n```","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1654225450,"metadata":{"github-id":"CE_lADODBZtRc5K4fhdzwAAAAGRVNC9"},"status":2},{"type":3,"author":{"id":"7a8552494914d3e4116f4b434eb4812a914ca405"},"timestamp":1654225511,"metadata":{"github-id":"IC_kwDODBZtRc5ER4we","github-url":"https://github.com/dandi/dandi-cli/issues/1025#issuecomment-1145539614"},"message":"\u003c!-- GITHUB_RELEASE COMMENT: released --\u003e\n:rocket: Issue was released in [`0.40.1`](https://github.com/dandi/dandi-cli/releases/tag/0.40.1) :rocket:","files":null},{"type":5,"author":{"id":"7a8552494914d3e4116f4b434eb4812a914ca405"},"timestamp":1654225512,"metadata":{"github-id":"LE_lADODBZtRc5K4fhdzwAAAAGRVOAV"},"added":["released"],"removed":[]},{"type":3,"author":{"id":"f068089e26f6e2e30d51a62e75a77af7d9dc5ecb"},"timestamp":1654262916,"metadata":{"github-id":"IC_kwDODBZtRc5ETg7W","github-url":"https://github.com/dandi/dandi-cli/issues/1025#issuecomment-1145966294"},"message":"thanks guys!","files":null}]}