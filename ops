{"version":2,"ops":[{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1612810512,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlRWRpdDo0OTA3NzEyOTE="},"target":"43c27e3d1b9618ae65bf96afa74016805e9dffd067dbd9a2d7b8e961e1ae9a95","message":"Blockers (AFAIK should be easy to address, so may be just send a PR @jwodder ):\n- [ ] https://github.com/dandi/dandi-api/issues/57\n\nOverall workflow:\n\n- Given a full collection of dandisets (so later we could upload data files as well), which is at `dandi@drogon:/mnt/backup/dandi/dandisets` or for now (since no data) just on a local copy which could be obtained quickly using `datalad install -r -J5 https://github.com/dandi/dandisets`\n- make a script which takes path(s) of dandisets to operate on, and for each given dandiset, \n  - uses `POST ​/dandisets​/`  to create a new one while providing metadata with original identifier (now possible, thanks to https://github.com/dandi/dandi-api/pull/87)\n  - uploads dandiset.yaml to that new dandiset (I am still a bit reluctant to merge it in, but we could do that if would make things easier)\n\nScript should have option to delete a dataset if already exists so we would just recreate it with that identifier for a \"clean start\"","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1612810518,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlRWRpdDo0OTA3NzEzMzM="},"target":"43c27e3d1b9618ae65bf96afa74016805e9dffd067dbd9a2d7b8e961e1ae9a95","message":"Blockers (AFAIK should be easy to address, so may be just send a PR @jwodder ):\n- [x] https://github.com/dandi/dandi-api/issues/57\n\nOverall workflow:\n\n- Given a full collection of dandisets (so later we could upload data files as well), which is at `dandi@drogon:/mnt/backup/dandi/dandisets` or for now (since no data) just on a local copy which could be obtained quickly using `datalad install -r -J5 https://github.com/dandi/dandisets`\n- make a script which takes path(s) of dandisets to operate on, and for each given dandiset, \n  - uses `POST ​/dandisets​/`  to create a new one while providing metadata with original identifier (now possible, thanks to https://github.com/dandi/dandi-api/pull/87)\n  - uploads dandiset.yaml to that new dandiset (I am still a bit reluctant to merge it in, but we could do that if would make things easier)\n\nScript should have option to delete a dataset if already exists so we would just recreate it with that identifier for a \"clean start\"","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1612810530,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlRWRpdDo0OTA3NzE0ODY="},"target":"43c27e3d1b9618ae65bf96afa74016805e9dffd067dbd9a2d7b8e961e1ae9a95","message":"Blockers (AFAIK should be easy to address, so may be just send a PR @jwodder ):\n- [x] ~~https://github.com/dandi/dandi-api/issues/57~~ no longer pertinent\n\nOverall workflow:\n\n- Given a full collection of dandisets (so later we could upload data files as well), which is at `dandi@drogon:/mnt/backup/dandi/dandisets` or for now (since no data) just on a local copy which could be obtained quickly using `datalad install -r -J5 https://github.com/dandi/dandisets`\n- make a script which takes path(s) of dandisets to operate on, and for each given dandiset, \n  - uses `POST ​/dandisets​/`  to create a new one while providing metadata with original identifier (now possible, thanks to https://github.com/dandi/dandi-api/pull/87)\n  - uploads dandiset.yaml to that new dandiset (I am still a bit reluctant to merge it in, but we could do that if would make things easier)\n\nScript should have option to delete a dataset if already exists so we would just recreate it with that identifier for a \"clean start\"","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1612465407,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc3MzUzNTk2NA==","github-url":"https://github.com/dandi/dandi-cli/issues/360#issuecomment-773535964"},"message":"* You don't need to worry about `DELETE`ing anything. Just `POST /scripts/map_ids/` whenever there is a dandiset that has the wrong identifier, and the script will move it if it is able. That includes creating a new dandiset, copying the owners, making all the existing versions point to the new dandiset, and deleting the old dandiset. \n* Nope, he just needs to be logged in. This is a temporary hack on a non-deployed system, so security is laxer in the name of convenience.","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1612465461,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc3MzUzNjQ3NA==","github-url":"https://github.com/dandi/dandi-cli/issues/360#issuecomment-773536474"},"message":"I also put in https://github.com/dandi/dandi-api/pull/86 to address https://github.com/dandi/dandi-api/issues/57","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1612532491,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc3NDAzNzg0Nw==","github-url":"https://github.com/dandi/dandi-cli/issues/360#issuecomment-774037847"},"message":"@yarikoptic \n\n\u003e uses `POST ​/dandisets​/` to create a new one (with some ID above 1000s)\n\nThat endpoint doesn't have an option for setting the ID.","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1612532491,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDMyNjgzODgx"},"target":"92449f249d1161f942f1c1e4f85562736b18941cbd792895b353b888832ac2a3","message":"@yarikoptic \n\n\u003e uses `POST ​/dandisets​/` to create a new one (with some ID above 1000s)\n\nThat endpoint doesn't have an option for setting the ID.\n\nAlso, is there a reason to set the metadata via `client.set_dandiset_metadata()` (as #357 does) rather than just including the metadata in the `POST /dandisets/` request?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1612532886,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc3NDA0MzE5Mg==","github-url":"https://github.com/dandi/dandi-cli/issues/360#issuecomment-774043192"},"message":"\u003e \u003e uses `POST ​/dandisets​/` to create a new one (with some ID above 1000s)\n\u003e \n\u003e That endpoint doesn't have an option for setting the ID.\n\nit will mint (and return I suppose) a new one.  That is why we need to do the \"remap\" dance.  Relevant issue is https://github.com/dandi/dandi-api/issues/69\n\n\u003e Also, is there a reason to set the metadata via `client.set_dandiset_metadata()` (as #357 does) rather than just including the metadata in the `POST /dandisets/` request?\n\nI guess it will set it with the minted identifier and we would need to overload it with the \"target\" (original) one so remap does its job later.  It it would not overwrite identifier with the minted one (didn't check) - might be considered a bug IMHO","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1612533257,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc3NDA0NjM4Ng==","github-url":"https://github.com/dandi/dandi-cli/issues/360#issuecomment-774046386"},"message":"@yarikoptic But what do you mean by \"with some ID above 1000s\"?  How is the client supposed to ensure that?  Are you saying that `POST /scripts/map_ids/` should be called twice for each Dandiset, once to move post-1000 and again to move to the final ID?\n\n\u003e I guess it will set it with the minted identifier and we would need to overload it with the \"target\" (original) one so remap does its job later. It it would not overwrite identifier with the minted one (didn't check) - might be considered a bug IMHO\n\nI don't understand what you're trying to say here.  My question was about setting the entire metadata — not just the identifier — for the Dandiset based on the contents of `dandiset.yaml` and when that should happen.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1612533376,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc3NDA0NzUyOQ==","github-url":"https://github.com/dandi/dandi-cli/issues/360#issuecomment-774047529"},"message":"Also, should this script do anything with assets, or is it only manipulating metadata \u0026 identifiers?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1612534967,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc3NDA2MjI3Mw==","github-url":"https://github.com/dandi/dandi-cli/issues/360#issuecomment-774062273"},"message":"\u003e @yarikoptic But what do you mean by \"with some ID above 1000s\"?\n\nsorry for not being descriptive -- it is just how dandi-api now mints IDs if you create a new datataset -- they will all be above 1000.\n\n\u003e Are you saying that POST /scripts/map_ids/ should be called twice for each Dandiset, once to move post-1000 and again to move to the final ID?\n\nnah - just once.  It would take that \"original\" ID (`\u003c1000`) from metadata and map that dandiset from its minted `\u003e1000` id into it.\n\n\u003e Also, should this script do anything with assets, or is it only manipulating metadata \u0026 identifiers?\n\nfor now - not.  Only dandiset level metadata.  Later I will try \"manually\" on a few dandisets","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1612538055,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc3NDA5MzU1Ng==","github-url":"https://github.com/dandi/dandi-cli/issues/360#issuecomment-774093556"},"message":"@dchiquito Is the `{dandiset_id}` in the path of `POST ​/scripts​/map_ids​/{dandiset_id}​/` supposed to be the ID that the Dandiset is being moved *from* or *to*?  How do I specify the other ID?","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1612539042,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc3NDEwNDE4MA==","github-url":"https://github.com/dandi/dandi-cli/issues/360#issuecomment-774104180"},"message":"Moved from. If you have a dandiset with identifier `111111` in Django, but the metadata specifies `\"identifier\": \"DANDI:222222\"`, you would call `POST /scripts/map_ids/111111`. Afterwards, `111111` would no longer exist and the original dandiset will have identifier `222222`. \n\nAlternatively, calling `POST /scripts/map_ids/` will just check all dandisets. If there's nothing to move, it won't move anything.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1612540462,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc3NDExODU3Ng==","github-url":"https://github.com/dandi/dandi-cli/issues/360#issuecomment-774118576"},"message":"@dchiquito @yarikoptic I've written a script and am testing against the latest version of dandi-api, but:\n\n* The IDs for new Dandisets are still starting at 000001, not 1000\n* Regardless of whether the metadata is set at Dandiset creation or via `client.set_dandiset_metadata()` (i.e., `PUT /dandisets/{dandiset_id}/versions/draft/`), the ID in the metadata for the resulting Dandiset version object always gets set to the autogenerated ID instead of the ID in the supplied metadata read from `dandiset.yaml`.  As a result, `POST ​/scripts​/map_ids​/{dandiset_id}​/` does nothing.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1612541073,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc3NDEyNDk1NA==","github-url":"https://github.com/dandi/dandi-cli/issues/360#issuecomment-774124954"},"message":"\u003e * The IDs for new Dandisets are still starting at 000001, not 1000\n\nFWIW I have just tried on https://api.dandiarchive.org/swagger/ and it created\n```\n{\n  \"identifier\": \"001008\",\n  \"created\": \"2021-02-05T16:00:12.520948Z\",\n  \"modified\": \"2021-02-05T16:00:12.520986Z\",\n  \"most_recent_version\": {\n    \"version\": \"draft\",\n    \"name\": \"the name\",\n    \"asset_count\": 0,\n    \"size\": 0,\n    \"created\": \"2021-02-05T16:00:12.625912Z\",\n    \"modified\": \"2021-02-05T16:00:12.625955Z\",\n    \"dandiset\": {\n      \"identifier\": \"001008\",\n      \"created\": \"2021-02-05T16:00:12.520948Z\",\n      \"modified\": \"2021-02-05T16:00:12.520986Z\"\n    }\n  }\n}\n```\n\n\u003e the ID in the metadata for the resulting Dandiset version object always gets set to the autogenerated ID instead of the ID in the supplied metadata read from dandiset.yaml\n\nhm, haven't tried, but if so - mapping cannot be done... I guess needs to be fixed, or a proper way (just allow to provide identifier) be implemented, please advise @dchiquito","files":null},{"type":3,"author":{"id":"be5d9cd197657770bbbabb5faa204fd4dcdcba01"},"timestamp":1612542665,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc3NDE0MDMzMQ==","github-url":"https://github.com/dandi/dandi-cli/issues/360#issuecomment-774140331"},"message":"\u003e @dchiquito @yarikoptic I've written a script and am testing against the latest version of dandi-api, but:\n\u003e \n\u003e * The IDs for new Dandisets are still starting at 000001, not 1000\n\u003e * Regardless of whether the metadata is set at Dandiset creation or via `client.set_dandiset_metadata()` (i.e., `PUT /dandisets/{dandiset_id}/versions/draft/`), the ID in the metadata for the resulting Dandiset version object always gets set to the autogenerated ID instead of the ID in the supplied metadata read from `dandiset.yaml`.  As a result, `POST ​/scripts​/map_ids​/{dandiset_id}​/` does nothing.\n\n@yarik Is it an issue to temporarily disable metadata population of identifier until the migration has been done?","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1612548486,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc3NDE5NjI1NQ==","github-url":"https://github.com/dandi/dandi-cli/issues/360#issuecomment-774196255"},"message":"As Jacob mentioned, the identifier in the metadata is now being set to the identifier of the dandiset in Django, which breaks the map_ids script :cry: I am working on adding the ability to create a dandiset with a specific identifier, as requested.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1612810571,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc3NTM2NjcxNA==","github-url":"https://github.com/dandi/dandi-cli/issues/360#issuecomment-775366714"},"message":"@jwodder Now thanks to https://github.com/dandi/dandi-api/pull/87 workflow is simplified, I adjusted the description to reflect that, and we should be ok to proceed","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1612814953,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc3NTQxMjA0MA==","github-url":"https://github.com/dandi/dandi-cli/issues/360#issuecomment-775412040"},"message":"@yarikoptic \n\n\u003e uploads dandiset.yaml to that new dandiset\n\nDo you mean that `dandiset.yaml` should be uploaded by using it to set the Dandiset's metadata — which is already done when the Dandiset is created — or that it should be uploaded as an asset — which (as far as I understand it) is not what assets are for?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1612819636,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc3NTQ3NDE1Mw==","github-url":"https://github.com/dandi/dandi-cli/issues/360#issuecomment-775474153"},"message":"I just meant `dandi upload dandiset.yaml` call, but indeed if full converted metadata is passed during create, this might not even be necessary now!","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1612884731,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50NDMwOTg0MjY4OQ=="},"status":2}]}