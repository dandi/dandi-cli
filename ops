{"version":2,"ops":[{"type":6,"author":{"id":"21bbe6f5e3272d3fe8aa9b85bbd29a984d2b0505"},"timestamp":1600020922,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlRWRpdDo0MjgxNTMzNjE="},"target":"09da3568dc311c0c92b5855fe9203408dd156806b7180d595f78ea0f5fc85230","message":"I'm trying to upload data from the Allen Institute but when I call `dandi upload` I get the following error:\n\n`2020-09-12 10:08:49,180 [    INFO] Found 101 files to consider  \nError: Failed to lock dandiset 000039`\n\nThe repo has already been created: https://gui.dandiarchive.org/#/dandiset/000039/draft. `dandi validate` was successful and my 000036/ directory contains 33 sub-*/ folders with valid sym links.\n\nThanks,\nKael","files":null},{"type":6,"author":{"id":"21bbe6f5e3272d3fe8aa9b85bbd29a984d2b0505"},"timestamp":1600020933,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlRWRpdDo0MjgxNTMzODE="},"target":"09da3568dc311c0c92b5855fe9203408dd156806b7180d595f78ea0f5fc85230","message":"I'm trying to upload data from the Allen Institute but when I call `dandi upload` I get the following error:\n\n`2020-09-12 10:08:49,180 [    INFO] Found 101 files to consider`\n`Error: Failed to lock dandiset 000039`\n\nThe repo has already been created: https://gui.dandiarchive.org/#/dandiset/000039/draft. `dandi validate` was successful and my 000036/ directory contains 33 sub-*/ folders with valid sym links.\n\nThanks,\nKael","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1600027291,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY5MTcxNzg3MA==","github-url":"https://github.com/dandi/dandi-cli/issues/238#issuecomment-691717870"},"message":"Was there some interrupted upload?\n We definitely should provide more information though on the nature of the existing lock. I will look into fixing it tomorrow, thanks for the report.","files":null},{"type":3,"author":{"id":"21bbe6f5e3272d3fe8aa9b85bbd29a984d2b0505"},"timestamp":1600034138,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY5MTczMTAxNQ==","github-url":"https://github.com/dandi/dandi-cli/issues/238#issuecomment-691731015"},"message":"I tried a few times throughout the day and still got the same error message. I was doing this through a VPN so the internet was working.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1600116146,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY5MjMwMjY3MA==","github-url":"https://github.com/dandi/dandi-cli/issues/238#issuecomment-692302670"},"message":"A little update - instead of just pruning the lock so you could progress forward, @mgrauer will check first on girder server side on what has lead to that stale lock to come to exist, and then we will remove it so you could proceed with the upload.","files":null},{"type":3,"author":{"id":"c8082a0f6b38dd60d28641b213f904bcd85419c2"},"timestamp":1600120704,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY5MjMzNjA2NA==","github-url":"https://github.com/dandi/dandi-cli/issues/238#issuecomment-692336064"},"message":"@yarikoptic We looked in Girder and don't see any lock on that dandiset.\n\nIf you go to the [swagger page API endpoint](https://girder.dandiarchive.org/api/v1#!/dandi/dandi_wrapper_0_1_2_3_4_5_6) and run the unlock endpoint, it will say that the dandiset isn't currently locked.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1600124481,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY5MjM2MzAzOQ==","github-url":"https://github.com/dandi/dandi-cli/issues/238#issuecomment-692363039"},"message":"Thank you Mike! Might then be some other issue (permissions etc) and client being stupid to report it properly, I will later provide further guidance to get closure.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1600131956,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY5MjM5ODgwOA==","github-url":"https://github.com/dandi/dandi-cli/issues/238#issuecomment-692398808"},"message":"Dear @kaeldai , please install the version from #239 via e.g. `pip3 install --upgrade git+https://github.com/dandi/dandi-cli@enh-lock2` and rerun the upload. Error message should provide more information then which would help to identify actual problem.","files":null},{"type":3,"author":{"id":"21bbe6f5e3272d3fe8aa9b85bbd29a984d2b0505"},"timestamp":1600133343,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY5MjQwNTc4NQ==","github-url":"https://github.com/dandi/dandi-cli/issues/238#issuecomment-692405785"},"message":"Hi @yarikoptic - I'm now getting a slightly different error message:\n\n`2020-09-14 18:21:30,475 [    INFO] Found 101 files to consider`\n`Error: Failed to lock dandiset 000039 due to: You must be logged in.`\n\nMy dandi account is linked to my github account. I checked and git's user.name and user.email is correct on the machine I'm trying to run a dandi upload from.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1600207366,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY5MzAwMzQ5Nw==","github-url":"https://github.com/dandi/dandi-cli/issues/238#issuecomment-693003497"},"message":"I have looked through the code and not sure yet how this could happen since we do authenticate into girder first.  Please \n- rerun `pip3 install --upgrade git+https://github.com/dandi/dandi-cli@enh-lock2`\n- run your upload as `DANDI_DEVEL=1 dandi -l debug upload --devel-debug [any other options you need]`\n- paste (or email me debian@onerussian.com) the log so I could see what is happening with authentication etc","files":null},{"type":3,"author":{"id":"21bbe6f5e3272d3fe8aa9b85bbd29a984d2b0505"},"timestamp":1600226183,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY5MzE0NDk2NA==","github-url":"https://github.com/dandi/dandi-cli/issues/238#issuecomment-693144964"},"message":"@yarikoptic thanks for all your help. This is the command line output I recieve:\n\n```\n2020-09-15 20:11:08,938 [   DEBUG] Running a newer version (0.6.4+2.g51bab5d) of dandi/dandi-cli than available (0.6.4)\n2020-09-15 20:11:10,667 [   DEBUG] Establishing a client for https://girder.dandiarchive.org\n2020-09-15 20:11:10,906 [   DEBUG] Successfully authenticated using the key\n2020-09-15 20:11:11,147 [   DEBUG] Working with collection {'_accessLevel': -1, '_id': '5e59bb0af19e820ab6ea6c62', '_modelType': 'collection', 'created': '2020-02-29T01:14:50.702000+00:00', 'description': '', 'meta': {}, 'name': 'drafts', 'public': True, 'size': 2565925161435, 'updated': '2020-03-03T21:03:41.237000+00:00'}\n2020-09-15 20:11:11,590 [    INFO] Found 101 files to consider\n2020-09-15 20:11:11,593 [   DEBUG] Trying to acquire lock for 000039\n2020-09-15 20:11:11,836 [   DEBUG] Caught exception Failed to lock dandiset 000039 due to: You must be logged in.\nTraceback (most recent call last):\n  File \"/local1/.local/miniconda3/envs/nwb_conversion/lib/python3.6/site-packages/dandi/girder.py\", line 512, in lock_dandiset\n    resp = self.post(f\"dandi/{dandiset_identifier}/lock\")\n  File \"/local1/.local/miniconda3/envs/nwb_conversion/lib/python3.6/site-packages/girder_client/__init__.py\", line 479, in post\n    data=data, json=json, headers=headers, jsonResp=jsonResp)\n  File \"/local1/.local/miniconda3/envs/nwb_conversion/lib/python3.6/site-packages/girder_client/__init__.py\", line 465, in sendRestRequest\n    response=result)\ngirder_client.HttpError: HTTP error 401: POST https://girder.dandiarchive.org/api/v1/dandi/000039/lock\nResponse text: {\"message\": \"You must be logged in.\", \"type\": \"access\"}\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/local1/.local/miniconda3/envs/nwb_conversion/bin/dandi\", line 8, in \u003cmodule\u003e\n    sys.exit(main())\n  File \"/local1/.local/miniconda3/envs/nwb_conversion/lib/python3.6/site-packages/click/core.py\", line 829, in __call__\n    return self.main(*args, **kwargs)\n  File \"/local1/.local/miniconda3/envs/nwb_conversion/lib/python3.6/site-packages/click/core.py\", line 782, in main\n    rv = self.invoke(ctx)\n  File \"/local1/.local/miniconda3/envs/nwb_conversion/lib/python3.6/site-packages/click/core.py\", line 1259, in invoke\n    return _process_result(sub_ctx.command.invoke(sub_ctx))\n  File \"/local1/.local/miniconda3/envs/nwb_conversion/lib/python3.6/site-packages/click/core.py\", line 1066, in invoke\n    return ctx.invoke(self.callback, **ctx.params)\n  File \"/local1/.local/miniconda3/envs/nwb_conversion/lib/python3.6/site-packages/click/core.py\", line 610, in invoke\n    return callback(*args, **kwargs)\n  File \"/local1/.local/miniconda3/envs/nwb_conversion/lib/python3.6/site-packages/dandi/cli/base.py\", line 106, in wrapper\n    return f(*args, **kwargs)\n  File \"/local1/.local/miniconda3/envs/nwb_conversion/lib/python3.6/site-packages/dandi/cli/cmd_upload.py\", line 101, in upload\n    devel_debug=devel_debug,\n  File \"/local1/.local/miniconda3/envs/nwb_conversion/lib/python3.6/site-packages/dandi/upload.py\", line 519, in upload\n    with out, client.lock_dandiset(dandiset.identifier):\n  File \"/local1/.local/miniconda3/envs/nwb_conversion/lib/python3.6/contextlib.py\", line 81, in __enter__\n    return next(self.gen)\n  File \"/local1/.local/miniconda3/envs/nwb_conversion/lib/python3.6/site-packages/dandi/girder.py\", line 517, in lock_dandiset\n    f\"Failed to lock dandiset {dandiset_identifier} due to: {msg}\"\ndandi.exceptions.LockingError: Failed to lock dandiset 000039 due to: You must be logged in.\n```","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1600227450,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY5MzE1MDIyNg==","github-url":"https://github.com/dandi/dandi-cli/issues/238#issuecomment-693150226"},"message":"Thank you. So session is authenticated. @mgrauer - anything in the logs could some the light why user can't lock dandiset? is it about login to django? May be owned by another user or scope is insufficient (in either of those cases error message isn't corresponding to the actual problem)","files":null},{"type":3,"author":{"id":"c8082a0f6b38dd60d28641b213f904bcd85419c2"},"timestamp":1600269711,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY5MzQ3ODQ3Mw==","github-url":"https://github.com/dandi/dandi-cli/issues/238#issuecomment-693478473"},"message":"I believe this is an API key issue, the dandi cli API key now needs a full scope because of changes introduced with locking, but previous keys had custom scopes.\n\nI deleted kaeldai's old key in Girder (description of this below for reference). @kaeldai can you go into gui.dandiarchive.org and log in, and click on your user initials at the top right, there will be a dropdown, the first row is the apikey, click the refresh button (the circled arrow) and this will generate a new key with you that has full scope. Use this new apikey with the CLI, and see if this works.\n\nThanks for your patience!\n\n\n\n\n\u003cdetails\u003e\n\u003csummary\u003eDescription of api key deletion, for a user\u003c/summary\u003e\n\nThis will also work if you are a Girder admin as you have the ability to delete other users' keys, as I did in this case.\n\nLog into `https://girder.dandiarchive.org/` with the same credentials as you log into `gui.dandiarchive.org`.\n\nClick on the dropdown under your username for `My account`\n\n\u003cimg width=\"198\" alt=\"Screen Shot 2020-09-16 at 11 09 43 AM\" src=\"https://user-images.githubusercontent.com/595023/93356735-8f42bb80-f80d-11ea-877c-0b1d0e2b6a26.png\"\u003e\n\nThen click on the `API keys` tab, and you'll see a apikey named dandicli. Yours currently says custom scopes, but we need a key with full access. Delete that api key.\n\n\n\u003cimg width=\"1275\" alt=\"Screen Shot 2020-09-16 at 11 17 39 AM\" src=\"https://user-images.githubusercontent.com/595023/93357682-98805800-f80e-11ea-9588-9fe0296210cb.png\"\u003e\n\n\n\u003c/details\u003e","files":null},{"type":3,"author":{"id":"21bbe6f5e3272d3fe8aa9b85bbd29a984d2b0505"},"timestamp":1600275385,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY5MzUzNDI0MA==","github-url":"https://github.com/dandi/dandi-cli/issues/238#issuecomment-693534240"},"message":"@yarikoptic @mgrauer Thanks, that seems to have done the trick and the upload seems to have been successful.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1600276709,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY5MzU0NTY0NQ==","github-url":"https://github.com/dandi/dandi-cli/issues/238#issuecomment-693545645"},"message":"GREAT!\n@mgrauer THANK YOU for tracking it down.   Closing it now and will merge #239 since would be generally useful\n\nNote: In \"no-girder\" reimplementation of API/backend we must make sure that error messages provided back are more descriptive of the cause which possibly lead to the error message.","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1600276710,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50Mzc3NDI2NDUwMQ=="},"status":2},{"type":3,"author":{"id":"c8082a0f6b38dd60d28641b213f904bcd85419c2"},"timestamp":1600276976,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY5MzU0Nzg2MQ==","github-url":"https://github.com/dandi/dandi-cli/issues/238#issuecomment-693547861"},"message":"I'm wondering what we should do for the rest of the users who will run into this.\n\nShould we go through all of the existing api keys and delete any dandicli keys that don't have full access? Let people run into the issue and then provide guidance? Provide some message in the cli to suggest this as a fix? \n\nWhat do you think @yarikoptic ?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1600282645,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY5MzU5NzUzMg==","github-url":"https://github.com/dandi/dandi-cli/issues/238#issuecomment-693597532"},"message":"If error message (from dandiarchive's girder extension?) could be adjusted to say that (instead of just \"must be logged in\") -- then with #239 now merged (and hopefully soon released), users would see that message.","files":null},{"type":3,"author":{"id":"c8082a0f6b38dd60d28641b213f904bcd85419c2"},"timestamp":1600283376,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY5MzYwMzk4Ng==","github-url":"https://github.com/dandi/dandi-cli/issues/238#issuecomment-693603986"},"message":"This message comes from upstream girder, i'm not able to change that in the dandiarchive girder plugin.","files":null}]}