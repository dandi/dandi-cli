{"version":2,"ops":[{"type":1,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1624635997,"metadata":{"github-id":"MDU6SXNzdWU5MzAyOTU5ODk=","github-url":"https://github.com/dandi/dandi-cli/issues/682","origin":"github"},"title":"dandi-api tests against dandi-cli started to fail in staging","message":"- master seems to be fine: https://github.com/dandi/dandi-api/actions/workflows/cli-integration.yml?query=branch%3Amaster . \n- [ ] submitted https://github.com/dandi/dandi-api/pull/366  to simplify archaeological expeditions in the future\n- for a proper solution IMHO we need dandi-api to\n  - [ ] show a proper version - have https://github.com/dandi/dandi-api/issues/222 addressed\n  - [ ] boost version whenever a breaking change is introduced https://github.com/dandi/dandi-api/issues/368\n  - [ ] dandi-cli to code in different logic depending on API version\n- but may be there is a simple workaround for now (didn't look in detail of failures) ?\n- might relate to #677 although there it worked fine for me\n\n\u003cdetails\u003e\n\u003csummary\u003ecut/paste from one of the broken runs\u003c/summary\u003e \n\n```shell\n2021-06-23T23:40:13.7802778Z _________________________ test_download_newest_version _________________________\n2021-06-23T23:40:13.7803114Z \n2021-06-23T23:40:13.7804913Z local_dandi_api = {'api_key': '4e15b41f88e021a134c2a8bef3fdb0975794e56c', 'client': \u003cdandi.dandiapi.DandiAPIClient object at 0x7f3d31374...di_instance(gui=None, redirector=None, api='http://localhost:8000/api'), 'instance_id': 'dandi-api-local-docker-tests'}\n2021-06-23T23:40:13.7807532Z text_dandiset = {'client': \u003cdandi.dandiapi.DandiAPIClient object at 0x7f3d31374970\u003e, 'dandiset_id': '000028', 'dspath': PosixPath('/tm...-of-runner/pytest-0/text_dandiset23'), 'reupload': \u003cfunction text_dandiset.\u003clocals\u003e.upload_dandiset at 0x7f3d300f7280\u003e}\n2021-06-23T23:40:13.7809214Z tmp_path = PosixPath('/tmp/pytest-of-runner/pytest-0/test_download_newest_version0')\n2021-06-23T23:40:13.7809742Z \n2021-06-23T23:40:13.7810278Z     def test_download_newest_version(local_dandi_api, text_dandiset, tmp_path):\n2021-06-23T23:40:13.7810917Z         dandiset_id = text_dandiset[\"dandiset_id\"]\n2021-06-23T23:40:13.7811753Z         download(f\"{local_dandi_api['instance'].api}/dandisets/{dandiset_id}\", tmp_path)\n2021-06-23T23:40:13.7812495Z         assert (tmp_path / dandiset_id / \"file.txt\").read_text() == \"This is test text.\\n\"\n2021-06-23T23:40:13.7813190Z \u003e       text_dandiset[\"client\"].publish_version(dandiset_id, \"draft\")\n2021-06-23T23:40:13.7813583Z \n2021-06-23T23:40:13.7814400Z /opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/tests/test_download.py:134: \n2021-06-23T23:40:13.7815095Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n2021-06-23T23:40:13.7815989Z /opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/dandiapi.py:628: in publish_version\n2021-06-23T23:40:13.7816714Z     return self.post(\n2021-06-23T23:40:13.7817657Z /opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/dandiapi.py:213: in post\n2021-06-23T23:40:13.7818364Z     return self.send_request(\n2021-06-23T23:40:13.7818794Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n2021-06-23T23:40:13.7819045Z \n2021-06-23T23:40:13.7819852Z self = \u003cdandi.dandiapi.DandiAPIClient object at 0x7f3d31374970\u003e, method = 'POST'\n2021-06-23T23:40:13.7820887Z path = '/dandisets/000028/versions/draft/publish/', parameters = {}, data = None\n2021-06-23T23:40:13.7821575Z files = None, json = None, headers = None, json_resp = True, retry = None\n2021-06-23T23:40:13.7822068Z kwargs = {}\n2021-06-23T23:40:13.7822732Z f = \u003cbound method Session.post of \u003crequests.sessions.Session object at 0x7f3d3148c730\u003e\u003e\n2021-06-23T23:40:13.7823807Z url = 'http://localhost:8000/api/dandisets/000028/versions/draft/publish/'\n2021-06-23T23:40:13.7825175Z _headers = {'Authorization': 'token 4e15b41f88e021a134c2a8bef3fdb0975794e56c', 'User-Agent': 'dandi/0.20.0 requests/2.25.1 CPython/3.8.10', 'accept': 'application/json'}\n2021-06-23T23:40:13.7826283Z doretry = \u003ctenacity.retry.retry_any object at 0x7f3d2bfd5c10\u003e\n2021-06-23T23:40:13.7826874Z result = \u003cResponse [400]\u003e\n2021-06-23T23:40:13.7827784Z msg = 'Error 400 while sending POST request to http://localhost:8000/api/dandisets/000028/versions/draft/publish/'\n2021-06-23T23:40:13.7828352Z \n2021-06-23T23:40:13.7828693Z     def send_request(\n2021-06-23T23:40:13.7829042Z         self,\n2021-06-23T23:40:13.7829367Z         method,\n2021-06-23T23:40:13.7829684Z         path,\n2021-06-23T23:40:13.7830052Z         parameters=None,\n2021-06-23T23:40:13.7830419Z         data=None,\n2021-06-23T23:40:13.7830858Z         files=None,\n2021-06-23T23:40:13.7831189Z         json=None,\n2021-06-23T23:40:13.7831548Z         headers=None,\n2021-06-23T23:40:13.7831908Z         json_resp=True,\n2021-06-23T23:40:13.7832267Z         retry=None,\n2021-06-23T23:40:13.7832596Z         **kwargs,\n2021-06-23T23:40:13.7832905Z     ):\n2021-06-23T23:40:13.7833177Z         \"\"\"\n2021-06-23T23:40:13.7833721Z         This method looks up the appropriate method, constructs a request URL\n2021-06-23T23:40:13.7834481Z         from the base URL, path, and parameters, and then sends the request. If\n2021-06-23T23:40:13.7835178Z         the method is unknown or if the path is not found, an exception is\n2021-06-23T23:40:13.7835875Z         raised, otherwise a JSON object is returned with the response.\n2021-06-23T23:40:13.7836357Z     \n2021-06-23T23:40:13.7836862Z         This is a convenience method to use when making basic requests that do\n2021-06-23T23:40:13.7837594Z         not involve multipart file data that might need to be specially encoded\n2021-06-23T23:40:13.7838204Z         or handled differently.\n2021-06-23T23:40:13.7838564Z     \n2021-06-23T23:40:13.7839059Z         :param method: The HTTP method to use in the request (GET, POST, etc.)\n2021-06-23T23:40:13.7839603Z         :type method: str\n2021-06-23T23:40:13.7840149Z         :param path: A string containing the path elements for this request.\n2021-06-23T23:40:13.7841237Z             Note that the path string should not begin or end with the path  separator, '/'.\n2021-06-23T23:40:13.7841793Z         :type path: str\n2021-06-23T23:40:13.7842368Z         :param parameters: A dictionary mapping strings to strings, to be used\n2021-06-23T23:40:13.7843046Z             as the key/value pairs in the request parameters.\n2021-06-23T23:40:13.7843576Z         :type parameters: dict\n2021-06-23T23:40:13.7844352Z         :param data: A dictionary, bytes or file-like object to send in the body.\n2021-06-23T23:40:13.7845357Z         :param files: A dictionary of 'name' =\u003e file-like-objects for multipart encoding upload.\n2021-06-23T23:40:13.7846017Z         :type files: dict\n2021-06-23T23:40:13.7846499Z         :param json: A JSON object to send in the request body.\n2021-06-23T23:40:13.7846979Z         :type json: dict\n2021-06-23T23:40:13.7847557Z         :param headers: If present, a dictionary of headers to encode in the request.\n2021-06-23T23:40:13.7848189Z         :type headers: dict\n2021-06-23T23:40:13.7848860Z         :param json_resp: Whether the response should be parsed as JSON. If False, the raw\n2021-06-23T23:40:13.7849658Z             response object is returned. To get the raw binary content of the response,\n2021-06-23T23:40:13.7850375Z             use the ``content`` attribute of the return value, e.g.\n2021-06-23T23:40:13.7850814Z     \n2021-06-23T23:40:13.7851541Z             .. code-block:: python\n2021-06-23T23:40:13.7851886Z     \n2021-06-23T23:40:13.7852499Z                 resp = client.get('my/endpoint', json_resp=False)\n2021-06-23T23:40:13.7853095Z                 print(resp.content)  # Raw binary content\n2021-06-23T23:40:13.7853676Z                 print(resp.headers)  # Dict of headers\n2021-06-23T23:40:13.7854082Z     \n2021-06-23T23:40:13.7854429Z         :type json_resp: bool\n2021-06-23T23:40:13.7855001Z         :param retry: an optional tenacity `retry` argument for retrying the\n2021-06-23T23:40:13.7855540Z             request method\n2021-06-23T23:40:13.7855883Z         \"\"\"\n2021-06-23T23:40:13.7856229Z         if not parameters:\n2021-06-23T23:40:13.7856641Z             parameters = {}\n2021-06-23T23:40:13.7856969Z     \n2021-06-23T23:40:13.7857347Z         # Look up the HTTP method we need\n2021-06-23T23:40:13.7857810Z         f = self._request_func(method)\n2021-06-23T23:40:13.7858185Z     \n2021-06-23T23:40:13.7858526Z         url = self.get_url(path)\n2021-06-23T23:40:13.7858877Z     \n2021-06-23T23:40:13.7859386Z         # Make the request, passing parameters and authentication info\n2021-06-23T23:40:13.7860004Z         _headers = dict(self._headers)\n2021-06-23T23:40:13.7860417Z         if headers:\n2021-06-23T23:40:13.7860928Z             _headers.update(headers)\n2021-06-23T23:40:13.7861325Z     \n2021-06-23T23:40:13.7861711Z         if json_resp and \"accept\" not in _headers:\n2021-06-23T23:40:13.7862251Z             _headers[\"accept\"] = \"application/json\"\n2021-06-23T23:40:13.7862654Z     \n2021-06-23T23:40:13.7863064Z         lgr.debug(\"%s %s\", method.upper(), url)\n2021-06-23T23:40:13.7863465Z     \n2021-06-23T23:40:13.7864177Z         # urllib3's ConnectionPool isn't thread-safe, so we sometimes hit\n2021-06-23T23:40:13.7864948Z         # ConnectionErrors on the start of an upload.  Retry when this happens.\n2021-06-23T23:40:13.7865704Z         # Cf. \u003chttps://github.com/urllib3/urllib3/issues/951\u003e.\n2021-06-23T23:40:13.7866371Z         doretry = tenacity.retry_if_exception_type(\n2021-06-23T23:40:13.7866991Z             requests.ConnectionError\n2021-06-23T23:40:13.7867635Z         ) | tenacity.retry_if_result(lambda r: r.status_code == 503)\n2021-06-23T23:40:13.7868144Z         if retry is not None:\n2021-06-23T23:40:13.7868547Z             doretry |= retry\n2021-06-23T23:40:13.7868865Z     \n2021-06-23T23:40:13.7869155Z         try:\n2021-06-23T23:40:13.7869552Z             result = try_multiple(5, doretry, 1.1)(\n2021-06-23T23:40:13.7870238Z                 f,\n2021-06-23T23:40:13.7870543Z                 url,\n2021-06-23T23:40:13.7870938Z                 params=parameters,\n2021-06-23T23:40:13.7871349Z                 data=data,\n2021-06-23T23:40:13.7871704Z                 files=files,\n2021-06-23T23:40:13.7872068Z                 json=json,\n2021-06-23T23:40:13.7872442Z                 headers=_headers,\n2021-06-23T23:40:13.7872825Z                 **kwargs,\n2021-06-23T23:40:13.7873133Z             )\n2021-06-23T23:40:13.7873490Z         except Exception:\n2021-06-23T23:40:13.7873992Z             lgr.exception(\"HTTP connection failed\")\n2021-06-23T23:40:13.7874454Z             raise\n2021-06-23T23:40:13.7874743Z     \n2021-06-23T23:40:13.7875187Z         lgr.debug(\"Response: %d\", result.status_code)\n2021-06-23T23:40:13.7875619Z     \n2021-06-23T23:40:13.7876172Z         # If success, return the json object. Otherwise throw an exception.\n2021-06-23T23:40:13.7876824Z         if not result.ok:\n2021-06-23T23:40:13.7877498Z             msg = f\"Error {result.status_code} while sending {method} request to {url}\"\n2021-06-23T23:40:13.7878159Z             if result.status_code == 409:\n2021-06-23T23:40:13.7898212Z                 # Blob exists on server; log at DEBUG level\n2021-06-23T23:40:13.7898823Z                 lgr.debug(\"%s: %s\", msg, result.text)\n2021-06-23T23:40:13.7899253Z             else:\n2021-06-23T23:40:13.7899702Z                 lgr.error(\"%s: %s\", msg, result.text)\n2021-06-23T23:40:13.7900308Z \u003e           raise requests.HTTPError(msg, response=result)\n2021-06-23T23:40:13.7901432Z E           requests.exceptions.HTTPError: Error 400 while sending POST request to http://localhost:8000/api/dandisets/000028/versions/draft/publish/\n2021-06-23T23:40:13.7902244Z \n2021-06-23T23:40:13.7903233Z /opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/dandiapi.py:177: HTTPError\n2021-06-23T23:40:13.7904280Z ------------------------------ Captured log setup ------------------------------\n2021-06-23T23:40:13.7905062Z DEBUG    dandi:dandiapi.py:141 POST http://localhost:8000/api/dandisets/\n2021-06-23T23:40:13.7905745Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.7906422Z DEBUG    dandi:dandiapi.py:141 GET http://localhost:8000/api/auth/token\n2021-06-23T23:40:13.7907084Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.7907922Z DEBUG    dandi:dandiset.py:99 Found identifier 000028 in top level 'identifier'\n2021-06-23T23:40:13.7908589Z INFO     dandi:upload.py:75 Found 5 files to consider\n2021-06-23T23:40:13.7909371Z DEBUG    dandi:dandiapi.py:141 GET http://localhost:8000/api/dandisets/000028/versions/draft/assets/\n2021-06-23T23:40:13.7910127Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.7911149Z ERROR    dandi:upload.py:249 Failed to extract metadata from /tmp/pytest-of-runner/pytest-0/text_dandiset23/file.txt\n2021-06-23T23:40:13.7912044Z Traceback (most recent call last):\n2021-06-23T23:40:13.7913143Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/upload.py\", line 245, in process_path\n2021-06-23T23:40:13.7914301Z     asset_metadata = nwb2asset(\n2021-06-23T23:40:13.7915350Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/metadata.py\", line 670, in nwb2asset\n2021-06-23T23:40:13.7916137Z     metadata = get_metadata(nwb_path)\n2021-06-23T23:40:13.7917201Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/fscacher/cache.py\", line 116, in fingerprinter\n2021-06-23T23:40:13.7918058Z     ret = fingerprinted(path, *args, **kwargs_)\n2021-06-23T23:40:13.7919084Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/joblib/memory.py\", line 591, in __call__\n2021-06-23T23:40:13.7919865Z     return self._cached_call(args, kwargs)[0]\n2021-06-23T23:40:13.7921707Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/joblib/memory.py\", line 534, in _cached_call\n2021-06-23T23:40:13.7922522Z     out, metadata = self.call(*args, **kwargs)\n2021-06-23T23:40:13.7923552Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/joblib/memory.py\", line 761, in call\n2021-06-23T23:40:13.7924286Z     output = self.func(*args, **kwargs)\n2021-06-23T23:40:13.7925349Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/fscacher/cache.py\", line 84, in fingerprinted\n2021-06-23T23:40:13.7926155Z     return f(path, *args, **kwargs)\n2021-06-23T23:40:13.7927153Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/metadata.py\", line 51, in get_metadata\n2021-06-23T23:40:13.7927957Z     meta[\"nwb_version\"] = get_nwb_version(path)\n2021-06-23T23:40:13.7929009Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/pynwb_utils.py\", line 95, in get_nwb_version\n2021-06-23T23:40:13.7929812Z     with h5py.File(filepath, \"r\") as h5file:\n2021-06-23T23:40:13.7930828Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/h5py/_hl/files.py\", line 406, in __init__\n2021-06-23T23:40:13.7931592Z     fid = make_fid(name, mode, userblock_size,\n2021-06-23T23:40:13.7932717Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/h5py/_hl/files.py\", line 173, in make_fid\n2021-06-23T23:40:13.7933481Z     fid = h5f.open(name, flags, fapl=fapl)\n2021-06-23T23:40:13.7934148Z   File \"h5py/_objects.pyx\", line 54, in h5py._objects.with_phil.wrapper\n2021-06-23T23:40:13.7934957Z   File \"h5py/_objects.pyx\", line 55, in h5py._objects.with_phil.wrapper\n2021-06-23T23:40:13.7935639Z   File \"h5py/h5f.pyx\", line 88, in h5py.h5f.open\n2021-06-23T23:40:13.7936205Z OSError: Unable to open file (file signature not found)\n2021-06-23T23:40:13.7937528Z DEBUG    dandi:dandiapi.py:454 Calculated dandi-etag of d5b215bbddf463221d1cc55c31098d40-1 for /tmp/pytest-of-runner/pytest-0/text_dandiset23/file.txt\n2021-06-23T23:40:13.7938598Z DEBUG    dandi:dandiapi.py:463 file.txt: Beginning upload\n2021-06-23T23:40:13.7939386Z DEBUG    dandi:dandiapi.py:141 POST http://localhost:8000/api/uploads/initialize/\n2021-06-23T23:40:13.7940110Z DEBUG    dandi:dandiapi.py:167 Response: 409\n2021-06-23T23:40:13.7940995Z DEBUG    dandi:dandiapi.py:174 Error 409 while sending POST request to http://localhost:8000/api/uploads/initialize/: \"Blob already exists.\"\n2021-06-23T23:40:13.7941965Z DEBUG    dandi:dandiapi.py:478 file.txt: Blob already exists on server\n2021-06-23T23:40:13.7942714Z DEBUG    dandi:dandiapi.py:551 file.txt: Assigning asset blob to dandiset \u0026 version\n2021-06-23T23:40:13.7943597Z DEBUG    dandi:dandiapi.py:141 GET http://localhost:8000/api/dandisets/000028/versions/draft/assets/\n2021-06-23T23:40:13.7944333Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.7945098Z DEBUG    dandi:dandiapi.py:141 POST http://localhost:8000/api/dandisets/000028/versions/draft/assets/\n2021-06-23T23:40:13.7945870Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.7946576Z INFO     dandi:dandiapi.py:565 file.txt: Asset successfully uploaded\n2021-06-23T23:40:13.7947428Z DEBUG    dandi:dandiapi.py:141 GET http://localhost:8000/api/dandisets/000028/versions/draft/assets/\n2021-06-23T23:40:13.7948203Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.7949336Z ERROR    dandi:upload.py:249 Failed to extract metadata from /tmp/pytest-of-runner/pytest-0/text_dandiset23/subdir2/coconut.txt\n2021-06-23T23:40:13.7950169Z Traceback (most recent call last):\n2021-06-23T23:40:13.7951199Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/upload.py\", line 245, in process_path\n2021-06-23T23:40:13.7951979Z     asset_metadata = nwb2asset(\n2021-06-23T23:40:13.7952975Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/metadata.py\", line 670, in nwb2asset\n2021-06-23T23:40:13.7953755Z     metadata = get_metadata(nwb_path)\n2021-06-23T23:40:13.7954811Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/fscacher/cache.py\", line 116, in fingerprinter\n2021-06-23T23:40:13.7955653Z     ret = fingerprinted(path, *args, **kwargs_)\n2021-06-23T23:40:13.7956682Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/joblib/memory.py\", line 591, in __call__\n2021-06-23T23:40:13.7957445Z     return self._cached_call(args, kwargs)[0]\n2021-06-23T23:40:13.7958471Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/joblib/memory.py\", line 534, in _cached_call\n2021-06-23T23:40:13.7959269Z     out, metadata = self.call(*args, **kwargs)\n2021-06-23T23:40:13.7960250Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/joblib/memory.py\", line 761, in call\n2021-06-23T23:40:13.7961111Z     output = self.func(*args, **kwargs)\n2021-06-23T23:40:13.7962167Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/fscacher/cache.py\", line 84, in fingerprinted\n2021-06-23T23:40:13.7962949Z     return f(path, *args, **kwargs)\n2021-06-23T23:40:13.7963956Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/metadata.py\", line 51, in get_metadata\n2021-06-23T23:40:13.7964753Z     meta[\"nwb_version\"] = get_nwb_version(path)\n2021-06-23T23:40:13.7965865Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/pynwb_utils.py\", line 95, in get_nwb_version\n2021-06-23T23:40:13.7966689Z     with h5py.File(filepath, \"r\") as h5file:\n2021-06-23T23:40:13.7967692Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/h5py/_hl/files.py\", line 406, in __init__\n2021-06-23T23:40:13.7968465Z     fid = make_fid(name, mode, userblock_size,\n2021-06-23T23:40:13.7969482Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/h5py/_hl/files.py\", line 173, in make_fid\n2021-06-23T23:40:13.7970230Z     fid = h5f.open(name, flags, fapl=fapl)\n2021-06-23T23:40:13.7970915Z   File \"h5py/_objects.pyx\", line 54, in h5py._objects.with_phil.wrapper\n2021-06-23T23:40:13.7971729Z   File \"h5py/_objects.pyx\", line 55, in h5py._objects.with_phil.wrapper\n2021-06-23T23:40:13.7972400Z   File \"h5py/h5f.pyx\", line 88, in h5py.h5f.open\n2021-06-23T23:40:13.7972983Z OSError: Unable to open file (file signature not found)\n2021-06-23T23:40:13.7974306Z DEBUG    dandi:dandiapi.py:454 Calculated dandi-etag of c461208d22d3fd53da6f748284d1b49f-1 for /tmp/pytest-of-runner/pytest-0/text_dandiset23/subdir2/coconut.txt\n2021-06-23T23:40:13.7975446Z DEBUG    dandi:dandiapi.py:463 subdir2/coconut.txt: Beginning upload\n2021-06-23T23:40:13.7976278Z DEBUG    dandi:dandiapi.py:141 POST http://localhost:8000/api/uploads/initialize/\n2021-06-23T23:40:13.7976989Z DEBUG    dandi:dandiapi.py:167 Response: 409\n2021-06-23T23:40:13.7977884Z DEBUG    dandi:dandiapi.py:174 Error 409 while sending POST request to http://localhost:8000/api/uploads/initialize/: \"Blob already exists.\"\n2021-06-23T23:40:13.7978892Z DEBUG    dandi:dandiapi.py:478 subdir2/coconut.txt: Blob already exists on server\n2021-06-23T23:40:13.7979814Z DEBUG    dandi:dandiapi.py:551 subdir2/coconut.txt: Assigning asset blob to dandiset \u0026 version\n2021-06-23T23:40:13.7980744Z DEBUG    dandi:dandiapi.py:141 GET http://localhost:8000/api/dandisets/000028/versions/draft/assets/\n2021-06-23T23:40:13.7981486Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.7982257Z DEBUG    dandi:dandiapi.py:141 POST http://localhost:8000/api/dandisets/000028/versions/draft/assets/\n2021-06-23T23:40:13.7983007Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.7983696Z INFO     dandi:dandiapi.py:565 subdir2/coconut.txt: Asset successfully uploaded\n2021-06-23T23:40:13.7984582Z DEBUG    dandi:dandiapi.py:141 GET http://localhost:8000/api/dandisets/000028/versions/draft/assets/\n2021-06-23T23:40:13.7985333Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.7986432Z ERROR    dandi:upload.py:249 Failed to extract metadata from /tmp/pytest-of-runner/pytest-0/text_dandiset23/subdir2/banana.txt\n2021-06-23T23:40:13.7987252Z Traceback (most recent call last):\n2021-06-23T23:40:13.7988278Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/upload.py\", line 245, in process_path\n2021-06-23T23:40:13.7989036Z     asset_metadata = nwb2asset(\n2021-06-23T23:40:13.7990049Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/metadata.py\", line 670, in nwb2asset\n2021-06-23T23:40:13.7990836Z     metadata = get_metadata(nwb_path)\n2021-06-23T23:40:13.7991877Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/fscacher/cache.py\", line 116, in fingerprinter\n2021-06-23T23:40:13.7992736Z     ret = fingerprinted(path, *args, **kwargs_)\n2021-06-23T23:40:13.7993767Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/joblib/memory.py\", line 591, in __call__\n2021-06-23T23:40:13.7994520Z     return self._cached_call(args, kwargs)[0]\n2021-06-23T23:40:13.7995541Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/joblib/memory.py\", line 534, in _cached_call\n2021-06-23T23:40:13.7996332Z     out, metadata = self.call(*args, **kwargs)\n2021-06-23T23:40:13.7997329Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/joblib/memory.py\", line 761, in call\n2021-06-23T23:40:13.7998080Z     output = self.func(*args, **kwargs)\n2021-06-23T23:40:13.7999195Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/fscacher/cache.py\", line 84, in fingerprinted\n2021-06-23T23:40:13.7999992Z     return f(path, *args, **kwargs)\n2021-06-23T23:40:13.8001156Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/metadata.py\", line 51, in get_metadata\n2021-06-23T23:40:13.8001947Z     meta[\"nwb_version\"] = get_nwb_version(path)\n2021-06-23T23:40:13.8003016Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/pynwb_utils.py\", line 95, in get_nwb_version\n2021-06-23T23:40:13.8003829Z     with h5py.File(filepath, \"r\") as h5file:\n2021-06-23T23:40:13.8004826Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/h5py/_hl/files.py\", line 406, in __init__\n2021-06-23T23:40:13.8005602Z     fid = make_fid(name, mode, userblock_size,\n2021-06-23T23:40:13.8006601Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/h5py/_hl/files.py\", line 173, in make_fid\n2021-06-23T23:40:13.8007366Z     fid = h5f.open(name, flags, fapl=fapl)\n2021-06-23T23:40:13.8008046Z   File \"h5py/_objects.pyx\", line 54, in h5py._objects.with_phil.wrapper\n2021-06-23T23:40:13.8008838Z   File \"h5py/_objects.pyx\", line 55, in h5py._objects.with_phil.wrapper\n2021-06-23T23:40:13.8009525Z   File \"h5py/h5f.pyx\", line 88, in h5py.h5f.open\n2021-06-23T23:40:13.8010110Z OSError: Unable to open file (file signature not found)\n2021-06-23T23:40:13.8011432Z DEBUG    dandi:dandiapi.py:454 Calculated dandi-etag of 1f2406f328ccfc069d2844d6fa64e564-1 for /tmp/pytest-of-runner/pytest-0/text_dandiset23/subdir2/banana.txt\n2021-06-23T23:40:13.8012567Z DEBUG    dandi:dandiapi.py:463 subdir2/banana.txt: Beginning upload\n2021-06-23T23:40:13.8013459Z DEBUG    dandi:dandiapi.py:141 POST http://localhost:8000/api/uploads/initialize/\n2021-06-23T23:40:13.8014188Z DEBUG    dandi:dandiapi.py:167 Response: 409\n2021-06-23T23:40:13.8015069Z DEBUG    dandi:dandiapi.py:174 Error 409 while sending POST request to http://localhost:8000/api/uploads/initialize/: \"Blob already exists.\"\n2021-06-23T23:40:13.8016082Z DEBUG    dandi:dandiapi.py:478 subdir2/banana.txt: Blob already exists on server\n2021-06-23T23:40:13.8016918Z DEBUG    dandi:dandiapi.py:551 subdir2/banana.txt: Assigning asset blob to dandiset \u0026 version\n2021-06-23T23:40:13.8017821Z DEBUG    dandi:dandiapi.py:141 GET http://localhost:8000/api/dandisets/000028/versions/draft/assets/\n2021-06-23T23:40:13.8018572Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.8019323Z DEBUG    dandi:dandiapi.py:141 POST http://localhost:8000/api/dandisets/000028/versions/draft/assets/\n2021-06-23T23:40:13.8020083Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.8020773Z INFO     dandi:dandiapi.py:565 subdir2/banana.txt: Asset successfully uploaded\n2021-06-23T23:40:13.8021652Z DEBUG    dandi:dandiapi.py:141 GET http://localhost:8000/api/dandisets/000028/versions/draft/assets/\n2021-06-23T23:40:13.8022404Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.8023493Z ERROR    dandi:upload.py:249 Failed to extract metadata from /tmp/pytest-of-runner/pytest-0/text_dandiset23/subdir1/apple.txt\n2021-06-23T23:40:13.8024328Z Traceback (most recent call last):\n2021-06-23T23:40:13.8025339Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/upload.py\", line 245, in process_path\n2021-06-23T23:40:13.8026122Z     asset_metadata = nwb2asset(\n2021-06-23T23:40:13.8027138Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/metadata.py\", line 670, in nwb2asset\n2021-06-23T23:40:13.8027904Z     metadata = get_metadata(nwb_path)\n2021-06-23T23:40:13.8028960Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/fscacher/cache.py\", line 116, in fingerprinter\n2021-06-23T23:40:13.8029818Z     ret = fingerprinted(path, *args, **kwargs_)\n2021-06-23T23:40:13.8030833Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/joblib/memory.py\", line 591, in __call__\n2021-06-23T23:40:13.8031605Z     return self._cached_call(args, kwargs)[0]\n2021-06-23T23:40:13.8032711Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/joblib/memory.py\", line 534, in _cached_call\n2021-06-23T23:40:13.8033501Z     out, metadata = self.call(*args, **kwargs)\n2021-06-23T23:40:13.8034513Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/joblib/memory.py\", line 761, in call\n2021-06-23T23:40:13.8035252Z     output = self.func(*args, **kwargs)\n2021-06-23T23:40:13.8047179Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/fscacher/cache.py\", line 84, in fingerprinted\n2021-06-23T23:40:13.8048045Z     return f(path, *args, **kwargs)\n2021-06-23T23:40:13.8049088Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/metadata.py\", line 51, in get_metadata\n2021-06-23T23:40:13.8049904Z     meta[\"nwb_version\"] = get_nwb_version(path)\n2021-06-23T23:40:13.8050968Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/dandi/pynwb_utils.py\", line 95, in get_nwb_version\n2021-06-23T23:40:13.8051774Z     with h5py.File(filepath, \"r\") as h5file:\n2021-06-23T23:40:13.8052794Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/h5py/_hl/files.py\", line 406, in __init__\n2021-06-23T23:40:13.8053564Z     fid = make_fid(name, mode, userblock_size,\n2021-06-23T23:40:13.8054584Z   File \"/opt/hostedtoolcache/Python/3.8.10/x64/lib/python3.8/site-packages/h5py/_hl/files.py\", line 173, in make_fid\n2021-06-23T23:40:13.8055346Z     fid = h5f.open(name, flags, fapl=fapl)\n2021-06-23T23:40:13.8056011Z   File \"h5py/_objects.pyx\", line 54, in h5py._objects.with_phil.wrapper\n2021-06-23T23:40:13.8056983Z   File \"h5py/_objects.pyx\", line 55, in h5py._objects.with_phil.wrapper\n2021-06-23T23:40:13.8057669Z   File \"h5py/h5f.pyx\", line 88, in h5py.h5f.open\n2021-06-23T23:40:13.8058242Z OSError: Unable to open file (file signature not found)\n2021-06-23T23:40:13.8059569Z DEBUG    dandi:dandiapi.py:454 Calculated dandi-etag of 61ad88b8426662e2466f70234dc02c4b-1 for /tmp/pytest-of-runner/pytest-0/text_dandiset23/subdir1/apple.txt\n2021-06-23T23:40:13.8060662Z DEBUG    dandi:dandiapi.py:463 subdir1/apple.txt: Beginning upload\n2021-06-23T23:40:13.8061483Z DEBUG    dandi:dandiapi.py:141 POST http://localhost:8000/api/uploads/initialize/\n2021-06-23T23:40:13.8062217Z DEBUG    dandi:dandiapi.py:167 Response: 409\n2021-06-23T23:40:13.8063104Z DEBUG    dandi:dandiapi.py:174 Error 409 while sending POST request to http://localhost:8000/api/uploads/initialize/: \"Blob already exists.\"\n2021-06-23T23:40:13.8064110Z DEBUG    dandi:dandiapi.py:478 subdir1/apple.txt: Blob already exists on server\n2021-06-23T23:40:13.8064936Z DEBUG    dandi:dandiapi.py:551 subdir1/apple.txt: Assigning asset blob to dandiset \u0026 version\n2021-06-23T23:40:13.8065858Z DEBUG    dandi:dandiapi.py:141 GET http://localhost:8000/api/dandisets/000028/versions/draft/assets/\n2021-06-23T23:40:13.8066607Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.8067569Z DEBUG    dandi:dandiapi.py:141 POST http://localhost:8000/api/dandisets/000028/versions/draft/assets/\n2021-06-23T23:40:13.8068343Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.8069019Z INFO     dandi:dandiapi.py:565 subdir1/apple.txt: Asset successfully uploaded\n2021-06-23T23:40:13.8070009Z ------------------------------ Captured log call -------------------------------\n2021-06-23T23:40:13.8070816Z DEBUG    dandi:dandiarchive.py:423 Parsing url http://localhost:8000/api/dandisets/000028\n2021-06-23T23:40:13.8072422Z DEBUG    dandi:dandiarchive.py:536 Parsed into DandisetURL(api_url=AnyHttpUrl('http://localhost:8000/api', scheme='http', host='localhost', host_type='int_domain', port='8000', path='/api'), dandiset_id='000028', version_id=None)\n2021-06-23T23:40:13.8073662Z DEBUG    dandi:dandiapi.py:141 GET http://localhost:8000/api/dandisets/000028/\n2021-06-23T23:40:13.8074329Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.8075078Z DEBUG    dandi:dandiapi.py:141 GET http://localhost:8000/api/dandisets/000028/versions/draft/info/\n2021-06-23T23:40:13.8075901Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.8076598Z DEBUG    dandi:dandiapi.py:141 GET http://localhost:8000/api/dandisets/000028/\n2021-06-23T23:40:13.8077287Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.8077991Z DEBUG    dandi:download.py:397 Updating dandiset.yaml from obtained dandiset metadata\n2021-06-23T23:40:13.8079021Z DEBUG    dandi:dandiset.py:99 Found identifier DANDI:000028 in top level 'identifier'\n2021-06-23T23:40:13.8079895Z DEBUG    dandi:dandiapi.py:141 GET http://localhost:8000/api/dandisets/000028/versions/draft/assets/\n2021-06-23T23:40:13.8080651Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.8081943Z DEBUG    dandi:dandiapi.py:141 GET http://localhost:8000/api/dandisets/000028/versions/draft/assets/993c6a66-34df-40a3-81d1-c516ee2f6831/\n2021-06-23T23:40:13.8082843Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.8084015Z DEBUG    dandi:dandiapi.py:141 GET http://localhost:8000/api/dandisets/000028/versions/draft/assets/7c545b63-eb4c-4afe-9197-c54d36ea5e5d/\n2021-06-23T23:40:13.8084932Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.8086083Z DEBUG    dandi:dandiapi.py:141 GET http://localhost:8000/api/dandisets/000028/versions/draft/assets/fd73f535-18fe-4ba4-b794-c320023a8cf6/\n2021-06-23T23:40:13.8086979Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.8088087Z DEBUG    dandi:dandiapi.py:141 GET http://localhost:8000/api/dandisets/000028/versions/draft/assets/d723f463-9a38-4d8a-9339-497b06be6c68/\n2021-06-23T23:40:13.8088943Z DEBUG    dandi:dandiapi.py:167 Response: 200\n2021-06-23T23:40:13.8089699Z DEBUG    dandi:download.py:667 Starting new download in new download directory\n2021-06-23T23:40:13.8091067Z DEBUG    dandi:dandiapi.py:375 Starting download from http://localhost:8000/api/dandisets/000028/versions/draft/assets/993c6a66-34df-40a3-81d1-c516ee2f6831/download/\n2021-06-23T23:40:13.8092457Z INFO     dandi:dandiapi.py:389 Asset 993c6a66-34df-40a3-81d1-c516ee2f6831 successfully downloaded\n2021-06-23T23:40:13.8094038Z DEBUG    dandi:download.py:606 Verified that /tmp/pytest-of-runner/pytest-0/test_download_newest_version0/000028/file.txt has correct dandi-etag d5b215bbddf463221d1cc55c31098d40-1\n2021-06-23T23:40:13.8095233Z DEBUG    dandi:download.py:667 Starting new download in new download directory\n2021-06-23T23:40:13.8096640Z DEBUG    dandi:dandiapi.py:375 Starting download from http://localhost:8000/api/dandisets/000028/versions/draft/assets/7c545b63-eb4c-4afe-9197-c54d36ea5e5d/download/\n2021-06-23T23:40:13.8098115Z INFO     dandi:dandiapi.py:389 Asset 7c545b63-eb4c-4afe-9197-c54d36ea5e5d successfully downloaded\n2021-06-23T23:40:13.8099736Z DEBUG    dandi:download.py:606 Verified that /tmp/pytest-of-runner/pytest-0/test_download_newest_version0/000028/subdir2/coconut.txt has correct dandi-etag c461208d22d3fd53da6f748284d1b49f-1\n2021-06-23T23:40:13.8100951Z DEBUG    dandi:download.py:667 Starting new download in new download directory\n2021-06-23T23:40:13.8102341Z DEBUG    dandi:dandiapi.py:375 Starting download from http://localhost:8000/api/dandisets/000028/versions/draft/assets/fd73f535-18fe-4ba4-b794-c320023a8cf6/download/\n2021-06-23T23:40:13.8103778Z INFO     dandi:dandiapi.py:389 Asset fd73f535-18fe-4ba4-b794-c320023a8cf6 successfully downloaded\n2021-06-23T23:40:13.8105388Z DEBUG    dandi:download.py:606 Verified that /tmp/pytest-of-runner/pytest-0/test_download_newest_version0/000028/subdir2/banana.txt has correct dandi-etag 1f2406f328ccfc069d2844d6fa64e564-1\n2021-06-23T23:40:13.8106584Z DEBUG    dandi:download.py:667 Starting new download in new download directory\n2021-06-23T23:40:13.8107930Z DEBUG    dandi:dandiapi.py:375 Starting download from http://localhost:8000/api/dandisets/000028/versions/draft/assets/d723f463-9a38-4d8a-9339-497b06be6c68/download/\n2021-06-23T23:40:13.8109294Z INFO     dandi:dandiapi.py:389 Asset d723f463-9a38-4d8a-9339-497b06be6c68 successfully downloaded\n2021-06-23T23:40:13.8110898Z DEBUG    dandi:download.py:606 Verified that /tmp/pytest-of-runner/pytest-0/test_download_newest_version0/000028/subdir1/apple.txt has correct dandi-etag 61ad88b8426662e2466f70234dc02c4b-1\n2021-06-23T23:40:13.8112196Z DEBUG    dandi:dandiapi.py:141 POST http://localhost:8000/api/dandisets/000028/versions/draft/publish/\n2021-06-23T23:40:13.8112953Z DEBUG    dandi:dandiapi.py:167 Response: 400\n2021-06-23T23:40:13.8113974Z ERROR    dandi:dandiapi.py:176 Error 400 while sending POST request to http://localhost:8000/api/dandisets/000028/versions/draft/publish/: \"Dandiset metadata or asset metadata is not valid\"\n```\n\u003c/details\u003e\nother broken runs could be found in PRs against staging, e.g. https://github.com/dandi/dandi-api/pull/353","files":null}]}