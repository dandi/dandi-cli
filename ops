{"version":2,"ops":[{"type":1,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1597352782,"metadata":{"github-id":"MDU6SXNzdWU2Nzg3MzQyMTE=","github-url":"https://github.com/dandi/dandi-cli/issues/198","origin":"github"},"title":"download: download into a temp file + rename / clean upon failed attempt","message":"As of 0.6.0 implementation `download` downloads directly into the target location.\n\nIn common scenarios it is better to download into some temporary location and then move into the target location upon successful completion.  That avoids users ending up with partial downloads which represent broken .nwb files without knowing that they are partial downloads.  Similar strategy is used e.g. by chrome browser and girder client which we stopped used for download (only to initiate streamed download).\n\nUnlike girder_client we do not want to download to a TMPDIR folder, since file could be large and `/tmp` could be lacking that much space and transfer into target location could entail additional delay.  I think the best would be to download into a temp file in the target location folder but with some prefix or suffix. E.g. for file `a/blah.nwb`, keep original one (if present) file (until renaming \"into\" it) and download into `a/blah.nwb-dandidownload` to be renamed into `a/blah.nwb` upon successful completion.  \n\nWhat to do if download is interrupted (my preferences are *emphasized*).  We could\n- remove partial download: but that might not happen if process is hard killed/power went down, so even if implemented we would need logic (below) to deal with them found on the drive\n- *keep partial download*: could be beneficial to e.g. establish resumed download, so I think we should proceed this way \n\nAt the beginning of the download, what to do if a partial download found:\n\n- that could mean that there is a 2nd `dandi` client running ATM for the same dandiset.  I think that the easiest would be for a download to *establish a lock file*, e.g. using fasteners library, to reside probably along side in `blah.nwb.lck` (well, there is `write_locked` helpers so may be a separate lck file is not even needed)\n- easiest -- just remove and start a new: since we will be dealing with large files -- could be very wasteful/undesired\n- with #189 we would be able to *resume download*. BUT before resuming, it would be necessary to establish first that the file on the remote end is still the same as original (interrupted) download.  For that reason, while locking the file for the download ideally we should store somewhere (may be filename as in `-dandidownload-\u003cCHECKSUM\u003e`) checksum we obtain from the metadata?  If no checksum was \"recorded\" - download from the start.  If there was checksum, and matches what is about to be downloaded, just roll back a chunk and try to resume... if resume fails (due to read in \"check\" chunk differs as in #189) - start from the beginning.\n\nBut may be if we rely on checksum we should just download into some `.dandi/tmp/\u003cCHECKSUM\u003e` and lock there?  What do you think @jwodder ?","files":null}]}