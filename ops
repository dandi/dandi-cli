{"version":2,"ops":[{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1734577763,"metadata":{"github-id":"IC_kwDODBZtRc6YJtWf","github-url":"https://github.com/dandi/dandi-cli/issues/1553#issuecomment-2552681887"},"message":"happened agin\n\n```\n2024-12-16T23:12:30-0500 [ERROR   ] dandi 893263:139627788764864 Caught while downloading sub-I48/ses-SPIM/micr/sub-I48_ses-SPIM_sample-BrocaAreaS03_stain-Somatostatin_SPIM.ome.zarr:\nTraceback (most recent call last):\n  File \"/mnt/backup/tmp/yoh/venv/dev/lib/python3.11/site-packages/dandi/download.py\", line 421, in _download_generator_guard\n    yield from generator\n  File \"/mnt/backup/tmp/yoh/venv/dev/lib/python3.11/site-packages/dandi/download.py\", line 1065, in _download_zarr\n    zarr_checksum = asset.get_digest().value\n                    ^^^^^^^^^^^^^^^^^^\n  File \"/mnt/backup/tmp/yoh/venv/dev/lib/python3.11/site-packages/dandi/dandiapi.py\", line 1513, in get_digest\n    return Digest(algorithm=algorithm, value=self.get_raw_digest(algorithm))\n                                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/mnt/backup/tmp/yoh/venv/dev/lib/python3.11/site-packages/dandi/dandiapi.py\", line 1499, in get_raw_digest\n    assert isinstance(digest, str)\nAssertionError\n```\n\nneed to do type checking etc.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1734666834,"metadata":{"github-id":"IC_kwDODBZtRc6YXQzK","github-url":"https://github.com/dandi/dandi-cli/issues/1553#issuecomment-2556234954"},"message":"we encounter zarr for which we have  size and checksum 0\n\n```\n❯ curl -X 'GET' --silent 'https://api.dandiarchive.org/api/dandisets/000026/versions/draft/assets/?path=sub-I48%2Fses-SPIM%2Fmicr%2Fsub-I48_ses-SPIM_sample-BrocaAreaS03_stain-Somatostatin_SPIM.ome.zarr\u0026metadata=true' -H 'accept: application/json' -H 'X-CSRFTOKEN: wTUZx1u5sMThqoLPhpAxD6TubffnRiFNTWXBxjXPRokYFa3kNB71LWKnwuJndJcA' | jq '.results[0] | ( .size, .zarr, .metadata.digest )'\n0\n\"7933bc72-ec3f-4043-8076-d7aa8a70e4f7\"\n{\n  \"dandi:dandi-zarr-checksum\": null\n}\n```\n\nalthough files are uploaded\n\n```\n$ aws s3 ls s3://dandiarchive/zarr/7933bc72-ec3f-4043-8076-d7aa8a70e4f7/\n                           PRE 0/\n                           PRE 1/\n                           PRE 2/\n                           PRE 3/\n                           PRE 4/\n2024-06-14 07:42:52       2824 .zattrs\n2024-04-14 14:50:05         24 .zgroup\n```\n\nand that zarr is still pending!\n\n```shell\n❯ curl --silent -X 'GET' 'https://api.dandiarchive.org/api/zarr/7933bc72-ec3f-4043-8076-d7aa8a70e4f7/' -H 'accept: application/json' -H 'X-CSRFTOKEN: wTUZx1u5sMThqoLPhpAxD6TubffnRiFNTWXBxjXPRokYFa3kNB71LWKnwuJndJcA' | jq .\n{\n  \"name\": \"sub-I48/ses-SPIM/micr/sub-I48_ses-SPIM_sample-BrocaAreaS03_stain-Somatostatin_SPIM.ome.zarr\",\n  \"dandiset\": \"000026\",\n  \"zarr_id\": \"7933bc72-ec3f-4043-8076-d7aa8a70e4f7\",\n  \"status\": \"Pending\",\n  \"checksum\": null,\n  \"file_count\": 0,\n  \"size\": 0\n}\n```\n\nso we are back in the effects of various issues with zarrs in the dandi-archive:\n- see https://github.com/dandi/dandi-archive/issues/2067#issuecomment-2556231233 and there on","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1734669196,"metadata":{"github-id":"IC_kwDODBZtRc6YXYj7","github-url":"https://github.com/dandi/dandi-cli/issues/1553#issuecomment-2556266747"},"message":"ok, so in this case we have downloaded some incomplete version of zarr, its checksum is null  etc. We should at least issue a warning of some kind that upload was never finalized and they fetched potentially an incomplete copy . The zarr in question has already 27G in size\n\nodd, interrupted and restarted with refresh completed without error \n\n```\n(dandisets-2) dandi@drogon:/mnt/backup/dandi$ dandi download -J 2:20 dandi://dandi/000026/sub-I48/ses-SPIM/micr/sub-I48_ses-SPIM_sample-BrocaAreaS03_stain-Somatostatin_SPIM.ome.zarr\nPATH                                                                  SIZE    DONE     DONE% CHECKSUM STATUS        MESSAGE\nsub-I48_ses-SPIM_sample-BrocaAreaS03_stain-Somatostatin_SPIM.ome.zarr 0 Bytes 1.3 GB      0%          error         FileExistsError\nSummary:                                                                      1.3 GB                  1 error       1 FileExistsError\n                                                                              0.00%\n2024-12-19 23:05:02,256 [    INFO] Logs saved in /home/dandi/.local/state/dandi-cli/log/2024.12.20-04.04.40Z-2706158.log\nError: Encountered 1 error while downloading.\n(dandisets-2) dandi@drogon:/mnt/backup/dandi$ dandi download -J 2:20 --existing refresh dandi://dandi/000026/sub-I48/ses-SPIM/micr/sub-I48_ses-SPIM_sample-BrocaAreaS03_stain-Somatostatin_SPIM.ome.zarr\nPATH                                                                  SIZE    DONE    DONE% CHECKSUM STATUS                 MESSAGE\nsub-I48_ses-SPIM_sample-BrocaAreaS03_stain-Somatostatin_SPIM.ome.zarr 0 Bytes 27.9 GB    0%          done                   15209 done, 1872 skipped\nSummary:                                                                      27.9 GB                1 done                 1 some done, some skipped\n                                                                              0.00%\n2024-12-19 23:17:32,942 [    INFO] Logs saved in /home/dandi/.local/state/dandi-cli/log/2024.12.20-04.05.15Z-2706190.log\n\n```\n\nso we might not be checking upon refresh???\n...","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1734702374,"metadata":{"github-id":"IC_kwDODBZtRc6YaXja","github-url":"https://github.com/dandi/dandi-cli/issues/1553#issuecomment-2557049050"},"message":"repeated afresh, indeed -- no error if refresh after failed process\n\n```\n(dandisets-2) dandi@drogon:/mnt/backup/dandi/tmp$ dandi download -J 2:20 dandi://dandi/000026/sub-I48/ses-SPIM/micr/sub-I48_ses-SPIM_sample-BrocaAreaS03_stain-Somatostatin_SPIM.ome.zarr\nPATH                                                                  SIZE    DONE     DONE% CHECKSUM STATUS                 MESSAGE         \nsub-I48_ses-SPIM_sample-BrocaAreaS03_stain-Somatostatin_SPIM.ome.zarr 0 Bytes 27.9 GB     0%          error                  AssertionError  \nSummary:                                                                      27.9 GB                 1 error                1 AssertionError\n                                                                              0.00%                                                          \n2024-12-19 23:37:09,310 [    INFO] Logs saved in /home/dandi/.local/state/dandi-cli/log/2024.12.20-04.24.21Z-2720891.log\nError: Encountered 1 error while downloading.\n(dandisets-2) dandi@drogon:/mnt/backup/dandi/tmp$ dandi download -J 2:20 --existing refresh dandi://dandi/000026/sub-I48/ses-SPIM/micr/sub-I48_ses-SPIM_sample-BrocaAreaS03_stain-Somatostatin_SPIM.ome.zarr\nPATH                                                                  SIZE    DONE    DONE% CHECKSUM STATUS    MESSAGE       \nsub-I48_ses-SPIM_sample-BrocaAreaS03_stain-Somatostatin_SPIM.ome.zarr 0 Bytes                        skipped   17082 skipped \nSummary:                                                                      0 Bytes                1 skipped 1 some skipped\n                                                                              100.00%                                        \n2024-12-19 23:45:18,033 [    INFO] Logs saved in /home/dandi/.local/state/dandi-cli/log/2024.12.20-04.42.45Z-2732233.log\n```","files":null}]}