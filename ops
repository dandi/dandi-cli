{"version":2,"ops":[{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1745339901,"metadata":{"github-id":"IC_kwDODBZtRc6oMpZ-","github-url":"https://github.com/dandi/dandi-cli/issues/1616#issuecomment-2821887614"},"message":"smells like some logic for dealing with folders vs files is flawed ...\n\nMost likely nobody has tried (and we have not tested) to rename \".zarr filesets\" (a special thing different from files). e.g. I see no hits in tests\n\n```\n❯ git grep zarr | grep move\ndandi/move.py:        return p.is_dir() and p.suffix not in (\".ngff\", \".zarr\")\ndandi/move.py:            or (p.is_dir() and p.suffix in (\".ngff\", \".zarr\"))\n```","files":null},{"type":3,"author":{"id":"bd35622b4fac033435347fff87f54b8235f275bb"},"timestamp":1745416055,"metadata":{"github-id":"IC_kwDODBZtRc6oWHTx","github-url":"https://github.com/dandi/dandi-cli/issues/1616#issuecomment-2824369393"},"message":"Looking into this today....","files":null},{"type":3,"author":{"id":"bd35622b4fac033435347fff87f54b8235f275bb"},"timestamp":1745423679,"metadata":{"github-id":"IC_kwDODBZtRc6oXrdZ","github-url":"https://github.com/dandi/dandi-cli/issues/1616#issuecomment-2824779609"},"message":"@kabilar @ayendiki\n\nFor the command:\n\n```\ndandi move -i linc sub-MF278/dwi/dtifit_S0.nii.zarr/ sub-MF278/dwi/sub-MF278_sample-brain_DTI_S0.nii.zarr/\n```\n\ndid you get the same error if you removed the trailing slashes? for example:\n\n```\ndandi move -i linc sub-MF278/dwi/dtifit_S0.nii.zarr sub-MF278/dwi/sub-MF278_sample-brain_DTI_S0.nii.zarr\n```","files":null},{"type":3,"author":{"id":"bd35622b4fac033435347fff87f54b8235f275bb"},"timestamp":1745426668,"metadata":{"github-id":"IC_kwDODBZtRc6oYMY9","github-url":"https://github.com/dandi/dandi-cli/issues/1616#issuecomment-2824914493"},"message":"\u003e smells like some logic for dealing with folders vs files is flawed ...\n\u003e \n\u003e Most likely nobody has tried (and we have not tested) to rename \".zarr filesets\" (a special thing different from files). e.g. I see no hits in tests\n\u003e \n\u003e ```\n\u003e ❯ git grep zarr | grep move\n\u003e dandi/move.py:        return p.is_dir() and p.suffix not in (\".ngff\", \".zarr\")\n\u003e dandi/move.py:            or (p.is_dir() and p.suffix in (\".ngff\", \".zarr\"))\n\u003e ```\n\n@yarikoptic just confirming your smell test here -- specifically that in the `test_move.py` -- the fixture being used does not hit the `.ngff` and `.zarr` logic: https://github.com/dandi/dandi-cli/blob/6518334b60c541890d83e293d000f350280dfbad/dandi/tests/test_move.py#L16-L33\n\nBefore altering any logic / writing more code (other than more test coverage of course) -- I'd ask the question -- why were those file suffixes (.ngff, .zarr) there in the first place?","files":null},{"type":6,"author":{"id":"bd35622b4fac033435347fff87f54b8235f275bb"},"timestamp":1745426870,"metadata":{"github-id":"UCE_lALODBZtRc6oYMY9zmRsoO8"},"target":"21d2ca572368c8ba65b20d5e53a15f35711fe25dfa237a8c48f2cdf3ad324df8","message":"\u003e smells like some logic for dealing with folders vs files is flawed ...\n\u003e \n\u003e Most likely nobody has tried (and we have not tested) to rename \".zarr filesets\" (a special thing different from files). e.g. I see no hits in tests\n\u003e \n\u003e ```\n\u003e ❯ git grep zarr | grep move\n\u003e dandi/move.py:        return p.is_dir() and p.suffix not in (\".ngff\", \".zarr\")\n\u003e dandi/move.py:            or (p.is_dir() and p.suffix in (\".ngff\", \".zarr\"))\n\u003e ```\n\n@yarikoptic just confirming your smell test here -- specifically that in the `test_move.py` -- the fixture being used does not hit the `.ngff` and `.zarr` logic: https://github.com/dandi/dandi-cli/blob/6518334b60c541890d83e293d000f350280dfbad/dandi/tests/test_move.py#L16-L33\n\nBefore altering any logic / writing more code (other than more test coverage of course) -- I'd ask the question (to @satra as well just for clarity) -- why were those file suffixes (.ngff, .zarr) there in the first place? My understanding is that we are wandering back into the issue of POSIX directory structures, where zarr's are _both_ files and directories depending on how a system might inspect them","files":null},{"type":6,"author":{"id":"bd35622b4fac033435347fff87f54b8235f275bb"},"timestamp":1745427145,"metadata":{"github-id":"UCE_lALODBZtRc6oYMY9zmRsyoI"},"target":"21d2ca572368c8ba65b20d5e53a15f35711fe25dfa237a8c48f2cdf3ad324df8","message":"\u003e smells like some logic for dealing with folders vs files is flawed ...\n\u003e \n\u003e Most likely nobody has tried (and we have not tested) to rename \".zarr filesets\" (a special thing different from files). e.g. I see no hits in tests\n\u003e \n\u003e ```\n\u003e ❯ git grep zarr | grep move\n\u003e dandi/move.py:        return p.is_dir() and p.suffix not in (\".ngff\", \".zarr\")\n\u003e dandi/move.py:            or (p.is_dir() and p.suffix in (\".ngff\", \".zarr\"))\n\u003e ```\n\n@yarikoptic just confirming your smell test here -- specifically that in the `test_move.py` -- the fixture being used does not hit the `.ngff` and `.zarr` logic: https://github.com/dandi/dandi-cli/blob/6518334b60c541890d83e293d000f350280dfbad/dandi/tests/test_move.py#L16-L33\n\nBefore altering any logic / writing more code (other than more test coverage of course) -- I'd ask the question (to @satra as well just for clarity) -- why were those file suffixes (.ngff, .zarr) there in the first place? My understanding is that we are wandering back into the issue of POSIX directory structures, where zarr's are _both_ files and directories depending on how a system might inspect them","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1745431774,"metadata":{"github-id":"IC_kwDODBZtRc6oY-hB","github-url":"https://github.com/dandi/dandi-cli/issues/1616#issuecomment-2825119809"},"message":"zarr files are assets too. so any move is still metadata update. there is no files/folders here, is there? the move command is always just metadata update on remote server. however, locally it would be a modified posix move (which would require deleting target (file/folder) if it exists and then moving), and probably requires a force flag if deletion needs to happen.","files":null},{"type":3,"author":{"id":"bd35622b4fac033435347fff87f54b8235f275bb"},"timestamp":1745433041,"metadata":{"github-id":"IC_kwDODBZtRc6oZJkH","github-url":"https://github.com/dandi/dandi-cli/issues/1616#issuecomment-2825165063"},"message":"\u003e zarr files are assets too. so any move is still metadata update. there is no files/folders here, is there? the move command is always just metadata update on remote server. however, locally it would be a modified posix move (which would require deleting target (file/folder) if it exists and then moving), and probably requires a force flag if deletion needs to happen.\n\nThanks @satra -- Could you elaborate what you mean by \"there is no files/folders here, is there?\" \n\nThe local modified posix move (e.g. essentially local deletion) feels pretty heavyweight for zarr's, especially in regards to their size, so I'm a bit stumped why we'd want to encourage that approach","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1745433310,"metadata":{"github-id":"IC_kwDODBZtRc6oZMFz","github-url":"https://github.com/dandi/dandi-cli/issues/1616#issuecomment-2825175411"},"message":"\u003e \"there is no files/folders here, is there?\"\n\nan asset doesn't care about what binary data it's connected to (whether file or folder).\n\n\u003e The local modified posix move (e.g. essentially local deletion) feels pretty heavyweight for zarr's, especially in regards to their size, so I'm a bit stumped why we'd want to encourage that approach\n\nhopefully with sharding this won't be a significant lift. more generally the questions is what a local move command does. i believe dandi move is not restricted to remote.","files":null},{"type":3,"author":{"id":"bd35622b4fac033435347fff87f54b8235f275bb"},"timestamp":1745433559,"metadata":{"github-id":"IC_kwDODBZtRc6oZONJ","github-url":"https://github.com/dandi/dandi-cli/issues/1616#issuecomment-2825184073"},"message":"\u003e \u003e \"there is no files/folders here, is there?\"\n\u003e \n\u003e an asset doesn't care about what binary data it's connected to (whether file or folder).\n\u003e \n\n@satra -- however, the code initially flags a suffix of .ngff, .zarr (hence my initial question for why that logic is there)","files":null},{"type":6,"author":{"id":"bd35622b4fac033435347fff87f54b8235f275bb"},"timestamp":1745433692,"metadata":{"github-id":"UCE_lALODBZtRc6oZONJzmRwrvA"},"target":"809f7e483503ff75885ed5478fc40b2b091ff97b5c3f85c1746df9dc46276d8b","message":"\u003e \u003e \"there is no files/folders here, is there?\"\n\u003e \n\u003e an asset doesn't care about what binary data it's connected to (whether file or folder).\n\u003e \n\n@satra -- however, the code initially flags a suffix of .ngff, .zarr (hence my initial question for why that logic is there)\n\nIn terms of proceeding forward here, basically what I'm trying to fully understand is: \"Because of the nature of the structure of zarrs (and the edge cases that come along with it with S3 (key-value object stores), POSIX directories, etc.) is `dandi move` something that should not be readily available for those types of asset types?","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1745433948,"metadata":{"github-id":"IC_kwDODBZtRc6oZSBp","github-url":"https://github.com/dandi/dandi-cli/issues/1616#issuecomment-2825199721"},"message":"\u003e dandi move something that should not be readily available for those types of asset types?\n\nit should be available for any asset on the server. the structure of zarrs should not be of any concern to this operation. however, concurrent operations would be. a \"move\" is simply a metadata json update for an asset on the server. moving to an existing object however will require deleting the target zarr asset and then \"moving\" the source asset. overwriting via a move is likely a less than 1% use-case. and could be approached as:\n\n---\n1. rename target\n2. move source\n3. delete renamed target (hopefully this is a worker operation for zarr)\n---","files":null},{"type":3,"author":{"id":"bd35622b4fac033435347fff87f54b8235f275bb"},"timestamp":1745501483,"metadata":{"github-id":"IC_kwDODBZtRc6oinZH","github-url":"https://github.com/dandi/dandi-cli/issues/1616#issuecomment-2827646535"},"message":"@ayendiki -- I'm unable to fully replicate the state/error message in this Issue, thus still investigating -- I did notice behavior below though, where I would be curious to see if using `--move-on remote` then `--move-on local` flags would alleviate the issue.\n\nSee below -- (from having the `.zarr` prefix on a `ZarrArchive` object is that `--move-on both` or no flag (which is `--move-on auto`) fails initially however, interestingly enough -- doing `--work-on remote` then `--work-on local` works fine:\n\n```\n(zarr-move) aaronkanzer@Aarons-MacBook-Pro-2 216584 % dandi move -i dandi-staging  new-icephys.zarr/ different-icephys.zarr/ --work-on remote\n2025-04-24 09:15:59,833 [    INFO] Fetching list of assets for Dandiset 216584\nSOURCE                                                                  TARGET                                                                  REMOTE MESSAGE\nnew-icephys.zarr/new-icephys-zarr/new-icephys/icephys/sub-1214579789... different-icephys.zarr/new-icephys.zarr/new-icephys-zarr/new-icephys... Moved         \nnew-icephys.zarr/new-icephys-zarr/new-icephys/icephys/sub-1214579789... different-icephys.zarr/new-icephys.zarr/new-icephys-zarr/new-icephys... Moved         \n2025-04-24 09:16:00,924 [    INFO] Logs saved in /Users/aaronkanzer/Library/Logs/dandi-cli/2025.04.24-13.15.59Z-25306.log\n(zarr-move) aaronkanzer@Aarons-MacBook-Pro-2 216584 % ls\ndandiset.yaml\t\tnew-icephys.zarr\n(zarr-move) aaronkanzer@Aarons-MacBook-Pro-2 216584 % dandi move -i dandi-staging  new-icephys.zarr/ different-icephys.zarr/ --work-on local \nSOURCE           TARGET                                  LOCAL  MESSAGE\nnew-icephys.zarr different-icephys.zarr/new-icephys.zarr Moved         \n2025-04-24 09:17:44,399 [    INFO] Logs saved in /Users/aaronkanzer/Library/Logs/dandi-cli/2025.04.24-13.17.44Z-25398.log\n(zarr-move) aaronkanzer@Aarons-MacBook-Pro-2 216584 % ls\ndandiset.yaml\t\tdifferent-icephys.zarr\n(zarr-move) aaronkanzer@Aarons-MacBook-Pro-2 216584 % dandi move -i dandi-staging  different-icephys.zarr/ another-icephys.zarr/ --work-on both\n2025-04-24 09:18:38,439 [    INFO] Fetching list of assets for Dandiset 216584\n2025-04-24 09:18:38,511 [    INFO] Logs saved in /Users/aaronkanzer/Library/Logs/dandi-cli/2025.04.24-13.18.37Z-25412.log\nError: Mismatch between local and remote Dandisets:\n- Asset 'different-icephys.zarr' only exists locally\n- Asset 'different-icephys.zarr/new-icephys.zarr/new-icephys-zarr/new-icephys/icephys/sub-1214579789_ses-1214621812_icephys_NestedDirectoryStore_nwb.zarr' only exists remotely\n```\n\n@ayendiki -- could you perhaps try that workflow for now to be unblocked?  thus:\n\n```\ndandi move -i linc sub-MF278/dwi/dtifit_S0.nii.zarr sub-MF278/dwi/sub-MF278_sample-brain_DTI_S0.nii.zarr --move-on remote\ndandi move -i linc sub-MF278/dwi/dtifit_S0.nii.zarr sub-MF278/dwi/sub-MF278_sample-brain_DTI_S0.nii.zarr --move-on local\n```\n\n@satra @kabilar -- as a heads-up, I'd like to start to timebox this, as it is eating up some time to resolve\n\nCc @yarikoptic","files":null},{"type":6,"author":{"id":"bd35622b4fac033435347fff87f54b8235f275bb"},"timestamp":1745501516,"metadata":{"github-id":"UCE_lALODBZtRc6oinZHzmSNWsg"},"target":"6e255e987889aff1b9e15e119e82a758ebf7acfec1fe42aba3313451c4f56ebd","message":"@ayendiki -- I'm unable to fully replicate the state/error message in this Issue, thus still investigating -- I did notice behavior below though, where I would be curious to see if using `--move-on remote` then `--move-on local` flags would alleviate the issue.\n\nSee below -- (from having the `.zarr` prefix on a `ZarrArchive` object) is that `--move-on both` or no flag (which is `--move-on auto`) fails initially however, interestingly enough, doing `--work-on remote` then `--work-on local` works fine:\n\n```\n(zarr-move) aaronkanzer@Aarons-MacBook-Pro-2 216584 % dandi move -i dandi-staging  new-icephys.zarr/ different-icephys.zarr/ --work-on remote\n2025-04-24 09:15:59,833 [    INFO] Fetching list of assets for Dandiset 216584\nSOURCE                                                                  TARGET                                                                  REMOTE MESSAGE\nnew-icephys.zarr/new-icephys-zarr/new-icephys/icephys/sub-1214579789... different-icephys.zarr/new-icephys.zarr/new-icephys-zarr/new-icephys... Moved         \nnew-icephys.zarr/new-icephys-zarr/new-icephys/icephys/sub-1214579789... different-icephys.zarr/new-icephys.zarr/new-icephys-zarr/new-icephys... Moved         \n2025-04-24 09:16:00,924 [    INFO] Logs saved in /Users/aaronkanzer/Library/Logs/dandi-cli/2025.04.24-13.15.59Z-25306.log\n(zarr-move) aaronkanzer@Aarons-MacBook-Pro-2 216584 % ls\ndandiset.yaml\t\tnew-icephys.zarr\n(zarr-move) aaronkanzer@Aarons-MacBook-Pro-2 216584 % dandi move -i dandi-staging  new-icephys.zarr/ different-icephys.zarr/ --work-on local \nSOURCE           TARGET                                  LOCAL  MESSAGE\nnew-icephys.zarr different-icephys.zarr/new-icephys.zarr Moved         \n2025-04-24 09:17:44,399 [    INFO] Logs saved in /Users/aaronkanzer/Library/Logs/dandi-cli/2025.04.24-13.17.44Z-25398.log\n(zarr-move) aaronkanzer@Aarons-MacBook-Pro-2 216584 % ls\ndandiset.yaml\t\tdifferent-icephys.zarr\n(zarr-move) aaronkanzer@Aarons-MacBook-Pro-2 216584 % dandi move -i dandi-staging  different-icephys.zarr/ another-icephys.zarr/ --work-on both\n2025-04-24 09:18:38,439 [    INFO] Fetching list of assets for Dandiset 216584\n2025-04-24 09:18:38,511 [    INFO] Logs saved in /Users/aaronkanzer/Library/Logs/dandi-cli/2025.04.24-13.18.37Z-25412.log\nError: Mismatch between local and remote Dandisets:\n- Asset 'different-icephys.zarr' only exists locally\n- Asset 'different-icephys.zarr/new-icephys.zarr/new-icephys-zarr/new-icephys/icephys/sub-1214579789_ses-1214621812_icephys_NestedDirectoryStore_nwb.zarr' only exists remotely\n```\n\n@ayendiki -- could you perhaps try that workflow for now to be unblocked?  thus:\n\n```\ndandi move -i linc sub-MF278/dwi/dtifit_S0.nii.zarr sub-MF278/dwi/sub-MF278_sample-brain_DTI_S0.nii.zarr --move-on remote\ndandi move -i linc sub-MF278/dwi/dtifit_S0.nii.zarr sub-MF278/dwi/sub-MF278_sample-brain_DTI_S0.nii.zarr --move-on local\n```\n\n@satra @kabilar -- as a heads-up, I'd like to start to timebox this, as it is eating up some time to resolve\n\nCc @yarikoptic","files":null},{"type":3,"author":{"id":"e21d3ca807eb00cd2ead0f00fba73f32cebda4e7"},"timestamp":1745531433,"metadata":{"github-id":"IC_kwDODBZtRc6onkeN","github-url":"https://github.com/dandi/dandi-cli/issues/1616#issuecomment-2828945293"},"message":"I was able to use \"--work-on remote\" and \"--work-on local\", and it does work, strangely.","files":null},{"type":3,"author":{"id":"d8203afd43c9e0a9d07c45dd62b58a81d53a2ebe"},"timestamp":1754511434,"metadata":{"github-id":"IC_kwDODBZtRc68cDnE","github-url":"https://github.com/dandi/dandi-cli/issues/1616#issuecomment-3161471428"},"message":"For a different set of Zarr assets, I was able to move them using the following arguments:\n\n```\ndandi move --dandiset https://lincbrain.org/dandiset/000005/draft rawdata/sub-S45/micr/sub-S45_sample-hemi_acq-zoom_chunk-02_XPCT.ome.zarr sourcedata/raw/sub-S45/micr/sub-S45_sample-hemi_acq-zoo\nm_chunk-02_XPCT.ome.zarr\n```\n\ndandi version: 0.69.3","files":null},{"type":6,"author":{"id":"d8203afd43c9e0a9d07c45dd62b58a81d53a2ebe"},"timestamp":1754512670,"metadata":{"github-id":"UCE_lALODBZtRc68cDnEznMdp54"},"target":"7ec639f18ebd7bbd7e63f272c30adcd7b2a298666371224eed588b0026393e88","message":"For a different set of Zarr assets, I was able to move them using the following arguments.  Note I did not have a local copy of the data.\n\n```\ndandi move --dandiset https://lincbrain.org/dandiset/000005/draft rawdata/sub-S45/micr/sub-S45_sample-hemi_acq-zoom_chunk-02_XPCT.ome.zarr sourcedata/raw/sub-S45/micr/sub-S45_sample-hemi_acq-zoo\nm_chunk-02_XPCT.ome.zarr\n```\n\ndandi version: 0.69.3","files":null}]}