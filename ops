{"version":2,"ops":[{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1616696283,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDgwNzIyMzM1OA==","github-url":"https://github.com/dandi/dandi-cli/issues/502#issuecomment-807223358"},"message":"I think this might be the reason:\n```\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/pyout/summary.py\", line 53, in summarize\n    summaries[col] = agg_fn(list(colvals))\n  File \"/home/yoh/proj/dandi/dandi-cli/dandi/upload.py\", line 869, in upload_agg\n    # with upload etc\n  File \"/home/yoh/proj/dandi/dandi-cli/dandi/upload.py\", line 869, in \u003cgenexpr\u003e\n    # with upload etc\nRuntimeError: dictionary changed size during iteration\n```\nrelating to traceback in original post:\n```\n    total = sum(v[\"size\"] for v in uploaded_paths.values())\n```\n\nI will try by making first a copy of `uploaded_paths.values()`.  I bet this also points to suboptimal code for dealing with 1mil files upload. And we might not be able to avoid some locking or prepopulating `uploaded_paths` so dictionary itself would not change\n\n\u003cdetails\u003e\n\u003csummary\u003efull traceback etc\u003c/summary\u003e \n\n```shell\nTraceback (most recent call last):\n  File \"/home/yoh/miniconda3/envs/dandi-devel/bin/dandi\", line 33, in \u003cmodule\u003e\n    sys.exit(load_entry_point('dandi', 'console_scripts', 'dandi')())\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/click/core.py\", line 829, in __call__\n    return self.main(*args, **kwargs)\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/click/core.py\", line 782, in main\n    rv = self.invoke(ctx)\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/click/core.py\", line 1259, in invoke\n    return _process_result(sub_ctx.command.invoke(sub_ctx))\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/click/core.py\", line 1066, in invoke\n    return ctx.invoke(self.callback, **ctx.params)\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/click/core.py\", line 610, in invoke\n    return callback(*args, **kwargs)\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/click/decorators.py\", line 33, in new_func\n    return f(get_current_context().obj, *args, **kwargs)\n  File \"/home/yoh/proj/dandi/dandi-cli/dandi/cli/base.py\", line 109, in wrapper\n    return f(*args, **kwargs)\n  File \"/home/yoh/proj/dandi/dandi-cli/dandi/cli/cmd_upload.py\", line 98, in upload\n    validation=\"require\",\n  File \"/home/yoh/proj/dandi/dandi-cli/dandi/upload.py\", line 49, in upload\n    if instance.girder is None:\n  File \"/home/yoh/proj/dandi/dandi-cli/dandi/upload.py\", line 907, in _new_upload\n    rec[tuple(rec_fields[1:])] = process_path(path, relpath)\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/pyout/interface.py\", line 96, in wrapped\n    return method(self, *args, **kwds)\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/pyout/interface.py\", line 634, in __call__\n    self._write(row, style)\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/pyout/interface.py\", line 357, in _write\n    self._write_fn(row, style)\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/pyout/interface.py\", line 376, in _write_update\n    content, status, summary = self._content.update(row, style)\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/pyout/common.py\", line 939, in update\n    summ_rows = self.summary.summarize(\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/pyout/summary.py\", line 53, in summarize\n    summaries[col] = agg_fn(list(colvals))\n  File \"/home/yoh/proj/dandi/dandi-cli/dandi/upload.py\", line 869, in upload_agg\n    # with upload etc\n  File \"/home/yoh/proj/dandi/dandi-cli/dandi/upload.py\", line 869, in \u003cgenexpr\u003e\n    # with upload etc\nRuntimeError: dictionary changed size during iteration\n\n```\n\u003c/details\u003e","files":null}]}