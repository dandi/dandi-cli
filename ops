{"version":2,"ops":[{"type":6,"author":{"id":"d8203afd43c9e0a9d07c45dd62b58a81d53a2ebe"},"timestamp":1742410290,"metadata":{"github-id":"UCE_lAHODBZtRc6uzzI9znUM6Wo"},"target":"aaeb480432e63a09db7582d42ee56f000301c5576944e9548da98c22b4fe6f31","message":"## Context\n\nWe are planning to upload 216 TB from Columbia University to lincbrain.org over the coming months.  We are working to reduce the upload time by compressing the data and optimizing the upload speed.\n\n## Benchmarking upload speeds\n\nRegarding the upload speed, I have testing both the DANDI Client and AWS CLI from a node on the MIT Engaging Cluster (8 cores, 32 GB).  I uploaded a single asset at a time to the DANDI Staging server with the DANDI CLI or to a private S3 bucket with the AWS CLI.  Certainly network variability could be a source of the variability in the results below, but I did perform some of the tests several times with similar results each time.  \n\n| Client | Asset | Max Upload Speed (MBps) |\n| - | - | - |\n| DANDI | Zarr | ~30 |\n| DANDI | NWB | ~80 |\n| DANDI | AVI | ~70 |\n| AWS | Zarr | ~55 |\n| AWS | NWB | ~110 |\n\nSteps to reproduce DANDI CLI tests:\n- `srun --ntasks 1 --cpus-per-task 8 --mem 32G -p mit_preemptable --pty /bin/bash`\n- DANDI Client version: `0.67.2`\n- `dandi upload -i dandi-staging --validation ignore --jobs 8`\n\nSteps to reproduce AWS CLI tests:\n- `srun --ntasks 1 --cpus-per-task 8 --mem 32G -p mit_preemptable --pty /bin/bash`\n- AWS CLI version: `aws-cli/2.24.26 Python/3.12.9 Linux/4.18.0-372.9.1.el8.x86_64 exe/x86_64.rocky.8`\n- `~/awsv2/2.24.26/bin/aws s3 cp --recursive \u003cfilename\u003e s3://linc-lsm-upload-test/ --acl private`\n\n### Speedtest CLI\n- Just as check I ran [speedtest CLI](https://github.com/sivel/speedtest-cli).  (Although these results can't be compared directly to the above DANDI and AWS speed tests.)\n\n  ```bash\n  $ curl -s https://raw.githubusercontent.com/sivel/speedtest-cli/master/speedtest.py | python3 -\n  \n  Retrieving speedtest.net configuration...\n  Testing from Massachusetts Institute of Technology (\u003credacted IP\u003e)...\n  Retrieving speedtest.net server list...\n  Selecting best server based on ping...\n  Hosted by Comcast (Boston, MA) [3.14 km]: 5.89 ms\n  Testing download speed................................................................................\n  Download: 829.92 Mbit/s\n  Testing upload speed......................................................................................................\n  Upload: 895.24 Mbit/s\n  ```\n\n### Questions\n- Is there anything I can do to increase the upload speed of the DANDI Client since it is noticeably slower than the AWS CLI?\n  - I can appreciate that uploading multiple assets in parallel with the `--jobs` flag will increase the overall data transfer speed, but I wanted to evaluate if there is anything I can do to increase the transfer of a single asset.\n- Why do Zarrs have slower upload speeds?\n  - If the slower speed is related to the number of files, perhaps reducing the number of chunks with sharded Zarrs would help with this.\n\nThank you.\n\ncc @aaronkanzer @emineozeen @wenzeli @ayendiki","files":null},{"type":3,"author":{"id":"d8203afd43c9e0a9d07c45dd62b58a81d53a2ebe"},"timestamp":1742411937,"metadata":{"github-id":"IC_kwDODBZtRc6jLxGc","github-url":"https://github.com/dandi/dandi-cli/issues/1595#issuecomment-2737770908"},"message":"Notes after discussion with Yarik:\n\n- Use  [con/duct](https://github.com/con/duct) to capture CPU utilization and job duration\n- Use [py-spy](https://github.com/benfred/py-spy) top\n- Try `--jobs 1:10` for parallelization with Zarrs.","files":null},{"type":6,"author":{"id":"d8203afd43c9e0a9d07c45dd62b58a81d53a2ebe"},"timestamp":1742412139,"metadata":{"github-id":"UCE_lALODBZtRc6jLxGczmBxVZc"},"target":"d8d12ac83b9e83aed0a9376a06488491dfa885f52ffd262975b1aaae5be4656d","message":"Notes after discussion with Yarik:\n\n- Use  [con/duct](https://github.com/con/duct) to capture CPU utilization and job duration\n- Use [py-spy](https://github.com/benfred/py-spy) top\n- Try `--jobs 1:10` for parallelization with Zarrs.\n- Try multiple assets with `--jobs 5:5`","files":null},{"type":3,"author":{"id":"d8203afd43c9e0a9d07c45dd62b58a81d53a2ebe"},"timestamp":1742526090,"metadata":{"github-id":"IC_kwDODBZtRc6jcZGY","github-url":"https://github.com/dandi/dandi-cli/issues/1595#issuecomment-2742129048"},"message":"\u003e * Try `--jobs 1:10` for parallelization with Zarrs.\n\nMax upload speed increased to 44 MBps for a single Zarr archive.\n\n\u003e * Try multiple assets with `--jobs 5:5`\n\nUploaded 20+ NWB files.  Total speed was 20-40 MBps.  Only two processes seemed to run concurrently.  They each intermittently hit 99% CPU utilization.","files":null},{"type":3,"author":{"id":"d8203afd43c9e0a9d07c45dd62b58a81d53a2ebe"},"timestamp":1742826819,"metadata":{"github-id":"IC_kwDODBZtRc6j0Fdu","github-url":"https://github.com/dandi/dandi-cli/issues/1595#issuecomment-2748340078"},"message":"Tested with Emine and Aaron on Hillman Lab servers.  Upload speed is ~100 MBps.  For comparison, next we will be testing rsync or scp to the MIT Engaging Cluster.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1742829306,"metadata":{"github-id":"IC_kwDODBZtRc6j0p6J","github-url":"https://github.com/dandi/dandi-cli/issues/1595#issuecomment-2748489353"},"message":"\u003e Upload speed is ~100 MBps. For comparison, next we will be testing rsync or scp to the MIT Engaging Cluster.\n\nideally should be to the same destination since network paths could differ (e.g. 10Gbps interconnect to engaging while 1Gbps outgoing to S3) etc. Could probably compare against s5cmd upload to some temp location/bucket?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1742829598,"metadata":{"github-id":"IC_kwDODBZtRc6j0tgl","github-url":"https://github.com/dandi/dandi-cli/issues/1595#issuecomment-2748504101"},"message":"FWIW, here is speed test on drogon -- escaping 1Gbps\n\n```\nRetrieving speedtest.net configuration...\nTesting from Dartmouth College (129.170.233.10)...\nRetrieving speedtest.net server list...\nSelecting best server based on ping...\nHosted by Surfshark Ltd (New York, NY) [361.39 km]: 13.81 ms\nTesting download speed................................................................................\nDownload: 1771.30 Mbit/s\nTesting upload speed......................................................................................................\nUpload: 1426.01 Mbit/s\n```","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1742830583,"metadata":{"github-id":"UCE_lALODBZtRc6j0tglzmDnmug"},"target":"50644c047ab4f3ac30e66cbd28b18352c146fae2e1128e38955d7664be6152c0","message":"FWIW, here is speed test on drogon -- escaping 1Gbps\n\n```\nHosted by Surfshark Ltd (New York, NY) [361.39 km]: 11.819 ms\nTesting download speed................................................................................\nDownload: 2705.47 Mbit/s\nTesting upload speed......................................................................................................\nUpload: 1291.27 Mbit/s\n```\n\n\u003cdetails\u003e\n\u003csummary\u003eoriginal run - was a little less\u003c/summary\u003e \n\n```\nRetrieving speedtest.net configuration...\nTesting from Dartmouth College (129.170.233.10)...\nRetrieving speedtest.net server list...\nSelecting best server based on ping...\nHosted by Surfshark Ltd (New York, NY) [361.39 km]: 13.81 ms\nTesting download speed................................................................................\nDownload: 1771.30 Mbit/s\nTesting upload speed......................................................................................................\nUpload: 1426.01 Mbit/s\n```\n\n\u003c/details\u003e","files":null},{"type":3,"author":{"id":"d8203afd43c9e0a9d07c45dd62b58a81d53a2ebe"},"timestamp":1743176637,"metadata":{"github-id":"IC_kwDODBZtRc6knK9H","github-url":"https://github.com/dandi/dandi-cli/issues/1595#issuecomment-2761731911"},"message":"\u003e \u003e Upload speed is ~100 MBps. For comparison, next we will be testing rsync or scp to the MIT Engaging Cluster.\n\u003e \n\u003e ideally should be to the same destination since network paths could differ (e.g. 10Gbps interconnect to engaging while 1Gbps outgoing to S3) etc. Could probably compare against s5cmd upload to some temp location/bucket?\n\nThanks.  I probably should have posted that update in a different issue in the LINC org.  We are actually making this comparison to determine if we should proceed with uploading to S3 with the `dandi` client or move this raw data to MIT with another tool.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1743178020,"metadata":{"github-id":"IC_kwDODBZtRc6knZnh","github-url":"https://github.com/dandi/dandi-cli/issues/1595#issuecomment-2761791969"},"message":"@kabilar - for Zarr, sharding to get much larger objects will significantly impact speeds. so that should be step 1 for that.","files":null},{"type":3,"author":{"id":"d8203afd43c9e0a9d07c45dd62b58a81d53a2ebe"},"timestamp":1745336127,"metadata":{"github-id":"IC_kwDODBZtRc6oMA65","github-url":"https://github.com/dandi/dandi-cli/issues/1595#issuecomment-2821721785"},"message":"@calvinchai Here is some of the testing I have done previously.","files":null},{"type":3,"author":{"id":"d8203afd43c9e0a9d07c45dd62b58a81d53a2ebe"},"timestamp":1750273621,"metadata":{"github-id":"IC_kwDODBZtRc6x8ag5","github-url":"https://github.com/dandi/dandi-cli/issues/1595#issuecomment-2985404473"},"message":"Closing for now.  Will revisit in the future.","files":null},{"type":4,"author":{"id":"d8203afd43c9e0a9d07c45dd62b58a81d53a2ebe"},"timestamp":1750273621,"metadata":{"github-id":"CE_lADODBZtRc6uzzI9zwAAAAQ9yp2P"},"status":2}]}