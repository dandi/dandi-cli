{"version":2,"ops":[{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1641405172,"metadata":{"github-id":"UCE_lAHODBZtRc5A15KWzig6QwQ"},"target":"f8571f00cf72ab7fb15b0f7dff68517d98a09cebd6f0b76a4fb17a4165bf9d19","message":"The dandi-api changes are currently still in draft PRs, but the external API shouldn't change.\n\n* [x] https://github.com/dandi/dandi-api/pull/643 adds an `embargo_status` field to the dandiset list and fetch endpoints. If `embargo_status == \"EMBARGOED\"`, then any assets should be uploaded as embargoed assets. See https://github.com/dandi/dandi-api/blob/65dc262ea565d03b089cd435c8a0d912638a95ae/doc/design/embargo-mvp.md?plain=1#L64-L74 and https://github.com/dandi/dandi-api/blob/65dc262ea565d03b089cd435c8a0d912638a95ae/doc/design/embargo-mvp.md?plain=1#L108\n* When uploading an embargoed asset, `{..., \"embargoed_dandiset\": \"123456\"}` should be included in the JSON request body. This will begin an embargoed upload. No other upload endpoints need this additional argument. See https://github.com/dandi/dandi-api/blob/65dc262ea565d03b089cd435c8a0d912638a95ae/doc/design/embargo-mvp.md?plain=1#L142-L155\n* Creating an asset from the blob_id will work exactly the same as normal uploads, but this has not yet been implemented.\n\n\nedit my @yarikoptic, other relevant PRs\n- [ ] https://github.com/dandi/dandi-api/pull/647","files":null},{"type":5,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1641405187,"metadata":{"github-id":"LE_lADODBZtRc5A15KWzwAAAAFckVVZ"},"added":["blocked"],"removed":[]},{"type":5,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1641572812,"metadata":{"github-id":"LE_lADODBZtRc5A15KWzwAAAAFdNbRC"},"added":["priority-high"],"removed":[]},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1641930881,"metadata":{"github-id":"IC_kwDODBZtRc48OB3A","github-url":"https://github.com/dandi/dandi-cli/issues/856#issuecomment-1010310592"},"message":"The API surface relevant to the CLI has changed a bit:\nWhen uploading ANY asset, {..., \"dandiset\": \"123456\"} should be included in the JSON request body. The API server will determine if the dandiset is embargoed or not and upload the data to the appropriate location in the appropriate bucket.\n\nThe API server should ignore that field right now, but it will be required as soon as https://github.com/dandi/dandi-api/pull/647 is released. This issue should no longer be blocked.","files":null},{"type":5,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1641930885,"metadata":{"github-id":"UNLE_lADODBZtRc5A15KWzwAAAAFeO2hl"},"added":[],"removed":["blocked"]},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1641931126,"metadata":{"github-id":"IC_kwDODBZtRc48OCim","github-url":"https://github.com/dandi/dandi-cli/issues/856#issuecomment-1010313382"},"message":"@dchiquito \n\n\u003e When uploading ANY asset, {..., \"dandiset\": \"123456\"} should be included in the JSON request body\n\nFor which request?  `POST /dandisets/{versions__dandiset__pk}/versions/{versions__version}/assets/`?","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1641934308,"metadata":{"github-id":"IC_kwDODBZtRc48OLc9","github-url":"https://github.com/dandi/dandi-cli/issues/856#issuecomment-1010349885"},"message":"\u003e The API surface relevant to the CLI has changed a bit:\n\u003e When uploading ANY asset, {..., \"dandiset\": \"123456\"} should be included in the JSON request body. The API server will determine if the dandiset is embargoed or not and upload the data to the appropriate location in the appropriate bucket.\n\nDo you mean that old dandi-cli would no longer upload data?","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1641934325,"metadata":{"github-id":"UCE_lALODBZtRc48OLc9ziARcHQ"},"target":"4887dab6fa02c04cc96f57b0d1043f22c97b6f9f44be24eaec6733390b7a9d93","message":"\u003e The API surface relevant to the CLI has changed a bit:\n\u003e When uploading ANY asset, {..., \"dandiset\": \"123456\"} should be included in the JSON request body. The API server will determine if the dandiset is embargoed or not and upload the data to the appropriate location in the appropriate bucket.\n\nDo you mean that old dandi-cli would no longer upload non embargoed data?","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1641934415,"metadata":{"github-id":"IC_kwDODBZtRc48OLs8","github-url":"https://github.com/dandi/dandi-cli/issues/856#issuecomment-1010350908"},"message":"Correct, users would need to update.","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1641934552,"metadata":{"github-id":"IC_kwDODBZtRc48OMDk","github-url":"https://github.com/dandi/dandi-cli/issues/856#issuecomment-1010352356"},"message":"\u003e For which request?\n@jwodder No, when uploading the asset blob: `/api/uploads/initialize/`\n```\n    api_client.post(\n        '/api/uploads/initialize/',\n        {\n            'contentSize': content_size,\n            'digest': {'algorithm': 'dandi:dandi-etag', 'value': etag},\n            'dandiset': dandiset.identifier,\n        },\n        format='json',\n    )\n```","files":null},{"type":6,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1641934576,"metadata":{"github-id":"UCE_lALODBZtRc48OMDkziARdrM"},"target":"97f95cee838c0964325d0b9693bbf677285f301ea5bee2839ca63839df377a53","message":"\u003e For which request?\n\n@jwodder when initializing the asset blob upload: `/api/uploads/initialize/`\n```\n    api_client.post(\n        '/api/uploads/initialize/',\n        {\n            'contentSize': content_size,\n            'digest': {'algorithm': 'dandi:dandi-etag', 'value': etag},\n            'dandiset': dandiset.identifier,\n        },\n        format='json',\n    )\n```","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1641934686,"metadata":{"github-id":"IC_kwDODBZtRc48OMaE","github-url":"https://github.com/dandi/dandi-cli/issues/856#issuecomment-1010353796"},"message":"@dchiquito\n\n* How will that work when uploading Zarrs, which don't use that endpoint?\n* Is the addition of the \"dandiset\" field to `/uploads/initialize/` the only net change to the API that the client needs to be aware of now?","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1641935148,"metadata":{"github-id":"IC_kwDODBZtRc48ONl2","github-url":"https://github.com/dandi/dandi-cli/issues/856#issuecomment-1010358646"},"message":"Embargoed zarrs have not been implemented yet, we are focusing on nailing down zarr and normal embargo first.\n\nYes, specifying the dandiset in `/uploads/initialize/` should be the only change required in the CLI to upload embargoed data.","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1641999550,"metadata":{"github-id":"IC_kwDODBZtRc48RKWd","github-url":"https://github.com/dandi/dandi-cli/issues/856#issuecomment-1011131805"},"message":"\u003e Is the addition of the \"dandiset\" field to /uploads/initialize/ the only net change to the API that the client needs to be aware of now?\n\nA slight correction: it's the only change necessary right now for normal asset embargo, but there will be some more small changes to support zarr embargo (assuming the CLI already has zarr support). It might be a good idea to include a useful error message like \"embargoed zarr isn't supported in this CLI version, please update\" if they are ever encountered. \n\n@jwodder @yarikoptic","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1641999716,"metadata":{"github-id":"IC_kwDODBZtRc48RLBx","github-url":"https://github.com/dandi/dandi-cli/issues/856#issuecomment-1011134577"},"message":"@dchiquito \n\n\u003e It might be a good idea to include a useful error message like \"embargoed zarr isn't supported in this CLI version, please update\" if they are ever encountered.\n\nIf what are ever encountered?  Are you suggesting checking the embargo status of Dandisets when performing an upload just for the purposes of this intelligent error message?","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1642000753,"metadata":{"github-id":"IC_kwDODBZtRc48RPY5","github-url":"https://github.com/dandi/dandi-cli/issues/856#issuecomment-1011152441"},"message":"I am suggesting checking for zarr files in an embargoed dandiset, yes. If this check is not present, then once embargoing zarr is implemented, an outdated CLI would naively upload the zarr file publicly, then add it to the embargoed dandiset, which defeats the whole purpose of embargo.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1642003246,"metadata":{"github-id":"IC_kwDODBZtRc48RZ-H","github-url":"https://github.com/dandi/dandi-cli/issues/856#issuecomment-1011195783"},"message":"@dchiquito Just to be clear, a Dandiset should be considered embargoed iff its `embargo_status` is `\"EMBARGOED\"`, and not for other values, correct?","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1642008384,"metadata":{"github-id":"IC_kwDODBZtRc48RvSi","github-url":"https://github.com/dandi/dandi-cli/issues/856#issuecomment-1011283106"},"message":"Right now the possible states are `EMBARGOED`, `UNEMBARGOING`, and `OPEN`. `UNEMBARGOING` means that the dandiset is currently locked and will not accept any changes, so the CLI can either yield a special error message or just let the API fail.\n\nSoon-ish we will also be adding a `RESTRICTED` state that for the purposes of upload also means that the data in the dandiset is embargoed.","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1642024184,"metadata":{"github-id":"CE_lADODBZtRc5A15KWzwAAAAFeqs4C"},"status":2}]}