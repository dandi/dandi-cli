{"version":2,"ops":[{"type":5,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1644520331,"metadata":{"github-id":"LE_lADODBZtRc5DZW3uzwAAAAFoUDj2"},"added":["cmd-upload"],"removed":[]},{"type":5,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1644520331,"metadata":{"github-id":"LE_lADODBZtRc5DZW3uzwAAAAFoUDj5"},"added":["priority-high"],"removed":[]},{"type":5,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1644520331,"metadata":{"github-id":"LE_lADODBZtRc5DZW3uzwAAAAFoUDj7"},"added":["zarr"],"removed":[]},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1644523892,"metadata":{"github-id":"IC_kwDODBZtRc49t66q","github-url":"https://github.com/dandi/dandi-cli/issues/906#issuecomment-1035447978"},"message":"@yarikoptic Problem: If a Zarr contains a file at, say, `foo/bar/baz` and a later update tries to upload a file to `foo/bar/baz/quux`, then ... I actually don't know what will happen, but I doubt it'll be good.  There does not seem to be a way to guard against this at the moment other than checking the remote file-ness of every ancestor of every Zarr entry being uploaded, which seems excessive.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1644526060,"metadata":{"github-id":"IC_kwDODBZtRc49uHB3","github-url":"https://github.com/dandi/dandi-cli/issues/906#issuecomment-1035497591"},"message":"in the short term for initial uploads we should consider that the local dataset is not undergoing modifications, and there is only one upload operation. \n\nsimple process: for each file, check if file exists (i.e. exists and etag matches). upload only if one or more of those checks fail.\n\nthe process we were hoping with checksums for general updates:\n- some treehash checking would first tell us what the differences are between local and remote (additions/deletions/changes). then one would perform all these operations.\n- since s3 only has keys and no concept of directories, there is no consideration of directories other than as an optimization for tree hash checking. i.e. one can ignore objects below a certain node if the node checksums match.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1644528659,"metadata":{"github-id":"IC_kwDODBZtRc49uRU4","github-url":"https://github.com/dandi/dandi-cli/issues/906#issuecomment-1035539768"},"message":"@jwodder \n\n\u003e Problem: If a Zarr contains a file at, say, `foo/bar/baz` and a later update tries to upload a file to `foo/bar/baz/quux`, then ... I actually don't know what will happen, but I doubt it'll be good.\n\nI don't think anything bad would happen since IIRC S3 doesn't care and I think there could be both `foo/bar/baz` and `foo/bar/baz/quux` keys, so we could upload the new `foo/bar/baz/quux` first and remove `foo/bar/baz` key later - I don't think it would remove all keys which start with `foo/bar/baz`. But worth checking ;)\n\n@satra \n\n\u003e in the short term for initial uploads we should consider that the local dataset is not undergoing modifications, and there is only one upload operation.\n\nI don't think we even need such an assumption since it doesn't simplify our life much since I believe we do have API for delete and listing of remote zarr structure.  Indeed optimizing (later or right away, I will let @jwodder to decide either to do in a single PR or in 2 ;) ) for using tree hash instead of getting a complete list would be preferable.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1644849329,"metadata":{"github-id":"IC_kwDODBZtRc498E4G","github-url":"https://github.com/dandi/dandi-cli/issues/906#issuecomment-1039158790"},"message":"@yarikoptic It turns out S3 (or at least minio) won't let you upload to `foo/bar/baz/quux` if `foo/bar/baz` is already a file.  I managed to handle this in the latest commit.","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1645039809,"metadata":{"github-id":"CE_lADODBZtRc5DZW3uzwAAAAFqtjSd"},"status":2}]}