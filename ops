{"version":2,"ops":[{"type":6,"author":{"id":"a9e2633aeb6d7e2366a97d09712312c2442c6054"},"timestamp":1768930212,"metadata":{"github-id":"UCE_lAHODBZtRc7j6wEuzp4Ftew"},"target":"9a694f2484a8ddd704f3dcafe7049ac6c566bb36969449b09bff8e604ce431ae","message":"We are receiving many requests to the API, from the CLI, of the following format:\n```\nGET /api/zarr/\u003czarr_id\u003e/files/?prefix=0/0/0/13/14/97\u0026download=true\n```\n\nOften times, the path provided (`0/0/0/13/14/97`) is itself the only file returned, and as such, could just be retrieved by querying for the \"level\" above (`0/0/0/13/14`). Really though, every response from that endpoint is itself an object, so there should never be a case where the CLI is trying to determine if a path returned is a directory or a file.\n\n~I believe the code generating these requests lives [here](https://github.com/dandi/dandi-cli/blob/953923aff871fc4dd16e3435427576e48eadb7c4/dandi/dandiapi.py#L1786-L1795)~ See the comment below.\n\nIt's possible the requests we're receiving are from a modified version of the CLI, in which case this issue can be closed (if we can truly determine that to be the case).","files":null},{"type":3,"author":{"id":"a9e2633aeb6d7e2366a97d09712312c2442c6054"},"timestamp":1768930163,"metadata":{"github-id":"IC_kwDODBZtRc7g9DPd","github-url":"https://github.com/dandi/dandi-cli/issues/1777#issuecomment-3774100445"},"message":"It actually seems to be originating from here:\n\nhttps://github.com/dandi/dandi-cli/blob/ccdb6593597c50cd9d8d7a905643b20d81caf3e6/dandi/dandiapi.py#L2085-L2096\n\n\nWhich is being called [here](https://github.com/dandi/dandi-cli/blob/ccdb6593597c50cd9d8d7a905643b20d81caf3e6/dandi/dandiapi.py#L2105). \n\nThis results in one request to the archive per zarr chunk.\n\n\n---\n\nWe should instead update the CLI to handle OPEN zarrs (zarrs within OPEN dandisets) by directly navigating to S3. The zarr can then be downloaded either by listing out files under the bucket prefix that corresponds to the zarr root, or by reading the zarr metadata files at the root of the zarr, which are in a known location. The `zarr-python` library could even be used, if that makes sense.\n\nFor embargoed zarrs, this behavior can remain. This is much less of an issue, as authentication would be required to access these zarrs anyway.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1768936894,"metadata":{"github-id":"IC_kwDODBZtRc7g-ySO","github-url":"https://github.com/dandi/dandi-cli/issues/1777#issuecomment-3774555278"},"message":"but shouldn't we also optimize as to batch request of URLs in such a code so it would become more efficient for embargoed as well?","files":null},{"type":6,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1768936961,"metadata":{"github-id":"UCE_lALODBZtRc7g-ySOzpIAW5E"},"target":"cfcbf2ff6e194a97869ece5a2df810944849948710c656dad5252678eb646945","message":"but shouldn't we also optimize as to batch request of URLs in such a code so it would become more efficient for embargoed as well?\n\nedit: as soon as we get ETag (https://github.com/dandi/dandi-archive/issues/2215) , we could then persistently cache those on drive as well.","files":null},{"type":3,"author":{"id":"a9e2633aeb6d7e2366a97d09712312c2442c6054"},"timestamp":1768943627,"metadata":{"github-id":"IC_kwDODBZtRc7hAaIi","github-url":"https://github.com/dandi/dandi-cli/issues/1777#issuecomment-3774980642"},"message":"\u003e but shouldn't we also optimize as to batch request of URLs in such a code so it would become more efficient for embargoed as well?\n\nThat's true, although that would come as a secondary objective, since public zarrs account for the vast majority of use.","files":null}]}