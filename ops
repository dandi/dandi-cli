{"version":2,"ops":[{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1642438785,"metadata":{"github-id":"IC_kwDODBZtRc48e6p0","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1014737524"},"message":"Should this always be done, or should it only happen if a certain `--embargoed`/`--anonymous` (or `--auth`/`--no-auth` or whatever) option is given/not given?\n\nCC: @yarikoptic","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1642439877,"metadata":{"github-id":"IC_kwDODBZtRc48e-Y5","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1014752825"},"message":"https://github.com/dandi/dandi-cli/blob/433380a07d01a8fd859b98a00c89141ddc4cd960/dandi/dandiarchive.py#L146-L147 is at least one of the places that `dandi_authenticate` needs to be called.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1642528753,"metadata":{"github-id":"IC_kwDODBZtRc48iem5","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1015671225"},"message":"Ideally authentication should be requested only if http return code instructs to do so, so HTTP return code 401 (requires authentication). I don't think that ATM we should do that on 403 (Forbidden) which would mean that user doesn't have credentials provided specifically for the requested resource.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1642529115,"metadata":{"github-id":"IC_kwDODBZtRc48ifyR","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1015676049"},"message":"@yarikoptic Why not request authentication iff the Dandiset's data indicates it's embargoed instead of relying on response codes?\n\n@dchiquito What exactly is returned currently if an unauthenticated request is made to `GET /dandisets/{versions__dandiset__pk}/versions/{versions__version}/assets/`?","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1642529124,"metadata":{"github-id":"UCE_lALODBZtRc48ifyRziA5UWs"},"target":"4653d401e53126d6b23c1d7f9e1fcc4c4ba8d5db11519b4ce9dd618acc4fac30","message":"@yarikoptic Why not request authentication iff the Dandiset's data indicates it's embargoed instead of relying on response codes?\n\n@dchiquito What exactly is returned currently if an unauthenticated request is made to `GET /dandisets/{versions__dandiset__pk}/versions/{versions__version}/assets/` for an embargoed Dandiset?","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1642529340,"metadata":{"github-id":"IC_kwDODBZtRc48igg0","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1015679028"},"message":"@jwodder Right now it is a 200 with this body:\n```json\n{\n  \"count\": 0,\n  \"next\": null,\n  \"previous\": null,\n  \"results\": []\n}\n```\nIn #869 there is discussion of changing it, however.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1642530297,"metadata":{"github-id":"IC_kwDODBZtRc48ijf0","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1015691252"},"message":"\u003e @yarikoptic Why not request authentication iff the Dandiset's data indicates it's embargoed instead of relying on response codes?\n\nI feel that relying on \"standard\" response codes would make it more robust.  E.g. would we need to adjust code if later we introduce some \"restricted\" dandisets?  Also it allows for per-asset control of needing authentication or not: e.g. if some assets of interest in embargoed dandiset are \"public\" (I believe current implementation allows for that and such assets could be downloaded without authentication) -- why should we require authentication?","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1642530484,"metadata":{"github-id":"IC_kwDODBZtRc48ikK4","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1015694008"},"message":"@yarikoptic\n\n\u003e if some assets of interest in embargoed dandiset are \"public\"\n\nHow would the API work in that case?  If an embargoed Dandiset has public assets, then I would expect a request to its `../assets/` endpoint to list only the public assets, in which case there would be no reason to make a request that would result in a 401.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1642535656,"metadata":{"github-id":"IC_kwDODBZtRc48i50F","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1015782661"},"message":"100$ questn ;-) i guess the same 401/403 regardless if any asset is public as long as dandiset is not.","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1642696560,"metadata":{"github-id":"IC_kwDODBZtRc48qMac","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1017693852"},"message":"AFAIK this is the only remaining blocker for releasing embargo. It seems like the easiest path forward would be to simply send Authorization headers on all requests if they are available. @jwodder @yarikoptic are you asking for the API to respond with a 401 rather than 404 on all embargo endpoints if the user is not logged in? That is a non-trivial change that will take me some time to add, and the deadline is looming.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1642697257,"metadata":{"github-id":"IC_kwDODBZtRc48qPGb","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1017704859"},"message":"@dchiquito What does \"if they are available\" mean?  Getting an API key can potentially involve prompting the user for input â€” possibly even when just trying to query the keyring.  Doing that every time a command is run seems like bad UX.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1642697430,"metadata":{"github-id":"IC_kwDODBZtRc48qPyw","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1017707696"},"message":"\u003e @jwodder @yarikoptic are you asking for the API to respond with a 401 rather than 404 on all embargo endpoints if the user is not logged in?\n\n401 or 403 to be exact. Ref: https://github.com/dandi/dandi-archive/issues/669\n\nagree with @jwodder on UX concern.  What we could do interim may be - do authenticate unconditionally iff `DANDI_API_KEY` env var is set, and let people know about such necessity. Wdyt @jwodder ?  But in the longer run I do think we need proper return codes to react to","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1642697599,"metadata":{"github-id":"IC_kwDODBZtRc48qQgo","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1017710632"},"message":"I had assumed that the keyring/env var were \"free\" and could be checked and included without user intervention. If they are costly UX wise then I agree that the API should be used to mitigate that.\nI'm still working on the zarr embargo feature though. so if there is a short-term fix that would be ideal. I would be fine with \"requiring\" `DANDI_API_KEY` for now and documenting that clearly in the embargo instructions.","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1642697860,"metadata":{"github-id":"IC_kwDODBZtRc48qRkO","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1017714958"},"message":"@yarikoptic @dchiquito Are public assets in embargoed Dandisets a thing that needs to be supported?  If yes, then I would expect unauthenticated requests to `.../assets/` to always return 200 (assuming the Dandiset \u0026 version exist) with a list of public assets, and in that case we would be unable to use return codes or embargo status to decide whether authentication is needed; `dandi download` would then need explicit an `--auth` (or whatever) option in order to enable downloading of embargoed assets.\n\nIf embargoed Dandisets cannot have public assets, then the client should be able to detect whether authentication is needed for a download based on the embargo status of the Dandiset, in which case we could triggre the ususal authentication routines.\n\nIn the long term, I think we should toss the whole keyring thing and add a \"login\" command that stores an API key in plain text in a config file somewhere, which is what things like [GitHub's official client](https://github.com/cli/cli) do.","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1642697963,"metadata":{"github-id":"UCE_lALODBZtRc48qRkOziBJMKU"},"target":"18576f81b7b131a40c168ddab0c2734832658d2baa15ed3042b59e67a4625318","message":"@yarikoptic @dchiquito Are public assets in embargoed Dandisets a thing that needs to be supported?  If yes, then I would expect unauthenticated requests to `.../assets/` to always return 200 (assuming the Dandiset \u0026 version exist) with a list of public assets, and in that case we would be unable to use return codes or embargo status to decide whether authentication is needed; `dandi download` would then need explicit an `--auth` (or whatever) option in order to enable downloading of embargoed assets.\n\nIf embargoed Dandisets cannot have public assets, then the client should be able to detect whether authentication is needed for a download based on the embargo status of the Dandiset, in which case we could trigger the ususal authentication routines.\n\nIn the long term, I think we should toss the whole keyring thing and add a \"login\" command that stores an API key in plain text in a config file somewhere, which is what things like [GitHub's official client](https://github.com/cli/cli) do.","files":null},{"type":6,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1642698143,"metadata":{"github-id":"UCE_lALODBZtRc48qRkOziBJNx4"},"target":"18576f81b7b131a40c168ddab0c2734832658d2baa15ed3042b59e67a4625318","message":"@yarikoptic @dchiquito Are public assets in embargoed Dandisets a thing that needs to be supported?  If yes, then I would expect unauthenticated requests to `.../assets/` to always return 200 (assuming the Dandiset \u0026 version exist) with a list of public assets, and in that case we would be unable to use return codes or embargo status to decide whether authentication is needed; `dandi download` would then need explicit an `--auth` (or whatever) option in order to enable downloading of embargoed assets.\n\nIf embargoed Dandisets cannot have public assets, then the client should be able to detect whether authentication is needed for a download based on the embargo status of the Dandiset, in which case we could trigger the ususal authentication routines.\n\nIn the long term, I think we should toss the whole keyring thing and add a \"login\" command that stores an API key in clear text in a config file somewhere, which is what things like [GitHub's official client](https://github.com/cli/cli) do.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1642698964,"metadata":{"github-id":"IC_kwDODBZtRc48qWCy","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1017733298"},"message":"\u003e Are public assets in embargoed Dandisets a thing that needs to be supported?\n\nyes. see this design PR: https://github.com/dandi/dandi-archive/pull/821","files":null},{"type":3,"author":{"id":"364914f8b1c8a9131d300bf2978e4ffe2ff1aeeb"},"timestamp":1642699254,"metadata":{"github-id":"IC_kwDODBZtRc48qXS2","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1017738422"},"message":"@satra That seems to suggest that an individual version would be composed of either all public assets or all embargoed assets, not a mix of the two, which is what I meant.","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1642699444,"metadata":{"github-id":"IC_kwDODBZtRc48qYGH","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1017741703"},"message":"it can be a mix. i publish and turn the draft into embargoed state and add new assets. the new assets would be embargoed, the existing assets from the draft would be public.","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1642700333,"metadata":{"github-id":"IC_kwDODBZtRc48qbTU","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1017754836"},"message":"@jwodder I think it would be fine to return a 401 from `api/dandisets/{did}/versions/{vid}/assets/` if the version is embargoed, even if it contains assets that are public. The 401 would indicate that the client does not have permission to see which assets belong to that version, even though the client could access those assets directly through other API endpoints.\n\n\u003eIn the long term, I think we should toss the whole keyring thing and add a \"login\" command that stores an API key in clear text in a config file somewhere, which is what things like GitHub's official client do.\n:+1: I like the idea of a `dandi login` that lets users adjust their API keys at will","files":null},{"type":6,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1642700579,"metadata":{"github-id":"UCE_lALODBZtRc48qbTUziBJh7A"},"target":"9c4c41b00a5a2e2f5d2888ca8991f2f56b2242d906b379c765ee6a2caae86f35","message":"@jwodder I think it would be fine to return a 401 from `api/dandisets/{did}/versions/{vid}/assets/` if the version is embargoed, even if it contains assets that are public. The 401 would indicate that the client does not have permission to see which assets belong to that version, even though the client could access those assets directly through other API endpoints.\n\n\u003eIn the long term, I think we should toss the whole keyring thing and add a \"login\" command that stores an API key in clear text in a config file somewhere, which is what things like GitHub's official client do.\n\n:+1: I like the idea of a `dandi login` that lets users adjust their API keys at will","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1642700509,"metadata":{"github-id":"IC_kwDODBZtRc48qb73","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1017757431"},"message":"\u003e @yarikoptic @dchiquito Are public assets in embargoed Dandisets a thing that needs to be supported? If yes, then I would expect unauthenticated requests to `.../assets/` to ...\n\nI [keep thinking](https://github.com/dandi/dandi-cli/issues/867#issuecomment-1015782661) API should just return 401/403 for embargoed regardless either it has any (or all) public assets.  Returning only public (if non-auth) could lead to undesired data disappearance (download dandiset forgetting to `--auth`, add asset, upload with --sync)","files":null},{"type":3,"author":{"id":"12cb25e6e3f19b53447b05d00d7d4d53c925c908"},"timestamp":1642700872,"metadata":{"github-id":"IC_kwDODBZtRc48qdHU","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1017762260"},"message":"\u003e API should just return 401/403 for embargoed regardless \n\ni think the challenge is not for things that have a notion of embargoed (e.g., upload to an embargoed dandiset), but for direct asset download links, where it's not known if the asset is in an embargoed dataset. a public asset is public, it's presence in an embargoed dandiset is irrelevant. so 401/403 should only apply to endpoints that have direct notion of dandiset information i.e under `/dandiset` or asset id, where it's known if the asset is in public or embargoed bucket.","files":null},{"type":3,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1642701201,"metadata":{"github-id":"IC_kwDODBZtRc48qeP_","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1017766911"},"message":"@satra I think we are on the same page ;) discussion above was primarily about `/api/dandisets/{did}/versions/{vid}/assets/` end point listing assets of an embargoed dandiset. so - it would have \"direct notion\".","files":null},{"type":3,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1642710473,"metadata":{"github-id":"IC_kwDODBZtRc48q--m","github-url":"https://github.com/dandi/dandi-cli/issues/867#issuecomment-1017900966"},"message":"https://github.com/dandi/dandi-archive/pull/831 will make it so that 401 is always returned when querying embargoed stuff without authenticating, and 403 is always returned when querying embargoed stuff without having ownership of the dandiset.","files":null},{"type":4,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1643052184,"metadata":{"github-id":"CE_lADODBZtRc5B7XJQzwAAAAFiWJwd"},"status":2}]}