{"version":2,"ops":[{"type":1,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1604599373,"metadata":{"github-id":"MDU6SXNzdWU3MzcxNTI5MDU=","github-url":"https://github.com/dandi/dandi-cli/issues/264","origin":"github"},"title":"race between upload and download leads to a crash","message":"We (ab)use girder so that we expect only 1 file per item.  But also to ensure that we are not leaving user without any file during download if a new version is being uploaded, or to end up without an item/file if upload fails,  we first upload new and then delete old file IIRC (yet to check code).  but that could lead to: \n\nWhen uploading a new version of a file \n\u003cdetails\u003e\n\u003csummary\u003edetails from the cron job\u003c/summary\u003e \n\n```shell\n2020-11-05T12:12:03-0500 [INFO    ] backups2datalad.py Syncing Dandiset 000003                                                                                                                                                                                                                                                                                                                                     \n2020-11-05T12:12:04-0500 [INFO    ] dandi Traversing remote dandisets (000003) recursively                                                                                                                                                                                                                                                                                                                         \n2020-11-05T12:12:04-0500 [INFO    ] backups2datalad.py Updating metadata file                                                                                                                                                                                                                                                                                                                                      \n2020-11-05T12:12:04-0500 [WARNING ] dandi Ran into an empty item: {'_id': '5fa42f0b271e91aad754e4b5', '_modelType': 'item', 'baseParentId': '5e59bb0af19e820ab6ea6c62', 'baseParentType': 'collection', 'created': '2020-11-05T16:57:47.668000+00:00', 'creatorId': '5ee6c160155e470d51c94881', 'description': '', 'folderId': '5e73fad0368d3c79a8006c12', 'meta': {}, 'name':                                     \n'sub-YutaMouse20_ses-YutaMouse20-140321_behavior+ecephys.nwb', 'size': 0, 'updated': '2020-11-05T16:57:47.668000+00:00'}                                                                                                                                                                                                                                                                                           \n2020-11-05T12:12:04-0500 [WARNING ] dandi Ran into an empty item: {'_id': '5fa42eef271e91aad754e4b1', '_modelType': 'item', 'baseParentId': '5e59bb0af19e820ab6ea6c62', 'baseParentType': 'collection', 'created': '2020-11-05T16:57:19.391000+00:00', 'creatorId': '5ee6c160155e470d51c94881', 'description': '', 'folderId': '5e73fad0368d3c79a8006c12', 'meta': {}, 'name':                                     \n'sub-YutaMouse20_ses-YutaMouse20-140324_behavior+ecephys.nwb', 'size': 0, 'updated': '2020-11-05T16:57:19.391000+00:00'}                                                                                                                                                                                                                                                                                           \n2020-11-05T12:12:04-0500 [WARNING ] dandi Ran into an empty item: {'_id': '5fa42f1d271e91aad754e4ba', '_modelType': 'item', 'baseParentId': '5e59bb0af19e820ab6ea6c62', 'baseParentType': 'collection', 'created': '2020-11-05T16:58:05.895000+00:00', 'creatorId': '5ee6c160155e470d51c94881', 'description': '', 'folderId': '5e73fad0368d3c79a8006c12', 'meta': {}, 'name':                                     \n'sub-YutaMouse20_ses-YutaMouse20-140325_behavior+ecephys.nwb', 'size': 0, 'updated': '2020-11-05T16:58:05.895000+00:00'}                                                                                                                                                                                                                                                                                           \n2020-11-05T12:12:04-0500 [WARNING ] dandi Ran into an empty item: {'_id': '5fa42f00271e91aad754e4b3', '_modelType': 'item', 'baseParentId': '5e59bb0af19e820ab6ea6c62', 'baseParentType': 'collection', 'created': '2020-11-05T16:57:35.985000+00:00', 'creatorId': '5ee6c160155e470d51c94881', 'description': '', 'folderId': '5e73fad0368d3c79a8006c12', 'meta': {}, 'name':                                     \n'sub-YutaMouse20_ses-YutaMouse20-140327_behavior+ecephys.nwb', 'size': 0, 'updated': '2020-11-05T16:57:35.985000+00:00'}                                                                                                                                                                                                                                                                                           \n2020-11-05T12:12:05-0500 [WARNING ] dandi Ran into an empty item: {'_id': '5fa42f10271e91aad754e4b7', '_modelType': 'item', 'baseParentId': '5e59bb0af19e820ab6ea6c62', 'baseParentType': 'collection', 'created': '2020-11-05T16:57:52.589000+00:00', 'creatorId': '5ee6c160155e470d51c94881', 'description': '', 'folderId': '5e73fad0368d3c79a8006c12', 'meta': {}, 'name':                                     \n'sub-YutaMouse20_ses-YutaMouse20-140328_behavior+ecephys.nwb', 'size': 0, 'updated': '2020-11-05T16:57:52.589000+00:00'}                                                                                                                                                                                                                                                                                           \n2020-11-05T12:12:05-0500 [ERROR   ] backups2datalad.py Operation failed with exception:                                                                                                                                                                                                                                                                                                                            \nTraceback (most recent call last):                                                                                                                                                                                                                                                                                                                                                                                 \n  File \"tools/backups2datalad.py\", line 462, in dandi_logging                                                                                                                                                                                                                                                                                                                                                      \n    yield logfile                                                                                                                                                                                                                                                                                                                                                                                                  \n  File \"tools/backups2datalad.py\", line 242, in sync_dataset                                                                                                                                                                                                                                                                                                                                                       \n    for a in assets:                                                                                                                                                                                                                                                                                                                                                                                               \n  File \"/home/dandi/proj/dandi/dandi-cli/dandi/girder.py\", line 518, in \u003cgenexpr\u003e                                                                                                                                                                                                                                                                                                                                  \n    (                                                                                                                                                                                                                                                                                                                                                                                                              \n  File \"/home/dandi/proj/dandi/dandi-cli/dandi/utils.py\", line 197, in flatten                                                                                                                                                                                                                                                                                                                                     \n    yield from flattened(i)                                                                                                                                                                                                                                                                                                                                                                                        \n  File \"/home/dandi/proj/dandi/dandi-cli/dandi/utils.py\", line 204, in flattened                                                                                                                                                                                                                                                                                                                                   \n    return list(flatten(it))                                                                                                                                                                                                                                                                                                                                                                                       \n  File \"/home/dandi/proj/dandi/dandi-cli/dandi/utils.py\", line 195, in flatten                                                                                                                                                                                                                                                                                                                                     \n    for i in it:                                                                                                                                                                                                                                                                                                                                                                                                   \n  File \"/home/dandi/proj/dandi/dandi-cli/dandi/girder.py\", line 470, in \u003cgenexpr\u003e                                                                                                                                                                                                                                                                                                                                  \n    files = (e for e in entities if e[\"type\"] == \"file\")                                                                                                                                                                                                                                                                                                                                                           \n  File \"/home/dandi/proj/dandi/dandi-cli/dandi/girder.py\", line 272, in traverse_asset                                                                                                                                                                                                                                                                                                                             \n    yield from self._traverse_asset_girder(g, parent_path, recursive=recursive)                                                                                                                                                                                                                                                                                                                                    \n  File \"/home/dandi/proj/dandi/dandi-cli/dandi/girder.py\", line 315, in _traverse_asset_girder                                                                                                                                                                                                                                                                                                                     \n    for child_a in self._traverse_asset_girder(child, a[\"path\"]):                                                                                                                                                                                                                                                                                                                                                  \n  File \"/home/dandi/proj/dandi/dandi-cli/dandi/girder.py\", line 315, in _traverse_asset_girder                                                                                                                                                                                                                                                                                                                     \n    for child_a in self._traverse_asset_girder(child, a[\"path\"]):                                                                                                                                                                                                                                                                                                                                                  \n  File \"/home/dandi/proj/dandi/dandi-cli/dandi/girder.py\", line 289, in _traverse_asset_girder                                                                                                                                                                                                                                                                                                                     \n    raise ValueError(                                                                                                                                                                                                                                                                                                                                                                                              \nValueError: multiple files per item not yet supported (if ever will be). Got: [{'_id': '5fa42f89271e91aad754e4bc', '_modelType': 'file', 'created': '2020-11-05T16:59:53.675000+00:00', 'creatorId': '5ee6c160155e470d51c94881', 'exts': ['nwb'], 'itemId': '5fa42d99271e91aad754e4a4', 'mimeType': 'application/octet-stream', 'name': 'sub-YutaMouse23_ses-YutaMouse23-140804_behavior+ecephys.nwb', 'size':     \n7482132601}, {'_id': '5fa431f2271e91aad754e4c0', '_modelType': 'file', 'created': '2020-11-05T17:10:10.478000+00:00', 'creatorId': '5ee6c160155e470d51c94881', 'exts': ['nwb'], 'itemId': '5fa42d99271e91aad754e4a4', 'mimeType': 'application/octet-stream', 'name': 'sub-YutaMouse23_ses-YutaMouse23-140804_behavior+ecephys.nwb', 'size': 7482132601}]                                                          \nTraceback (most recent call last):                                                                                                                                                                                                                                                                                                                                                                                 \n  File \"tools/backups2datalad.py\", line 471, in \u003cmodule\u003e                                                                                                                                                                                                                                                                                                                                                           \n    main()                                                                                                                                                                                                                                                                                                                                                                                                         \n  File \"/home/dandi/miniconda3/envs/dandi-cli-dev/lib/python3.8/site-packages/click/core.py\", line 829, in __call__                                                                                                                                                                                                                                                                                                \n    return self.main(*args, **kwargs)                                                                                                                                                                                                                                                                                                                                                                              \n  File \"/home/dandi/miniconda3/envs/dandi-cli-dev/lib/python3.8/site-packages/click/core.py\", line 782, in main                                                                                                                                                                                                                                                                                                    \n    rv = self.invoke(ctx)                                                                                                                                                                                                                                                                                                                                                                                          \n  File \"/home/dandi/miniconda3/envs/dandi-cli-dev/lib/python3.8/site-packages/click/core.py\", line 1066, in invoke                                                                                                                                                                                                                                                                                                 \n    return ctx.invoke(self.callback, **ctx.params)                                                                                                                                                                                                                                                                                                                                                                 \n  File \"/home/dandi/miniconda3/envs/dandi-cli-dev/lib/python3.8/site-packages/click/core.py\", line 610, in invoke                                                                                                                                                                                                                                                                                                  \n    return callback(*args, **kwargs)                                                                                                                                                                                                                                                                                                                                                                               \n  File \"tools/backups2datalad.py\", line 96, in main                                                                                                                                                                                                                                                                                                                                                                \n    DatasetInstantiator(                                                                                                                                                                                                                                                                                                                                                                                           \n  File \"tools/backups2datalad.py\", line 170, in run                                                                                                                                                                                                                                                                                                                                                                \n    if self.sync_dataset(did, ds):                                                                                                                                                                                                                                                                                                                                                                                 \n  File \"tools/backups2datalad.py\", line 242, in sync_dataset                                                                                                                                                                                                                                                                                                                                                       \n    for a in assets:                                                                                                                                                                                                                                                                                                                                                                                               \n  File \"/home/dandi/proj/dandi/dandi-cli/dandi/girder.py\", line 518, in \u003cgenexpr\u003e                                                                                                                                                                                                                                                                                                                                  \n    (                                                                                                                                                                                                                                                                                                                                                                                                              \n  File \"/home/dandi/proj/dandi/dandi-cli/dandi/utils.py\", line 197, in flatten                                                                                                                                                                                                                                                                                                                                     \n    yield from flattened(i)                                                                                                                                                                                                                                                                                                                                                                                        \n  File \"/home/dandi/proj/dandi/dandi-cli/dandi/utils.py\", line 204, in flattened                                                                                                                                                                                                                                                                                                                                   \n    return list(flatten(it))                                                                                                                                                                                                                                                                                                                                                                                       \n  File \"/home/dandi/proj/dandi/dandi-cli/dandi/utils.py\", line 195, in flatten                                                                                                                                                                                                                                                                                                                                     \n    for i in it:                                                                                                                                                                                                                                                                                                                                                                                                   \n  File \"/home/dandi/proj/dandi/dandi-cli/dandi/girder.py\", line 470, in \u003cgenexpr\u003e                                                                                                                                                                                                                                                                                                                                  \n    files = (e for e in entities if e[\"type\"] == \"file\")                                                                                                                                                                                                                                                                                                                                                           \n  File \"/home/dandi/proj/dandi/dandi-cli/dandi/girder.py\", line 272, in traverse_asset                                                                                                                                                                                                                                                                                                                             \n    yield from self._traverse_asset_girder(g, parent_path, recursive=recursive)                                                                                                                                                                                                                                                                                                                                    \n  File \"/home/dandi/proj/dandi/dandi-cli/dandi/girder.py\", line 315, in _traverse_asset_girder                                                                                                                                                                                                                                                                                                                     \n    for child_a in self._traverse_asset_girder(child, a[\"path\"]):                                                                                                                                                                                                                                                                                                                                                  \n  File \"/home/dandi/proj/dandi/dandi-cli/dandi/girder.py\", line 315, in _traverse_asset_girder                                                                                                                                                                                                                                                                                                                     \n    for child_a in self._traverse_asset_girder(child, a[\"path\"]):                                                                                                                                                                                                                                                                                                                                                  \n  File \"/home/dandi/proj/dandi/dandi-cli/dandi/girder.py\", line 289, in _traverse_asset_girder                                                                                                                                                                                                                                                                                                                     \n    raise ValueError(                                                                                                                                                                                                                                                                                                                                                                                              \nValueError: multiple files per item not yet supported (if ever will be). Got: [{'_id': '5fa42f89271e91aad754e4bc', '_modelType': 'file', 'created': '2020-11-05T16:59:53.675000+00:00', 'creatorId': '5ee6c160155e470d51c94881', 'exts': ['nwb'], 'itemId': '5fa42d99271e91aad754e4a4', 'mimeType': 'application/octet-stream', 'name': 'sub-YutaMouse23_ses-YutaMouse23-140804_behavior+ecephys.nwb', 'size':     \n7482132601}, {'_id': '5fa431f2271e91aad754e4c0', '_modelType': 'file', 'created': '2020-11-05T17:10:10.478000+00:00', 'creatorId': '5ee6c160155e470d51c94881', 'exts': ['nwb'], 'itemId': '5fa42d99271e91aad754e4a4', 'mimeType': 'application/octet-stream', 'name': 'sub-YutaMouse23_ses-YutaMouse23-140804_behavior+ecephys.nwb', 'size': 7482132601}]         \n```\n\u003c/details\u003e\n\nEven though in the case of new API this shouldn't happen, I think we should fixup current code to avoid that - probably, if girder would always have first file to be the older one, warn that there are multiple (not error) and proceed with the first one.","files":null}]}