{"version":2,"ops":[{"type":1,"author":{"id":"818a29386a430d42cbb57ad6dcccbe0fb486ffc3"},"timestamp":1593025977,"metadata":{"github-id":"MDU6SXNzdWU2NDQ4NTc3NDM=","github-url":"https://github.com/dandi/dandi-cli/issues/125","origin":"github"},"title":"Lock dandisets during modification","message":"`dandiarchive` now supports locking dandisets in girder so that other users cannot modify or publish them. The publish workflow is still unreleased (as of 6/24), but the functionality should be implemented in the CLI before release as a safeguard.\n\nThere are 3 new endpoints related to locking:\n- [/dandi/{identifier}/lock](https://girder.dandiarchive.org/api/v1#!/dandi/dandi_wrapper_0_1) locks a dandiset with the currently authenticated user. If the dandiset is already locked, even by the currently authenticated user, the call will fail. If locking fails, the operation should abort.\n- [/dandi/{identifier}/lock/owner](https://girder.dandiarchive.org/api/v1#!/dandi/dandi_wrapper_0_1_2) returns some info on the current owner of the lock on the dandiset. If the dandiset is unlocked, the response body will be `null`. If the dandiset is currently being published, the response will look like this:\n```\n{\n  \"email\": \"publish@dandiarchive.org\",\n  \"firstName\": \"publish\",\n  \"lastName\": \"service\"\n}\n```\n- [/dandi/{identifier}/unlock](https://girder.dandiarchive.org/api/v1#!/dandi/dandi_wrapper_0_1_2_3_4_5_6) unlocks the dandiset. If the dandiset is not locked by the currently authenticated user, the call will fail.\n\nBefore doing any modification to a dandiset in girder (i.e. upload), the CLI should call the lock endpoint. Afterwards, it should call the unlock endpoint.\nI recommend a pattern like what was used in [`dandi-publish`](https://github.com/dandi/dandi-publish/blob/master/publish/girder.py#L78):\n```\n@contextlib.contextmanager\ndef dandiset_lock(client, dandiset_identifier: str):\n    resp = client.post(f'dandi/{dandiset_identifier}/lock')\n    if resp.status_code != 200:\n        raise GirderError(f'Failed to lock dandiset {dandiset_identifier}')\n    try:\n        yield\n    finally:\n        resp = client.post(f'dandi/{dandiset_identifier}/unlock')\n        if resp.status_code != 200:\n            raise GirderError(f'Failed to unlock dandiset {dandiset_identifier}')\n```\nThis will create a method that can be used in a python `with` statement (like [this](https://github.com/dandi/dandi-publish/blob/master/publish/tasks.py#L17)):\n```\nwith dandiset_lock(client, dandiset.identifier):\n    ... do things ...\n```","files":null}]}