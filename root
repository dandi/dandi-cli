{"version":2,"ops":[{"type":1,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1726183222,"metadata":{"github-id":"I_kwDODBZtRc6WadEr","github-url":"https://github.com/dandi/dandi-cli/issues/1500","origin":"github"},"title":"download might fail with tons of `ValueError: Not all part hashes submitted` from dandietag","message":"reported by @Kevancic on slack for an attempt to re-download (with `-e refresh`) https://dandiarchive.org/dandiset/000026 which is respectful  File Count 40994 Size 38.4 TB . On my quick attempt to also do download -- all worked just fine.\n\n- #1499 is prepared to add more debug logging information during download\n\nbut looking at the log which reports that error for **majority** of logged there downloads -- it **feels like our loop for retries within `_download_file` manages to exit without any error while file is not yet fully downloaded: we looked at a sample failed file and it was not downloaded fully, but it did reach that state of the check for digest which we should reach ONLY if download finished successfully \n\n```shell\n❯ grep -e 2fb8dcd8-9ff3-47b8-b69a-11204ab2ea9e -e sub-I60/ses-SPIM/micr/sub-I60_ses-SPIM_sample-BrocaAreaS20_stain-Nuclei_chunk-40_SPIM.ome.tif ~/2024.09.10-16.09.03Z-152515.log\n2024-09-10T15:39:25-0400 [DEBUG   ] dandi 152515:140114245916480 GET https://api.dandiarchive.org/api/dandisets/000026/versions/draft/assets/2fb8dcd8-9ff3-47b8-b69a-11204ab2ea9e/\n2024-09-10T15:39:25-0400 [DEBUG   ] urllib3.connectionpool 152515:140114245916480 https://api.dandiarchive.org:443 \"GET /api/dandisets/000026/versions/draft/assets/2fb8dcd8-9ff3-47b8-b69a-11204ab2ea9e/ HTTP/1.1\" 200 1280\n2024-09-10T15:40:25-0400 [DEBUG   ] dandi 152515:140113753392896 Starting download from https://api.dandiarchive.org/api/assets/2fb8dcd8-9ff3-47b8-b69a-11204ab2ea9e/download/\n2024-09-10T15:40:25-0400 [DEBUG   ] urllib3.connectionpool 152515:140113753392896 https://api.dandiarchive.org:443 \"GET /api/assets/2fb8dcd8-9ff3-47b8-b69a-11204ab2ea9e/download/ HTTP/1.1\" 302 0\n2024-09-10T15:40:56-0400 [INFO    ] dandi 152515:140113753392896 Asset 2fb8dcd8-9ff3-47b8-b69a-11204ab2ea9e successfully downloaded\n2024-09-10T15:40:57-0400 [ERROR   ] dandi 152515:140113753392896 Caught while downloading 000026/sub-I60/ses-SPIM/micr/sub-I60_ses-SPIM_sample-BrocaAreaS20_stain-Nuclei_chunk-40_SPIM.ome.tif:\n\n❯ grep -A 10 'Caught while downloading 000026/sub-I60/ses-SPIM/micr/sub-I60_ses-SPIM_sample-BrocaAreaS20_stain-Nuclei_chunk-40_SPIM.ome.tif' ~/2024.09.10-16.09.03Z-152515.log\n2024-09-10T15:40:57-0400 [ERROR   ] dandi 152515:140113753392896 Caught while downloading 000026/sub-I60/ses-SPIM/micr/sub-I60_ses-SPIM_sample-BrocaAreaS20_stain-Nuclei_chunk-40_SPIM.ome.tif:\nTraceback (most recent call last):\n  File \"/autofs/cluster/exvivo3/dandi_env/dandi_v0.51/lib/python3.9/site-packages/dandi/download.py\", line 371, in _download_generator_guard\n    yield from generator\n  File \"/autofs/cluster/exvivo3/dandi_env/dandi_v0.51/lib/python3.9/site-packages/dandi/download.py\", line 764, in _download_file\n    final_digest = downloaded_digest.hexdigest()  # we care only about hex\n  File \"/autofs/cluster/exvivo3/dandi_env/dandi_v0.51/lib/python3.9/site-packages/dandischema/digests/dandietag.py\", line 207, in hexdigest\n    return self.etagger.as_str()\n  File \"/autofs/cluster/exvivo3/dandi_env/dandi_v0.51/lib/python3.9/site-packages/dandischema/digests/dandietag.py\", line 134, in as_str\n    raise ValueError(\"Not all part hashes submitted\")\nValueError: Not all part hashes submitted\n\n\n```\n\non filesystem it is\n\n```\n  File: sub-I60/ses-SPIM/micr/sub-I60_ses-SPIM_sample-BrocaAreaS20_stain-Nuclei_chunk-40_SPIM.ome.tif\n  Size: 83140248  \tBlocks: 162384     IO Block: 1048576 regular file\nDevice: 47h/71d\tInode: 14174564916967927168  Links: 1\nAccess: (0664/-rw-rw-r--)  Uid: (4688076/   kae34)   Gid: ( 1046/   recon)\nContext: system_u:object_r:nfs_t:s0\nAccess: 2024-09-12 15:56:16.675401095 -0400\nModify: 2024-09-10 15:40:57.084080980 -0400\nChange: 2024-09-10 15:40:57.092095496 -0400\n Birth: -\n```\n\nso 83MB whenever actual file should have size of 303MB:\n\n```shell\n❯ dandi ls --metadata all -f json dandi://dandi/000026@draft/sub-I60/ses-SPIM/micr/sub-I60_ses-SPIM_sample-BrocaAreaS20_stain-Nuclei_chunk-40_SPIM.ome.tif  | jq '.[].metadata | ( .id, .contentSize, .path, .digest ) '\n2024-09-12 19:18:09,821 [    INFO] Logs saved in /home/yoh/.local/state/dandi-cli/log/2024.09.12-23.18.08Z-327041.log\n\"dandiasset:2fb8dcd8-9ff3-47b8-b69a-11204ab2ea9e\"\n303529943\n\"sub-I60/ses-SPIM/micr/sub-I60_ses-SPIM_sample-BrocaAreaS20_stain-Nuclei_chunk-40_SPIM.ome.tif\"\n{\n  \"dandi:dandi-etag\": \"26634f4ae3043b43e90e36dbf83ddf2f-5\",\n  \"dandi:sha2-256\": \"926375681bd4c18259ee2266b449288fcca3e6745b883f8e2152c8fa953777fd\"\n}\n```","files":null}]}