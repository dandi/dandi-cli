{"version":2,"ops":[{"type":1,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1650570939,"metadata":{"github-id":"I_kwDODBZtRc5INdvn","github-url":"https://github.com/dandi/dandi-cli/issues/980","origin":"github"},"title":"get_content_url(follow_redirects=True) should stop when reaching a \"folder\"","message":"Discovered by @satra .\nATM for a zarr it would try to follow through with the HEAD request for the \"folder\" and that pukes.  I think it should be ok to catch that exception and if URL already ends with `/` then just stop at that URL.  Or may be @jwodder you see a better/more standardized way?\n\nA sample case:\n\n```\nIn [17]: import dandi.dandiapi as da\n\nIn [18]: dandi = da.DandiAPIClient.for_dandi_instance(\"dandi\")\n\nIn [19]: ds = dandi.get_dandiset('000108')\n\nIn [20]: asset = ds.get_asset_by_path('sub-MITU01/ses-20210521h17m17s06/micr/sub-MITU01_ses-20210521h17m17s06_sample-178_stain-LEC_run-1_chunk-1_SPIM.ngff')\n\nIn [21]: asset.get_content_url('s3')\nOut[21]: 'https://dandiarchive.s3.amazonaws.com/zarr/56509720-870c-4f43-ae41-7b75f9590722/'\n\nIn [22]: asset.get_content_url('s3', follow_redirects=True)\nError 404 while sending HEAD request to https://dandiarchive.s3.amazonaws.com/zarr/56509720-870c-4f43-ae41-7b75f9590722/: \n---------------------------------------------------------------------------\nHTTP404Error                              Traceback (most recent call last)\n\u003cipython-input-22-7673eb38d60d\u003e in \u003cmodule\u003e\n----\u003e 1 asset.get_content_url('s3', follow_redirects=True)\n\n~/proj/dandi/dandi-cli-master/dandi/dandiapi.py in get_content_url(self, regex, follow_redirects, strip_query)\n   1251             )\n   1252         if follow_redirects is True:\n-\u003e 1253             url = self.client.request(\n   1254                 \"HEAD\", url, json_resp=False, allow_redirects=True\n   1255             ).url\n\n~/proj/dandi/dandi-cli-master/dandi/dandiapi.py in request(self, method, path, params, data, files, json, headers, json_resp, retry_statuses, **kwargs)\n    241                 lgr.error(\"%s: %s\", msg, result.text)\n    242             if result.status_code == 404:\n--\u003e 243                 raise HTTP404Error(msg, response=result)\n    244             else:\n    245                 raise requests.HTTPError(msg, response=result)\n\nHTTP404Error: Error 404 while sending HEAD request to https://dandiarchive.s3.amazonaws.com/zarr/56509720-870c-4f43-ae41-7b75f9590722/\n\nIn [23]: asset.get_content_url()\nOut[23]: 'https://api.dandiarchive.org/api/assets/1838aeed-c773-400e-84b1-be0b8fa63dd9/download/'\n\nIn [24]: asset.get_content_url(follow_redirects=True)\nError 404 while sending HEAD request to https://api.dandiarchive.org/api/assets/1838aeed-c773-400e-84b1-be0b8fa63dd9/download/: \n---------------------------------------------------------------------------\nHTTP404Error                              Traceback (most recent call last)\n\u003cipython-input-24-b6f368972ab4\u003e in \u003cmodule\u003e\n----\u003e 1 asset.get_content_url(follow_redirects=True)\n\n~/proj/dandi/dandi-cli-master/dandi/dandiapi.py in get_content_url(self, regex, follow_redirects, strip_query)\n   1251             )\n   1252         if follow_redirects is True:\n-\u003e 1253             url = self.client.request(\n   1254                 \"HEAD\", url, json_resp=False, allow_redirects=True\n   1255             ).url\n\n~/proj/dandi/dandi-cli-master/dandi/dandiapi.py in request(self, method, path, params, data, files, json, headers, json_resp, retry_statuses, **kwargs)\n    241                 lgr.error(\"%s: %s\", msg, result.text)\n    242             if result.status_code == 404:\n--\u003e 243                 raise HTTP404Error(msg, response=result)\n    244             else:\n    245                 raise requests.HTTPError(msg, response=result)\n\nHTTP404Error: Error 404 while sending HEAD request to https://api.dandiarchive.org/api/assets/1838aeed-c773-400e-84b1-be0b8fa63dd9/download/\n```\n\nthe question is either we should not bother redirecting for any `/` or only for the urls from the `s3.amazonaws.com` subdomains since we know that there is no real \"folder/\" on S3 (although \"folder\" key could exist)... for now I think we could stop following for any `/` url","files":null}]}