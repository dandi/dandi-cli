{"version":2,"ops":[{"type":1,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1615581896,"metadata":{"github-id":"MDU6SXNzdWU4MzA0MzMwOTQ=","github-url":"https://github.com/dandi/dandi-cli/issues/470","origin":"github"},"title":"tools/s3-gc-stats helper script","message":"dandiarchive bucket has versioning turned on, which is a great feature to guarantee access to the specific version of a key in case it mutates.  Versioning though brings in potential overhead, since deleted keys are not really deleted but rather DeleteMarker key is placed as the last \"version\" of that key.  Before we jump into GC of the bucket to get rid of no longer active prior versions, we need to be able to assess the current state of the given folder/prefix within s3 bucket.  \n\nSo I think we need a script like\n\n`s3-gc-stats --stat [\"all\",\"visible\",\"invisible\", \"old\"] [--list] [--fail-if-any] bucket [prefix]` \n\nwhich would traverse all versions of all the keys and provide stats on \nhow many (number)/much (total size) (and a list of them if ran with `--list`) for following cases (\"all\" by default)\n\n- `visible`: files/keys are \"visible\" (not DeleteMarker on top) \n- `invisible`: keys are \"invisible\" (as files) -- they were either removed (DeleteMarker is their last version) or superseded by a new version of the key; note: same file (prefix) could have multiple invisible keys\n- `old`: keys are \"old\" - correspond to prior versions of still valid files (so there is no DeleteMarker on top)\n\n\u003cdetails\u003e\n\u003csummary\u003e`s3://datalad-test0-versioned` might be a nice tiny sample bucket to try on since I believe it has a good number of use cases covered:\u003c/summary\u003e \n\n```shell\n$\u003e datalad ls -La -r s3://datalad-test0-versioned\nConnecting to bucket: datalad-test0-versioned\n[INFO   ] S3 session: Connecting to the bucket datalad-test0-versioned with authentication \nBucket info:\n  Versioning: {'Versioning': 'Enabled', 'MfaDelete': 'Disabled'}\n     Website: datalad-test0-versioned.s3-website-us-east-1.amazonaws.com\n         ACL: \u003cPolicy: yoh@cs.unm.edu (owner) = FULL_CONTROL\u003e\n1version-nonversioned1.txt                 2015-11-07T05:23:36.000Z 8 ver:null                              acl:\u003cPolicy: yoh@cs.unm.edu (owner) = FULL_CONTROL\u003e  http://datalad-test0-versioned.s3.amazonaws.com/1version-nonversioned1.txt?versionId=null [OK]\n1version-removed-recreated.txt             2015-11-07T05:23:38.000Z 8 ver:vurmCZo5d3.iAzTV.YAfTcMr.LDVjQIK  acl:\u003cPolicy: yoh@cs.unm.edu (owner) = FULL_CONTROL\u003e  http://datalad-test0-versioned.s3.amazonaws.com/1version-removed-recreated.txt?versionId=vurmCZo5d3.iAzTV.YAfTcMr.LDVjQIK [OK]\n1version-removed-recreated.txt             2015-11-07T05:23:38.000Z DeleteMarker\n1version-removed-recreated.txt             2015-11-07T05:23:38.000Z 8 ver:B7cP2PKGRNeRZ7EktWN82UnUaGjb9dh_  acl:\u003cPolicy: yoh@cs.unm.edu (owner) = FULL_CONTROL\u003e  http://datalad-test0-versioned.s3.amazonaws.com/1version-removed-recreated.txt?versionId=B7cP2PKGRNeRZ7EktWN82UnUaGjb9dh_ [OK]\n1version-removed.txt                       2015-11-07T05:23:37.000Z DeleteMarker\n1version-removed.txt                       2015-11-07T05:23:37.000Z 8 ver:eZ5Hgwo8azfBv3QT7aW9dmm2sbLUY.QP  acl:S3ResponseError: 404 Not Found\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e\n\u003cError\u003e\u003cCode\u003eNoSuchKey\u003c/Code\u003e\u003cMessage\u003eThe specified key does not exist.\u003c/Message\u003e\u003cKey\u003e1version-removed.txt\u003c/Key\u003e\u003cRequestId\u003eFCRBDCVKNVMY1MBJ\u003c/RequestId\u003e\u003cHostId\u003eAB1OdmQw4GWXfOK0h9ZcMEcNeh20Li/vpQz80fAn1/thA100x7OzjdveWSJq7mriR3TYovlisvs=\u003c/HostId\u003e\u003c/Error\u003e  http://datalad-test0-versioned.s3.amazonaws.com/1version-removed.txt?versionId=eZ5Hgwo8azfBv3QT7aW9dmm2sbLUY.QP [OK]\n2versions-nonversioned1.txt                2015-11-07T05:23:37.000Z 8 ver:V4Dqhu0QTEtxmvoNkCHGrjVZVomR1Ryo  acl:\u003cPolicy: yoh@cs.unm.edu (owner) = FULL_CONTROL\u003e  http://datalad-test0-versioned.s3.amazonaws.com/2versions-nonversioned1.txt?versionId=V4Dqhu0QTEtxmvoNkCHGrjVZVomR1Ryo [OK]\n2versions-nonversioned1.txt                2015-11-07T05:23:36.000Z 8 ver:null                              acl:\u003cPolicy: yoh@cs.unm.edu (owner) = FULL_CONTROL\u003e  http://datalad-test0-versioned.s3.amazonaws.com/2versions-nonversioned1.txt?versionId=null [OK]\n2versions-nonversioned1.txt_sameprefix     2015-11-07T05:23:37.000Z 8 ver:QUOLbSrBHBmU3UNeEvdfcX2puqRffH9l  acl:\u003cPolicy: yoh@cs.unm.edu (owner) = FULL_CONTROL\u003e  http://datalad-test0-versioned.s3.amazonaws.com/2versions-nonversioned1.txt_sameprefix?versionId=QUOLbSrBHBmU3UNeEvdfcX2puqRffH9l [OK]\n2versions-removed-recreated.txt            2015-11-07T05:23:37.000Z 8 ver:bBVSCB4MdBOeEXDQ2KwrjtrevpwFabaY  acl:\u003cPolicy: yoh@cs.unm.edu (owner) = FULL_CONTROL\u003e  http://datalad-test0-versioned.s3.amazonaws.com/2versions-removed-recreated.txt?versionId=bBVSCB4MdBOeEXDQ2KwrjtrevpwFabaY [OK]\n2versions-removed-recreated.txt            2015-11-07T05:23:37.000Z DeleteMarker\n2versions-removed-recreated.txt            2015-11-07T05:23:37.000Z 8 ver:zwW0b567gYO3puJeLMZsOmETqowJnv6l  acl:\u003cPolicy: yoh@cs.unm.edu (owner) = FULL_CONTROL\u003e  http://datalad-test0-versioned.s3.amazonaws.com/2versions-removed-recreated.txt?versionId=zwW0b567gYO3puJeLMZsOmETqowJnv6l [OK]\n2versions-removed-recreated.txt_sameprefix 2015-11-07T05:23:37.000Z 8 ver:cfTdf3N8exZLFg.KcW5szQKrFNLUyCu1  acl:\u003cPolicy: yoh@cs.unm.edu (owner) = FULL_CONTROL\u003e  http://datalad-test0-versioned.s3.amazonaws.com/2versions-removed-recreated.txt_sameprefix?versionId=cfTdf3N8exZLFg.KcW5szQKrFNLUyCu1 [OK]\n3versions-allversioned.txt                 2015-11-07T05:23:37.000Z 8 ver:Kvuind11HZh._dCPaDAb0OY9dRrQoTMn  acl:\u003cPolicy: yoh@cs.unm.edu (owner) = FULL_CONTROL\u003e  http://datalad-test0-versioned.s3.amazonaws.com/3versions-allversioned.txt?versionId=Kvuind11HZh._dCPaDAb0OY9dRrQoTMn [OK]\n3versions-allversioned.txt                 2015-11-07T05:23:37.000Z 8 ver:b.qCuh7Sg58VIYj8TVHzbRS97EvejzEl  acl:\u003cPolicy: yoh@cs.unm.edu (owner) = FULL_CONTROL\u003e  http://datalad-test0-versioned.s3.amazonaws.com/3versions-allversioned.txt?versionId=b.qCuh7Sg58VIYj8TVHzbRS97EvejzEl [OK]\n3versions-allversioned.txt                 2015-11-07T05:23:37.000Z 8 ver:pNsV5jJrnGATkmNrP8.i_xNH6CY4Mo5s  acl:\u003cPolicy: yoh@cs.unm.edu (owner) = FULL_CONTROL\u003e  http://datalad-test0-versioned.s3.amazonaws.com/3versions-allversioned.txt?versionId=pNsV5jJrnGATkmNrP8.i_xNH6CY4Mo5s [OK]\n3versions-allversioned.txt_sameprefix      2015-11-07T05:23:37.000Z 8 ver:Mvsc4FgJWc6gExwSw1d6wsLrnk6wdDVa  acl:\u003cPolicy: yoh@cs.unm.edu (owner) = FULL_CONTROL\u003e  http://datalad-test0-versioned.s3.amazonaws.com/3versions-allversioned.txt_sameprefix?versionId=Mvsc4FgJWc6gExwSw1d6wsLrnk6wdDVa [OK]\n```\n\u003c/details\u003e\n\nimmediate target use cases will be \n- `s3://dandiarchive/` as a whole so we could assess how many skeletons are in the closet\n- `--stat \"old\" --list --fail-if-any s3://dandiarchive/blobs` (as soon as we get new dandi-api blob store in the public bucket) - to be alerted to what should in theory not happen since blobs should be immutable and there should be no multiple versions of the same blob (or blobs with colliding UUIDs) \n\n@satra - any other target metric we might like/need?","files":null}]}