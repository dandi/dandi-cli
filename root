{"version":2,"ops":[{"type":1,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1600354206,"metadata":{"github-id":"MDU6SXNzdWU3MDM2NjA1ODQ=","github-url":"https://github.com/dandi/dandi-cli/issues/243","origin":"github"},"title":"\"instantiate\" dandisets from the \"backup\"","message":"To provide extensive testing for #226 on dandisets we have already in the archive, we need to download them all.  But that would be increasingly prohibitive.\n\nOn `drogon` backup server we already have a datalad dataset with the backup of S3.  \n\nThe idea is to \"instantiate\" dandisets present in the archive as directories with symlinks (or could actually be actual files via `cp --refllink=always` since its BTRFS CoW filesystem!) into some location on the drive, where those \"symlinks\" would be coming from an asset store which is located under /mnt/backup/dandi/dandiarchive-s3-backup/girder-assetstore .\n\nThe culprit is that asset store is using its own UUID, it is not an id of the girder's \"file\" .  So we would need to either follow the redirect from dandiarchive's girder to `https://girder.dandiarchive.org/api/v1/file/{file['id']}/download` to get the actual asset id:\n\n```shell\n$\u003e curl -I https://girder.dandiarchive.org/api/v1/file/5f176584f63d62e1dbd06946/download     \nHTTP/1.1 303 See Other\nServer: nginx/1.14.0 (Ubuntu)\nDate: Thu, 17 Sep 2020 14:42:28 GMT\nContent-Type: text/html;charset=utf-8\nContent-Length: 1652\nConnection: keep-alive\nAllow: DELETE, GET, HEAD, OPTIONS, PATCH, POST, PUT\nGirder-Request-Uid: 6e2b2cbc-c6a3-4265-8068-14151b94f9cc\nLocation: https://dandiarchive.s3.amazonaws.com/girder-assetstore/74/0f/740feade0d784acc8ec76bb7834d80dc?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIA3GIMZPVVEYHMC7MS%2F20200917%2Fus-east-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20200917T144228Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=FwoGZXIvYXdzEBAaDKv1lZXvP9wFZRzEdCK%2FAZFXw8ch9QU9XsbYJneN4%2BIZTHUkUdu9P8xVvYlNNECKMEA25TTmbsKywS5YSDkTeY6x%2F67QDDHhbGRH89XanXXUejXHSk%2F5vU8MajEq0WV2iGMkpbYTUw9lFIlCAXnprmcDLd7LyTWCBi9tWpycrXD8YSUto3VUXG%2FTMjHOx4%2FG8CGi3I%2F1m3siPX7SQexDrmK7YpGI0jxEVYxF9sVvUtKeYF3PZWyX1b6KB0t%2BOOy4UCL%2FPRhW8gYvtHO%2F2EnxKIrrjfsFMi1WZZe2Ye%2FEJi6jx1xSE6nG%2B%2BdKQ%2BdHoigP06wBwHoLSaCdyIhVkoNGyk%2BEMt8%3D\u0026X-Amz-Signature=cf09a8c3a24040939b756080de942bc79f171675ab70a4530a13e271b4adbe09\nStrict-Transport-Security: max-age=63072000\n```\nto get that `girder-assetstore/74/0f/740feade0d784acc8ec76bb7834d80dc` path which is on drogon:\n```\n$\u003e ls -l /mnt/backup/dandi/dandiarchive-s3-backup/girder-assetstore/74/0f/740feade0d784acc8ec76bb7834d80dc                 \nlrwxrwxrwx 1 yoh yoh 125 Jul 21 18:00 /mnt/backup/dandi/dandiarchive-s3-backup/girder-assetstore/74/0f/740feade0d784acc8ec76bb7834d80dc -\u003e ../../../.git/annex/objects/z8/3w/MD5E-s18792--33318fd510094e4304868b4a481d4a5a/MD5E-s18792--33318fd510094e4304868b4a481d4a5a\n```\n\nwhich would work but somewhat inefficient (we could cache those since mapping should not change) but work, or load from mongodb back the entire table and get all the mappings (more work - probably not).\n\nSo I think the course of action could be to \n\n- add an option \"add_resolved_url\" to `GirderCli.get_dandiset_and_assets` so it would add resolved URLs like above \"https://dandiarchive.s3.amazonaws.com/girder-assetstore/74/0f/740feade0d784acc...\" to the returned records of the assets\n- add `dandi instantiate --assetstore PATH -o TOPPATH DANDISET_ID` command (present only in `DANDI_DEVEL` mode) which would just go through all the assets of the dandiset and perform aforementioned `cp -L --reflink=always {assetstore}/{path-within-assetstore-fromurl}` \n\nI think it should work quite fast and would be very efficient since no heavy data transfer would be happening and no new space consumed (besides for filesystem level metadata for COW copied files)","files":null}]}