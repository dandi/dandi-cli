{"version":2,"ops":[{"type":1,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1702306392,"metadata":{"github-id":"I_kwDODBZtRc55WMH2","github-url":"https://github.com/dandi/dandi-cli/issues/1373","origin":"github"},"title":"Make file upload  be robust to file size changes","message":"Per request of @jwodder in https://github.com/dandi/dandi-cli/issues/1257#issuecomment-1850127241 filing it as a separate issue.\n\nBackground: As discovered [in that issue](https://github.com/dandi/dandi-cli/issues/1257#issuecomment-1839101911) we caught NFS (or some layer above on the way to Python) lying about file size to be 0 whenever it is not: the reported size gets changed within few seconds.  We also spotted S3 failing some uploads due to \"Content-MD5 you specified did not match what we received\", an exact reason for which we do not know.\nSo, apparently we cannot really rely on file system to provide us robust file size, and thus we should 1. provide mitigation to the 0-size file issue and to possibly help isolate any other incorrect file size reporting add a safe-guard.  \n\nI am filing it as a single issue since IMHO two aspects are very related and likely to be implemented in a concerted effort.   I will provide only high level description of desired behavior instead of mandating any particular implementation.\n\n- Should be in effect for *any* file upload,  be it a blob or a file within zarr folder upload\n- Upon initiation of upload do a *filesize check*: a file size reported to be 0, loop for up to 2 seconds (sleeping may be 100ms between) re-checking the file size. If it changes from 0 - can immediately proceed forward. If it remains 0 - proceed forward with 0 file size after those 2 seconds.\n- Upon completion of upload, be it successful or failed with an error, compare filesize with the one obtained in previous *filesize check* step. If size differs: if upload finished    successfully - do raise an (`IOError` or other you find more appropriate) exception summarizing size changes, if upload errorred out - just log an ERROR level log message summarizing size changes.","files":null}]}