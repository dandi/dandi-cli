{"version":2,"ops":[{"type":1,"author":{"id":"34bb3b7763ea6d04cae1c21ede40209df34305b5"},"timestamp":1616694037,"metadata":{"github-id":"MDU6SXNzdWU4NDExNjI0OTg=","github-url":"https://github.com/dandi/dandi-cli/issues/502","origin":"github"},"title":"upload: choked while uploading lots of tiny files","message":"did\n```\ndrogon:/mnt/backup/dandi/trash/010000\n$\u003e DANDI_DEVEL=1 dandi --pdb upload --validation ignore --allow-any-path -i dandi-api sub-*\n\n```\nto upload 1mil files (ref: https://github.com/dandi/dandi-api/issues/78#issuecomment-806714079)\n\nwhich fell into pdb and was not clear what exactly the reason\n\u003cdetails\u003e\n\u003csummary\u003ecopy paste from screen with some traceback\u003c/summary\u003e \n\n```shell\nsub-1/sub-1_ses-3_cell-5.z/8    29 Bytes         2               100% uploading\nsub-1/sub-1_ses-3_cell-5.z/6    29 Bytes         2               100% producing asset\nsub-1/sub-1_ses-3_cell-5.z/10   30 Bytes         2                    extracting metadata\n                                                                      3 uploading\n                                                                      1 producing asset\n2021-03-25 12:59:22,409 [    INFO] Logs saved in /home/yoh/.cache/dandi-cli/log/20210325162907Z-21350.log\nTraceback (most recent call last):\n  File \"/home/yoh/miniconda3/envs/dandi-devel/bin/dandi\", line 33, in \u003cmodule\u003e\n    sys.exit(load_entry_point('dandi', 'console_scripts', 'dandi')())\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/click/core.py\", line 829, in __call__\n    return self.main(*args, **kwargs)\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/click/core.py\", line 782, in main\n    rv = self.invoke(ctx)\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/click/core.py\", line 1259, in invoke\n    return _process_result(sub_ctx.command.invoke(sub_ctx))\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/click/core.py\", line 1066, in invoke\n    return ctx.invoke(self.callback, **ctx.params)\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/click/core.py\", line 610, in invoke\n    return callback(*args, **kwargs)\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/click/decorators.py\", line 33, in new_func\n    return f(get_current_context().obj, *args, **kwargs)\n  File \"/home/yoh/proj/dandi/dandi-cli/dandi/cli/base.py\", line 109, in wrapper\n    return f(*args, **kwargs)\n  File \"/home/yoh/proj/dandi/dandi-cli/dandi/cli/cmd_upload.py\", line 98, in upload\n    upload(\n  File \"/home/yoh/proj/dandi/dandi-cli/dandi/upload.py\", line 49, in upload\n    return _new_upload(\n  File \"/home/yoh/proj/dandi/dandi-cli/dandi/upload.py\", line 907, in _new_upload\n    out(rec)\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/pyout/interface.py\", line 96, in wrapped\n    return method(self, *args, **kwds)\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/pyout/interface.py\", line 634, in __call__\n    self._write(row, style)\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/pyout/interface.py\", line 357, in _write\n    self._write_fn(row, style)\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/pyout/interface.py\", line 376, in _write_update\n    content, status, summary = self._content.update(row, style)\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/pyout/common.py\", line 939, in update\n    summ_rows = self.summary.summarize(\n  File \"/home/yoh/miniconda3/envs/dandi-devel/lib/python3.8/site-packages/pyout/summary.py\", line 53, in summarize\n    summaries[col] = agg_fn(list(colvals))\n  Filesub-1/sub-1_ses-3_cell-5.z/6    29 Bytes         2               100% done\n    total = sum(v[\"size\"] for v in uploaded_paths.values())\n  File \"/home/yoh/proj/dandi/dandi-cli/dandi/upload.py\", line 869, in \u003cgenexpr\u003e\nsub-1/sub-1_ses-3_cell-5.z/11   30 Bytes         2                    pre-validating\nsub-1/sub-1_ses-3_cell-5.z/9    29 Bytes         2                    calculating etag\n\n\u003e /home/yoh/proj/dandi/dandi-cli/dandi/upload.py(869)\u003cgenexpr\u003e()\n-\u003e total = sum(v[\"size\"] for v in uploaded_paths.values())\n2021-03-25 12:59:22,716 [   ERROR] Error 404 while sending POST request to https://api.dandiarchive.org/api/blobs/digest/: {\"detail\":\"Not found.\"}\nSummary:                        72.4 kB   2411 with errors 40 Bytes/s 2405 done\n                                                                      3 uploading\n                                                                      1 calculating etag\n                                                                      1 extracting metadata\n                                                                      1 pre-validating\n                                                                      1 digesting\n2021-03-25 12:59:22,757 [   ERROR] Error 404 while sending POST request to https://api.dandiarchive.org/api/blobs/digest/: {\"detail\":\"Not found.\"}\n2021-03-25 12:59:22,763 [   ERROR] Error 404 while sending POST request to https://api.dandiarchive.org/api/blobs/digest/: {\"detail\":\"Not found.\"}\n2021-03-25 12:59:22,895 [   ERROR] Error 404 while sending POST request to https://api.dandiarchive.org/api/blobs/digest/: {\"detail\":\"Not found.\"}\n2021-03-25 12:59:23,230 [    INFO] sub-1/sub-1_ses-3_cell-5.z/7: Asset successfully uploaded\n2021-03-25 12:59:23,316 [    INFO] sub-1/sub-1_ses-3_cell-5.z/8: Asset successfully uploaded\n2021-03-25 12:59:23,752 [    INFO] sub-1/sub-1_ses-3_cell-5.z/10: Asset successfully uploaded\n2021-03-25 12:59:23,865 [    INFO] sub-1/sub-1_ses-3_cell-5.z/11: Asset successfully uploaded\n2021-03-25 12:59:23,924 [    INFO] sub-1/sub-1_ses-3_cell-5.z/12: Asset successfully uploaded\n2021-03-25 12:59:23,987 [    INFO] sub-1/sub-1_ses-3_cell-5.z/9: Asset successfully uploaded\n(Pdb) bt\n\n```\n\u003c/details\u003e\nand I have not looked into server logs. `dandi-cli` was 0.12.0+17.gbfe168c ... I will update `dandi-cli` to 0.12.1 and see if reproduces (although we switched from checking blobs for presence so it might just hide away the issue with dandi-api)","files":null}]}