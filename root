{"version":2,"ops":[{"type":1,"author":{"id":"f3856669ae05db18871381e4a2bf44e84858d017"},"timestamp":1701159409,"metadata":{"github-id":"I_kwDODBZtRc54CYPh","github-url":"https://github.com/dandi/dandi-cli/issues/1366","origin":"github"},"title":"Downloads hang indefinitely if connection interrupted from lack of `timeout`","message":"tell me when you're getting sick of me \u003c3\n\nDownloads happen by [iterating](https://github.com/dandi/dandi-cli/blob/0971d02a0725d5e22c76e1bf32c45ca32e666c92/dandi/download.py#L685) over some `downloader` object, wrapped in some number of [`attempt`](https://github.com/dandi/dandi-cli/blob/0971d02a0725d5e22c76e1bf32c45ca32e666c92/dandi/download.py#L669)s, catching [`HTTPErrors`](https://github.com/dandi/dandi-cli/blob/0971d02a0725d5e22c76e1bf32c45ca32e666c92/dandi/download.py#L706)\n\nThe core of the downloading logic for the default downloader is here, standard `requests` streaming:\n\nhttps://github.com/dandi/dandi-cli/blob/0971d02a0725d5e22c76e1bf32c45ca32e666c92/dandi/dandiapi.py#L1473-L1480\n\nThe zarr downloader is I think identical in this block?\n\nhttps://github.com/dandi/dandi-cli/blob/0971d02a0725d5e22c76e1bf32c45ca32e666c92/dandi/dandiapi.py#L1886-L1911\n\nA timeout is not used in either case, and the [`requests` docs](https://docs.python-requests.org/en/latest/user/quickstart/#timeouts) warn:\n\n\u003e Nearly all production code should use this parameter in nearly all requests. Failure to do so can cause your program to hang indefinitely\n\nand elaborates further on how timeouts are handled after the initial connection [here](https://docs.python-requests.org/en/latest/user/advanced/#timeouts)\n\nIf the connection is interrupted, the downloader hangs indefinitely even if the connection is re-established. \n\n## MWE\n\n- systems tested: MacOS and Debian 12\n- dandi version: `0.58.0`\n\nTo replicate:\n- Start downloading any dandiset with the `dandi download` command\n- Toggle WiFi off and on or disconnect and reconnect ethernet cable briefly.\n\n## Expected Behavior\n\nSince there is already retry logic around the download command, I think it would be straightforward to\n- set some timeout value in consts or read from env variable\n- pass timeout value to `session.get` call\n- catch `requests.exceptions.Timeout` in existing `requests.exceptions.HTTPError` block, which should already sleep for 5 seconds and retry.\n\nHappy to PR this very minimal change :)","files":null}]}