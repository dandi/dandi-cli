# Global Copilot Instructions

* Prioritize **minimal scope**: only edit code directly implicated by the failing test.
* Protect existing functionality: do **not** delete or refactor code outside the immediate test context.
* Before deleting any code, follow the "Coverage & Code Safety" guidelines below.

Copilot, do not modify any files under .lad/.
All edits must occur outside .lad/, or in prompts/ when explicitly updating LAD itself.

Coding & formatting
* Follow PEP 8; formatting enforced by pre-commit hooks (black, isort).
* Use type hints everywhere.
* Respect existing project dependencies declared in pyproject.toml.

Testing & linting
* Write tests using pytest; run via `tox -e py3` or `python -m pytest dandi`.
* Tests requiring the DANDI archive use Docker Compose fixtures.
* Mark AI-generated tests with `@pytest.mark.ai_generated`.
* Every function/class **must** include a **NumPy-style docstring** (Sections: Parameters, Returns, Raises, Examples).

## Testing Strategy by Component Type

**CLI Commands:**
* Use click's `CliRunner` for testing CLI entry points
* Test argument parsing, output formatting, and error messages
* Mock API calls and filesystem where appropriate

**API Client Operations (upload, download, move, etc.):**
* Use **integration testing** with Docker Compose fixtures for archive interactions
* Mock only external services not under test
* Test actual HTTP interactions, authentication, and error handling

**File Processing & Utilities:**
* Use **unit testing** with minimal dependencies
* Use test data fixtures (tmp_path, simple NWB files) for predictable inputs
* Focus on input/output correctness and error handling

## Regression Prevention

**Before making changes:**
* Run full test suite to establish baseline: `tox -e py3` or `python -m pytest dandi`
* Identify dependencies: `grep -r "function_name" . --include="*.py"`
* Understand impact scope before modifications

**During development:**
* Run affected tests after each change: `python -m pytest dandi/tests/test_modified_module.py`
* Preserve public API interfaces or update all callers
* Make minimal changes focused on the failing test

**Before commit:**
* Run full test suite: `tox -e py3`
* Verify no regressions introduced
* Ensure test coverage maintained or improved

## Code Quality Setup

**This project already has quality tooling configured.** Do not create new config files; use existing ones.

**Verify setup:**
```bash
pre-commit install               # Install pre-commit hooks if not present
tox -e lint                      # Run linting
tox -e typing                    # Run type checking
python -m pytest dandi           # Run tests
```

**Existing configuration locations:**
- **Linting/formatting**: `.pre-commit-config.yaml` (black, isort, flake8)
- **Pytest config**: `tox.ini` under `[pytest]` section
- **Type checking**: `tox.ini` under `[testenv:typing]`
- **Dependencies**: `pyproject.toml`

Coverage & Code Safety
* Before deleting code, verify:
  1. 0% coverage via `coverage report --show-missing`
  2. No references found via grep
  If both hold, prompt for confirmation before deletion.

Commits
* Follow existing project conventions for commit messages.
* pre-commit hooks will auto-fix formatting; if commit fails due to auto-fixes, re-run the commit.

Docs
* High-level docs live under the target project's `docs/` directory (Sphinx RST format).

* After completing each **main task** (top-level checklist item), run:
  • `tox -e lint`
  • `python -m pytest dandi -q --maxfail=1`
  If either step fails, pause for user guidance.
